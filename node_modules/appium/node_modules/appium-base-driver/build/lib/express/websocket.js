'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var DEFAULT_WS_PATHNAME_PREFIX = '/ws';

/**
 * Adds websocket handler to express server instance.
 * It is expected this function is called in Express
 * server instance context.
 *
 * @param {Object} server - An instance of express HTTP server.
 * @param {string} handlerPathname - Web socket endpoint path starting with
 * a single slash character. It is recommended to always add
 * DEFAULT_WS_PATHNAME_PREFIX to all web socket pathnames.
 * @param {Object} handlerServer - WebSocket server instance. See
 * https://github.com/websockets/ws/pull/885 for more details
 * on how to configure the handler properly.
 */
function addWebSocketHandler(handlerPathname, handlerServer) {
  var isUpgradeListenerAssigned;
  return _regeneratorRuntime.async(function addWebSocketHandler$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        isUpgradeListenerAssigned = true;

        if (_lodash2['default'].isUndefined(this.webSocketsMapping)) {
          this.webSocketsMapping = {};
          isUpgradeListenerAssigned = false;
        }
        this.webSocketsMapping[handlerPathname] = handlerServer;

        if (!isUpgradeListenerAssigned) {
          context$1$0.next = 5;
          break;
        }

        return context$1$0.abrupt('return');

      case 5:

        // https://github.com/websockets/ws/pull/885
        this.on('upgrade', function (request, socket, head) {
          var currentPathname = _url2['default'].parse(request.url).pathname;
          var _iteratorNormalCompletion = true;
          var _didIteratorError = false;
          var _iteratorError = undefined;

          try {
            var _loop = function () {
              var _step$value = _slicedToArray(_step.value, 2);

              var pathname = _step$value[0];
              var wsServer = _step$value[1];

              if (currentPathname === pathname) {
                wsServer.handleUpgrade(request, socket, head, function (ws) {
                  wsServer.emit('connection', ws, request);
                });
                return {
                  v: undefined
                };
              }
            };

            for (var _iterator = _getIterator(_lodash2['default'].toPairs(_this.webSocketsMapping)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              var _ret = _loop();

              if (typeof _ret === 'object') return _ret.v;
            }
          } catch (err) {
            _didIteratorError = true;
            _iteratorError = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion && _iterator['return']) {
                _iterator['return']();
              }
            } finally {
              if (_didIteratorError) {
                throw _iteratorError;
              }
            }
          }

          socket.destroy();
        });

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Returns web socket handlers registered for the given server
 * instance.
 * It is expected this function is called in Express
 * server instance context.
 *
 * @param {?string} keysFilter [null]- Only include pathnames with given
 * `keysFilter` value if set. All pairs will be included by default.
 * @returns {Object} pathnames to websocket server isntances mapping
 * matching the search criteria or an empty object otherwise.
 */
function getWebSocketHandlers() {
  var keysFilter = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];

  var result, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, _step2$value, pathname, wsServer;

  return _regeneratorRuntime.async(function getWebSocketHandlers$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!_lodash2['default'].isEmpty(this.webSocketsMapping)) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return', {});

      case 2:
        result = {};
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 6;

        for (_iterator2 = _getIterator(_lodash2['default'].toPairs(this.webSocketsMapping)); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          _step2$value = _slicedToArray(_step2.value, 2);
          pathname = _step2$value[0];
          wsServer = _step2$value[1];

          if (!_lodash2['default'].isString(keysFilter) || pathname.includes(keysFilter)) {
            result[pathname] = wsServer;
          }
        }
        context$1$0.next = 14;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](6);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 14:
        context$1$0.prev = 14;
        context$1$0.prev = 15;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 17:
        context$1$0.prev = 17;

        if (!_didIteratorError2) {
          context$1$0.next = 20;
          break;
        }

        throw _iteratorError2;

      case 20:
        return context$1$0.finish(17);

      case 21:
        return context$1$0.finish(14);

      case 22:
        return context$1$0.abrupt('return', result);

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 10, 14, 22], [15,, 17, 21]]);
}

/**
 * Removes existing websocket handler from express server instance.
 * The call is ignored if the given `handlerPathname` handler
 * is not present in the handlers list.
 * It is expected this function is called in Express
 * server instance context.
 *
 * @param {string} handlerPathname - Websocket endpoint path.
 * @returns {boolean} true if the handlerPathname was found and deleted
 */
function removeWebSocketHandler(handlerPathname) {
  return _regeneratorRuntime.async(function removeWebSocketHandler$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!this.webSocketsMapping || !this.webSocketsMapping[handlerPathname])) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 2:
        context$1$0.prev = 2;

        this.webSocketsMapping[handlerPathname].close();
        return context$1$0.abrupt('return', true);

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](2);

      case 9:
        context$1$0.prev = 9;

        delete this.webSocketsMapping[handlerPathname];
        return context$1$0.finish(9);

      case 12:
        return context$1$0.abrupt('return', false);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 7, 9, 12]]);
}

/**
 * Removes all existing websocket handler from express server instance.
 * It is expected this function is called in Express
 * server instance context.
 *
 * @returns {boolean} true if at least one handler has been deleted
 */
function removeAllWebSocketHandlers() {
  var result, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, pathname;

  return _regeneratorRuntime.async(function removeAllWebSocketHandlers$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!_lodash2['default'].isEmpty(this.webSocketsMapping)) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 2:
        result = false;
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 6;
        _iterator3 = _getIterator(_lodash2['default'].keys(this.webSocketsMapping));

      case 8:
        if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
          context$1$0.next = 19;
          break;
        }

        pathname = _step3.value;
        context$1$0.t0 = result;

        if (context$1$0.t0) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.removeWebSocketHandler(pathname));

      case 14:
        context$1$0.t0 = context$1$0.sent;

      case 15:
        result = context$1$0.t0;

      case 16:
        _iteratorNormalCompletion3 = true;
        context$1$0.next = 8;
        break;

      case 19:
        context$1$0.next = 25;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t1 = context$1$0['catch'](6);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t1;

      case 25:
        context$1$0.prev = 25;
        context$1$0.prev = 26;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 28:
        context$1$0.prev = 28;

        if (!_didIteratorError3) {
          context$1$0.next = 31;
          break;
        }

        throw _iteratorError3;

      case 31:
        return context$1$0.finish(28);

      case 32:
        return context$1$0.finish(25);

      case 33:
        return context$1$0.abrupt('return', result);

      case 34:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 21, 25, 33], [26,, 28, 32]]);
}

exports.addWebSocketHandler = addWebSocketHandler;
exports.removeWebSocketHandler = removeWebSocketHandler;
exports.removeAllWebSocketHandlers = removeAllWebSocketHandlers;
exports.getWebSocketHandlers = getWebSocketHandlers;
exports.DEFAULT_WS_PATHNAME_PREFIX = DEFAULT_WS_PATHNAME_PREFIX;

// ignore
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3dlYnNvY2tldC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztzQkFBYyxRQUFROzs7O21CQUNOLEtBQUs7Ozs7QUFFckIsSUFBTSwwQkFBMEIsR0FBRyxLQUFLLENBQUM7Ozs7Ozs7Ozs7Ozs7OztBQWdCekMsU0FBZSxtQkFBbUIsQ0FBRSxlQUFlLEVBQUUsYUFBYTtNQUM1RCx5QkFBeUI7Ozs7OztBQUF6QixpQ0FBeUIsR0FBRyxJQUFJOztBQUNwQyxZQUFJLG9CQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRTtBQUN6QyxjQUFJLENBQUMsaUJBQWlCLEdBQUcsRUFBRSxDQUFDO0FBQzVCLG1DQUF5QixHQUFHLEtBQUssQ0FBQztTQUNuQztBQUNELFlBQUksQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsR0FBRyxhQUFhLENBQUM7O2FBQ3BELHlCQUF5Qjs7Ozs7Ozs7OztBQUs3QixZQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxVQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFLO0FBQzVDLGNBQU0sZUFBZSxHQUFHLGlCQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDOzs7Ozs7Ozs7a0JBQzVDLFFBQVE7a0JBQUUsUUFBUTs7QUFDNUIsa0JBQUksZUFBZSxLQUFLLFFBQVEsRUFBRTtBQUNoQyx3QkFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxVQUFDLEVBQUUsRUFBSztBQUNwRCwwQkFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUMxQyxDQUFDLENBQUM7QUFDSDs7a0JBQU87ZUFDUjs7O0FBTkgsOENBQW1DLG9CQUFFLE9BQU8sQ0FBQyxNQUFLLGlCQUFpQixDQUFDLDRHQUFFOzs7O2FBT3JFOzs7Ozs7Ozs7Ozs7Ozs7O0FBQ0QsZ0JBQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNsQixDQUFDLENBQUM7Ozs7Ozs7Q0FDSjs7Ozs7Ozs7Ozs7OztBQWFELFNBQWUsb0JBQW9CO01BQUUsVUFBVSx5REFBRyxJQUFJOztNQUtoRCxNQUFNLHFHQUNFLFFBQVEsRUFBRSxRQUFROzs7OzthQUwxQixvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDOzs7Ozs0Q0FDNUIsRUFBRTs7O0FBR1AsY0FBTSxHQUFHLEVBQUU7Ozs7OztBQUNmLHVDQUFtQyxvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHlHQUFFOztBQUExRCxrQkFBUTtBQUFFLGtCQUFROztBQUM1QixjQUFJLENBQUMsb0JBQUUsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEVBQUU7QUFDNUQsa0JBQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxRQUFRLENBQUM7V0FDN0I7U0FDRjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7NENBQ00sTUFBTTs7Ozs7OztDQUNkOzs7Ozs7Ozs7Ozs7QUFZRCxTQUFlLHNCQUFzQixDQUFFLGVBQWU7Ozs7Y0FDaEQsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDLENBQUE7Ozs7OzRDQUM5RCxLQUFLOzs7OztBQUlaLFlBQUksQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQzs0Q0FDekMsSUFBSTs7Ozs7Ozs7O0FBSVgsZUFBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDLENBQUM7Ozs7NENBRTFDLEtBQUs7Ozs7Ozs7Q0FDYjs7Ozs7Ozs7O0FBU0QsU0FBZSwwQkFBMEI7TUFLbkMsTUFBTSx1RkFDQyxRQUFROzs7OzthQUxmLG9CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7Ozs7OzRDQUM1QixLQUFLOzs7QUFHVixjQUFNLEdBQUcsS0FBSzs7Ozs7a0NBQ0ssb0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQzs7Ozs7Ozs7QUFBMUMsZ0JBQVE7eUJBQ1IsTUFBTTs7Ozs7Ozs7eUNBQVUsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQzs7Ozs7O0FBQTlELGNBQU07Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs0Q0FFRCxNQUFNOzs7Ozs7O0NBQ2Q7O1FBRVEsbUJBQW1CLEdBQW5CLG1CQUFtQjtRQUFFLHNCQUFzQixHQUF0QixzQkFBc0I7UUFDM0MsMEJBQTBCLEdBQTFCLDBCQUEwQjtRQUFFLG9CQUFvQixHQUFwQixvQkFBb0I7UUFDaEQsMEJBQTBCLEdBQTFCLDBCQUEwQiIsImZpbGUiOiJsaWIvZXhwcmVzcy93ZWJzb2NrZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuXG5jb25zdCBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCA9ICcvd3MnO1xuXG5cbi8qKlxuICogQWRkcyB3ZWJzb2NrZXQgaGFuZGxlciB0byBleHByZXNzIHNlcnZlciBpbnN0YW5jZS5cbiAqIEl0IGlzIGV4cGVjdGVkIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGluIEV4cHJlc3NcbiAqIHNlcnZlciBpbnN0YW5jZSBjb250ZXh0LlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBzZXJ2ZXIgLSBBbiBpbnN0YW5jZSBvZiBleHByZXNzIEhUVFAgc2VydmVyLlxuICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZXJQYXRobmFtZSAtIFdlYiBzb2NrZXQgZW5kcG9pbnQgcGF0aCBzdGFydGluZyB3aXRoXG4gKiBhIHNpbmdsZSBzbGFzaCBjaGFyYWN0ZXIuIEl0IGlzIHJlY29tbWVuZGVkIHRvIGFsd2F5cyBhZGRcbiAqIERFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIHRvIGFsbCB3ZWIgc29ja2V0IHBhdGhuYW1lcy5cbiAqIEBwYXJhbSB7T2JqZWN0fSBoYW5kbGVyU2VydmVyIC0gV2ViU29ja2V0IHNlcnZlciBpbnN0YW5jZS4gU2VlXG4gKiBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93cy9wdWxsLzg4NSBmb3IgbW9yZSBkZXRhaWxzXG4gKiBvbiBob3cgdG8gY29uZmlndXJlIHRoZSBoYW5kbGVyIHByb3Blcmx5LlxuICovXG5hc3luYyBmdW5jdGlvbiBhZGRXZWJTb2NrZXRIYW5kbGVyIChoYW5kbGVyUGF0aG5hbWUsIGhhbmRsZXJTZXJ2ZXIpIHtcbiAgbGV0IGlzVXBncmFkZUxpc3RlbmVyQXNzaWduZWQgPSB0cnVlO1xuICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzLndlYlNvY2tldHNNYXBwaW5nKSkge1xuICAgIHRoaXMud2ViU29ja2V0c01hcHBpbmcgPSB7fTtcbiAgICBpc1VwZ3JhZGVMaXN0ZW5lckFzc2lnbmVkID0gZmFsc2U7XG4gIH1cbiAgdGhpcy53ZWJTb2NrZXRzTWFwcGluZ1toYW5kbGVyUGF0aG5hbWVdID0gaGFuZGxlclNlcnZlcjtcbiAgaWYgKGlzVXBncmFkZUxpc3RlbmVyQXNzaWduZWQpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93cy9wdWxsLzg4NVxuICB0aGlzLm9uKCd1cGdyYWRlJywgKHJlcXVlc3QsIHNvY2tldCwgaGVhZCkgPT4ge1xuICAgIGNvbnN0IGN1cnJlbnRQYXRobmFtZSA9IHVybC5wYXJzZShyZXF1ZXN0LnVybCkucGF0aG5hbWU7XG4gICAgZm9yIChjb25zdCBbcGF0aG5hbWUsIHdzU2VydmVyXSBvZiBfLnRvUGFpcnModGhpcy53ZWJTb2NrZXRzTWFwcGluZykpIHtcbiAgICAgIGlmIChjdXJyZW50UGF0aG5hbWUgPT09IHBhdGhuYW1lKSB7XG4gICAgICAgIHdzU2VydmVyLmhhbmRsZVVwZ3JhZGUocmVxdWVzdCwgc29ja2V0LCBoZWFkLCAod3MpID0+IHtcbiAgICAgICAgICB3c1NlcnZlci5lbWl0KCdjb25uZWN0aW9uJywgd3MsIHJlcXVlc3QpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBzb2NrZXQuZGVzdHJveSgpO1xuICB9KTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIHdlYiBzb2NrZXQgaGFuZGxlcnMgcmVnaXN0ZXJlZCBmb3IgdGhlIGdpdmVuIHNlcnZlclxuICogaW5zdGFuY2UuXG4gKiBJdCBpcyBleHBlY3RlZCB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiBFeHByZXNzXG4gKiBzZXJ2ZXIgaW5zdGFuY2UgY29udGV4dC5cbiAqXG4gKiBAcGFyYW0gez9zdHJpbmd9IGtleXNGaWx0ZXIgW251bGxdLSBPbmx5IGluY2x1ZGUgcGF0aG5hbWVzIHdpdGggZ2l2ZW5cbiAqIGBrZXlzRmlsdGVyYCB2YWx1ZSBpZiBzZXQuIEFsbCBwYWlycyB3aWxsIGJlIGluY2x1ZGVkIGJ5IGRlZmF1bHQuXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBwYXRobmFtZXMgdG8gd2Vic29ja2V0IHNlcnZlciBpc250YW5jZXMgbWFwcGluZ1xuICogbWF0Y2hpbmcgdGhlIHNlYXJjaCBjcml0ZXJpYSBvciBhbiBlbXB0eSBvYmplY3Qgb3RoZXJ3aXNlLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRXZWJTb2NrZXRIYW5kbGVycyAoa2V5c0ZpbHRlciA9IG51bGwpIHtcbiAgaWYgKF8uaXNFbXB0eSh0aGlzLndlYlNvY2tldHNNYXBwaW5nKSkge1xuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIGxldCByZXN1bHQgPSB7fTtcbiAgZm9yIChjb25zdCBbcGF0aG5hbWUsIHdzU2VydmVyXSBvZiBfLnRvUGFpcnModGhpcy53ZWJTb2NrZXRzTWFwcGluZykpIHtcbiAgICBpZiAoIV8uaXNTdHJpbmcoa2V5c0ZpbHRlcikgfHwgcGF0aG5hbWUuaW5jbHVkZXMoa2V5c0ZpbHRlcikpIHtcbiAgICAgIHJlc3VsdFtwYXRobmFtZV0gPSB3c1NlcnZlcjtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiBSZW1vdmVzIGV4aXN0aW5nIHdlYnNvY2tldCBoYW5kbGVyIGZyb20gZXhwcmVzcyBzZXJ2ZXIgaW5zdGFuY2UuXG4gKiBUaGUgY2FsbCBpcyBpZ25vcmVkIGlmIHRoZSBnaXZlbiBgaGFuZGxlclBhdGhuYW1lYCBoYW5kbGVyXG4gKiBpcyBub3QgcHJlc2VudCBpbiB0aGUgaGFuZGxlcnMgbGlzdC5cbiAqIEl0IGlzIGV4cGVjdGVkIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGluIEV4cHJlc3NcbiAqIHNlcnZlciBpbnN0YW5jZSBjb250ZXh0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGVyUGF0aG5hbWUgLSBXZWJzb2NrZXQgZW5kcG9pbnQgcGF0aC5cbiAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIHRoZSBoYW5kbGVyUGF0aG5hbWUgd2FzIGZvdW5kIGFuZCBkZWxldGVkXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHJlbW92ZVdlYlNvY2tldEhhbmRsZXIgKGhhbmRsZXJQYXRobmFtZSkge1xuICBpZiAoIXRoaXMud2ViU29ja2V0c01hcHBpbmcgfHwgIXRoaXMud2ViU29ja2V0c01hcHBpbmdbaGFuZGxlclBhdGhuYW1lXSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgdGhpcy53ZWJTb2NrZXRzTWFwcGluZ1toYW5kbGVyUGF0aG5hbWVdLmNsb3NlKCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIC8vIGlnbm9yZVxuICB9IGZpbmFsbHkge1xuICAgIGRlbGV0ZSB0aGlzLndlYlNvY2tldHNNYXBwaW5nW2hhbmRsZXJQYXRobmFtZV07XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG4vKipcbiAqIFJlbW92ZXMgYWxsIGV4aXN0aW5nIHdlYnNvY2tldCBoYW5kbGVyIGZyb20gZXhwcmVzcyBzZXJ2ZXIgaW5zdGFuY2UuXG4gKiBJdCBpcyBleHBlY3RlZCB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiBFeHByZXNzXG4gKiBzZXJ2ZXIgaW5zdGFuY2UgY29udGV4dC5cbiAqXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gdHJ1ZSBpZiBhdCBsZWFzdCBvbmUgaGFuZGxlciBoYXMgYmVlbiBkZWxldGVkXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzICgpIHtcbiAgaWYgKF8uaXNFbXB0eSh0aGlzLndlYlNvY2tldHNNYXBwaW5nKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGxldCByZXN1bHQgPSBmYWxzZTtcbiAgZm9yIChjb25zdCBwYXRobmFtZSBvZiBfLmtleXModGhpcy53ZWJTb2NrZXRzTWFwcGluZykpIHtcbiAgICByZXN1bHQgPSByZXN1bHQgfHwgYXdhaXQgdGhpcy5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgeyBhZGRXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVXZWJTb2NrZXRIYW5kbGVyLFxuICAgICAgICAgcmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnMsIGdldFdlYlNvY2tldEhhbmRsZXJzLFxuICAgICAgICAgREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVggfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
