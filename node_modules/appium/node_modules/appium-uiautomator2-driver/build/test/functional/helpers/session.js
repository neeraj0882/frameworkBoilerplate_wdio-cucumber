'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

var _ = require('../../..');

var _libLogger = require('../../../lib/logger');

var _libLogger2 = _interopRequireDefault(_libLogger);

var _wd = require('wd');

var _wd2 = _interopRequireDefault(_wd);

function initDriver(caps, adbPort) {
  var adb, driver, src, okBtn;
  return _regeneratorRuntime.async(function initDriver$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!process.env.TRAVIS) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumAdb2['default'].createADB({ adbPort: adbPort }));

      case 3:
        adb = context$1$0.sent;
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(adb.forceStop('com.android.inputmethod.latin'));

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(adb.shell(['pm', 'clear', 'com.android.inputmethod.latin']));

      case 9:
        context$1$0.next = 13;
        break;

      case 11:
        context$1$0.prev = 11;
        context$1$0.t0 = context$1$0['catch'](4);

      case 13:

        // Create a WD driver
        _libLogger2['default'].debug('Starting session on ' + _.DEFAULT_HOST + ':' + _.DEFAULT_PORT);
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(_wd2['default'].promiseChainRemote(_.DEFAULT_HOST, _.DEFAULT_PORT));

      case 16:
        driver = context$1$0.sent;
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(driver.init(caps));

      case 19:
        if (!process.env.CI) {
          context$1$0.next = 39;
          break;
        }

        context$1$0.prev = 20;
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap(driver.source());

      case 23:
        src = context$1$0.sent;

        console.log('Source:', src); // eslint-disable-line

        if (!src.includes('Unfortunately, Calendar has stopped')) {
          context$1$0.next = 34;
          break;
        }

        _libLogger2['default'].warn('Calendar crashed. Trying to dismiss alert');
        context$1$0.next = 29;
        return _regeneratorRuntime.awrap(driver.elementById('android:id/button1'));

      case 29:
        okBtn = context$1$0.sent;
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap(okBtn.click());

      case 32:
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(driver.startActivity(caps));

      case 34:
        context$1$0.next = 39;
        break;

      case 36:
        context$1$0.prev = 36;
        context$1$0.t1 = context$1$0['catch'](20);

        _libLogger2['default'].error('TEST RUN ERROR: ' + context$1$0.t1.message);

      case 39:
        return context$1$0.abrupt('return', driver);

      case 40:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 11], [20, 36]]);
}

exports.initDriver = initDriver;

// on Travis, sometimes we get the keyboard dying and the screen stuck

// In Travis, there is sometimes a popup
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZnVuY3Rpb25hbC9oZWxwZXJzL3Nlc3Npb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozt5QkFBZ0IsWUFBWTs7OztnQkFDZSxVQUFVOzt5QkFDbEMscUJBQXFCOzs7O2tCQUN6QixJQUFJOzs7O0FBR25CLFNBQWUsVUFBVSxDQUFFLElBQUksRUFBRSxPQUFPO01BRWhDLEdBQUcsRUFVTCxNQUFNLEVBTUEsR0FBRyxFQUlELEtBQUs7Ozs7YUFyQmIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNOzs7Ozs7eUNBQ0osdUJBQUksU0FBUyxDQUFDLEVBQUMsT0FBTyxFQUFQLE9BQU8sRUFBQyxDQUFDOzs7QUFBcEMsV0FBRzs7O3lDQUdDLEdBQUcsQ0FBQyxTQUFTLENBQUMsK0JBQStCLENBQUM7Ozs7eUNBQzlDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLCtCQUErQixDQUFDLENBQUM7Ozs7Ozs7Ozs7Ozs7QUFLckUsK0JBQU8sS0FBSyxnRUFBdUQsQ0FBQzs7eUNBQ2pELGdCQUFHLGtCQUFrQixnQ0FBNEI7OztBQUFoRSxjQUFNOzt5Q0FDSixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzs7O2FBR25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTs7Ozs7Ozt5Q0FFSSxNQUFNLENBQUMsTUFBTSxFQUFFOzs7QUFBM0IsV0FBRzs7QUFDVCxlQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQzs7YUFDeEIsR0FBRyxDQUFDLFFBQVEsQ0FBQyxxQ0FBcUMsQ0FBQzs7Ozs7QUFDckQsK0JBQU8sSUFBSSxDQUFDLDJDQUEyQyxDQUFDLENBQUM7O3lDQUNyQyxNQUFNLENBQUMsV0FBVyxDQUFDLG9CQUFvQixDQUFDOzs7QUFBdEQsYUFBSzs7eUNBQ0wsS0FBSyxDQUFDLEtBQUssRUFBRTs7Ozt5Q0FDYixNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQzs7Ozs7Ozs7OztBQUdsQywrQkFBTyxLQUFLLHNCQUFvQixlQUFJLE9BQU8sQ0FBRyxDQUFDOzs7NENBSTVDLE1BQU07Ozs7Ozs7Q0FDZDs7UUFFUSxVQUFVLEdBQVYsVUFBVSIsImZpbGUiOiJ0ZXN0L2Z1bmN0aW9uYWwvaGVscGVycy9zZXNzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFEQiBmcm9tICdhcHBpdW0tYWRiJztcbmltcG9ydCB7IERFRkFVTFRfSE9TVCwgREVGQVVMVF9QT1JUIH0gZnJvbSAnLi4vLi4vLi4nO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi8uLi8uLi9saWIvbG9nZ2VyJztcbmltcG9ydCB3ZCBmcm9tICd3ZCc7XG5cblxuYXN5bmMgZnVuY3Rpb24gaW5pdERyaXZlciAoY2FwcywgYWRiUG9ydCkge1xuICBpZiAocHJvY2Vzcy5lbnYuVFJBVklTKSB7XG4gICAgbGV0IGFkYiA9IGF3YWl0IEFEQi5jcmVhdGVBREIoe2FkYlBvcnR9KTtcbiAgICB0cnkge1xuICAgICAgLy8gb24gVHJhdmlzLCBzb21ldGltZXMgd2UgZ2V0IHRoZSBrZXlib2FyZCBkeWluZyBhbmQgdGhlIHNjcmVlbiBzdHVja1xuICAgICAgYXdhaXQgYWRiLmZvcmNlU3RvcCgnY29tLmFuZHJvaWQuaW5wdXRtZXRob2QubGF0aW4nKTtcbiAgICAgIGF3YWl0IGFkYi5zaGVsbChbJ3BtJywgJ2NsZWFyJywgJ2NvbS5hbmRyb2lkLmlucHV0bWV0aG9kLmxhdGluJ10pO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxuXG4gIC8vIENyZWF0ZSBhIFdEIGRyaXZlclxuICBsb2dnZXIuZGVidWcoYFN0YXJ0aW5nIHNlc3Npb24gb24gJHtERUZBVUxUX0hPU1R9OiR7REVGQVVMVF9QT1JUfWApO1xuICBsZXQgZHJpdmVyID0gYXdhaXQgd2QucHJvbWlzZUNoYWluUmVtb3RlKERFRkFVTFRfSE9TVCwgREVGQVVMVF9QT1JUKTtcbiAgYXdhaXQgZHJpdmVyLmluaXQoY2Fwcyk7XG5cbiAgLy8gSW4gVHJhdmlzLCB0aGVyZSBpcyBzb21ldGltZXMgYSBwb3B1cFxuICBpZiAocHJvY2Vzcy5lbnYuQ0kpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3JjID0gYXdhaXQgZHJpdmVyLnNvdXJjZSgpO1xuICAgICAgY29uc29sZS5sb2coJ1NvdXJjZTonLCBzcmMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgICBpZiAoc3JjLmluY2x1ZGVzKCdVbmZvcnR1bmF0ZWx5LCBDYWxlbmRhciBoYXMgc3RvcHBlZCcpKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKCdDYWxlbmRhciBjcmFzaGVkLiBUcnlpbmcgdG8gZGlzbWlzcyBhbGVydCcpO1xuICAgICAgICBjb25zdCBva0J0biA9IGF3YWl0IGRyaXZlci5lbGVtZW50QnlJZCgnYW5kcm9pZDppZC9idXR0b24xJyk7XG4gICAgICAgIGF3YWl0IG9rQnRuLmNsaWNrKCk7XG4gICAgICAgIGF3YWl0IGRyaXZlci5zdGFydEFjdGl2aXR5KGNhcHMpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBURVNUIFJVTiBFUlJPUjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZHJpdmVyO1xufVxuXG5leHBvcnQgeyBpbml0RHJpdmVyIH07Il0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
