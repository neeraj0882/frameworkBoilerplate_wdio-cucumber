require('source-map-support').install();

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _bplistCreator = require('bplist-creator');

var _bplistCreator2 = _interopRequireDefault(_bplistCreator);

var _bplistParser = require('bplist-parser');

var _bplistParser2 = _interopRequireDefault(_bplistParser);

var _bufferpack = require('bufferpack');

var _bufferpack2 = _interopRequireDefault(_bufferpack);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var log = _appiumSupport.logger.getLogger('RemoteDebugger');

var DEVICE_INFO = {
  name: 'iPhone Simulator',
  build: 'WP42FJ'
};

var APP_INFO = {
  'PID:42': {
    id: 'PID:42',
    name: 'app',
    bundleId: 'io.appium.bundle',
    isProxy: false,
    hostId: '',
    isActive: '1',
    isAutomationEnabled: false
  }
};

// a bunch of new app info structures to simulate
// the app getting proxied through other apps
var UPDATED_APP_INFO = [{
  id: 'PID:44',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:42',
  isActive: '1'
}, {
  id: 'PID:46',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:44',
  isActive: '1'
}, {
  id: 'PID:48',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:46',
  isActive: '1'
}, {
  id: 'PID:50',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:48',
  isActive: '1'
}];

/*
 * A fake remote debugger server that can be told to send certain
 * messages back to the client, and to return certain values.
 * Used for testing the client.
 */

var RemoteDebuggerServer = (function () {
  function RemoteDebuggerServer() {
    _classCallCheck(this, RemoteDebuggerServer);

    this.server = null;
    this.client = null;
    this.pendingAppChange = false;
    this.appIdKey = 'PID:42';
    this.destinationKey = '2';
    this.app = 1;
    this.dataResponseValue = [];
  }

  _createClass(RemoteDebuggerServer, [{
    key: '_getConnectedApplicationList',
    value: function _getConnectedApplicationList(num) {
      var data = {
        __selector: '_rpc_reportConnectedApplicationList:',
        __argument: {
          WIRApplicationDictionaryKey: [{
            WIRApplicationIdentifierKey: APP_INFO['PID:42'].id,
            WIRApplicationNameKey: APP_INFO['PID:42'].name,
            WIRApplicationBundleIdentifierKey: APP_INFO['PID:42'].bundleId,
            WIRIsApplicationProxyKey: APP_INFO['PID:42'].isProxy,
            WIRHostApplicationIdentifierKey: APP_INFO['PID:42'].hostId,
            WIRIsApplicationActiveKey: APP_INFO['PID:42'].isActive
          }]
        }
      };

      // add more
      if (num > UPDATED_APP_INFO + 1) {
        // we only have so many to give!
        num = UPDATED_APP_INFO + 1;
      }
      for (var i = 0; i < num - 1; i++) {
        var entry = UPDATED_APP_INFO[i];
        data.__argument.WIRApplicationDictionaryKey.push(_defineProperty({}, entry.id, entry));
      }

      return data;
    }
  }, {
    key: 'handleReportIdentifier',
    value: function handleReportIdentifier() {
      var data = {
        __selector: '_rpc_reportSetup:',
        __argument: {
          WIRSimulatorNameKey: DEVICE_INFO.name,
          WIRSimulatorBuildKey: DEVICE_INFO.build
        }
      };
      this.send(data);

      if (this.dataResponseError) {
        data = {
          __selector: '_rpc_reportConnectedApplicationList:',
          __argument: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else {
        data = this._getConnectedApplicationList(1);
      }
      this.send(data);
    }
  }, {
    key: 'handleGetListing',
    value: function handleGetListing() {
      // if we have pending app change events, send them
      if (this.pendingAppChange) {
        this.changeApp(this.pendingAppChange, true);
        this.pendingAppChange = 0;
      }

      // need to send an app dictionary back
      var data = {
        __selector: '_rpc_applicationSentListing:',
        __argument: {
          WIRApplicationIdentifierKey: 'PID:42',
          WIRListingKey: {
            '1': {
              WIRTypeKey: 'WIRTypeWeb',
              WIRPageIdentifierKey: 1,
              WIRTitleKey: '',
              WIRURLKey: 'about:blank'
            }
          }
        }
      };
      this.send(data);
    }
  }, {
    key: 'handleSocketData',
    value: function handleSocketData(plist) {
      var plistData = JSON.parse(plist.__argument.WIRSocketDataKey.toString('utf8'));

      var result = {};
      if (this.dataResponseError) {
        result = {
          result: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else if (this.dataResponseValue.length > 0) {
        // add the response value
        result = {
          result: {
            type: 'string',
            value: this.dataResponseValue.shift()
          },
          wasThrown: false
        };
      }

      var dataKey = {
        result: result,
        id: plistData.id
      };
      dataKey = new Buffer(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: plist.__argument.WIRSenderKey,
          WIRApplicationIdentifierKey: plist.__argument.WIRApplicationIdentifierKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'changeApp',
    value: function changeApp() {
      var num = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];
      var immediate = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

      if (immediate) {
        if (num > UPDATED_APP_INFO.length - 1) {
          // we only have a certain number of info to send
          num = UPDATED_APP_INFO.length - 1;
        }
        for (var i = 0; i < num; i++) {
          var data = {
            __selector: '_rpc_applicationConnected:',
            __argument: {
              WIRApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].id,
              WIRApplicationNameKey: UPDATED_APP_INFO[this.app - 1].name,
              WIRApplicationBundleIdentifierKey: UPDATED_APP_INFO[this.app - 1].bundleId,
              WIRIsApplicationProxyKey: UPDATED_APP_INFO[this.app - 1].isProxy,
              WIRHostApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].hostId,
              WIRIsApplicationActiveKey: UPDATED_APP_INFO[this.app - 1].isActive
            }
          };
          this.send(data);

          this.app++;
        }
      } else {
        this.pendingAppChange = num;
      }
    }
  }, {
    key: 'sendPageInfoMessage',
    value: function sendPageInfoMessage(appIdKey) {
      var data = {
        __selector: '_rpc_applicationSentListing:',
        __argument: {
          WIRApplicationIdentifierKey: appIdKey,
          WIRListingKey: {
            '1': {
              WIRTypeKey: 'WIRTypeWeb',
              WIRPageIdentifierKey: 1,
              WIRTitleKey: '',
              WIRURLKey: 'about:blank'
            }
          }
        }
      };
      this.send(data);
    }
  }, {
    key: 'sendFrameNavigationMessage',
    value: function sendFrameNavigationMessage() {
      var dataKey = {
        method: 'Page.frameNavigated',
        result: {},
        id: 1
      };
      dataKey = new Buffer(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: this.destinationKey,
          WIRApplicationIdentifierKey: this.appIdKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'setDataResponseError',
    value: function setDataResponseError(error) {
      this.dataResponseError = error;
    }
  }, {
    key: 'setDataResponseValue',
    value: function setDataResponseValue(value) {
      this.dataResponseValue.push(value);
    }
  }, {
    key: 'start',
    value: function start() {
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              _this.server = _net2['default'].createServer(function (c) {
                _this.client = c;
                c.on('end', function () {
                  log.debug('client disconnected');
                });
                c.on('data', function (data) {
                  var plist = _bplistParser2['default'].parseBuffer(data.slice(4));

                  if (!plist[0].__selector) {
                    reject(new Error('Unable to decipher plist: ' + plist));
                    return;
                  }

                  switch (plist[0].__selector) {
                    case '_rpc_reportIdentifier:':
                      _this.handleReportIdentifier(plist[0]);
                      break;
                    case '_rpc_forwardGetListing:':
                      _this.handleGetListing(plist[0]);
                      break;
                    case '_rpc_forwardSocketSetup:':
                      // do nothing
                      break;
                    case '_rpc_forwardSocketData:':
                      _this.handleSocketData(plist[0]);
                      break;
                    case '_rpc_forwardIndicateWebView:':
                      reject(new Error('NOT YET IMPLEMENTED: ' + plist[0].__selector));
                      break;
                    default:
                      _this.client.write('do not compute');
                  }
                });
              });

              // don't use the real port, or any open sims will break the tests
              _this.server.listen(27754, '::1', function () {
                log.info('server bound: ' + JSON.stringify(_this.server.address()));
                resolve();
              });
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve) {
              if (_this2.server) {
                if (_this2.client) {
                  _this2.client.end();
                }
                _this2.server.close(function (err) {
                  // eslint-disable-line promise/prefer-await-to-callbacks
                  resolve('Stopped listening: ' + err);
                });
              } else {
                resolve('Not listening.');
              }
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'send',
    value: function send(data) {
      var buf = (0, _bplistCreator2['default'])(data);
      var length = _bufferpack2['default'].pack('L', [buf.length]);
      this.client.write(Buffer.concat([length, buf]));
    }
  }]);

  return RemoteDebuggerServer;
})();

exports.RemoteDebuggerServer = RemoteDebuggerServer;
exports.APP_INFO = APP_INFO;
exports.DEVICE_INFO = DEVICE_INFO;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvaGVscGVycy9yZW1vdGUtZGVidWdnZXItc2VydmVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OzttQkFFZ0IsS0FBSzs7Ozs2QkFDSSxnQkFBZ0I7Ozs7NEJBQ2pCLGVBQWU7Ozs7MEJBQ2hCLFlBQVk7Ozs7d0JBQ2YsVUFBVTs7Ozs2QkFDUCxnQkFBZ0I7O0FBRXZDLElBQU0sR0FBRyxHQUFHLHNCQUFPLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztBQUcvQyxJQUFNLFdBQVcsR0FBRztBQUNsQixNQUFJLEVBQUUsa0JBQWtCO0FBQ3hCLE9BQUssRUFBRSxRQUFRO0NBQ2hCLENBQUM7O0FBRUYsSUFBTSxRQUFRLEdBQUc7QUFDZixVQUFRLEVBQUU7QUFDUixNQUFFLEVBQUUsUUFBUTtBQUNaLFFBQUksRUFBRSxLQUFLO0FBQ1gsWUFBUSxFQUFFLGtCQUFrQjtBQUM1QixXQUFPLEVBQUUsS0FBSztBQUNkLFVBQU0sRUFBRSxFQUFFO0FBQ1YsWUFBUSxFQUFFLEdBQUc7QUFDYix1QkFBbUIsRUFBRSxLQUFLO0dBQzNCO0NBQ0YsQ0FBQzs7OztBQUlGLElBQU0sZ0JBQWdCLEdBQUcsQ0FDdkI7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxFQUFFLElBQUk7QUFDYixRQUFNLEVBQUUsUUFBUTtBQUNoQixVQUFRLEVBQUUsR0FBRztDQUNkLEVBQ0Q7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxFQUFFLElBQUk7QUFDYixRQUFNLEVBQUUsUUFBUTtBQUNoQixVQUFRLEVBQUUsR0FBRztDQUNkLEVBQ0Q7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxF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QkFBSyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRyxFQUFLOztBQUN6Qix5QkFBTyx5QkFBdUIsR0FBRyxDQUFHLENBQUM7aUJBQ3RDLENBQUMsQ0FBQztlQUNKLE1BQU07QUFDTCx1QkFBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7ZUFDM0I7YUFDRixDQUFDOzs7Ozs7O0tBQ0g7OztXQUVJLGNBQUMsSUFBSSxFQUFFO0FBQ1YsVUFBSSxHQUFHLEdBQUcsZ0NBQWEsSUFBSSxDQUFDLENBQUM7QUFDN0IsVUFBSSxNQUFNLEdBQUcsd0JBQVcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ2hELFVBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2pEOzs7U0F6UUcsb0JBQW9COzs7UUE0UWpCLG9CQUFvQixHQUFwQixvQkFBb0I7UUFBRSxRQUFRLEdBQVIsUUFBUTtRQUFFLFdBQVcsR0FBWCxXQUFXIiwiZmlsZSI6InRlc3QvaGVscGVycy9yZW1vdGUtZGVidWdnZXItc2VydmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1haW5cblxuaW1wb3J0IG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IGJwbGlzdENyZWF0ZSBmcm9tICdicGxpc3QtY3JlYXRvcic7XG5pbXBvcnQgYnBsaXN0UGFyc2UgZnJvbSAnYnBsaXN0LXBhcnNlcic7XG5pbXBvcnQgYnVmZmVycGFjayBmcm9tICdidWZmZXJwYWNrJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignUmVtb3RlRGVidWdnZXInKTtcblxuXG5jb25zdCBERVZJQ0VfSU5GTyA9IHtcbiAgbmFtZTogJ2lQaG9uZSBTaW11bGF0b3InLFxuICBidWlsZDogJ1dQNDJGSidcbn07XG5cbmNvbnN0IEFQUF9JTkZPID0ge1xuICAnUElEOjQyJzoge1xuICAgIGlkOiAnUElEOjQyJyxcbiAgICBuYW1lOiAnYXBwJyxcbiAgICBidW5kbGVJZDogJ2lvLmFwcGl1bS5idW5kbGUnLFxuICAgIGlzUHJveHk6IGZhbHNlLFxuICAgIGhvc3RJZDogJycsXG4gICAgaXNBY3RpdmU6ICcxJyxcbiAgICBpc0F1dG9tYXRpb25FbmFibGVkOiBmYWxzZVxuICB9XG59O1xuXG4vLyBhIGJ1bmNoIG9mIG5ldyBhcHAgaW5mbyBzdHJ1Y3R1cmVzIHRvIHNpbXVsYXRlXG4vLyB0aGUgYXBwIGdldHRpbmcgcHJveGllZCB0aHJvdWdoIG90aGVyIGFwcHNcbmNvbnN0IFVQREFURURfQVBQX0lORk8gPSBbXG4gIHtcbiAgICBpZDogJ1BJRDo0NCcsXG4gICAgbmFtZTogJ3Byb3h5IGFwcCAxJyxcbiAgICBidW5kbGVJZDogJ2lvLmFwcGl1bS5idW5kbGUucHJveHkxJyxcbiAgICBpc1Byb3h5OiB0cnVlLFxuICAgIGhvc3RJZDogJ1BJRDo0MicsXG4gICAgaXNBY3RpdmU6ICcxJ1xuICB9LFxuICB7XG4gICAgaWQ6ICdQSUQ6NDYnLFxuICAgIG5hbWU6ICdwcm94eSBhcHAgMScsXG4gICAgYnVuZGxlSWQ6ICdpby5hcHBpdW0uYnVuZGxlLnByb3h5MScsXG4gICAgaXNQcm94eTogdHJ1ZSxcbiAgICBob3N0SWQ6ICdQSUQ6NDQnLFxuICAgIGlzQWN0aXZlOiAnMSdcbiAgfSxcbiAge1xuICAgIGlkOiAnUElEOjQ4JyxcbiAgICBuYW1lOiAncHJveHkgYXBwIDEnLFxuICAgIGJ1bmRsZUlkOiAnaW8uYXBwaXVtLmJ1bmRsZS5wcm94eTEnLFxuICAgIGlzUHJveHk6IHRydWUsXG4gICAgaG9zdElkOiAnUElEOjQ2JyxcbiAgICBpc0FjdGl2ZTogJzEnXG4gIH0sXG4gIHtcbiAgICBpZDogJ1BJRDo1MCcsXG4gICAgbmFtZTogJ3Byb3h5IGFwcCAxJyxcbiAgICBidW5kbGVJZDogJ2lvLmFwcGl1bS5idW5kbGUucHJveHkxJyxcbiAgICBpc1Byb3h5OiB0cnVlLFxuICAgIGhvc3RJZDogJ1BJRDo0OCcsXG4gICAgaXNBY3RpdmU6ICcxJ1xuICB9XG5dO1xuXG5cbi8qXG4gKiBBIGZha2UgcmVtb3RlIGRlYnVnZ2VyIHNlcnZlciB0aGF0IGNhbiBiZSB0b2xkIHRvIHNlbmQgY2VydGFpblxuICogbWVzc2FnZXMgYmFjayB0byB0aGUgY2xpZW50LCBhbmQgdG8gcmV0dXJuIGNlcnRhaW4gdmFsdWVzLlxuICogVXNlZCBmb3IgdGVzdGluZyB0aGUgY2xpZW50LlxuICovXG5jbGFzcyBSZW1vdGVEZWJ1Z2dlclNlcnZlciB7XG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICB0aGlzLnNlcnZlciA9IG51bGw7XG4gICAgdGhpcy5jbGllbnQgPSBudWxsO1xuICAgIHRoaXMucGVuZGluZ0FwcENoYW5nZSA9IGZhbHNlO1xuICAgIHRoaXMuYXBwSWRLZXkgPSAnUElEOjQyJztcbiAgICB0aGlzLmRlc3RpbmF0aW9uS2V5ID0gJzInO1xuICAgIHRoaXMuYXBwID0gMTtcbiAgICB0aGlzLmRhdGFSZXNwb25zZVZhbHVlID0gW107XG4gIH1cblxuICBfZ2V0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0IChudW0pIHtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLFxuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJBcHBsaWNhdGlvbkRpY3Rpb25hcnlLZXk6IFt7XG4gICAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBBUFBfSU5GT1snUElEOjQyJ10uaWQsXG4gICAgICAgICAgV0lSQXBwbGljYXRpb25OYW1lS2V5OiBBUFBfSU5GT1snUElEOjQyJ10ubmFtZSxcbiAgICAgICAgICBXSVJBcHBsaWNhdGlvbkJ1bmRsZUlkZW50aWZpZXJLZXk6IEFQUF9JTkZPWydQSUQ6NDInXS5idW5kbGVJZCxcbiAgICAgICAgICBXSVJJc0FwcGxpY2F0aW9uUHJveHlLZXk6IEFQUF9JTkZPWydQSUQ6NDInXS5pc1Byb3h5LFxuICAgICAgICAgIFdJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IEFQUF9JTkZPWydQSUQ6NDInXS5ob3N0SWQsXG4gICAgICAgICAgV0lSSXNBcHBsaWNhdGlvbkFjdGl2ZUtleTogQVBQX0lORk9bJ1BJRDo0MiddLmlzQWN0aXZlXG4gICAgICAgIH1dXG4gICAgICB9XG4gICAgfTtcblxuICAgIC8vIGFkZCBtb3JlXG4gICAgaWYgKG51bSA+IFVQREFURURfQVBQX0lORk8rMSkge1xuICAgICAgLy8gd2Ugb25seSBoYXZlIHNvIG1hbnkgdG8gZ2l2ZSFcbiAgICAgIG51bSA9IFVQREFURURfQVBQX0lORk8gKyAxO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bS0xOyBpKyspIHtcbiAgICAgIGxldCBlbnRyeSA9IFVQREFURURfQVBQX0lORk9baV07XG4gICAgICBkYXRhLl9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5LnB1c2goe1tlbnRyeS5pZF06IGVudHJ5fSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBoYW5kbGVSZXBvcnRJZGVudGlmaWVyICgpIHtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX3JlcG9ydFNldHVwOicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUlNpbXVsYXRvck5hbWVLZXk6IERFVklDRV9JTkZPLm5hbWUsXG4gICAgICAgIFdJUlNpbXVsYXRvckJ1aWxkS2V5OiBERVZJQ0VfSU5GTy5idWlsZFxuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5zZW5kKGRhdGEpO1xuXG4gICAgaWYgKHRoaXMuZGF0YVJlc3BvbnNlRXJyb3IpIHtcbiAgICAgIGRhdGEgPSB7XG4gICAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLFxuICAgICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgdmFsdWU6IHRoaXMuZGF0YVJlc3BvbnNlRXJyb3JcbiAgICAgICAgfSxcbiAgICAgICAgd2FzVGhyb3duOiB0cnVlXG4gICAgICB9O1xuICAgICAgdGhpcy5kYXRhUmVzcG9uc2VFcnJvciA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRhdGEgPSB0aGlzLl9nZXRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3QoMSk7XG4gICAgfVxuICAgIHRoaXMuc2VuZChkYXRhKTtcbiAgfVxuXG4gIGhhbmRsZUdldExpc3RpbmcgKCkge1xuICAgIC8vIGlmIHdlIGhhdmUgcGVuZGluZyBhcHAgY2hhbmdlIGV2ZW50cywgc2VuZCB0aGVtXG4gICAgaWYgKHRoaXMucGVuZGluZ0FwcENoYW5nZSkge1xuICAgICAgdGhpcy5jaGFuZ2VBcHAodGhpcy5wZW5kaW5nQXBwQ2hhbmdlLCB0cnVlKTtcbiAgICAgIHRoaXMucGVuZGluZ0FwcENoYW5nZSA9IDA7XG4gICAgfVxuXG4gICAgLy8gbmVlZCB0byBzZW5kIGFuIGFwcCBkaWN0aW9uYXJ5IGJhY2tcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2FwcGxpY2F0aW9uU2VudExpc3Rpbmc6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiAnUElEOjQyJyxcbiAgICAgICAgV0lSTGlzdGluZ0tleToge1xuICAgICAgICAgICcxJzoge1xuICAgICAgICAgICAgV0lSVHlwZUtleTogJ1dJUlR5cGVXZWInLFxuICAgICAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IDEsXG4gICAgICAgICAgICBXSVJUaXRsZUtleTogJycsXG4gICAgICAgICAgICBXSVJVUkxLZXk6ICdhYm91dDpibGFuaydcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuc2VuZChkYXRhKTtcbiAgfVxuXG4gIGhhbmRsZVNvY2tldERhdGEgKHBsaXN0KSB7XG4gICAgbGV0IHBsaXN0RGF0YSA9IEpTT04ucGFyc2UocGxpc3QuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnRvU3RyaW5nKCd1dGY4JykpO1xuXG4gICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgIGlmICh0aGlzLmRhdGFSZXNwb25zZUVycm9yKSB7XG4gICAgICByZXN1bHQgPSB7XG4gICAgICAgIHJlc3VsdDoge1xuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLmRhdGFSZXNwb25zZUVycm9yXG4gICAgICAgIH0sXG4gICAgICAgIHdhc1Rocm93bjogdHJ1ZVxuICAgICAgfTtcbiAgICAgIHRoaXMuZGF0YVJlc3BvbnNlRXJyb3IgPSBudWxsO1xuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhUmVzcG9uc2VWYWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAvLyBhZGQgdGhlIHJlc3BvbnNlIHZhbHVlXG4gICAgICByZXN1bHQgPSB7XG4gICAgICAgIHJlc3VsdDoge1xuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLmRhdGFSZXNwb25zZVZhbHVlLnNoaWZ0KClcbiAgICAgICAgfSxcbiAgICAgICAgd2FzVGhyb3duOiBmYWxzZVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBsZXQgZGF0YUtleSA9IHtcbiAgICAgIHJlc3VsdCxcbiAgICAgIGlkOiBwbGlzdERhdGEuaWRcbiAgICB9O1xuICAgIGRhdGFLZXkgPSBuZXcgQnVmZmVyKEpTT04uc3RyaW5naWZ5KGRhdGFLZXkpKTtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2FwcGxpY2F0aW9uU2VudERhdGE6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSRGVzdGluYXRpb25LZXk6IHBsaXN0Ll9fYXJndW1lbnQuV0lSU2VuZGVyS2V5LFxuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5LFxuICAgICAgICBXSVJNZXNzYWdlRGF0YUtleTogZGF0YUtleVxuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5zZW5kKGRhdGEpO1xuICB9XG5cbiAgY2hhbmdlQXBwIChudW0gPSAxLCBpbW1lZGlhdGUgPSB0cnVlKSB7XG4gICAgaWYgKGltbWVkaWF0ZSkge1xuICAgICAgaWYgKG51bSA+IFVQREFURURfQVBQX0lORk8ubGVuZ3RoLTEpIHtcbiAgICAgICAgLy8gd2Ugb25seSBoYXZlIGEgY2VydGFpbiBudW1iZXIgb2YgaW5mbyB0byBzZW5kXG4gICAgICAgIG51bSA9IFVQREFURURfQVBQX0lORk8ubGVuZ3RoIC0gMTtcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtOyBpKyspIHtcbiAgICAgICAgbGV0IGRhdGEgPSB7XG4gICAgICAgICAgX19zZWxlY3RvcjogJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JyxcbiAgICAgICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IFVQREFURURfQVBQX0lORk9bdGhpcy5hcHAtMV0uaWQsXG4gICAgICAgICAgICBXSVJBcHBsaWNhdGlvbk5hbWVLZXk6IFVQREFURURfQVBQX0lORk9bdGhpcy5hcHAtMV0ubmFtZSxcbiAgICAgICAgICAgIFdJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleTogVVBEQVRFRF9BUFBfSU5GT1t0aGlzLmFwcC0xXS5idW5kbGVJZCxcbiAgICAgICAgICAgIFdJUklzQXBwbGljYXRpb25Qcm94eUtleTogVVBEQVRFRF9BUFBfSU5GT1t0aGlzLmFwcC0xXS5pc1Byb3h5LFxuICAgICAgICAgICAgV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogVVBEQVRFRF9BUFBfSU5GT1t0aGlzLmFwcC0xXS5ob3N0SWQsXG4gICAgICAgICAgICBXSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmlzQWN0aXZlXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNlbmQoZGF0YSk7XG5cbiAgICAgICAgdGhpcy5hcHArKztcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wZW5kaW5nQXBwQ2hhbmdlID0gbnVtO1xuICAgIH1cbiAgfVxuXG4gIHNlbmRQYWdlSW5mb01lc3NhZ2UgKGFwcElkS2V5KSB7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19hcHBsaWNhdGlvblNlbnRMaXN0aW5nOicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogYXBwSWRLZXksXG4gICAgICAgIFdJUkxpc3RpbmdLZXk6IHtcbiAgICAgICAgICAnMSc6IHtcbiAgICAgICAgICAgIFdJUlR5cGVLZXk6ICdXSVJUeXBlV2ViJyxcbiAgICAgICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiAxLFxuICAgICAgICAgICAgV0lSVGl0bGVLZXk6ICcnLFxuICAgICAgICAgICAgV0lSVVJMS2V5OiAnYWJvdXQ6YmxhbmsnXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBzZW5kRnJhbWVOYXZpZ2F0aW9uTWVzc2FnZSAoKSB7XG4gICAgbGV0IGRhdGFLZXkgPSB7XG4gICAgICBtZXRob2Q6ICdQYWdlLmZyYW1lTmF2aWdhdGVkJyxcbiAgICAgIHJlc3VsdDoge30sXG4gICAgICBpZDogMVxuICAgIH07XG4gICAgZGF0YUtleSA9IG5ldyBCdWZmZXIoSlNPTi5zdHJpbmdpZnkoZGF0YUtleSkpO1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgX19zZWxlY3RvcjogJ19ycGNfYXBwbGljYXRpb25TZW50RGF0YTonLFxuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJEZXN0aW5hdGlvbktleTogdGhpcy5kZXN0aW5hdGlvbktleSxcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgICBXSVJNZXNzYWdlRGF0YUtleTogZGF0YUtleVxuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5zZW5kKGRhdGEpO1xuICB9XG5cbiAgc2V0RGF0YVJlc3BvbnNlRXJyb3IgKGVycm9yKSB7XG4gICAgdGhpcy5kYXRhUmVzcG9uc2VFcnJvciA9IGVycm9yO1xuICB9XG5cbiAgc2V0RGF0YVJlc3BvbnNlVmFsdWUgKHZhbHVlKSB7XG4gICAgdGhpcy5kYXRhUmVzcG9uc2VWYWx1ZS5wdXNoKHZhbHVlKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5zZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKChjKSA9PiB7XG4gICAgICAgIHRoaXMuY2xpZW50ID0gYztcbiAgICAgICAgYy5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZygnY2xpZW50IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgICB9KTtcbiAgICAgICAgYy5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgbGV0IHBsaXN0ID0gYnBsaXN0UGFyc2UucGFyc2VCdWZmZXIoZGF0YS5zbGljZSg0KSk7XG5cbiAgICAgICAgICBpZiAoIXBsaXN0WzBdLl9fc2VsZWN0b3IpIHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFVuYWJsZSB0byBkZWNpcGhlciBwbGlzdDogJHtwbGlzdH1gKSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgc3dpdGNoIChwbGlzdFswXS5fX3NlbGVjdG9yKSB7XG4gICAgICAgICAgICBjYXNlICdfcnBjX3JlcG9ydElkZW50aWZpZXI6JzpcbiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVSZXBvcnRJZGVudGlmaWVyKHBsaXN0WzBdKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOic6XG4gICAgICAgICAgICAgIHRoaXMuaGFuZGxlR2V0TGlzdGluZyhwbGlzdFswXSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnX3JwY19mb3J3YXJkU29ja2V0U2V0dXA6JzpcbiAgICAgICAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ19ycGNfZm9yd2FyZFNvY2tldERhdGE6JzpcbiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVTb2NrZXREYXRhKHBsaXN0WzBdKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdfcnBjX2ZvcndhcmRJbmRpY2F0ZVdlYlZpZXc6JzpcbiAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgTk9UIFlFVCBJTVBMRU1FTlRFRDogJHtwbGlzdFswXS5fX3NlbGVjdG9yfWApKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICB0aGlzLmNsaWVudC53cml0ZSgnZG8gbm90IGNvbXB1dGUnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIGRvbid0IHVzZSB0aGUgcmVhbCBwb3J0LCBvciBhbnkgb3BlbiBzaW1zIHdpbGwgYnJlYWsgdGhlIHRlc3RzXG4gICAgICB0aGlzLnNlcnZlci5saXN0ZW4oMjc3NTQsICc6OjEnLCAoKSA9PiB7XG4gICAgICAgIGxvZy5pbmZvKGBzZXJ2ZXIgYm91bmQ6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5zZXJ2ZXIuYWRkcmVzcygpKX1gKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzdG9wICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIGlmICh0aGlzLnNlcnZlcikge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQpIHtcbiAgICAgICAgICB0aGlzLmNsaWVudC5lbmQoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNlcnZlci5jbG9zZSgoZXJyKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICAgICAgcmVzb2x2ZShgU3RvcHBlZCBsaXN0ZW5pbmc6ICR7ZXJyfWApO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUoJ05vdCBsaXN0ZW5pbmcuJyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZW5kIChkYXRhKSB7XG4gICAgbGV0IGJ1ZiA9IGJwbGlzdENyZWF0ZShkYXRhKTtcbiAgICBsZXQgbGVuZ3RoID0gYnVmZmVycGFjay5wYWNrKCdMJywgW2J1Zi5sZW5ndGhdKTtcbiAgICB0aGlzLmNsaWVudC53cml0ZShCdWZmZXIuY29uY2F0KFtsZW5ndGgsIGJ1Zl0pKTtcbiAgfVxufVxuXG5leHBvcnQgeyBSZW1vdGVEZWJ1Z2dlclNlcnZlciwgQVBQX0lORk8sIERFVklDRV9JTkZPIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
