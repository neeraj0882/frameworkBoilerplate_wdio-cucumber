'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _remoteDebugger = require('./remote-debugger');

var _remoteMessages = require('./remote-messages');

var _remoteMessages2 = _interopRequireDefault(_remoteMessages);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _helpers = require('./helpers');

var DATA_LOG_LENGTH = { length: 200 };

var WebKitRpcClient = (function (_events$EventEmitter) {
  _inherits(WebKitRpcClient, _events$EventEmitter);

  function WebKitRpcClient(host) {
    var port = arguments.length <= 1 || arguments[1] === undefined ? _remoteDebugger.REMOTE_DEBUGGER_PORT : arguments[1];
    var responseTimeout = arguments.length <= 2 || arguments[2] === undefined ? _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS : arguments[2];

    _classCallCheck(this, WebKitRpcClient);

    _get(Object.getPrototypeOf(WebKitRpcClient.prototype), 'constructor', this).call(this);

    this.host = host || 'localhost';
    this.port = port;

    this.responseTimeout = responseTimeout;

    this.curMsgId = 0;

    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};

    this.setHandlers();
  }

  _createClass(WebKitRpcClient, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // we will only resolve this call when the socket is open
              // WebKit url
              var url = 'ws://' + _this.host + ':' + _this.port + '/devtools/page/' + pageId;
              _this.pageIdKey = pageId;

              // create and set up socket with appropriate event handlers
              _this.socket = new _ws2['default'](url);
              _this.socket.on('open', function () {
                _logger2['default'].debug('WebKit debugger web socket connected to url: ' + url);
                _this.connected = true;
                resolve();
              });
              _this.socket.on('close', function () {
                _logger2['default'].debug('WebKit remote debugger socket disconnected');
                _this.connected = false;
              });
              _this.socket.on('error', function (exception) {
                if (_this.connected) {
                  _logger2['default'].debug('WebKit debugger web socket error: ' + exception.message);
                  _this.connected = false;
                }

                reject(exception);
              });
              _this.socket.on('message', _this.receive.bind(_this));
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      _logger2['default'].debug('Disconnecting from WebKit remote debugger');
      if (this.isConnected()) {
        this.socket.close(1001);
      }
      this.connected = false;
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return this.socket !== null && this.connected;
    }
  }, {
    key: 'send',
    value: function send(command) {
      var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var data, id;
      return _regeneratorRuntime.async(function send$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            data = (0, _remoteMessages2['default'])(command, _lodash2['default'].defaults({ connId: this.connId, senderId: this.senderId }, opts));

            _logger2['default'].debug('Sending WebKit data: ' + _lodash2['default'].truncate(JSON.stringify(data), DATA_LOG_LENGTH)); // jshint ignore:line
            _logger2['default'].debug('Webkit response timeout: ' + this.responseTimeout);

            this.curMsgId++;
            data.id = this.curMsgId;

            id = this.curMsgId.toString();
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // only resolve the send command when WebKit returns a response
              // store the handler and the data sent
              _this2.dataHandlers[id] = resolve;
              _this2.dataMethods[id] = data.method;
              _this2.errorHandlers[id] = reject;

              // send the data
              data = JSON.stringify(data);
              _this2.socket.send(data, function (error) {
                if (!_lodash2['default'].isUndefined(error) && !_lodash2['default'].isNull(error)) {
                  _logger2['default'].debug('WebKit socket error occurred: ' + error);
                  reject(new Error(error));
                }
              });
            })['finally'](function (res) {
              // no need to hold onto anything
              delete _this2.dataHandlers[id];
              delete _this2.dataMethods[id];
              delete _this2.errorHandlers[id];

              // and pass along the result
              return res;
            }).timeout(this.responseTimeout));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'receive',
    value: function receive(data) {
      _logger2['default'].debug('Receiving WebKit data: \'' + _lodash2['default'].truncate(data, DATA_LOG_LENGTH) + '\'');

      data = JSON.parse(data);
      if (!data) {
        _logger2['default'].warn('No parseable data found');
        return;
      }

      // we can get an error, or we can get a response that is an error
      if (data.wasThrown || data.result && data.result.wasThrown) {
        var message = undefined;
        if (data.wasThrown) {
          message = data.result.value || data.result.description;
        } else {
          message = data.result.result.value || data.result.result.description;
        }
        var error = new Error(message);
        if (data.id && this.errorHandlers[data.id]) {
          this.errorHandlers[data.id](error);
          return;
        } else {
          // this should never happen, but log at least
          _logger2['default'].errorAndThrow(error);
        }
      }

      // when sending we set a data method and associated callback.
      // get that, or the generic (automatically sent, not associated
      // with a particular request) method
      var handlerFor = undefined;
      if (data.id && this.dataMethods[data.id]) {
        _logger2['default'].debug('Found handler for message \'' + data.id + '\'');
        handlerFor = this.dataMethods[data.id];
      } else {
        _logger2['default'].debug('Did not find handler for message');
        handlerFor = data.method;
      }

      if (!handlerFor) {
        _logger2['default'].debug('Received an invalid method: \'' + data.method + '\'');
        return;
      }
      if (_lodash2['default'].has(this.handlers, handlerFor)) {
        this.handlers[handlerFor](data);
      } else {
        _logger2['default'].debug('WebKit debugger got a message for \'' + handlerFor + '\' ' + 'and have no handler, doing nothing.');
      }
    }
  }, {
    key: 'setHandlers',
    value: function setHandlers() {
      var _this3 = this;

      this.handlers = {
        'Runtime.evaluate': function RuntimeEvaluate(data) {
          var msgId = data.id;
          if (data.error) {
            _this3.errorHandlers[msgId](data.error);
          }

          _this3.dataHandlers[msgId](data.result);
        },
        'Page.navigate': function PageNavigate(data) {
          _logger2['default'].debug('Received page navigated message: ' + (0, _helpers.simpleStringify)(data));
          var msgId = data.id;
          if (data.error) {
            _this3.errorHandlers[msgId](data.error);
          }

          _this3.dataHandlers[msgId](data.result);
        },
        'Profiler.resetProfiles': function ProfilerResetProfiles() {
          _logger2['default'].debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
        },
        'Timeline.eventRecorded': function TimelineEventRecorded(data) {
          if (_this3.timelineEventHandler) {
            _this3.timelineEventHandler(data.result);
          }
        },
        'Console.messageAdded': function ConsoleMessageAdded(data) {
          if (_this3.consoleEventHandler) {
            _this3.consoleEventHandler(data.params.message);
          }
        }
      };
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
    }
  }, {
    key: 'setConsoleLogEventHandler',
    value: function setConsoleLogEventHandler(consoleEventHandler) {
      this.consoleEventHandler = consoleEventHandler;
    }
  }]);

  return WebKitRpcClient;
})(_events2['default'].EventEmitter);

exports['default'] = WebKitRpcClient;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWdCLFVBQVU7Ozs7OEJBQ29DLG1CQUFtQjs7OEJBQ3BELG1CQUFtQjs7OztrQkFDMUIsSUFBSTs7Ozt3QkFDTixVQUFVOzs7O3NCQUNoQixRQUFROzs7O3NCQUNILFFBQVE7Ozs7dUJBQ0ssV0FBVzs7QUFHM0MsSUFBTSxlQUFlLEdBQUcsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLENBQUM7O0lBRWpCLGVBQWU7WUFBZixlQUFlOztBQUN0QixXQURPLGVBQWUsQ0FDckIsSUFBSSxFQUEwRTtRQUF4RSxJQUFJO1FBQXlCLGVBQWU7OzBCQUQ1QyxlQUFlOztBQUVoQywrQkFGaUIsZUFBZSw2Q0FFeEI7O0FBRVIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksV0FBVyxDQUFDO0FBQ2hDLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDOztBQUVqQixRQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQzs7QUFFdkMsUUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7O0FBRWxCLFFBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLFFBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLFFBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDOztBQUV4QixRQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7R0FDcEI7O2VBaEJrQixlQUFlOztXQWtCcEIsaUJBQUMsTUFBTTs7Ozs7O2dEQUNaLDBCQUFZLFVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBSzs7O0FBR3RDLGtCQUFJLEdBQUcsYUFBVyxNQUFLLElBQUksU0FBSSxNQUFLLElBQUksdUJBQWtCLE1BQU0sQUFBRSxDQUFDO0FBQ25FLG9CQUFLLFNBQVMsR0FBRyxNQUFNLENBQUM7OztBQUd4QixvQkFBSyxNQUFNLEdBQUcsb0JBQWMsR0FBRyxDQUFDLENB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bUJBQW1CLEdBQUcsbUJBQW1CLENBQUM7S0FDaEQ7OztTQWhNa0IsZUFBZTtHQUFTLG9CQUFPLFlBQVk7O3FCQUEzQyxlQUFlIiwiZmlsZSI6ImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgUkVNT1RFX0RFQlVHR0VSX1BPUlQsIFJQQ19SRVNQT05TRV9USU1FT1VUX01TIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IGdldFJlbW90ZUNvbW1hbmQgZnJvbSAnLi9yZW1vdGUtbWVzc2FnZXMnO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgc2ltcGxlU3RyaW5naWZ5IH0gZnJvbSAnLi9oZWxwZXJzJztcblxuXG5jb25zdCBEQVRBX0xPR19MRU5HVEggPSB7bGVuZ3RoOiAyMDB9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXZWJLaXRScGNDbGllbnQgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKGhvc3QsIHBvcnQgPSBSRU1PVEVfREVCVUdHRVJfUE9SVCwgcmVzcG9uc2VUaW1lb3V0ID0gUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5ob3N0ID0gaG9zdCB8fCAnbG9jYWxob3N0JztcbiAgICB0aGlzLnBvcnQgPSBwb3J0O1xuXG4gICAgdGhpcy5yZXNwb25zZVRpbWVvdXQgPSByZXNwb25zZVRpbWVvdXQ7XG5cbiAgICB0aGlzLmN1ck1zZ0lkID0gMDtcblxuICAgIHRoaXMuZGF0YUhhbmRsZXJzID0ge307XG4gICAgdGhpcy5kYXRhTWV0aG9kcyA9IHt9O1xuICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IHt9O1xuXG4gICAgdGhpcy5zZXRIYW5kbGVycygpO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAocGFnZUlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIHdlIHdpbGwgb25seSByZXNvbHZlIHRoaXMgY2FsbCB3aGVuIHRoZSBzb2NrZXQgaXMgb3BlblxuICAgICAgLy8gV2ViS2l0IHVybFxuICAgICAgbGV0IHVybCA9IGB3czovLyR7dGhpcy5ob3N0fToke3RoaXMucG9ydH0vZGV2dG9vbHMvcGFnZS8ke3BhZ2VJZH1gO1xuICAgICAgdGhpcy5wYWdlSWRLZXkgPSBwYWdlSWQ7XG5cbiAgICAgIC8vIGNyZWF0ZSBhbmQgc2V0IHVwIHNvY2tldCB3aXRoIGFwcHJvcHJpYXRlIGV2ZW50IGhhbmRsZXJzXG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBXZWJTb2NrZXQodXJsKTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdvcGVuJywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciB3ZWIgc29ja2V0IGNvbm5lY3RlZCB0byB1cmw6ICR7dXJsfWApO1xuICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoJ1dlYktpdCByZW1vdGUgZGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCAoZXhjZXB0aW9uKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmNvbm5lY3RlZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IGRlYnVnZ2VyIHdlYiBzb2NrZXQgZXJyb3I6ICR7ZXhjZXB0aW9uLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlamVjdChleGNlcHRpb24pO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignbWVzc2FnZScsIHRoaXMucmVjZWl2ZS5iaW5kKHRoaXMpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3QgKCkge1xuICAgIGxvZy5kZWJ1ZygnRGlzY29ubmVjdGluZyBmcm9tIFdlYktpdCByZW1vdGUgZGVidWdnZXInKTtcbiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICB0aGlzLnNvY2tldC5jbG9zZSgxMDAxKTtcbiAgICB9XG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGlzQ29ubmVjdGVkICgpIHtcbiAgICByZXR1cm4gKHRoaXMuc29ja2V0ICE9PSBudWxsICYmIHRoaXMuY29ubmVjdGVkKTtcbiAgfVxuXG5cbiAgYXN5bmMgc2VuZCAoY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gICAgbGV0IGRhdGEgPSBnZXRSZW1vdGVDb21tYW5kKGNvbW1hbmQsIF8uZGVmYXVsdHMoe2Nvbm5JZDogdGhpcy5jb25uSWQsIHNlbmRlcklkOiB0aGlzLnNlbmRlcklkfSwgb3B0cykpO1xuXG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nIFdlYktpdCBkYXRhOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZGF0YSksIERBVEFfTE9HX0xFTkdUSCl9YCk7IC8vIGpzaGludCBpZ25vcmU6bGluZVxuICAgIGxvZy5kZWJ1ZyhgV2Via2l0IHJlc3BvbnNlIHRpbWVvdXQ6ICR7dGhpcy5yZXNwb25zZVRpbWVvdXR9YCk7XG5cbiAgICB0aGlzLmN1ck1zZ0lkKys7XG4gICAgZGF0YS5pZCA9IHRoaXMuY3VyTXNnSWQ7XG5cbiAgICBsZXQgaWQgPSB0aGlzLmN1ck1zZ0lkLnRvU3RyaW5nKCk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIG9ubHkgcmVzb2x2ZSB0aGUgc2VuZCBjb21tYW5kIHdoZW4gV2ViS2l0IHJldHVybnMgYSByZXNwb25zZVxuICAgICAgLy8gc3RvcmUgdGhlIGhhbmRsZXIgYW5kIHRoZSBkYXRhIHNlbnRcbiAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW2lkXSA9IHJlc29sdmU7XG4gICAgICB0aGlzLmRhdGFNZXRob2RzW2lkXSA9IGRhdGEubWV0aG9kO1xuICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW2lkXSA9IHJlamVjdDtcblxuICAgICAgLy8gc2VuZCB0aGUgZGF0YVxuICAgICAgZGF0YSA9IEpTT04uc3RyaW5naWZ5KGRhdGEpO1xuICAgICAgdGhpcy5zb2NrZXQuc2VuZChkYXRhLCBmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGVycm9yKSAmJiAhXy5pc051bGwoZXJyb3IpKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBXZWJLaXQgc29ja2V0IGVycm9yIG9jY3VycmVkOiAke2Vycm9yfWApO1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoZXJyb3IpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSkuZmluYWxseSgocmVzKSA9PiB7XG4gICAgICAvLyBubyBuZWVkIHRvIGhvbGQgb250byBhbnl0aGluZ1xuICAgICAgZGVsZXRlIHRoaXMuZGF0YUhhbmRsZXJzW2lkXTtcbiAgICAgIGRlbGV0ZSB0aGlzLmRhdGFNZXRob2RzW2lkXTtcbiAgICAgIGRlbGV0ZSB0aGlzLmVycm9ySGFuZGxlcnNbaWRdO1xuXG4gICAgICAvLyBhbmQgcGFzcyBhbG9uZyB0aGUgcmVzdWx0XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH0pLnRpbWVvdXQodGhpcy5yZXNwb25zZVRpbWVvdXQpO1xuICB9XG5cblxuICByZWNlaXZlIChkYXRhKSB7XG4gICAgbG9nLmRlYnVnKGBSZWNlaXZpbmcgV2ViS2l0IGRhdGE6ICcke18udHJ1bmNhdGUoZGF0YSwgREFUQV9MT0dfTEVOR1RIKX0nYCk7XG5cbiAgICBkYXRhID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIGxvZy53YXJuKGBObyBwYXJzZWFibGUgZGF0YSBmb3VuZGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgYW4gZXJyb3IsIG9yIHdlIGNhbiBnZXQgYSByZXNwb25zZSB0aGF0IGlzIGFuIGVycm9yXG4gICAgaWYgKGRhdGEud2FzVGhyb3duIHx8IChkYXRhLnJlc3VsdCAmJiBkYXRhLnJlc3VsdC53YXNUaHJvd24pKSB7XG4gICAgICBsZXQgbWVzc2FnZTtcbiAgICAgIGlmIChkYXRhLndhc1Rocm93bikge1xuICAgICAgICBtZXNzYWdlID0gZGF0YS5yZXN1bHQudmFsdWUgfHwgZGF0YS5yZXN1bHQuZGVzY3JpcHRpb247XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtZXNzYWdlID0gZGF0YS5yZXN1bHQucmVzdWx0LnZhbHVlIHx8IGRhdGEucmVzdWx0LnJlc3VsdC5kZXNjcmlwdGlvbjtcbiAgICAgIH1cbiAgICAgIGxldCBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICAgIGlmIChkYXRhLmlkICYmIHRoaXMuZXJyb3JIYW5kbGVyc1tkYXRhLmlkXSkge1xuICAgICAgICB0aGlzLmVycm9ySGFuZGxlcnNbZGF0YS5pZF0oZXJyb3IpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB0aGlzIHNob3VsZCBuZXZlciBoYXBwZW4sIGJ1dCBsb2cgYXQgbGVhc3RcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coZXJyb3IpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHdoZW4gc2VuZGluZyB3ZSBzZXQgYSBkYXRhIG1ldGhvZCBhbmQgYXNzb2NpYXRlZCBjYWxsYmFjay5cbiAgICAvLyBnZXQgdGhhdCwgb3IgdGhlIGdlbmVyaWMgKGF1dG9tYXRpY2FsbHkgc2VudCwgbm90IGFzc29jaWF0ZWRcbiAgICAvLyB3aXRoIGEgcGFydGljdWxhciByZXF1ZXN0KSBtZXRob2RcbiAgICBsZXQgaGFuZGxlckZvcjtcbiAgICBpZiAoZGF0YS5pZCAmJiB0aGlzLmRhdGFNZXRob2RzW2RhdGEuaWRdKSB7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIGhhbmRsZXIgZm9yIG1lc3NhZ2UgJyR7ZGF0YS5pZH0nYCk7XG4gICAgICBoYW5kbGVyRm9yID0gdGhpcy5kYXRhTWV0aG9kc1tkYXRhLmlkXTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKGBEaWQgbm90IGZpbmQgaGFuZGxlciBmb3IgbWVzc2FnZWApO1xuICAgICAgaGFuZGxlckZvciA9IGRhdGEubWV0aG9kO1xuICAgIH1cblxuICAgIGlmICghaGFuZGxlckZvcikge1xuICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBhbiBpbnZhbGlkIG1ldGhvZDogJyR7ZGF0YS5tZXRob2R9J2ApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoXy5oYXModGhpcy5oYW5kbGVycywgaGFuZGxlckZvcikpIHtcbiAgICAgIHRoaXMuaGFuZGxlcnNbaGFuZGxlckZvcl0oZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IGRlYnVnZ2VyIGdvdCBhIG1lc3NhZ2UgZm9yICcke2hhbmRsZXJGb3J9JyBgICtcbiAgICAgICAgICAgICAgICBgYW5kIGhhdmUgbm8gaGFuZGxlciwgZG9pbmcgbm90aGluZy5gKTtcbiAgICB9XG4gIH1cblxuICBzZXRIYW5kbGVycyAoKSB7XG4gICAgdGhpcy5oYW5kbGVycyA9IHtcbiAgICAgICdSdW50aW1lLmV2YWx1YXRlJzogKGRhdGEpID0+IHtcbiAgICAgICAgbGV0IG1zZ0lkID0gZGF0YS5pZDtcbiAgICAgICAgaWYgKGRhdGEuZXJyb3IpIHtcbiAgICAgICAgICB0aGlzLmVycm9ySGFuZGxlcnNbbXNnSWRdKGRhdGEuZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdKGRhdGEucmVzdWx0KTtcbiAgICAgIH0sXG4gICAgICAnUGFnZS5uYXZpZ2F0ZSc6IChkYXRhKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcGFnZSBuYXZpZ2F0ZWQgbWVzc2FnZTogJHtzaW1wbGVTdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgICAgIGxldCBtc2dJZCA9IGRhdGEuaWQ7XG4gICAgICAgIGlmIChkYXRhLmVycm9yKSB7XG4gICAgICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShkYXRhLmVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXShkYXRhLnJlc3VsdCk7XG4gICAgICB9LFxuICAgICAgJ1Byb2ZpbGVyLnJlc2V0UHJvZmlsZXMnOiAoKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGV2aWNlIGlzIHRlbGxpbmcgdXMgdG8gcmVzZXQgcHJvZmlsZXMuIFNob3VsZCBwcm9iYWJseSAnICtcbiAgICAgICAgICAgICAgICAgICdkbyBzb21lIGtpbmQgb2YgY2FsbGJhY2sgaGVyZScpO1xuICAgICAgfSxcbiAgICAgICdUaW1lbGluZS5ldmVudFJlY29yZGVkJzogKGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICAgICAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyKGRhdGEucmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgICdDb25zb2xlLm1lc3NhZ2VBZGRlZCc6IChkYXRhKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIpIHtcbiAgICAgICAgICB0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIoZGF0YS5wYXJhbXMubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG5cbiAgc2V0VGltZWxpbmVFdmVudEhhbmRsZXIgKHRpbWVsaW5lRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy50aW1lbGluZUV2ZW50SGFuZGxlciA9IHRpbWVsaW5lRXZlbnRIYW5kbGVyO1xuICB9XG5cbiAgc2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlciAoY29uc29sZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMuY29uc29sZUV2ZW50SGFuZGxlciA9IGNvbnNvbGVFdmVudEhhbmRsZXI7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
