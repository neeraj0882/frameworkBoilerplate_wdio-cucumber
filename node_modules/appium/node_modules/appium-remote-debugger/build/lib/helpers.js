'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _atoms = require('./atoms');

var _atoms2 = _interopRequireDefault(_atoms);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var WEB_CONTENT_BUNDLE_ID = 'com.apple.WebKit.WebContent';

/*
 * Takes a dictionary from the remote debugger and makes a more manageable
 * dictionary whose keys are understandable
 */
function appInfoFromDict(dict) {
  var id = dict.WIRApplicationIdentifierKey;
  var isProxy = _lodash2['default'].isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  var entry = {
    id: id,
    isProxy: isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled: !!dict.WIRRemoteAutomationEnabledKey
  };

  return [id, entry];
}

/*
 * Take a dictionary from the remote debugger and makes a more manageable
 * dictionary of pages available.
 */
function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    // the page is already translated, so wrap in an array and pass back
    return [pageDict];
  }
  var newPageArray = [];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].values(pageDict)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dict = _step.value;

      // count only WIRTypeWeb pages and ignore all others (WIRTypeJavaScript etc)
      if (_lodash2['default'].isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
        newPageArray.push({
          id: dict.WIRPageIdentifierKey,
          title: dict.WIRTitleKey,
          url: dict.WIRURLKey,
          isKey: !_lodash2['default'].isUndefined(dict.WIRConnectionIdentifierKey)
        });
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return newPageArray;
}

/*
 * Given a bundle id, finds the correct remote debugger app that is
 * connected.
 */
function getDebuggerAppKey(bundleId, platformVersion, appDict) {
  var appId = undefined;
  if (parseFloat(platformVersion) >= 8) {
    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(appDict)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        var _step2$value = _slicedToArray(_step2.value, 2);

        var key = _step2$value[0];
        var data = _step2$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }
      // now we need to determine if we should pick a proxy for this instead
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }

    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var proxiedAppIds = [];
      var _iteratorNormalCompletion3 = true;
      var _didIteratorError3 = false;
      var _iteratorError3 = undefined;

      try {
        for (var _iterator3 = _getIterator(_lodash2['default'].toPairs(appDict)), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          var _step3$value = _slicedToArray(_step3.value, 2);

          var key = _step3$value[0];
          var data = _step3$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError3 = true;
        _iteratorError3 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion3 && _iterator3['return']) {
            _iterator3['return']();
          }
        } finally {
          if (_didIteratorError3) {
            throw _iteratorError3;
          }
        }
      }

      if (proxiedAppIds.length) {
        // use the last app being proxied
        appId = _lodash2['default'].last(proxiedAppIds);
        _logger2['default'].debug('Using proxied app id \'' + appId + '\'');
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      appId = bundleId;
    }
  }

  return appId;
}

function appIdForBundle(_x2, _x3) {
  var _again = true;

  _function: while (_again) {
    var bundleId = _x2,
        appDict = _x3;
    _again = false;

    var appId = undefined;
    var _iteratorNormalCompletion4 = true;
    var _didIteratorError4 = false;
    var _iteratorError4 = undefined;

    try {
      for (var _iterator4 = _getIterator(_lodash2['default'].toPairs(appDict)), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
        var _step4$value = _slicedToArray(_step4.value, 2);

        var key = _step4$value[0];
        var data = _step4$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }

      // if nothing is found, try to get the generic app
    } catch (err) {
      _didIteratorError4 = true;
      _iteratorError4 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }
      } finally {
        if (_didIteratorError4) {
          throw _iteratorError4;
        }
      }
    }

    if (!appId && bundleId !== WEB_CONTENT_BUNDLE_ID) {
      _x2 = WEB_CONTENT_BUNDLE_ID;
      _x3 = appDict;
      _again = true;
      appId = _iteratorNormalCompletion4 = _didIteratorError4 = _iteratorError4 = undefined;
      continue _function;
    }

    return appId;
  }
}

function getPossibleDebuggerAppKeys(bundleId, platformVersion, appDict) {
  var proxiedAppIds = [];
  if (parseFloat(platformVersion) >= 8) {
    var appId = appIdForBundle(bundleId, appDict);

    // now we need to determine if we should pick a proxy for this instead
    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var _iteratorNormalCompletion5 = true;
      var _didIteratorError5 = false;
      var _iteratorError5 = undefined;

      try {
        for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(appDict)), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
          var _step5$value = _slicedToArray(_step5.value, 2);

          var key = _step5$value[0];
          var data = _step5$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError5 = true;
        _iteratorError5 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion5 && _iterator5['return']) {
            _iterator5['return']();
          }
        } finally {
          if (_didIteratorError5) {
            throw _iteratorError5;
          }
        }
      }

      if (proxiedAppIds.length === 0) {
        proxiedAppIds = [appId];
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      proxiedAppIds = [bundleId];
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  var errors = [];
  var _iteratorNormalCompletion6 = true;
  var _didIteratorError6 = false;
  var _iteratorError6 = undefined;

  try {
    for (var _iterator6 = _getIterator(_lodash2['default'].toPairs(params)), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {
      var _step6$value = _slicedToArray(_step6.value, 2);

      var param = _step6$value[0];
      var value = _step6$value[1];

      try {
        _assert2['default'].ok(value);
      } catch (err) {
        errors.push(param);
      }
    }
  } catch (err) {
    _didIteratorError6 = true;
    _iteratorError6 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion6 && _iterator6['return']) {
        _iterator6['return']();
      }
    } finally {
      if (_didIteratorError6) {
        throw _iteratorError6;
      }
    }
  }

  if (errors.length) {
    return errors;
  }
}

function wrapScriptForFrame(script, frame) {
  var elFromCache;
  return _regeneratorRuntime.async(function wrapScriptForFrame$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Wrapping script for frame \'' + frame + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _atoms2['default'])('get_element_from_cache'));

      case 3:
        elFromCache = context$1$0.sent;
        return context$1$0.abrupt('return', '(function (window) { var document = window.document; ' + ('return (' + script + '); })((' + elFromCache.toString('utf8') + ')(' + JSON.stringify(frame) + '))'));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getScriptForAtom(atom, args, frames) {
  var asyncCallBack = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

  var atomSrc, script, _iteratorNormalCompletion7, _didIteratorError7, _iteratorError7, _iterator7, _step7, frame;

  return _regeneratorRuntime.async(function getScriptForAtom$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _atoms2['default'])(atom));

      case 2:
        atomSrc = context$1$0.sent;
        script = undefined;

        if (!(frames.length > 0)) {
          context$1$0.next = 35;
          break;
        }

        script = atomSrc;
        _iteratorNormalCompletion7 = true;
        _didIteratorError7 = false;
        _iteratorError7 = undefined;
        context$1$0.prev = 9;
        _iterator7 = _getIterator(frames);

      case 11:
        if (_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done) {
          context$1$0.next = 19;
          break;
        }

        frame = _step7.value;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(wrapScriptForFrame(script, frame));

      case 15:
        script = context$1$0.sent;

      case 16:
        _iteratorNormalCompletion7 = true;
        context$1$0.next = 11;
        break;

      case 19:
        context$1$0.next = 25;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError7 = true;
        _iteratorError7 = context$1$0.t0;

      case 25:
        context$1$0.prev = 25;
        context$1$0.prev = 26;

        if (!_iteratorNormalCompletion7 && _iterator7['return']) {
          _iterator7['return']();
        }

      case 28:
        context$1$0.prev = 28;

        if (!_didIteratorError7) {
          context$1$0.next = 31;
          break;
        }

        throw _iteratorError7;

      case 31:
        return context$1$0.finish(28);

      case 32:
        return context$1$0.finish(25);

      case 33:
        context$1$0.next = 37;
        break;

      case 35:
        _logger2['default'].debug('Executing \'' + atom + '\' atom in default context');
        script = '(' + atomSrc + ')';

      case 37:

        // add the arguments, as strings
        args = args.map(JSON.stringify);
        if (asyncCallBack) {
          script += '(' + args.join(',') + ', ' + asyncCallBack + ', true )';
        } else {
          script += '(' + args.join(',') + ')';
        }

        return context$1$0.abrupt('return', script);

      case 40:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 21, 25, 33], [26,, 28, 32]]);
}

function simpleStringify(value) {
  if (!value) {
    return JSON.stringify(value);
  }

  // we get back objects sometimes with string versions of functions
  // which muddy the logs
  var cleanValue = _lodash2['default'].clone(value);
  var _arr = ['ceil', 'clone', 'floor', 'round', 'scale', 'toString'];
  for (var _i = 0; _i < _arr.length; _i++) {
    var property = _arr[_i];
    delete cleanValue[property];
  }
  return JSON.stringify(cleanValue);
}

function deferredPromise() {
  // http://bluebirdjs.com/docs/api/deferred-migration.html
  var resolve = undefined;
  var reject = undefined;
  var promise = new _bluebird2['default'](function (res, rej) {
    // eslint-disable-line promise/param-names
    resolve = res;
    reject = rej;
  });
  return {
    promise: promise,
    resolve: resolve,
    reject: reject
  };
}

exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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aGVscGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGdldEF0b20gZnJvbSAnLi9hdG9tcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGFzc2VydCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmNvbnN0IFdFQl9DT05URU5UX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUuV2ViS2l0LldlYkNvbnRlbnQnO1xuXG4vKlxuICogVGFrZXMgYSBkaWN0aW9uYXJ5IGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlciBhbmQgbWFrZXMgYSBtb3JlIG1hbmFnZWFibGVcbiAqIGRpY3Rpb25hcnkgd2hvc2Uga2V5cyBhcmUgdW5kZXJzdGFuZGFibGVcbiAqL1xuZnVuY3Rpb24gYXBwSW5mb0Zyb21EaWN0IChkaWN0KSB7XG4gIGxldCBpZCA9IGRpY3QuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICBsZXQgaXNQcm94eSA9IF8uaXNTdHJpbmcoZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkpID9cbiAgICAgICAgICAgICAgICAgIGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5LnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJyA6IGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5O1xuICBsZXQgZW50cnkgPSB7XG4gICAgaWQsXG4gICAgaXNQcm94eSxcbiAgICBuYW1lOiBkaWN0LldJUkFwcGxpY2F0aW9uTmFtZUtleSxcbiAgICBidW5kbGVJZDogZGljdC5XSVJBcHBsaWNhdGlvbkJ1bmRsZUlkZW50aWZpZXJLZXksXG4gICAgaG9zdElkOiBkaWN0LldJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXksXG4gICAgaXNBY3RpdmU6IGRpY3QuV0lSSXNBcHBsaWNhdGlvbkFjdGl2ZUtleSxcbiAgICBpc0F1dG9tYXRpb25FbmFibGVkOiAhIWRpY3QuV0lSUmVtb3RlQXV0b21hdGlvbkVuYWJsZWRLZXksXG4gIH07XG5cbiAgcmV0dXJuIFtpZCwgZW50cnldO1xufVxuXG4vKlxuICogVGFrZSBhIGRpY3Rpb25hcnkgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyIGFuZCBtYWtlcyBhIG1vcmUgbWFuYWdlYWJsZVxuICogZGljdGlvbmFyeSBvZiBwYWdlcyBhdmFpbGFibGUuXG4gKi9cbmZ1bmN0aW9uIHBhZ2VBcnJheUZyb21EaWN0IChwYWdlRGljdCkge1xuICBpZiAocGFnZURpY3QuaWQpIHtcbiAgICAvLyB0aGUgcGFnZSBpcyBhbHJlYWR5IHRyYW5zbGF0ZWQsIHNvIHdyYXAgaW4gYW4gYXJyYXkgYW5kIHBhc3MgYmFja1xuICAgIHJldHVybiBbcGFnZURpY3RdO1xuICB9XG4gIGxldCBuZXdQYWdlQXJyYXkgPSBbXTtcbiAgZm9yIChsZXQgZGljdCBvZiBfLnZhbHVlcyhwYWdlRGljdCkpIHtcbiAgICAvLyBjb3VudCBvbmx5IFdJUlR5cGVXZWIgcGFnZXMgYW5kIGlnbm9yZSBhbGwgb3RoZXJzIChXSVJUeXBlSmF2YVNjcmlwdCBldGMpXG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZGljdC5XSVJUeXBlS2V5KSB8fCBkaWN0LldJUlR5cGVLZXkgPT09ICdXSVJUeXBlV2ViJykge1xuICAgICAgbmV3UGFnZUFycmF5LnB1c2goe1xuICAgICAgICBpZDogZGljdC5XSVJQYWdlSWRlbnRpZmllcktleSxcbiAgICAgICAgdGl0bGU6IGRpY3QuV0lSVGl0bGVLZXksXG4gICAgICAgIHVybDogZGljdC5XSVJVUkxLZXksXG4gICAgICAgIGlzS2V5OiAhXy5pc1VuZGVmaW5lZChkaWN0LldJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5KSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gbmV3UGFnZUFycmF5O1xufVxuXG4vKlxuICogR2l2ZW4gYSBidW5kbGUgaWQsIGZpbmRzIHRoZSBjb3JyZWN0IHJlbW90ZSBkZWJ1Z2dlciBhcHAgdGhhdCBpc1xuICogY29ubmVjdGVkLlxuICovXG5mdW5jdGlvbiBnZXREZWJ1Z2dlckFwcEtleSAoYnVuZGxlSWQsIHBsYXRmb3JtVmVyc2lvbiwgYXBwRGljdCkge1xuICBsZXQgYXBwSWQ7XG4gIGlmIChwYXJzZUZsb2F0KHBsYXRmb3JtVmVyc2lvbikgPj0gOCkge1xuICAgIGZvciAobGV0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgaWYgKGRhdGEuYnVuZGxlSWQgPT09IGJ1bmRsZUlkKSB7XG4gICAgICAgIGFwcElkID0ga2V5O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICAgIGlmIChhcHBJZCkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuICAgICAgZm9yIChsZXQgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgICAgIGlmIChkYXRhLmlzUHJveHkgJiYgZGF0YS5ob3N0SWQgPT09IGFwcElkKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBGb3VuZCBzZXBhcmF0ZSBidW5kbGVJZCAnJHtkYXRhLmJ1bmRsZUlkfScgYCArXG4gICAgICAgICAgICAgICAgICAgIGBhY3RpbmcgYXMgcHJveHkgZm9yICcke2J1bmRsZUlkfScsIHdpdGggYXBwIGlkICcke2tleX0nYCk7XG4gICAgICAgICAgcHJveGllZEFwcElkcy5wdXNoKGtleSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChwcm94aWVkQXBwSWRzLmxlbmd0aCkge1xuICAgICAgICAvLyB1c2UgdGhlIGxhc3QgYXBwIGJlaW5nIHByb3hpZWRcbiAgICAgICAgYXBwSWQgPSBfLmxhc3QocHJveGllZEFwcElkcyk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVXNpbmcgcHJveGllZCBhcHAgaWQgJyR7YXBwSWR9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoXy5oYXMoYXBwRGljdCwgYnVuZGxlSWQpKSB7XG4gICAgICBhcHBJZCA9IGJ1bmRsZUlkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBhcHBJZDtcbn1cblxuZnVuY3Rpb24gYXBwSWRGb3JCdW5kbGUgKGJ1bmRsZUlkLCBhcHBEaWN0KSB7XG4gIGxldCBhcHBJZDtcbiAgZm9yIChsZXQgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgaWYgKGRhdGEuYnVuZGxlSWQgPT09IGJ1bmRsZUlkKSB7XG4gICAgICBhcHBJZCA9IGtleTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIC8vIGlmIG5vdGhpbmcgaXMgZm91bmQsIHRyeSB0byBnZXQgdGhlIGdlbmVyaWMgYXBwXG4gIGlmICghYXBwSWQgJiYgYnVuZGxlSWQgIT09IFdFQl9DT05URU5UX0JVTkRMRV9JRCkge1xuICAgIHJldHVybiBhcHBJZEZvckJ1bmRsZShXRUJfQ09OVEVOVF9CVU5ETEVfSUQsIGFwcERpY3QpO1xuICB9XG5cbiAgcmV0dXJuIGFwcElkO1xufVxuXG5mdW5jdGlvbiBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyAoYnVuZGxlSWQsIHBsYXRmb3JtVmVyc2lvbiwgYXBwRGljdCkge1xuICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuICBpZiAocGFyc2VGbG9hdChwbGF0Zm9ybVZlcnNpb24pID49IDgpIHtcbiAgICBsZXQgYXBwSWQgPSBhcHBJZEZvckJ1bmRsZShidW5kbGVJZCwgYXBwRGljdCk7XG5cbiAgICAvLyBub3cgd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIHBpY2sgYSBwcm94eSBmb3IgdGhpcyBpbnN0ZWFkXG4gICAgaWYgKGFwcElkKSB7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIGFwcCBpZCBrZXkgJyR7YXBwSWR9JyBmb3IgYnVuZGxlICcke2J1bmRsZUlkfSdgKTtcbiAgICAgIGZvciAobGV0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgICBpZiAoZGF0YS5pc1Byb3h5ICYmIGRhdGEuaG9zdElkID09PSBhcHBJZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgc2VwYXJhdGUgYnVuZGxlSWQgJyR7ZGF0YS5idW5kbGVJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgYWN0aW5nIGFzIHByb3h5IGZvciAnJHtidW5kbGVJZH0nLCB3aXRoIGFwcCBpZCAnJHtrZXl9J2ApO1xuICAgICAgICAgIHByb3hpZWRBcHBJZHMucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAocHJveGllZEFwcElkcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcHJveGllZEFwcElkcyA9IFthcHBJZF07XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChfLmhhcyhhcHBEaWN0LCBidW5kbGVJZCkpIHtcbiAgICAgIHByb3hpZWRBcHBJZHMgPSBbYnVuZGxlSWRdO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwcm94aWVkQXBwSWRzO1xufVxuXG5mdW5jdGlvbiBjaGVja1BhcmFtcyAocGFyYW1zKSB7XG4gIGxldCBlcnJvcnMgPSBbXTtcbiAgZm9yIChsZXQgW3BhcmFtLCB2YWx1ZV0gb2YgXy50b1BhaXJzKHBhcmFtcykpIHtcbiAgICB0cnkge1xuICAgICAgYXNzZXJ0Lm9rKHZhbHVlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGVycm9ycy5wdXNoKHBhcmFtKTtcbiAgICB9XG4gIH1cbiAgaWYgKGVycm9ycy5sZW5ndGgpIHtcbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdyYXBTY3JpcHRGb3JGcmFtZSAoc2NyaXB0LCBmcmFtZSkge1xuICBsb2cuZGVidWcoYFdyYXBwaW5nIHNjcmlwdCBmb3IgZnJhbWUgJyR7ZnJhbWV9J2ApO1xuICBsZXQgZWxGcm9tQ2FjaGUgPSBhd2FpdCBnZXRBdG9tKCdnZXRfZWxlbWVudF9mcm9tX2NhY2hlJyk7XG4gIHJldHVybiBgKGZ1bmN0aW9uICh3aW5kb3cpIHsgdmFyIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50OyBgICtcbiAgICAgICAgIGByZXR1cm4gKCR7c2NyaXB0fSk7IH0pKCgke2VsRnJvbUNhY2hlLnRvU3RyaW5nKCd1dGY4Jyl9KSgke0pTT04uc3RyaW5naWZ5KGZyYW1lKX0pKWA7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNjcmlwdEZvckF0b20gKGF0b20sIGFyZ3MsIGZyYW1lcywgYXN5bmNDYWxsQmFjayA9IG51bGwpIHtcbiAgbGV0IGF0b21TcmMgPSBhd2FpdCBnZXRBdG9tKGF0b20pO1xuICBsZXQgc2NyaXB0O1xuICBpZiAoZnJhbWVzLmxlbmd0aCA+IDApIHtcbiAgICBzY3JpcHQgPSBhdG9tU3JjO1xuICAgIGZvciAobGV0IGZyYW1lIG9mIGZyYW1lcykge1xuICAgICAgc2NyaXB0ID0gYXdhaXQgd3JhcFNjcmlwdEZvckZyYW1lKHNjcmlwdCwgZnJhbWUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2cuZGVidWcoYEV4ZWN1dGluZyAnJHthdG9tfScgYXRvbSBpbiBkZWZhdWx0IGNvbnRleHRgKTtcbiAgICBzY3JpcHQgPSBgKCR7YXRvbVNyY30pYDtcbiAgfVxuXG4gIC8vIGFkZCB0aGUgYXJndW1lbnRzLCBhcyBzdHJpbmdzXG4gIGFyZ3MgPSBhcmdzLm1hcChKU09OLnN0cmluZ2lmeSk7XG4gIGlmIChhc3luY0NhbGxCYWNrKSB7XG4gICAgc2NyaXB0ICs9IGAoJHthcmdzLmpvaW4oJywnKX0sICR7YXN5bmNDYWxsQmFja30sIHRydWUgKWA7XG4gIH0gZWxzZSB7XG4gICAgc2NyaXB0ICs9IGAoJHthcmdzLmpvaW4oJywnKX0pYDtcbiAgfVxuXG4gIHJldHVybiBzY3JpcHQ7XG59XG5cbmZ1bmN0aW9uIHNpbXBsZVN0cmluZ2lmeSAodmFsdWUpIHtcbiAgaWYgKCF2YWx1ZSkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gIH1cblxuICAvLyB3ZSBnZXQgYmFjayBvYmplY3RzIHNvbWV0aW1lcyB3aXRoIHN0cmluZyB2ZXJzaW9ucyBvZiBmdW5jdGlvbnNcbiAgLy8gd2hpY2ggbXVkZHkgdGhlIGxvZ3NcbiAgbGV0IGNsZWFuVmFsdWUgPSBfLmNsb25lKHZhbHVlKTtcbiAgZm9yIChsZXQgcHJvcGVydHkgb2YgWydjZWlsJywgJ2Nsb25lJywgJ2Zsb29yJywgJ3JvdW5kJywgJ3NjYWxlJywgJ3RvU3RyaW5nJ10pIHtcbiAgICBkZWxldGUgY2xlYW5WYWx1ZVtwcm9wZXJ0eV07XG4gIH1cbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNsZWFuVmFsdWUpO1xufVxuXG5mdW5jdGlvbiBkZWZlcnJlZFByb21pc2UgKCkge1xuICAvLyBodHRwOi8vYmx1ZWJpcmRqcy5jb20vZG9jcy9hcGkvZGVmZXJyZWQtbWlncmF0aW9uLmh0bWxcbiAgbGV0IHJlc29sdmU7XG4gIGxldCByZWplY3Q7XG4gIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlcywgcmVqKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wYXJhbS1uYW1lc1xuICAgIHJlc29sdmUgPSByZXM7XG4gICAgcmVqZWN0ID0gcmVqO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBwcm9taXNlLFxuICAgIHJlc29sdmUsXG4gICAgcmVqZWN0XG4gIH07XG59XG5cbmV4cG9ydCB7IGFwcEluZm9Gcm9tRGljdCwgcGFnZUFycmF5RnJvbURpY3QsIGdldERlYnVnZ2VyQXBwS2V5LCBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cywgY2hlY2tQYXJhbXMsXG4gICAgICAgICB3cmFwU2NyaXB0Rm9yRnJhbWUsIGdldFNjcmlwdEZvckF0b20sIHNpbXBsZVN0cmluZ2lmeSwgZGVmZXJyZWRQcm9taXNlIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
