require('source-map-support').install();

'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumBaseDriver = require('appium-base-driver');

var _remoteDebugger = require('./remote-debugger');

var _webkitRpcClient = require('./webkit-rpc-client');

var _webkitRpcClient2 = _interopRequireDefault(_webkitRpcClient);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _helpers = require('./helpers');

var WebKitRemoteDebugger = (function (_RemoteDebugger) {
  _inherits(WebKitRemoteDebugger, _RemoteDebugger);

  function WebKitRemoteDebugger() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, WebKitRemoteDebugger);

    // make sure there is a host
    opts = _Object$assign({
      host: 'localhost'
    }, opts);
    _get(Object.getPrototypeOf(WebKitRemoteDebugger.prototype), 'constructor', this).call(this, _lodash2['default'].defaults({ debuggerType: _remoteDebugger.DEBUGGER_TYPES.webkit }, opts));

    this.webkitResponseTimeout = opts.webkitResponseTimeout || _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS;

    // used to store callback types when sending requests
    this.dataMethods = {};
  }

  _createClass(WebKitRemoteDebugger, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.rpcClient = new _webkitRpcClient2['default'](this.host, this.port, this.webkitResponseTimeout);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.connect(pageId));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      if (this.rpcClient && this.rpcClient.isConnected()) {
        this.rpcClient.disconnect();
      }
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return !!(this.rpcClient && this.rpcClient.isConnected());
    }
  }, {
    key: 'pageArrayFromJson',
    value: function pageArrayFromJson() {
      var ignoreAboutBlankUrl = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
      var pageElementJSON, devices, newPageArray;
      return _regeneratorRuntime.async(function pageArrayFromJson$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Getting WebKitRemoteDebugger pageArray: ' + this.host + ', ' + this.port);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getJsonFromUrl(this.host, this.port, '/json'));

          case 3:
            pageElementJSON = context$2$0.sent;

            if (!(pageElementJSON[0] && pageElementJSON[0].deviceId)) {
              context$2$0.next = 13;
              break;
            }

            _logger2['default'].debug('Device JSON: ' + (0, _helpers.simpleStringify)(pageElementJSON));

            devices = pageElementJSON.filter(function (device) {
              return device.deviceId !== 'SIMULATOR';
            });

            if (devices.length > 1) {
              _logger2['default'].debug('Connected to ' + devices.length + ' devices. ' + ('Choosing the first, with udid \'' + devices[0].deviceId + '\'.'));
            }
            this.port = devices[0].url.split(':')[1];
            _logger2['default'].debug('Received notification that ios-webkit-debug-proxy is listening on port \'' + this.port + '\'');

            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.getJsonFromUrl(this.host, this.port, '/json'));

          case 12:
            pageElementJSON = context$2$0.sent;

          case 13:
            _logger2['default'].debug('Page element JSON: ' + (0, _helpers.simpleStringify)(pageElementJSON));

            // Add elements to an array
            newPageArray = pageElementJSON.filter(function (pageObject) {
              return pageObject.url && (!ignoreAboutBlankUrl || pageObject.url !== 'about:blank');
            }).map(function (pageObject) {
              var urlArray = pageObject.webSocketDebuggerUrl.split('/').reverse();
              var id = urlArray[0];
              return {
                id: id,
                title: pageObject.title,
                url: pageObject.url,
                isKey: !!id
              };
            });
            return context$2$0.abrupt('return', newPageArray);

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getJsonFromUrl',
    value: function getJsonFromUrl(hostname, port, pathname) {
      var uri;
      return _regeneratorRuntime.async(function getJsonFromUrl$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            uri = _url2['default'].format({
              protocol: 'http',
              hostname: hostname,
              port: port,
              pathname: pathname
            });

            _logger2['default'].debug('Sending request to: ' + uri);
            context$2$0.t0 = JSON;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _requestPromise2['default'])({ uri: uri, method: 'GET' }));

          case 5:
            context$2$0.t1 = context$2$0.sent;
            return context$2$0.abrupt('return', context$2$0.t0.parse.call(context$2$0.t0, context$2$0.t1));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'convertResult',
    value: function convertResult(res) {
      // WebKit returns a result wrapped deeper than the Remote Debugger:
      //   {
      //     result: {
      //       type: "string",
      //       value: {
      //         status: 0,
      //         value: {
      //           ELEMENT: ":wdc:1441819740060"
      //         }
      //       }
      //     },
      //     wasThrown: false
      //   }

      // check for errors
      if (res && res.wasThrown) {
        // we got some form of error.
        var message = res.result.value || res.result;
        throw new _appiumBaseDriver.errors.JavaScriptError(message);
      }

      if (res && res.result && res.result.type === 'undefined') {
        // if it doesn't throw an error, we just want to put in a
        // place holder. this happens when we have an async execute request
        res.result.value = {};
      }

      // send the actual result to the Remote Debugger converter
      return _get(Object.getPrototypeOf(WebKitRemoteDebugger.prototype), 'convertResult', this).call(this, res && res.result ? res.result.value : res);
    }
  }]);

  return WebKitRemoteDebugger;
})(_remoteDebugger.RemoteDebugger);

exports['default'] = WebKitRemoteDebugger;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcmVtb3RlLWRlYnVnZ2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBRWdCLFVBQVU7Ozs7Z0NBQ0gsb0JBQW9COzs4QkFDNkIsbUJBQW1COzsrQkFDL0QscUJBQXFCOzs7O3NCQUNuQyxRQUFROzs7O21CQUNOLEtBQUs7Ozs7OEJBQ0QsaUJBQWlCOzs7O3VCQUNMLFdBQVc7O0lBR3RCLG9CQUFvQjtZQUFwQixvQkFBb0I7O0FBQzNCLFdBRE8sb0JBQW9CLEdBQ2Y7UUFBWCxJQUFJLHlEQUFHLEVBQUU7OzBCQURILG9CQUFvQjs7O0FBR3JDLFFBQUksR0FBRyxlQUFjO0FBQ25CLFVBQUksRUFBRSxXQUFXO0tBQ2xCLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDVCwrQkFOaUIsb0JBQW9CLDZDQU0vQixvQkFBRSxRQUFRLENBQUMsRUFBQyxZQUFZLEVBQUUsK0JBQWUsTUFBTSxFQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUU7O0FBRS9ELFFBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUMscUJBQXFCLDJDQUEyQixDQUFDOzs7QUFHbkYsUUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7R0FDdkI7O2VBWmtCLG9CQUFvQjs7V0FjekIsaUJBQUMsTUFBTTs7OztBQUNuQixnQkFBSSxDQUFDLFNBQVMsR0FBRyxpQ0FBb0IsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDOzs2Q0FDakYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDOzs7Ozs7O0tBQ3JDOzs7V0FFVSxzQkFBRztBQUNaLFVBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxFQUFFO0FBQ2xELFlBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLENBQUM7T0FDN0I7S0FDRjs7O1dB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QUcsRUFBRTs7Ozs7Ozs7Ozs7Ozs7OztBQWdCbEIsVUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLFNBQVMsRUFBRTs7QUFFeEIsWUFBSSxPQUFPLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQztBQUM3QyxjQUFNLElBQUkseUJBQU8sZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO09BQzNDOztBQUVELFVBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFOzs7QUFHeEQsV0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO09BQ3ZCOzs7QUFHRCx3Q0F4R2lCLG9CQUFvQiwrQ0F3R1YsR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsR0FBRyxFQUFFO0tBQ3hFOzs7U0F6R2tCLG9CQUFvQjs7O3FCQUFwQixvQkFBb0IiLCJmaWxlIjoibGliL3dlYmtpdC1yZW1vdGUtZGVidWdnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bWFpblxuXG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBSZW1vdGVEZWJ1Z2dlciwgREVCVUdHRVJfVFlQRVMsIFJQQ19SRVNQT05TRV9USU1FT1VUX01TIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IFdlYktpdFJwY0NsaWVudCBmcm9tICcuL3dlYmtpdC1ycGMtY2xpZW50JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgc2ltcGxlU3RyaW5naWZ5IH0gZnJvbSAnLi9oZWxwZXJzJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXZWJLaXRSZW1vdGVEZWJ1Z2dlciBleHRlbmRzIFJlbW90ZURlYnVnZ2VyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIC8vIG1ha2Ugc3VyZSB0aGVyZSBpcyBhIGhvc3RcbiAgICBvcHRzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICB9LCBvcHRzKTtcbiAgICBzdXBlcihfLmRlZmF1bHRzKHtkZWJ1Z2dlclR5cGU6IERFQlVHR0VSX1RZUEVTLndlYmtpdH0sIG9wdHMpKTtcblxuICAgIHRoaXMud2Via2l0UmVzcG9uc2VUaW1lb3V0ID0gb3B0cy53ZWJraXRSZXNwb25zZVRpbWVvdXQgfHwgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVM7XG5cbiAgICAvLyB1c2VkIHRvIHN0b3JlIGNhbGxiYWNrIHR5cGVzIHdoZW4gc2VuZGluZyByZXF1ZXN0c1xuICAgIHRoaXMuZGF0YU1ldGhvZHMgPSB7fTtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QgKHBhZ2VJZCkge1xuICAgIHRoaXMucnBjQ2xpZW50ID0gbmV3IFdlYktpdFJwY0NsaWVudCh0aGlzLmhvc3QsIHRoaXMucG9ydCwgdGhpcy53ZWJraXRSZXNwb25zZVRpbWVvdXQpO1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LmNvbm5lY3QocGFnZUlkKTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3QgKCkge1xuICAgIGlmICh0aGlzLnJwY0NsaWVudCAmJiB0aGlzLnJwY0NsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICB0aGlzLnJwY0NsaWVudC5kaXNjb25uZWN0KCk7XG4gICAgfVxuICB9XG5cbiAgaXNDb25uZWN0ZWQgKCkge1xuICAgIHJldHVybiAhISh0aGlzLnJwY0NsaWVudCAmJiB0aGlzLnJwY0NsaWVudC5pc0Nvbm5lY3RlZCgpKTtcbiAgfVxuXG4gIGFzeW5jIHBhZ2VBcnJheUZyb21Kc29uIChpZ25vcmVBYm91dEJsYW5rVXJsID0gZmFsc2UpIHtcbiAgICBsb2cuZGVidWcoYEdldHRpbmcgV2ViS2l0UmVtb3RlRGVidWdnZXIgcGFnZUFycmF5OiAke3RoaXMuaG9zdH0sICR7dGhpcy5wb3J0fWApO1xuICAgIGxldCBwYWdlRWxlbWVudEpTT04gPSBhd2FpdCB0aGlzLmdldEpzb25Gcm9tVXJsKHRoaXMuaG9zdCwgdGhpcy5wb3J0LCAnL2pzb24nKTtcbiAgICBpZiAocGFnZUVsZW1lbnRKU09OWzBdICYmIHBhZ2VFbGVtZW50SlNPTlswXS5kZXZpY2VJZCkge1xuICAgICAgbG9nLmRlYnVnKGBEZXZpY2UgSlNPTjogJHtzaW1wbGVTdHJpbmdpZnkocGFnZUVsZW1lbnRKU09OKX1gKTtcblxuICAgICAgbGV0IGRldmljZXMgPSBwYWdlRWxlbWVudEpTT04uZmlsdGVyKChkZXZpY2UpID0+IGRldmljZS5kZXZpY2VJZCAhPT0gJ1NJTVVMQVRPUicpO1xuICAgICAgaWYgKGRldmljZXMubGVuZ3RoID4gMSkge1xuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RlZCB0byAke2RldmljZXMubGVuZ3RofSBkZXZpY2VzLiBgICtcbiAgICAgICAgICAgICAgICAgIGBDaG9vc2luZyB0aGUgZmlyc3QsIHdpdGggdWRpZCAnJHtkZXZpY2VzWzBdLmRldmljZUlkfScuYCk7XG4gICAgICB9XG4gICAgICB0aGlzLnBvcnQgPSBkZXZpY2VzWzBdLnVybC5zcGxpdCgnOicpWzFdO1xuICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBub3RpZmljYXRpb24gdGhhdCBpb3Mtd2Via2l0LWRlYnVnLXByb3h5IGlzIGxpc3RlbmluZyBvbiBwb3J0ICcke3RoaXMucG9ydH0nYCk7XG5cbiAgICAgIHBhZ2VFbGVtZW50SlNPTiA9IGF3YWl0IHRoaXMuZ2V0SnNvbkZyb21VcmwodGhpcy5ob3N0LCB0aGlzLnBvcnQsICcvanNvbicpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFBhZ2UgZWxlbWVudCBKU09OOiAke3NpbXBsZVN0cmluZ2lmeShwYWdlRWxlbWVudEpTT04pfWApO1xuXG4gICAgLy8gQWRkIGVsZW1lbnRzIHRvIGFuIGFycmF5XG4gICAgbGV0IG5ld1BhZ2VBcnJheSA9IHBhZ2VFbGVtZW50SlNPTi5maWx0ZXIoKHBhZ2VPYmplY3QpID0+IHtcbiAgICAgIHJldHVybiBwYWdlT2JqZWN0LnVybCAmJiAoIWlnbm9yZUFib3V0QmxhbmtVcmwgfHwgcGFnZU9iamVjdC51cmwgIT09ICdhYm91dDpibGFuaycpO1xuICAgIH0pLm1hcCgocGFnZU9iamVjdCkgPT4ge1xuICAgICAgbGV0IHVybEFycmF5ID0gcGFnZU9iamVjdC53ZWJTb2NrZXREZWJ1Z2dlclVybC5zcGxpdCgnLycpLnJldmVyc2UoKTtcbiAgICAgIGxldCBpZCA9IHVybEFycmF5WzBdO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQsXG4gICAgICAgIHRpdGxlOiBwYWdlT2JqZWN0LnRpdGxlLFxuICAgICAgICB1cmw6IHBhZ2VPYmplY3QudXJsLFxuICAgICAgICBpc0tleTogISFpZCxcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3UGFnZUFycmF5O1xuICB9XG5cbiAgYXN5bmMgZ2V0SnNvbkZyb21VcmwgKGhvc3RuYW1lLCBwb3J0LCBwYXRobmFtZSkge1xuICAgIGxldCB1cmkgPSB1cmwuZm9ybWF0KHtcbiAgICAgIHByb3RvY29sOiAnaHR0cCcsXG4gICAgICBob3N0bmFtZSxcbiAgICAgIHBvcnQsXG4gICAgICBwYXRobmFtZVxuICAgIH0pO1xuICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyByZXF1ZXN0IHRvOiAke3VyaX1gKTtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShhd2FpdCByZXF1ZXN0KHt1cmksIG1ldGhvZDogJ0dFVCd9KSk7XG4gIH1cblxuICBjb252ZXJ0UmVzdWx0IChyZXMpIHtcbiAgICAvLyBXZWJLaXQgcmV0dXJucyBhIHJlc3VsdCB3cmFwcGVkIGRlZXBlciB0aGFuIHRoZSBSZW1vdGUgRGVidWdnZXI6XG4gICAgLy8gICB7XG4gICAgLy8gICAgIHJlc3VsdDoge1xuICAgIC8vICAgICAgIHR5cGU6IFwic3RyaW5nXCIsXG4gICAgLy8gICAgICAgdmFsdWU6IHtcbiAgICAvLyAgICAgICAgIHN0YXR1czogMCxcbiAgICAvLyAgICAgICAgIHZhbHVlOiB7XG4gICAgLy8gICAgICAgICAgIEVMRU1FTlQ6IFwiOndkYzoxNDQxODE5NzQwMDYwXCJcbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgICB9XG4gICAgLy8gICAgIH0sXG4gICAgLy8gICAgIHdhc1Rocm93bjogZmFsc2VcbiAgICAvLyAgIH1cblxuICAgIC8vIGNoZWNrIGZvciBlcnJvcnNcbiAgICBpZiAocmVzICYmIHJlcy53YXNUaHJvd24pIHtcbiAgICAgIC8vIHdlIGdvdCBzb21lIGZvcm0gb2YgZXJyb3IuXG4gICAgICBsZXQgbWVzc2FnZSA9IHJlcy5yZXN1bHQudmFsdWUgfHwgcmVzLnJlc3VsdDtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSmF2YVNjcmlwdEVycm9yKG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmIChyZXMgJiYgcmVzLnJlc3VsdCAmJiByZXMucmVzdWx0LnR5cGUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAvLyBpZiBpdCBkb2Vzbid0IHRocm93IGFuIGVycm9yLCB3ZSBqdXN0IHdhbnQgdG8gcHV0IGluIGFcbiAgICAgIC8vIHBsYWNlIGhvbGRlci4gdGhpcyBoYXBwZW5zIHdoZW4gd2UgaGF2ZSBhbiBhc3luYyBleGVjdXRlIHJlcXVlc3RcbiAgICAgIHJlcy5yZXN1bHQudmFsdWUgPSB7fTtcbiAgICB9XG5cbiAgICAvLyBzZW5kIHRoZSBhY3R1YWwgcmVzdWx0IHRvIHRoZSBSZW1vdGUgRGVidWdnZXIgY29udmVydGVyXG4gICAgcmV0dXJuIHN1cGVyLmNvbnZlcnRSZXN1bHQocmVzICYmIHJlcy5yZXN1bHQgPyByZXMucmVzdWx0LnZhbHVlIDogcmVzKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
