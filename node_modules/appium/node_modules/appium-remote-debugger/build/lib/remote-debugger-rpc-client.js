// jshint ignore: start
'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bplistCreator = require('bplist-creator');

var _bplistCreator2 = _interopRequireDefault(_bplistCreator);

var _bplistParser = require('bplist-parser');

var _bplistParser2 = _interopRequireDefault(_bplistParser);

var _bufferpack = require('bufferpack');

var _bufferpack2 = _interopRequireDefault(_bufferpack);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _remoteDebugger = require('./remote-debugger');

var _uuid = require('uuid');

var _uuid2 = _interopRequireDefault(_uuid);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _remoteDebuggerMessageHandler = require('./remote-debugger-message-handler');

var _remoteDebuggerMessageHandler2 = _interopRequireDefault(_remoteDebuggerMessageHandler);

var _remoteMessages = require('./remote-messages');

var _remoteMessages2 = _interopRequireDefault(_remoteMessages);

var _helpers = require('./helpers');

var RemoteDebuggerRpcClient = (function () {
  function RemoteDebuggerRpcClient() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, RemoteDebuggerRpcClient);

    var _opts$host = opts.host;
    var host = _opts$host === undefined ? '::1' : _opts$host;
    var _opts$port = opts.port;
    var port = _opts$port === undefined ? _remoteDebugger.REMOTE_DEBUGGER_PORT : _opts$port;
    var socketPath = opts.socketPath;
    var _opts$specialMessageHandlers = opts.specialMessageHandlers;
    var specialMessageHandlers = _opts$specialMessageHandlers === undefined ? {} : _opts$specialMessageHandlers;

    // host/port config for TCP communication, socketPath for unix domain sockets
    this.host = host;
    this.port = port;
    this.socketPath = socketPath;

    this.socket = null;
    this.connected = false;
    this.connId = _uuid2['default'].v4();
    this.senderId = _uuid2['default'].v4();
    this.curMsgId = 0;
    this.received = new Buffer(0);
    this.readPos = 0;

    // message handlers
    this.specialMessageHandlers = specialMessageHandlers;
    this.messageHandler = null;
  }

  _createClass(RemoteDebuggerRpcClient, [{
    key: 'connect',
    value: function connect() {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.messageHandler = new _remoteDebuggerMessageHandler2['default'](this.specialMessageHandlers);

            // create socket and handle its messages
            if (this.socketPath) {
              // unix domain socket
              _logger2['default'].debug('Connecting to remote debugger through unix domain socket: \'' + this.socketPath + '\'');
              this.socket = _net2['default'].connect(this.socketPath);
            } else {
              // tcp socket
              _logger2['default'].debug('Connecting to remote debugger through TCP: ' + this.host + ':' + this.port);
              this.socket = new _net2['default'].Socket({ type: 'tcp6' });
              this.socket.connect(this.port, this.host);
            }

            this.socket.setNoDelay(true);
            this.socket.on('close', function () {
              if (_this.connected) {
                _logger2['default'].debug('Debugger socket disconnected');
              }
              _this.connected = false;
              _this.socket = null;
            });
            this.socket.on('end', function () {
              _this.connected = false;
            });
            this.socket.on('data', this.receive.bind(this));

            // connect the socket
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              // only resolve this function when we are actually connected
              _this.socket.on('connect', function callee$3$0() {
                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      _logger2['default'].debug('Debugger socket connected');
                      this.connected = true;

                      resolve();

                    case 3:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this);
              });
              _this.socket.on('error', function (err) {
                if (_this.connected) {
                  _logger2['default'].error('Socket error: ' + err.message);
                  _this.connected = false;
                }

                // the connection was refused, so reject the connect promise
                reject(err);
              });
            }));

          case 8:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      return _regeneratorRuntime.async(function disconnect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.isConnected()) {
              _logger2['default'].debug('Disconnecting from remote debugger');
              this.socket.destroy();
            }
            this.connected = false;

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return this.connected;
    }
  }, {
    key: 'setSpecialMessageHandler',
    value: function setSpecialMessageHandler(key, errorHandler, handler) {
      this.messageHandler.setSpecialMessageHandler(key, errorHandler, handler);
    }
  }, {
    key: 'getSpecialMessageHandler',
    value: function getSpecialMessageHandler(key) {
      return this.messageHandler.getSpecialMessageHandler(key);
    }
  }, {
    key: 'setDataMessageHandler',
    value: function setDataMessageHandler(key, errorHandler, handler) {
      this.messageHandler.setDataMessageHandler(key, errorHandler, handler);
    }
  }, {
    key: 'allowNavigationWithoutReload',
    value: function allowNavigationWithoutReload() {
      var allow = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

      this.messageHandler.allowNavigationWithoutReload(allow);
    }
  }, {
    key: 'selectApp',
    value: function selectApp(appIdKey, applicationConnectedHandler) {
      return _regeneratorRuntime.async(function selectApp$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              // local callback, temporarily added as callback to
              // `_rpc_applicationConnected:` remote debugger response
              // to handle the initial connection
              var onAppChange = function onAppChange(dict) {
                var oldAppIdKey, correctAppIdKey;
                return _regeneratorRuntime.async(function onAppChange$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      oldAppIdKey = dict.WIRHostApplicationIdentifierKey;
                      correctAppIdKey = dict.WIRApplicationIdentifierKey;

                      // if this is a report of a proxy redirect from the remote debugger
                      // we want to update our dictionary and get a new app id
                      if (oldAppIdKey && correctAppIdKey !== oldAppIdKey) {
                        _logger2['default'].debug('We were notified we might have connected to the wrong app. ' + ('Using id ' + correctAppIdKey + ' instead of ' + oldAppIdKey));
                      }

                      applicationConnectedHandler(dict);
                      reject('New application has connected');

                    case 5:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this2);
              };
              _this2.setSpecialMessageHandler('_rpc_applicationConnected:', reject, onAppChange);

              // do the actual connecting to the app
              return (function callee$3$0() {
                var _ref, _ref2, connectedAppIdKey, pageDict, msg;

                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      context$4$0.next = 2;
                      return _regeneratorRuntime.awrap(this.send('connectToApp', {
                        appIdKey: appIdKey
                      }));

                    case 2:
                      _ref = context$4$0.sent;
                      _ref2 = _slicedToArray(_ref, 2);
                      connectedAppIdKey = _ref2[0];
                      pageDict = _ref2[1];

                      // sometimes the connect logic happens, but with an empty dictionary
                      // which leads to the remote debugger getting disconnected, and into a loop
                      if (_lodash2['default'].isEmpty(pageDict)) {
                        msg = 'Empty page dictionary received';

                        _logger2['default'].debug(msg);
                        reject(new Error(msg));
                      } else {
                        resolve([connectedAppIdKey, pageDict]);
                      }

                    case 7:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this2);
              })();
            })['finally'](function () {
              // no matter what, we want to restore the handler that was changed.
              _this2.setSpecialMessageHandler('_rpc_applicationConnected:', null, applicationConnectedHandler);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'send',
    value: function send(command) {
      var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var onSocketError;
      return _regeneratorRuntime.async(function send$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            onSocketError = undefined;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              // promise to be resolved whenever remote debugger
              // replies to our request

              // retrieve the correct command to send
              opts = _lodash2['default'].defaults({ connId: _this3.connId, senderId: _this3.senderId }, opts);
              var data = (0, _remoteMessages2['default'])(command, opts);

              // most of the time we don't care when socket.write does
              // so give it an empty function
              var socketCb = _lodash2['default'].noop;

              // handle socket problems
              onSocketError = function (exception) {
                if (_this3.connected) {
                  _logger2['default'].error('Socket error: ' + exception.message);
                }

                // the connection was refused, so reject the connect promise
                reject(exception);
              };
              _this3.socket.on('error', onSocketError);
              if (_this3.messageHandler.hasSpecialMessageHandler(data.__selector)) {
                (function () {
                  // special replies will return any number of arguments
                  // temporarily wrap with promise handling
                  var specialMessageHandler = _this3.getSpecialMessageHandler(data.__selector);
                  _this3.setSpecialMessageHandler(data.__selector, reject, (function () {
                    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
                      args[_key] = arguments[_key];
                    }

                    _logger2['default'].debug('Received response from socket send: \'' + _lodash2['default'].truncate(JSON.stringify(args), { length: 50 }) + '\'');

                    // call the original listener, and put it back, if necessary
                    specialMessageHandler.apply(undefined, args);
                    if (this.messageHandler.hasSpecialMessageHandler(data.__selector)) {
                      // this means that the system has not removed this listener
                      this.setSpecialMessageHandler(data.__selector, null, specialMessageHandler);
                    }

                    resolve(args);
                  }).bind(_this3));
                })();
              } else if (data.__argument && data.__argument.WIRSocketDataKey) {
                // keep track of the messages coming and going using
                // a simple sequential id
                _this3.curMsgId++;
                _this3.setDataMessageHandler(_this3.curMsgId.toString(), reject, function (value) {
                  var msg = _lodash2['default'].truncate(_lodash2['default'].isString(value) ? value : JSON.stringify(value), { length: 50 });
                  _logger2['default'].debug('Received data response from socket send: \'' + msg + '\'');
                  _logger2['default'].debug('Original command: ' + command);
                  resolve(value);
                });
                data.__argument.WIRSocketDataKey.id = _this3.curMsgId;
                data.__argument.WIRSocketDataKey = new Buffer(JSON.stringify(data.__argument.WIRSocketDataKey));
              } else {
                // we want to immediately resolve this socket.write
                // any long term callbacks will do their business in the background
                socketCb = resolve;
              }

              _logger2['default'].debug('Sending \'' + data.__selector + '\' message to remote debugger');

              // remote debugger expects a binary plist as data
              var plist = undefined;
              try {
                plist = (0, _bplistCreator2['default'])(data);
              } catch (e) {
                var msg = 'Could not create binary plist from data: ' + e.message;
                _logger2['default'].error(msg);
                return reject(new Error(msg));
              }

              if (_this3.socket && _this3.connected) {
                // cork and uncork in order to not buffer the write
                // on some systems this is necessary or the server
                // gets confused.
                _this3.socket.cork();
                _this3.socket.write(_bufferpack2['default'].pack('L', [plist.length]));
                _this3.socket.write(plist, socketCb);
                _this3.socket.uncork();
              } else {
                var msg = 'Attempted to write data to socket after it was closed!';
                _logger2['default'].error(msg);
                reject(new Error(msg));
              }
            })['finally'](function () {
              // remove this listener, so we don't exhaust the system
              _this3.socket.removeListener('error', onSocketError);
            }));

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'receive',
    value: function receive(data) {
      // Append this new data to the existing Buffer
      this.received = Buffer.concat([this.received, data]);
      var dataLeftOver = true;

      // Parse multiple messages in the same packet
      while (dataLeftOver) {
        // Store a reference to where we were
        var oldReadPos = this.readPos;

        // Read the prefix (plist length) to see how far to read next
        // It's always 4 bytes long
        var prefix = this.received.slice(this.readPos, this.readPos + 4);

        var msgLength = undefined;
        try {
          msgLength = _bufferpack2['default'].unpack('L', prefix)[0];
        } catch (e) {
          _logger2['default'].error('Buffer could not unpack: ' + e);
          return;
        }

        // Jump forward 4 bytes
        this.readPos += 4;

        // Is there enough data here?
        // If not, jump back to our original position and gtfo
        if (this.received.length < msgLength + this.readPos) {
          this.readPos = oldReadPos;
          break;
        }

        // Extract the main body of the message (where the plist should be)
        var body = this.received.slice(this.readPos, msgLength + this.readPos);

        // Extract the plist
        var plist = undefined;
        try {
          plist = _bplistParser2['default'].parseBuffer(body);
        } catch (e) {
          _logger2['default'].error('Error parsing binary plist: ' + e);
          return;
        }

        // bplistParse.parseBuffer returns an array
        if (plist.length === 1) {
          plist = plist[0];
        }

        var _arr = ['WIRMessageDataKey', 'WIRDestinationKey', 'WIRSocketDataKey'];
        for (var _i = 0; _i < _arr.length; _i++) {
          var key = _arr[_i];
          if (!_lodash2['default'].isUndefined(plist[key])) {
            plist[key] = plist[key].toString("utf8");
          }
        }

        if (plist.__selector === "_rpc_applicationSentData:") {
          _logger2['default'].debug('Received applicationSentData response');
        } else {
          _logger2['default'].debug('Receiving data from remote debugger: \'' + (0, _helpers.simpleStringify)(plist) + '\'');
        }

        // Jump forward the length of the plist
        this.readPos += msgLength;

        // Calculate how much buffer is left
        var leftOver = this.received.length - this.readPos;

        // Is there some left over?
        if (leftOver !== 0) {
          // Copy what's left over into a new buffer, and save it for next time
          var chunk = new Buffer(leftOver);
          this.received.copy(chunk, 0, this.readPos);
          this.received = chunk;
        } else {
          // Otherwise, empty the buffer and get out of the loop
          this.received = new Buffer(0);
          dataLeftOver = false;
        }

        // Reset the read position
        this.readPos = 0;

        // Now do something with the plist
        if (plist) {
          this.messageHandler.handleMessage(plist);
        }
      }
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
      this.messageHandler.setTimelineEventHandler(timelineEventHandler);
    }
  }, {
    key: 'setConsoleLogEventHandler',
    value: function setConsoleLogEventHandler(consoleEventHandler) {
      this.consoleEventHandler = consoleEventHandler;
      this.messageHandler.setConsoleLogEventHandler(consoleEventHandler);
    }
  }, {
    key: 'setNetworkLogEventHandler',
    value: function setNetworkLogEventHandler(networkEventHandler) {
      this.networkEventHandler = networkEventHandler;
      this.messageHandler.setNetworkEventHandler(networkEventHandler);
    }
  }]);

  return RemoteDebuggerRpcClient;
})();

exports['default'] = RemoteDebuggerRpcClient;
module.exports = exports['default'];

// from the dictionary returned, get the ids

// error listener, which needs to be removed after the promise is resolved
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztzQkFDZ0IsVUFBVTs7OztzQkFDWixRQUFROzs7OzZCQUNHLGdCQUFnQjs7Ozs0QkFDakIsZUFBZTs7OzswQkFDaEIsWUFBWTs7Ozt3QkFDZixVQUFVOzs7OzhCQUNPLG1CQUFtQjs7b0JBQ3ZDLE1BQU07Ozs7bUJBQ1AsS0FBSzs7Ozs0Q0FDUyxtQ0FBbUM7Ozs7OEJBQ3BDLG1CQUFtQjs7Ozt1QkFDaEIsV0FBVzs7SUFHdEIsdUJBQXVCO0FBQzlCLFdBRE8sdUJBQXVCLEdBQ2xCO1FBQVgsSUFBSSx5REFBRyxFQUFFOzswQkFESCx1QkFBdUI7O3FCQU9wQyxJQUFJLENBSk4sSUFBSTtRQUFKLElBQUksOEJBQUcsS0FBSztxQkFJVixJQUFJLENBSE4sSUFBSTtRQUFKLElBQUk7UUFDSixVQUFVLEdBRVIsSUFBSSxDQUZOLFVBQVU7dUNBRVIsSUFBSSxDQUROLHNCQUFzQjtRQUF0QixzQkFBc0IsZ0RBQUcsRUFBRTs7O0FBSTdCLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLFFBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDOztBQUU3QixRQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztBQUNuQixRQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztBQUN2QixRQUFJLENBQUMsTUFBTSxHQUFHLGtCQUFLLEVBQUUsRUFBRSxDQUFDO0FBQ3hCLFFBQUksQ0FBQyxRQUFRLEdBQUcsa0JBQUssRUFBRSxFQUFFLENBQUM7QUFDMUIsUUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFDbEIsUUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixRQUFJLENBQUMsT0FBTyxHQUFHLENB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QUF2Qix1QkFBdUIiLCJmaWxlIjoibGliL3JlbW90ZS1kZWJ1Z2dlci1ycGMtY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8ganNoaW50IGlnbm9yZTogc3RhcnRcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBicGxpc3RDcmVhdGUgZnJvbSAnYnBsaXN0LWNyZWF0b3InO1xuaW1wb3J0IGJwbGlzdFBhcnNlIGZyb20gJ2JwbGlzdC1wYXJzZXInO1xuaW1wb3J0IGJ1ZmZlcnBhY2sgZnJvbSAnYnVmZmVycGFjayc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBSRU1PVEVfREVCVUdHRVJfUE9SVCB9IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCB1dWlkIGZyb20gJ3V1aWQnO1xuaW1wb3J0IG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IFJwY01lc3NhZ2VIYW5kbGVyIGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyLW1lc3NhZ2UtaGFuZGxlcic7XG5pbXBvcnQgZ2V0UmVtb3RlQ29tbWFuZCBmcm9tICcuL3JlbW90ZS1tZXNzYWdlcyc7XG5pbXBvcnQgeyBzaW1wbGVTdHJpbmdpZnkgfSBmcm9tICcuL2hlbHBlcnMnO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlbW90ZURlYnVnZ2VyUnBjQ2xpZW50IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHtcbiAgICAgIGhvc3QgPSAnOjoxJyxcbiAgICAgIHBvcnQgPSBSRU1PVEVfREVCVUdHRVJfUE9SVCxcbiAgICAgIHNvY2tldFBhdGgsXG4gICAgICBzcGVjaWFsTWVzc2FnZUhhbmRsZXJzID0ge30sXG4gICAgfSA9IG9wdHM7XG5cbiAgICAvLyBob3N0L3BvcnQgY29uZmlnIGZvciBUQ1AgY29tbXVuaWNhdGlvbiwgc29ja2V0UGF0aCBmb3IgdW5peCBkb21haW4gc29ja2V0c1xuICAgIHRoaXMuaG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcbiAgICB0aGlzLnNvY2tldFBhdGggPSBzb2NrZXRQYXRoO1xuXG4gICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgdGhpcy5jb25uSWQgPSB1dWlkLnY0KCk7XG4gICAgdGhpcy5zZW5kZXJJZCA9IHV1aWQudjQoKTtcbiAgICB0aGlzLmN1ck1zZ0lkID0gMDtcbiAgICB0aGlzLnJlY2VpdmVkID0gbmV3IEJ1ZmZlcigwKTtcbiAgICB0aGlzLnJlYWRQb3MgPSAwO1xuXG4gICAgLy8gbWVzc2FnZSBoYW5kbGVyc1xuICAgIHRoaXMuc3BlY2lhbE1lc3NhZ2VIYW5kbGVycyA9IHNwZWNpYWxNZXNzYWdlSGFuZGxlcnM7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlciA9IG51bGw7XG4gIH1cblxuICBhc3luYyBjb25uZWN0ICgpIHtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyID0gbmV3IFJwY01lc3NhZ2VIYW5kbGVyKHRoaXMuc3BlY2lhbE1lc3NhZ2VIYW5kbGVycyk7XG5cbiAgICAvLyBjcmVhdGUgc29ja2V0IGFuZCBoYW5kbGUgaXRzIG1lc3NhZ2VzXG4gICAgaWYgKHRoaXMuc29ja2V0UGF0aCkge1xuICAgICAgLy8gdW5peCBkb21haW4gc29ja2V0XG4gICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHRocm91Z2ggdW5peCBkb21haW4gc29ja2V0OiAnJHt0aGlzLnNvY2tldFBhdGh9J2ApO1xuICAgICAgdGhpcy5zb2NrZXQgPSBuZXQuY29ubmVjdCh0aGlzLnNvY2tldFBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyB0Y3Agc29ja2V0XG4gICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHRocm91Z2ggVENQOiAke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9YCk7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KHt0eXBlOiAndGNwNid9KTtcbiAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QodGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xuICAgIH1cblxuICAgIHRoaXMuc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XG4gICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc29ja2V0ID0gbnVsbDtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIHRoaXMucmVjZWl2ZS5iaW5kKHRoaXMpKTtcblxuICAgIC8vIGNvbm5lY3QgdGhlIHNvY2tldFxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBvbmx5IHJlc29sdmUgdGhpcyBmdW5jdGlvbiB3aGVuIHdlIGFyZSBhY3R1YWxseSBjb25uZWN0ZWRcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdjb25uZWN0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYERlYnVnZ2VyIHNvY2tldCBjb25uZWN0ZWRgKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYFNvY2tldCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gdGhlIGNvbm5lY3Rpb24gd2FzIHJlZnVzZWQsIHNvIHJlamVjdCB0aGUgY29ubmVjdCBwcm9taXNlXG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkaXNjb25uZWN0ICgpIHtcbiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICBsb2cuZGVidWcoJ0Rpc2Nvbm5lY3RpbmcgZnJvbSByZW1vdGUgZGVidWdnZXInKTtcbiAgICAgIHRoaXMuc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGlzQ29ubmVjdGVkICgpIHtcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0ZWQ7XG4gIH1cblxuICBzZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIgKGtleSwgZXJyb3JIYW5kbGVyLCBoYW5kbGVyKSB7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpO1xuICB9XG5cbiAgZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5nZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoa2V5KTtcbiAgfVxuXG4gIHNldERhdGFNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldERhdGFNZXNzYWdlSGFuZGxlcihrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcik7XG4gIH1cblxuICBhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIChhbGxvdyA9IHRydWUpIHtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQoYWxsb3cpO1xuICB9XG5cbiAgYXN5bmMgc2VsZWN0QXBwIChhcHBJZEtleSwgYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyKSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIGxvY2FsIGNhbGxiYWNrLCB0ZW1wb3JhcmlseSBhZGRlZCBhcyBjYWxsYmFjayB0b1xuICAgICAgLy8gYF9ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6YCByZW1vdGUgZGVidWdnZXIgcmVzcG9uc2VcbiAgICAgIC8vIHRvIGhhbmRsZSB0aGUgaW5pdGlhbCBjb25uZWN0aW9uXG4gICAgICBsZXQgb25BcHBDaGFuZ2UgPSBhc3luYyAoZGljdCkgPT4ge1xuICAgICAgICAvLyBmcm9tIHRoZSBkaWN0aW9uYXJ5IHJldHVybmVkLCBnZXQgdGhlIGlkc1xuICAgICAgICBsZXQgb2xkQXBwSWRLZXkgPSBkaWN0LldJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gICAgICAgIGxldCBjb3JyZWN0QXBwSWRLZXkgPSBkaWN0LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcblxuICAgICAgICAvLyBpZiB0aGlzIGlzIGEgcmVwb3J0IG9mIGEgcHJveHkgcmVkaXJlY3QgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICAgIC8vIHdlIHdhbnQgdG8gdXBkYXRlIG91ciBkaWN0aW9uYXJ5IGFuZCBnZXQgYSBuZXcgYXBwIGlkXG4gICAgICAgIGlmIChvbGRBcHBJZEtleSAmJiBjb3JyZWN0QXBwSWRLZXkgIT09IG9sZEFwcElkS2V5KSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBXZSB3ZXJlIG5vdGlmaWVkIHdlIG1pZ2h0IGhhdmUgY29ubmVjdGVkIHRvIHRoZSB3cm9uZyBhcHAuIGAgK1xuICAgICAgICAgICAgICAgICAgICBgVXNpbmcgaWQgJHtjb3JyZWN0QXBwSWRLZXl9IGluc3RlYWQgb2YgJHtvbGRBcHBJZEtleX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFwcGxpY2F0aW9uQ29ubmVjdGVkSGFuZGxlcihkaWN0KTtcbiAgICAgICAgcmVqZWN0KCdOZXcgYXBwbGljYXRpb24gaGFzIGNvbm5lY3RlZCcpO1xuICAgICAgfTtcbiAgICAgIHRoaXMuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsIHJlamVjdCwgb25BcHBDaGFuZ2UpO1xuXG4gICAgICAvLyBkbyB0aGUgYWN0dWFsIGNvbm5lY3RpbmcgdG8gdGhlIGFwcFxuICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBbY29ubmVjdGVkQXBwSWRLZXksIHBhZ2VEaWN0XSA9IGF3YWl0IHRoaXMuc2VuZCgnY29ubmVjdFRvQXBwJywge1xuICAgICAgICAgIGFwcElkS2V5XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIHNvbWV0aW1lcyB0aGUgY29ubmVjdCBsb2dpYyBoYXBwZW5zLCBidXQgd2l0aCBhbiBlbXB0eSBkaWN0aW9uYXJ5XG4gICAgICAgIC8vIHdoaWNoIGxlYWRzIHRvIHRoZSByZW1vdGUgZGVidWdnZXIgZ2V0dGluZyBkaXNjb25uZWN0ZWQsIGFuZCBpbnRvIGEgbG9vcFxuICAgICAgICBpZiAoXy5pc0VtcHR5KHBhZ2VEaWN0KSkge1xuICAgICAgICAgIGxldCBtc2cgPSAnRW1wdHkgcGFnZSBkaWN0aW9uYXJ5IHJlY2VpdmVkJztcbiAgICAgICAgICBsb2cuZGVidWcobXNnKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc29sdmUoW2Nvbm5lY3RlZEFwcElkS2V5LCBwYWdlRGljdF0pO1xuICAgICAgICB9XG4gICAgICB9KSgpO1xuICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgLy8gbm8gbWF0dGVyIHdoYXQsIHdlIHdhbnQgdG8gcmVzdG9yZSB0aGUgaGFuZGxlciB0aGF0IHdhcyBjaGFuZ2VkLlxuICAgICAgdGhpcy5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JywgbnVsbCwgYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmQgKGNvbW1hbmQsIG9wdHMgPSB7fSkge1xuICAgIC8vIGVycm9yIGxpc3RlbmVyLCB3aGljaCBuZWVkcyB0byBiZSByZW1vdmVkIGFmdGVyIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkXG4gICAgbGV0IG9uU29ja2V0RXJyb3I7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gcHJvbWlzZSB0byBiZSByZXNvbHZlZCB3aGVuZXZlciByZW1vdGUgZGVidWdnZXJcbiAgICAgIC8vIHJlcGxpZXMgdG8gb3VyIHJlcXVlc3RcblxuICAgICAgLy8gcmV0cmlldmUgdGhlIGNvcnJlY3QgY29tbWFuZCB0byBzZW5kXG4gICAgICBvcHRzID0gXy5kZWZhdWx0cyh7Y29ubklkOiB0aGlzLmNvbm5JZCwgc2VuZGVySWQ6IHRoaXMuc2VuZGVySWR9LCBvcHRzKTtcbiAgICAgIGxldCBkYXRhID0gZ2V0UmVtb3RlQ29tbWFuZChjb21tYW5kLCBvcHRzKTtcblxuICAgICAgLy8gbW9zdCBvZiB0aGUgdGltZSB3ZSBkb24ndCBjYXJlIHdoZW4gc29ja2V0LndyaXRlIGRvZXNcbiAgICAgIC8vIHNvIGdpdmUgaXQgYW4gZW1wdHkgZnVuY3Rpb25cbiAgICAgIGxldCBzb2NrZXRDYiA9IF8ubm9vcDtcblxuICAgICAgLy8gaGFuZGxlIHNvY2tldCBwcm9ibGVtc1xuICAgICAgb25Tb2NrZXRFcnJvciA9IChleGNlcHRpb24pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBTb2NrZXQgZXJyb3I6ICR7ZXhjZXB0aW9uLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB0aGUgY29ubmVjdGlvbiB3YXMgcmVmdXNlZCwgc28gcmVqZWN0IHRoZSBjb25uZWN0IHByb21pc2VcbiAgICAgICAgcmVqZWN0KGV4Y2VwdGlvbik7XG4gICAgICB9O1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG4gICAgICBpZiAodGhpcy5tZXNzYWdlSGFuZGxlci5oYXNTcGVjaWFsTWVzc2FnZUhhbmRsZXIoZGF0YS5fX3NlbGVjdG9yKSkge1xuICAgICAgICAvLyBzcGVjaWFsIHJlcGxpZXMgd2lsbCByZXR1cm4gYW55IG51bWJlciBvZiBhcmd1bWVudHNcbiAgICAgICAgLy8gdGVtcG9yYXJpbHkgd3JhcCB3aXRoIHByb21pc2UgaGFuZGxpbmdcbiAgICAgICAgbGV0IHNwZWNpYWxNZXNzYWdlSGFuZGxlciA9IHRoaXMuZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGRhdGEuX19zZWxlY3Rvcik7XG4gICAgICAgIHRoaXMuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGRhdGEuX19zZWxlY3RvciwgcmVqZWN0LCBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcmVzcG9uc2UgZnJvbSBzb2NrZXQgc2VuZDogJyR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShhcmdzKSwge2xlbmd0aDogNTB9KX0nYCk7XG5cbiAgICAgICAgICAvLyBjYWxsIHRoZSBvcmlnaW5hbCBsaXN0ZW5lciwgYW5kIHB1dCBpdCBiYWNrLCBpZiBuZWNlc3NhcnlcbiAgICAgICAgICBzcGVjaWFsTWVzc2FnZUhhbmRsZXIoLi4uYXJncyk7XG4gICAgICAgICAgaWYgKHRoaXMubWVzc2FnZUhhbmRsZXIuaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGRhdGEuX19zZWxlY3RvcikpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgbWVhbnMgdGhhdCB0aGUgc3lzdGVtIGhhcyBub3QgcmVtb3ZlZCB0aGlzIGxpc3RlbmVyXG4gICAgICAgICAgICB0aGlzLnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcihkYXRhLl9fc2VsZWN0b3IsIG51bGwsIHNwZWNpYWxNZXNzYWdlSGFuZGxlcik7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmVzb2x2ZShhcmdzKTtcbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICAgIH0gZWxzZSBpZiAoZGF0YS5fX2FyZ3VtZW50ICYmIGRhdGEuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5KSB7XG4gICAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhlIG1lc3NhZ2VzIGNvbWluZyBhbmQgZ29pbmcgdXNpbmdcbiAgICAgICAgLy8gYSBzaW1wbGUgc2VxdWVudGlhbCBpZFxuICAgICAgICB0aGlzLmN1ck1zZ0lkKys7XG4gICAgICAgIHRoaXMuc2V0RGF0YU1lc3NhZ2VIYW5kbGVyKHRoaXMuY3VyTXNnSWQudG9TdHJpbmcoKSwgcmVqZWN0LCAodmFsdWUpID0+IHtcbiAgICAgICAgICBsZXQgbXNnID0gXy50cnVuY2F0ZShfLmlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpLCB7bGVuZ3RoOiA1MH0pO1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgZGF0YSByZXNwb25zZSBmcm9tIHNvY2tldCBzZW5kOiAnJHttc2d9J2ApO1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgT3JpZ2luYWwgY29tbWFuZDogJHtjb21tYW5kfWApO1xuICAgICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgZGF0YS5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkuaWQgPSB0aGlzLmN1ck1zZ0lkO1xuICAgICAgICBkYXRhLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleSA9XG4gICAgICAgICAgICBuZXcgQnVmZmVyKEpTT04uc3RyaW5naWZ5KGRhdGEuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB3ZSB3YW50IHRvIGltbWVkaWF0ZWx5IHJlc29sdmUgdGhpcyBzb2NrZXQud3JpdGVcbiAgICAgICAgLy8gYW55IGxvbmcgdGVybSBjYWxsYmFja3Mgd2lsbCBkbyB0aGVpciBidXNpbmVzcyBpbiB0aGUgYmFja2dyb3VuZFxuICAgICAgICBzb2NrZXRDYiA9IHJlc29sdmU7XG4gICAgICB9XG5cbiAgICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyAnJHtkYXRhLl9fc2VsZWN0b3J9JyBtZXNzYWdlIHRvIHJlbW90ZSBkZWJ1Z2dlcmApO1xuXG4gICAgICAvLyByZW1vdGUgZGVidWdnZXIgZXhwZWN0cyBhIGJpbmFyeSBwbGlzdCBhcyBkYXRhXG4gICAgICBsZXQgcGxpc3Q7XG4gICAgICB0cnkge1xuICAgICAgICBwbGlzdCA9IGJwbGlzdENyZWF0ZShkYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbGV0IG1zZyA9IGBDb3VsZCBub3QgY3JlYXRlIGJpbmFyeSBwbGlzdCBmcm9tIGRhdGE6ICR7ZS5tZXNzYWdlfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuc29ja2V0ICYmIHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgIC8vIGNvcmsgYW5kIHVuY29yayBpbiBvcmRlciB0byBub3QgYnVmZmVyIHRoZSB3cml0ZVxuICAgICAgICAvLyBvbiBzb21lIHN5c3RlbXMgdGhpcyBpcyBuZWNlc3Nhcnkgb3IgdGhlIHNlcnZlclxuICAgICAgICAvLyBnZXRzIGNvbmZ1c2VkLlxuICAgICAgICB0aGlzLnNvY2tldC5jb3JrKCk7XG4gICAgICAgIHRoaXMuc29ja2V0LndyaXRlKGJ1ZmZlcnBhY2sucGFjaygnTCcsIFtwbGlzdC5sZW5ndGhdKSk7XG4gICAgICAgIHRoaXMuc29ja2V0LndyaXRlKHBsaXN0LCBzb2NrZXRDYik7XG4gICAgICAgIHRoaXMuc29ja2V0LnVuY29yaygpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IG1zZyA9ICdBdHRlbXB0ZWQgdG8gd3JpdGUgZGF0YSB0byBzb2NrZXQgYWZ0ZXIgaXQgd2FzIGNsb3NlZCEnO1xuICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgIC8vIHJlbW92ZSB0aGlzIGxpc3RlbmVyLCBzbyB3ZSBkb24ndCBleGhhdXN0IHRoZSBzeXN0ZW1cbiAgICAgIHRoaXMuc29ja2V0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uU29ja2V0RXJyb3IpO1xuICAgIH0pO1xuICB9XG5cbiAgcmVjZWl2ZSAoZGF0YSkge1xuICAgIC8vIEFwcGVuZCB0aGlzIG5ldyBkYXRhIHRvIHRoZSBleGlzdGluZyBCdWZmZXJcbiAgICB0aGlzLnJlY2VpdmVkID0gQnVmZmVyLmNvbmNhdChbdGhpcy5yZWNlaXZlZCwgZGF0YV0pO1xuICAgIGxldCBkYXRhTGVmdE92ZXIgPSB0cnVlO1xuXG4gICAgLy8gUGFyc2UgbXVsdGlwbGUgbWVzc2FnZXMgaW4gdGhlIHNhbWUgcGFja2V0XG4gICAgd2hpbGUgKGRhdGFMZWZ0T3Zlcikge1xuICAgICAgLy8gU3RvcmUgYSByZWZlcmVuY2UgdG8gd2hlcmUgd2Ugd2VyZVxuICAgICAgbGV0IG9sZFJlYWRQb3MgPSB0aGlzLnJlYWRQb3M7XG5cbiAgICAgIC8vIFJlYWQgdGhlIHByZWZpeCAocGxpc3QgbGVuZ3RoKSB0byBzZWUgaG93IGZhciB0byByZWFkIG5leHRcbiAgICAgIC8vIEl0J3MgYWx3YXlzIDQgYnl0ZXMgbG9uZ1xuICAgICAgbGV0IHByZWZpeCA9IHRoaXMucmVjZWl2ZWQuc2xpY2UodGhpcy5yZWFkUG9zLCB0aGlzLnJlYWRQb3MgKyA0KTtcblxuICAgICAgbGV0IG1zZ0xlbmd0aDtcbiAgICAgIHRyeSB7XG4gICAgICAgIG1zZ0xlbmd0aCA9IGJ1ZmZlcnBhY2sudW5wYWNrKCdMJywgcHJlZml4KVswXTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLmVycm9yKGBCdWZmZXIgY291bGQgbm90IHVucGFjazogJHtlfWApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIEp1bXAgZm9yd2FyZCA0IGJ5dGVzXG4gICAgICB0aGlzLnJlYWRQb3MgKz0gNDtcblxuICAgICAgLy8gSXMgdGhlcmUgZW5vdWdoIGRhdGEgaGVyZT9cbiAgICAgIC8vIElmIG5vdCwganVtcCBiYWNrIHRvIG91ciBvcmlnaW5hbCBwb3NpdGlvbiBhbmQgZ3Rmb1xuICAgICAgaWYgKHRoaXMucmVjZWl2ZWQubGVuZ3RoIDwgbXNnTGVuZ3RoICsgdGhpcy5yZWFkUG9zKSB7XG4gICAgICAgIHRoaXMucmVhZFBvcyA9IG9sZFJlYWRQb3M7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICAvLyBFeHRyYWN0IHRoZSBtYWluIGJvZHkgb2YgdGhlIG1lc3NhZ2UgKHdoZXJlIHRoZSBwbGlzdCBzaG91bGQgYmUpXG4gICAgICBsZXQgYm9keSA9IHRoaXMucmVjZWl2ZWQuc2xpY2UodGhpcy5yZWFkUG9zLCBtc2dMZW5ndGggKyB0aGlzLnJlYWRQb3MpO1xuXG4gICAgICAvLyBFeHRyYWN0IHRoZSBwbGlzdFxuICAgICAgbGV0IHBsaXN0O1xuICAgICAgdHJ5IHtcbiAgICAgICAgcGxpc3QgPSBicGxpc3RQYXJzZS5wYXJzZUJ1ZmZlcihib2R5KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLmVycm9yKGBFcnJvciBwYXJzaW5nIGJpbmFyeSBwbGlzdDogJHtlfWApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIGJwbGlzdFBhcnNlLnBhcnNlQnVmZmVyIHJldHVybnMgYW4gYXJyYXlcbiAgICAgIGlmIChwbGlzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgcGxpc3QgPSBwbGlzdFswXTtcbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQga2V5IG9mIFsnV0lSTWVzc2FnZURhdGFLZXknLCAnV0lSRGVzdGluYXRpb25LZXknLCAnV0lSU29ja2V0RGF0YUtleSddKSB7XG4gICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChwbGlzdFtrZXldKSkge1xuICAgICAgICAgIHBsaXN0W2tleV0gPSBwbGlzdFtrZXldLnRvU3RyaW5nKFwidXRmOFwiKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAocGxpc3QuX19zZWxlY3RvciA9PT0gXCJfcnBjX2FwcGxpY2F0aW9uU2VudERhdGE6XCIpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBhcHBsaWNhdGlvblNlbnREYXRhIHJlc3BvbnNlJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmluZyBkYXRhIGZyb20gcmVtb3RlIGRlYnVnZ2VyOiAnJHtzaW1wbGVTdHJpbmdpZnkocGxpc3QpfSdgKTtcbiAgICAgIH1cblxuICAgICAgLy8gSnVtcCBmb3J3YXJkIHRoZSBsZW5ndGggb2YgdGhlIHBsaXN0XG4gICAgICB0aGlzLnJlYWRQb3MgKz0gbXNnTGVuZ3RoO1xuXG4gICAgICAvLyBDYWxjdWxhdGUgaG93IG11Y2ggYnVmZmVyIGlzIGxlZnRcbiAgICAgIGxldCBsZWZ0T3ZlciA9IHRoaXMucmVjZWl2ZWQubGVuZ3RoIC0gdGhpcy5yZWFkUG9zO1xuXG4gICAgICAvLyBJcyB0aGVyZSBzb21lIGxlZnQgb3Zlcj9cbiAgICAgIGlmIChsZWZ0T3ZlciAhPT0gMCkge1xuICAgICAgICAvLyBDb3B5IHdoYXQncyBsZWZ0IG92ZXIgaW50byBhIG5ldyBidWZmZXIsIGFuZCBzYXZlIGl0IGZvciBuZXh0IHRpbWVcbiAgICAgICAgbGV0IGNodW5rID0gbmV3IEJ1ZmZlcihsZWZ0T3Zlcik7XG4gICAgICAgIHRoaXMucmVjZWl2ZWQuY29weShjaHVuaywgMCwgdGhpcy5yZWFkUG9zKTtcbiAgICAgICAgdGhpcy5yZWNlaXZlZCA9IGNodW5rO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gT3RoZXJ3aXNlLCBlbXB0eSB0aGUgYnVmZmVyIGFuZCBnZXQgb3V0IG9mIHRoZSBsb29wXG4gICAgICAgIHRoaXMucmVjZWl2ZWQgPSBuZXcgQnVmZmVyKDApO1xuICAgICAgICBkYXRhTGVmdE92ZXIgPSBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVzZXQgdGhlIHJlYWQgcG9zaXRpb25cbiAgICAgIHRoaXMucmVhZFBvcyA9IDA7XG5cbiAgICAgIC8vIE5vdyBkbyBzb21ldGhpbmcgd2l0aCB0aGUgcGxpc3RcbiAgICAgIGlmIChwbGlzdCkge1xuICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhbmRsZU1lc3NhZ2UocGxpc3QpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldFRpbWVsaW5lRXZlbnRIYW5kbGVyICh0aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIgPSB0aW1lbGluZUV2ZW50SGFuZGxlcjtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldFRpbWVsaW5lRXZlbnRIYW5kbGVyKHRpbWVsaW5lRXZlbnRIYW5kbGVyKTtcbiAgfVxuXG4gIHNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIgKGNvbnNvbGVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIgPSBjb25zb2xlRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlcihjb25zb2xlRXZlbnRIYW5kbGVyKTtcbiAgfVxuXG4gIHNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIgKG5ldHdvcmtFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIgPSBuZXR3b3JrRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0TmV0d29ya0V2ZW50SGFuZGxlcihuZXR3b3JrRXZlbnRIYW5kbGVyKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
