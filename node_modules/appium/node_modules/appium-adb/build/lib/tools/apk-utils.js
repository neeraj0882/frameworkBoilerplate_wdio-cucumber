'use strict';

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _helpersJs = require('../helpers.js');

var _teen_process = require('teen_process');

var _loggerJs = require('../logger.js');

var _loggerJs2 = _interopRequireDefault(_loggerJs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _asyncbox = require('asyncbox');

var _appiumSupport = require('appium-support');

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var apkUtilsMethods = {};

/**
 * Check whether the particular package is present on the device under test.
 *
 * @param {string} pkg - The name of the package to check.
 * @return {boolean} True if the package is installed.
 */
apkUtilsMethods.isAppInstalled = function callee$0$0(pkg) {
  var installed, stdout, apkInstalledRgx;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        installed = false;

        _loggerJs2['default'].debug('Getting install status for ' + pkg);
        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.shell(['pm', 'list', 'packages', pkg]));

      case 5:
        stdout = context$1$0.sent;
        apkInstalledRgx = new RegExp('^package:' + pkg.replace(/(\.)/g, "\\$1") + '$', 'm');

        installed = apkInstalledRgx.test(stdout);
        _loggerJs2['default'].debug('App is' + (!installed ? ' not' : '') + ' installed');
        return context$1$0.abrupt('return', installed);

      case 12:
        context$1$0.prev = 12;
        context$1$0.t0 = context$1$0['catch'](2);
        throw new Error('Error finding if app is installed. Original error: ' + context$1$0.t0.message);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 12]]);
};

/**
 * Start the particular URI on the device under test.
 *
 * @param {string} uri - The name of URI to start.
 * @param {string} pkg - The name of the package to start the URI with.
 */
apkUtilsMethods.startUri = function callee$0$0(uri, pkg) {
  var args, res;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!uri || !pkg)) {
          context$1$0.next = 2;
          break;
        }

        throw new Error("URI and package arguments are required");

      case 2:
        context$1$0.prev = 2;
        args = ["am", "start", "-W", "-a", "android.intent.action.VIEW", "-d", uri.replace(/&/g, '\\&'), pkg];
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.shell(args));

      case 6:
        res = context$1$0.sent;

        if (!res.toLowerCase().includes('unable to resolve intent')) {
          context$1$0.next = 9;
          break;
        }

        throw new Error(res);

      case 9:
        context$1$0.next = 14;
        break;

      case 11:
        context$1$0.prev = 11;
        context$1$0.t0 = context$1$0['catch'](2);
        throw new Error('Error attempting to start URI. Original error: ' + context$1$0.t0);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 11]]);
};

/**
 * Start the particular package on the device under test.
 *
 * @param {object} startAppOptions [{}] - Startup options mapping.
 *                                        It is mandatory that 'activity' and 'pkg' properties are set.
 *                                        Additional supported properties are: 'retry', 'stopApp', 'waitPkg'
 *                                        and 'waitActivity'.
 * @return {string} The output of the corresponding adb command.
 */
apkUtilsMethods.startApp = function callee$0$0() {
  var startAppOptions = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var apiLevel, cmd, stdout;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;

        if (!(!startAppOptions.activity || !startAppOptions.pkg)) {
          context$1$0.next = 3;
          break;
        }

        throw new Error("activity and pkg is required for launching application");

      case 3:
        startAppOptions = _lodash2['default'].clone(startAppOptions);
        startAppOptions.activity = startAppOptions.activity.replace('$', '\\$');

        // initializing defaults
        _lodash2['default'].defaults(startAppOptions, {
          waitPkg: startAppOptions.pkg,
          waitActivity: false,
          retry: true,
          stopApp: true
        });
        // preventing null waitpkg
        startAppOptions.waitPkg = startAppOptions.waitPkg || startAppOptions.pkg;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getApiLevel());

      case 9:
        apiLevel = context$1$0.sent;
        cmd = (0, _helpersJs.buildStartCmd)(startAppOptions, apiLevel);
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.shell(cmd));

      case 13:
        stdout = context$1$0.sent;

        if (!(stdout.indexOf("Error: Activity class") !== -1 && stdout.indexOf("does not exist") !== -1)) {
          context$1$0.next = 25;
          break;
        }

        if (!(startAppOptions.retry && startAppOptions.activity[0] !== ".")) {
          context$1$0.next = 22;
          break;
        }

        _loggerJs2['default'].debug("We tried to start an activity that doesn't exist, " + "retrying with . prepended to activity");
        startAppOptions.activity = '.' + startAppOptions.activity;
        startAppOptions.retry = false;
        return context$1$0.abrupt('return', this.startApp(startAppOptions));

      case 22:
        throw new Error("Activity used to start app doesn't exist or cannot be " + "launched! Make sure it exists and is a launchable activity");

      case 23:
        context$1$0.next = 27;
        break;

      case 25:
        if (!(stdout.indexOf("java.lang.SecurityException") !== -1)) {
          context$1$0.next = 27;
          break;
        }

        throw new Error("Permission to start activity denied.");

      case 27:
        if (!startAppOptions.waitActivity) {
          context$1$0.next = 30;
          break;
        }

        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(this.waitForActivity(startAppOptions.waitPkg, startAppOptions.waitActivity, startAppOptions.waitDuration));

      case 30:
        context$1$0.next = 35;
        break;

      case 32:
        context$1$0.prev = 32;
        context$1$0.t0 = context$1$0['catch'](0);
        throw new Error('Error occured while starting App. Original error: ' + context$1$0.t0.message);

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 32]]);
};

/**
 * @typedef {Object} PackageActivityInfo
 * @property {?string} appPackage - The name of application package,
 *                                  for example 'com.acme.app'.
 * @property {?string} appActivity - The name of main application activity.
 */

/**
 * Get the name of currently focused package and activity.
 *
 * @return {PackageActivityInfo} The mapping, where property names are 'appPackage' and 'appActivity'.
 * @throws {Error} If there is an error while parsing the data.
 */
apkUtilsMethods.getFocusedPackageAndActivity = function callee$0$0() {
  var cmd, nullRe, searchRe, stdout, foundNullMatch, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, line, foundMatch;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug("Getting focused package and activity");
        cmd = ['dumpsys', 'window', 'windows'];
        nullRe = new RegExp(/mFocusedApp=null/);
        searchRe = new RegExp('mFocusedApp.+Record\\{.*\\s([^\\s\\/\\}]+)' + '\\/([^\\s\\/\\}\\,]+)\\,?(\\s[^\\s\\/\\}]+)*\\}');
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.shell(cmd));

      case 7:
        stdout = context$1$0.sent;
        foundNullMatch = false;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 12;
        _iterator = _getIterator(stdout.split("\n"));

      case 14:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 25;
          break;
        }

        line = _step.value;
        foundMatch = searchRe.exec(line);

        if (!foundMatch) {
          context$1$0.next = 21;
          break;
        }

        return context$1$0.abrupt('return', { appPackage: foundMatch[1].trim(), appActivity: foundMatch[2].trim() });

      case 21:
        if (nullRe.test(line)) {
          foundNullMatch = true;
        }

      case 22:
        _iteratorNormalCompletion = true;
        context$1$0.next = 14;
        break;

      case 25:
        context$1$0.next = 31;
        break;

      case 27:
        context$1$0.prev = 27;
        context$1$0.t0 = context$1$0['catch'](12);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 31:
        context$1$0.prev = 31;
        context$1$0.prev = 32;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 34:
        context$1$0.prev = 34;

        if (!_didIteratorError) {
          context$1$0.next = 37;
          break;
        }

        throw _iteratorError;

      case 37:
        return context$1$0.finish(34);

      case 38:
        return context$1$0.finish(31);

      case 39:
        if (!foundNullMatch) {
          context$1$0.next = 43;
          break;
        }

        return context$1$0.abrupt('return', { appPackage: null, appActivity: null });

      case 43:
        throw new Error("Could not parse activity from dumpsys");

      case 44:
        context$1$0.next = 49;
        break;

      case 46:
        context$1$0.prev = 46;
        context$1$0.t1 = context$1$0['catch'](4);
        throw new Error('Could not get focusPackageAndActivity. Original error: ' + context$1$0.t1.message);

      case 49:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 46], [12, 27, 31, 39], [32,, 34, 38]]);
};

/**
 * Wait for the given activity to be focused/non-focused.
 *
 * @param {string} pkg - The name of the package to wait for.
 * @param {string} activity - The name of the activity, belonging to that package,
 *                            to wait for.
 * @param {boolean} waitForStop - Whether to wait until the activity is focused (true)
 *                                or is not focused (false).
 * @param {number} waitMs [20000] - Number of milliseconds to wait before timeout occurs.
 * @throws {error} If timeout happens.
 */
apkUtilsMethods.waitForActivityOrNot = function callee$0$0(pkg, activity, waitForStop) {
  var waitMs = arguments.length <= 3 || arguments[3] === undefined ? 20000 : arguments[3];

  var splitNames, allPackages, allActivities, possibleActivityNames, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, oneActivity, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, currentPkg, possibleActivityPatterns, retries;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!pkg || !activity)) {
          context$1$0.next = 2;
          break;
        }

        throw new Error('Package and activity required.');

      case 2:
        _loggerJs2['default'].debug('Waiting up to ' + waitMs + 'ms for activity matching pkg: \'' + pkg + '\' and ' + ('activity: \'' + activity + '\' to' + (waitForStop ? ' not' : '') + ' be focused'));

        splitNames = function splitNames(names) {
          return names.split(',').map(function (name) {
            return name.trim();
          });
        };

        allPackages = splitNames(pkg);
        allActivities = splitNames(activity);
        possibleActivityNames = [];
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 10;
        _iterator2 = _getIterator(allActivities);

      case 12:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 41;
          break;
        }

        oneActivity = _step2.value;

        if (!oneActivity.startsWith('.')) {
          context$1$0.next = 36;
          break;
        }

        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 18;

        // add the package name if activity is not full qualified
        for (_iterator3 = _getIterator(allPackages); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          currentPkg = _step3.value;

          possibleActivityNames.push(('' + currentPkg + oneActivity).replace(/\.+/g, '.'));
        }
        context$1$0.next = 26;
        break;

      case 22:
        context$1$0.prev = 22;
        context$1$0.t0 = context$1$0['catch'](18);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 26:
        context$1$0.prev = 26;
        context$1$0.prev = 27;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 29:
        context$1$0.prev = 29;

        if (!_didIteratorError3) {
          context$1$0.next = 32;
          break;
        }

        throw _iteratorError3;

      case 32:
        return context$1$0.finish(29);

      case 33:
        return context$1$0.finish(26);

      case 34:
        context$1$0.next = 38;
        break;

      case 36:
        // accept fully qualified activity name.
        possibleActivityNames.push(oneActivity);
        possibleActivityNames.push(pkg + '.' + oneActivity);

      case 38:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 12;
        break;

      case 41:
        context$1$0.next = 47;
        break;

      case 43:
        context$1$0.prev = 43;
        context$1$0.t1 = context$1$0['catch'](10);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t1;

      case 47:
        context$1$0.prev = 47;
        context$1$0.prev = 48;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 50:
        context$1$0.prev = 50;

        if (!_didIteratorError2) {
          context$1$0.next = 53;
          break;
        }

        throw _iteratorError2;

      case 53:
        return context$1$0.finish(50);

      case 54:
        return context$1$0.finish(47);

      case 55:
        /* jshint ignore:start */
        _loggerJs2['default'].debug('Possible activities, to be checked: ' + possibleActivityNames.map(function (name) {
          return '\'' + name + '\'';
        }).join(', '));
        /* jshint ignore:end */
        possibleActivityPatterns = possibleActivityNames.map(function (possibleActivityName) {
          return new RegExp('^' + possibleActivityName.replace(/\./g, '\\.').replace(/\*/g, '.*?').replace(/\$/g, '\\$') + '$');
        });
        retries = parseInt(waitMs / 750, 10) || 1;

        retries = isNaN(retries) ? 30 : retries;
        context$1$0.next = 61;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(retries, 750, function callee$1$0() {
          var _ref, appPackage, appActivity, _ret;

          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.getFocusedPackageAndActivity());

              case 2:
                _ref = context$2$0.sent;
                appPackage = _ref.appPackage;
                appActivity = _ref.appActivity;

                if (!(appActivity && appPackage)) {
                  context$2$0.next = 9;
                  break;
                }

                _ret = (function () {
                  var fullyQualifiedActivity = appActivity.startsWith('.') ? '' + appPackage + appActivity : appActivity;
                  _loggerJs2['default'].debug('Found package: \'' + appPackage + '\' and fully qualified activity name : \'' + fullyQualifiedActivity + '\'');
                  var foundAct = _lodash2['default'].includes(allPackages, appPackage) && _lodash2['default'].findIndex(possibleActivityPatterns, function (possiblePattern) {
                    return possiblePattern.test(fullyQualifiedActivity);
                  }) !== -1;
                  if (!waitForStop && foundAct || waitForStop && !foundAct) {
                    return {
                      v: undefined
                    };
                  }
                })();

                if (!(typeof _ret === 'object')) {
                  context$2$0.next = 9;
                  break;
                }

                return context$2$0.abrupt('return', _ret.v);

              case 9:
                _loggerJs2['default'].debug('Incorrect package and activity. Retrying.');
                /* jshint ignore:start */
                throw new Error(possibleActivityNames.map(function (name) {
                  return '\'' + name + '\'';
                }).join(' or ') + ' never ' + (waitForStop ? 'stopped' : 'started'));

              case 11:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }));

      case 61:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10, 43, 47, 55], [18, 22, 26, 34], [27,, 29, 33], [48,, 50, 54]]);
};

/**
 * Wait for the given activity to be focused
 *
 * @param {string} pkg - The name of the package to wait for.
 * @param {string} activity - The name of the activity, belonging to that package,
 *                            to wait for.
 * @param {number} waitMs [20000] - Number of milliseconds to wait before timeout occurs.
 * @throws {error} If timeout happens.
 */

/* jshint ignore:end */
apkUtilsMethods.waitForActivity = function callee$0$0(pkg, act) {
  var waitMs = arguments.length <= 2 || arguments[2] === undefined ? 20000 : arguments[2];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.waitForActivityOrNot(pkg, act, false, waitMs));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Wait for the given activity to be non-focused.
 *
 * @param {string} pkg - The name of the package to wait for.
 * @param {string} activity - The name of the activity, belonging to that package,
 *                            to wait for.
 * @param {number} waitMs [20000] - Number of milliseconds to wait before timeout occurs.
 * @throws {error} If timeout happens.
 */
apkUtilsMethods.waitForNotActivity = function callee$0$0(pkg, act) {
  var waitMs = arguments.length <= 2 || arguments[2] === undefined ? 20000 : arguments[2];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.waitForActivityOrNot(pkg, act, true, waitMs));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * @typedef {Object} UninstallOptions
 * @property {number} timeout [20000] - The count of milliseconds to wait until the
 *                                      app is uninstalled.
 * @property {boolean} keepData [false] - Set to true in order to keep the
 *                                        application data and cache folders after uninstall.
 */

var APK_UNINSTALL_TIMEOUT = 20000;

/**
 * Uninstall the given package from the device under test.
 *
 * @param {string} pkg - The name of the package to be uninstalled.
 * @param {?UninstallOptions} options - The set of uninstallation options.
 * @return {boolean} True if the package was found on the device and
 *                   successfully uninstalled.
 */
apkUtilsMethods.uninstallApk = function callee$0$0(pkg) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var timeout, cmd, stdout;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Uninstalling ' + pkg);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.isAppInstalled(pkg));

      case 3:
        if (context$1$0.sent) {
          context$1$0.next = 6;
          break;
        }

        _loggerJs2['default'].info(pkg + ' was not uninstalled, because it was not present on the device');
        return context$1$0.abrupt('return', false);

      case 6:
        timeout = APK_UNINSTALL_TIMEOUT;

        if (_appiumSupport.util.hasValue(options.timeout) && !isNaN(options.timeout)) {
          timeout = parseInt(options.timeout, 10);
        }
        cmd = ['uninstall'];

        if (options.keepData) {
          cmd.push('-k');
        }
        cmd.push(pkg);

        stdout = undefined;
        context$1$0.prev = 12;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.forceStop(pkg));

      case 15:
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.adbExec(cmd, { timeout: timeout }));

      case 17:
        stdout = context$1$0.sent.trim();
        context$1$0.next = 23;
        break;

      case 20:
        context$1$0.prev = 20;
        context$1$0.t0 = context$1$0['catch'](12);
        throw new Error('Unable to uninstall APK. Original error: ' + context$1$0.t0.message);

      case 23:
        _loggerJs2['default'].debug('\'adb ' + cmd.join(' ') + '\' command output: ' + stdout);

        if (!stdout.includes("Success")) {
          context$1$0.next = 27;
          break;
        }

        _loggerJs2['default'].info(pkg + ' was successfully uninstalled');
        return context$1$0.abrupt('return', true);

      case 27:
        _loggerJs2['default'].info(pkg + ' was not uninstalled');
        return context$1$0.abrupt('return', false);

      case 29:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[12, 20]]);
};

/**
 * Install the package after it was pushed to the device under test.
 *
 * @param {string} apkPathOnDevice - The full path to the package on the device file system.
 * @param {object} opts [{}] - Additional exec options. See {@link https://github.com/appium/node-teen_process}
 *                             for more details on this parameter.
 * @throws {error} If there was a failure during application install.
 */
apkUtilsMethods.installFromDevicePath = function callee$0$0(apkPathOnDevice) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var stdout;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.shell(['pm', 'install', '-r', apkPathOnDevice], opts));

      case 2:
        stdout = context$1$0.sent;

        if (!(stdout.indexOf("Failure") !== -1)) {
          context$1$0.next = 5;
          break;
        }

        throw new Error('Remote install failed: ' + stdout);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

var APK_INSTALL_TIMEOUT = 60000;

/**
 * @typedef {Object} InstallOptions
 * @property {number} timeout [60000] - The count of milliseconds to wait until the
 *                                      app is installed.
 * @property {boolean} allowTestPackages [false] - Set to true in order to allow test
 *                                                 packages installation.
 * @property {boolean} useSdcard [false] - Set to true to install the app on sdcard
 *                                         instead of the device memory.
 * @property {boolean} grantPermissions [false] - Set to true in order to grant all the
 *                                                permissions requested in the application's manifest
 *                                                automatically after the installation is completed
 *                                                under Android 6+.
 * @property {boolean} replace [true] - Set it to false if you don't want
 *                                      the application to be upgraded/reinstalled
 *                                      if it is already present on the device.
 */

/**
 * Install the package from the local file system.
 *
 * @param {string} apk - The full path to the local package.
 * @param {boolean} repalce [true] - Whether to replace the package if it
 *                                   already installed. True by default.
 * @param {?InstallOptions} options - The set of installation options.
 * @throws {error} If an unexpected error happens during install.
 */
apkUtilsMethods.install = function callee$0$0(apk) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var timeout, additionalArgs, apiLevel, executeInstall;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!_appiumSupport.util.hasValue(options.replace)) {
          options.replace = true;
        }
        timeout = APK_INSTALL_TIMEOUT;

        if (_appiumSupport.util.hasValue(options.timeout) && !isNaN(options.timeout)) {
          timeout = parseInt(options.timeout, 10);
        }

        additionalArgs = [];

        if (options.allowTestPackages) {
          additionalArgs.push('-t');
        }
        if (options.useSdcard) {
          additionalArgs.push('-s');
        }

        if (!options.grantPermissions) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getApiLevel());

      case 9:
        apiLevel = context$1$0.sent;

        if (apiLevel < 23) {
          _loggerJs2['default'].debug('Skipping granting permissions for \'' + apk + '\', since ' + ('the current API level ' + apiLevel + ' does not support applications ') + 'permissions customization');
        } else {
          additionalArgs.push('-g');
        }

      case 11:
        executeInstall = function executeInstall(args) {
          var output, truncatedOutput;
          return _regeneratorRuntime.async(function executeInstall$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.adbExec(['install'].concat(_toConsumableArray(args), [apk]), { timeout: timeout }));

              case 2:
                output = context$2$0.sent;
                truncatedOutput = !_lodash2['default'].isString(output) || output.length <= 300 ? output : output.substr(0, 150) + '...' + output.substr(output.length - 150);

                _loggerJs2['default'].debug('Install command stdout: ' + truncatedOutput);

                if (!(_lodash2['default'].isString(output) && output.includes('INSTALL_FAILED'))) {
                  context$2$0.next = 7;
                  break;
                }

                throw new Error(output);

              case 7:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this2);
        };

        if (!options.replace) {
          context$1$0.next = 16;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(executeInstall(['-r'].concat(additionalArgs)));

      case 15:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 16:
        context$1$0.prev = 16;
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(executeInstall(additionalArgs));

      case 19:
        context$1$0.next = 26;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t0 = context$1$0['catch'](16);

        if (context$1$0.t0.message.includes('INSTALL_FAILED_ALREADY_EXISTS')) {
          context$1$0.next = 25;
          break;
        }

        throw context$1$0.t0;

      case 25:
        _loggerJs2['default'].debug('Application \'' + apk + '\' already installed. Continuing.');

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[16, 21]]);
};

/**
 * @typedef {Object} InstallOrUpgradeOptions
 * @property {number} timeout [60000] - The count of milliseconds to wait until the
 *                                      app is installed.
 * @property {boolean} allowTestPackages [false] - Set to true in order to allow test
 *                                                 packages installation.
 * @property {boolean} useSdcard [false] - Set to true to install the app on sdcard
 *                                         instead of the device memory.
 * @property {boolean} grantPermissions [false] - Set to true in order to grant all the
 *                                                permissions requested in the application's manifest
 *                                                automatically after the installation is completed
 *                                                under Android 6+.
 */

/**
 * Install the package from the local file system of upgrade it if an older
 * version of the same package is already installed.
 *
 * @param {string} apk - The full path to the local package.
 * @param {?string} pkg - The name of the installed package. The method will
 *                        perform faster if it is set.
 * @param {?InstallOrUpgradeOptions} options - Set of install options.
 * @throws {error} If an unexpected error happens during install.
 */
apkUtilsMethods.installOrUpgrade = function callee$0$0(apk) {
  var pkg = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

  var apkInfo, _ref2, pkgVersionCode, pkgVersionNameStr, pkgVersionName, _apkInfo, apkVersionCode, apkVersionNameStr, apkVersionName;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!_appiumSupport.util.hasValue(options.timeout)) {
          options.timeout = APK_INSTALL_TIMEOUT;
        }

        apkInfo = null;

        if (pkg) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getApkInfo(apk));

      case 5:
        apkInfo = context$1$0.sent;

        pkg = apkInfo.name;

      case 7:
        if (pkg) {
          context$1$0.next = 10;
          break;
        }

        _loggerJs2['default'].warn('Cannot read the package name of ' + apk + '. Assuming correct app version is already installed');
        return context$1$0.abrupt('return');

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.isAppInstalled(pkg));

      case 12:
        if (context$1$0.sent) {
          context$1$0.next = 17;
          break;
        }

        _loggerJs2['default'].debug('App \'' + apk + '\' not installed. Installing');
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.install(apk, _Object$assign({}, options, { replace: false })));

      case 16:
        return context$1$0.abrupt('return');

      case 17:
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(this.getPackageInfo(pkg));

      case 19:
        _ref2 = context$1$0.sent;
        pkgVersionCode = _ref2.versionCode;
        pkgVersionNameStr = _ref2.versionName;
        pkgVersionName = _semver2['default'].valid(_semver2['default'].coerce(pkgVersionNameStr));

        if (apkInfo) {
          context$1$0.next = 27;
          break;
        }

        context$1$0.next = 26;
        return _regeneratorRuntime.awrap(this.getApkInfo(apk));

      case 26:
        apkInfo = context$1$0.sent;

      case 27:
        _apkInfo = apkInfo;
        apkVersionCode = _apkInfo.versionCode;
        apkVersionNameStr = _apkInfo.versionName;
        apkVersionName = _semver2['default'].valid(_semver2['default'].coerce(apkVersionNameStr));

        if (!(!_lodash2['default'].isNumber(apkVersionCode) || !_lodash2['default'].isNumber(pkgVersionCode))) {
          context$1$0.next = 36;
          break;
        }

        _loggerJs2['default'].warn('Cannot read version codes of \'' + apk + '\' and/or \'' + pkg + '\'');

        if (!(!_lodash2['default'].isString(apkVersionName) || !_lodash2['default'].isString(pkgVersionName))) {
          context$1$0.next = 36;
          break;
        }

        _loggerJs2['default'].warn('Cannot read version names of \'' + apk + '\' and/or \'' + pkg + '\'. Assuming correct app version is already installed');
        return context$1$0.abrupt('return');

      case 36:
        if (!(_lodash2['default'].isNumber(apkVersionCode) && _lodash2['default'].isNumber(pkgVersionCode) && pkgVersionCode > apkVersionCode)) {
          context$1$0.next = 39;
          break;
        }

        _loggerJs2['default'].debug('The installed \'' + pkg + '\' package does not require upgrade (' + pkgVersionCode + ' > ' + apkVersionCode + ')');
        return context$1$0.abrupt('return');

      case 39:
        if (!(_lodash2['default'].isString(apkVersionName) && _lodash2['default'].isString(pkgVersionName))) {
          context$1$0.next = 45;
          break;
        }

        if (!_semver2['default'].satisfies(pkgVersionName, '>=' + apkVersionName)) {
          context$1$0.next = 43;
          break;
        }

        _loggerJs2['default'].debug('The installed \'' + pkg + '\' package does not require upgrade (\'' + pkgVersionName + '\' >= \'' + apkVersionName + '\')');
        return context$1$0.abrupt('return');

      case 43:
        context$1$0.next = 48;
        break;

      case 45:
        if (!(_lodash2['default'].isNumber(apkVersionCode) && _lodash2['default'].isNumber(pkgVersionCode) && pkgVersionCode === apkVersionCode)) {
          context$1$0.next = 48;
          break;
        }

        _loggerJs2['default'].debug('The installed \'' + pkg + '\' package does not require upgrade (' + pkgVersionCode + ' === ' + apkVersionCode + ')');
        return context$1$0.abrupt('return');

      case 48:

        _loggerJs2['default'].debug('The installed \'' + pkg + '\' package is older than \'' + apk + '\' ' + ('(' + pkgVersionCode + ' < ' + apkVersionCode + ' or \'' + pkgVersionName + '\' < \'' + apkVersionName + '\')\'. ') + 'Executing upgrade');
        context$1$0.prev = 49;
        context$1$0.next = 52;
        return _regeneratorRuntime.awrap(this.install(apk, _Object$assign({}, options, { replace: true })));

      case 52:
        context$1$0.next = 63;
        break;

      case 54:
        context$1$0.prev = 54;
        context$1$0.t0 = context$1$0['catch'](49);

        _loggerJs2['default'].warn('Cannot upgrade \'' + pkg + '\' because of \'' + context$1$0.t0.message + '\'. Trying full reinstall');
        context$1$0.next = 59;
        return _regeneratorRuntime.awrap(this.uninstallApk(pkg));

      case 59:
        if (context$1$0.sent) {
          context$1$0.next = 61;
          break;
        }

        throw new Error('\'' + pkg + '\' package cannot be uninstalled');

      case 61:
        context$1$0.next = 63;
        return _regeneratorRuntime.awrap(this.install(apk, _Object$assign({}, options, { replace: false })));

      case 63:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[49, 54]]);
};

/**
 * Extract string resources from the given package on local file system.
 *
 * @param {string} apk - The full path to the local package.
 * @param {?string} language - The name of the language to extract the resources for.
 *                             The default language is used if this equals to `null`/`undefined`
 * @param {string} out - The name of the destination folder on the local file system to
 *                       store the extracted file to.
 * @return {Object} A mapping object, where properties are: 'apkStrings', containing
 *                  parsed resource file represented as JSON object, and 'localPath',
 *                  containing the path to the extracted file on the local file system.
 */
apkUtilsMethods.extractStringsFromApk = function callee$0$0(apk, language, out) {
  var rawAaptOutput, _ref3,
  // Assume the 'en' configuration is the default one
  stdout, defaultConfigMarker, configMarker, _ref4, configs, apkStrings, isInConfig, currentResourceId, isInPluralGroup, startsWithAny, normalizeStringMatch, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, line, trimmedLine, match, localPath;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Extracting strings for language: ' + (language || 'default'));
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.initAapt());

      case 3:
        rawAaptOutput = undefined;
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.binaries.aapt, ['d', '--values', 'resources', apk]));

      case 7:
        _ref3 = context$1$0.sent;
        stdout = _ref3.stdout;

        rawAaptOutput = stdout;
        context$1$0.next = 15;
        break;

      case 12:
        context$1$0.prev = 12;
        context$1$0.t0 = context$1$0['catch'](4);
        throw new Error('Cannot extract resources from \'' + apk + '\'. Original error: ' + context$1$0.t0.message);

      case 15:
        defaultConfigMarker = '(default)';
        configMarker = language || defaultConfigMarker;

        if (configMarker.includes('-') && !configMarker.includes('-r')) {
          configMarker = configMarker.replace('-', '-r');
        }

        if (!configMarker.toLowerCase().startsWith('en')) {
          context$1$0.next = 25;
          break;
        }

        context$1$0.next = 21;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.binaries.aapt, ['d', 'configurations', apk]));

      case 21:
        _ref4 = context$1$0.sent;
        stdout = _ref4.stdout;
        configs = stdout.split(_os2['default'].EOL);

        if (!configs.includes(configMarker)) {
          _loggerJs2['default'].debug('There is no \'' + configMarker + '\' configuration. ' + ('Replacing it with \'' + defaultConfigMarker + '\''));
          configMarker = defaultConfigMarker;
        }

      case 25:
        apkStrings = {};
        isInConfig = false;
        currentResourceId = null;
        isInPluralGroup = false;

        startsWithAny = function startsWithAny(s, arr) {
          return arr.reduce(function (acc, x) {
            return acc || s.startsWith(x);
          }, false);
        };

        normalizeStringMatch = function normalizeStringMatch(s) {
          return s.replace(/"$/, '').replace(/^"/, '').replace(/\\"/g, '"');
        };

        _iteratorNormalCompletion4 = true;
        _didIteratorError4 = false;
        _iteratorError4 = undefined;
        context$1$0.prev = 34;
        _iterator4 = _getIterator(rawAaptOutput.split(_os2['default'].EOL));

      case 36:
        if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
          context$1$0.next = 65;
          break;
        }

        line = _step4.value;
        trimmedLine = line.trim();

        if (!_lodash2['default'].isEmpty(trimmedLine)) {
          context$1$0.next = 41;
          break;
        }

        return context$1$0.abrupt('continue', 62);

      case 41:
        if (!startsWithAny(trimmedLine, ['config', 'type', 'spec', 'Package'])) {
          context$1$0.next = 46;
          break;
        }

        isInConfig = trimmedLine.startsWith('config ' + configMarker + ':');
        currentResourceId = null;
        isInPluralGroup = false;
        return context$1$0.abrupt('continue', 62);

      case 46:
        if (isInConfig) {
          context$1$0.next = 48;
          break;
        }

        return context$1$0.abrupt('continue', 62);

      case 48:
        if (!trimmedLine.startsWith('resource')) {
          context$1$0.next = 53;
          break;
        }

        isInPluralGroup = false;
        currentResourceId = null;

        if (trimmedLine.includes(':string/')) {
          match = /:string\/(\S+):/.exec(trimmedLine);

          if (match) {
            currentResourceId = match[1];
          }
        } else if (trimmedLine.includes(':plurals/')) {
          match = /:plurals\/(\S+):/.exec(trimmedLine);

          if (match) {
            currentResourceId = match[1];
            isInPluralGroup = true;
          }
        }
        return context$1$0.abrupt('continue', 62);

      case 53:
        if (!(currentResourceId && trimmedLine.startsWith('(string'))) {
          context$1$0.next = 58;
          break;
        }

        match = /"[^"\\]*(?:\\.[^"\\]*)*"/.exec(trimmedLine);

        if (match) {
          apkStrings[currentResourceId] = normalizeStringMatch(match[0]);
        }
        currentResourceId = null;
        return context$1$0.abrupt('continue', 62);

      case 58:
        if (!(currentResourceId && isInPluralGroup && trimmedLine.includes(': (string'))) {
          context$1$0.next = 62;
          break;
        }

        match = /"[^"\\]*(?:\\.[^"\\]*)*"/.exec(trimmedLine);

        if (match) {
          apkStrings[currentResourceId] = [].concat(_toConsumableArray(apkStrings[currentResourceId] || []), [normalizeStringMatch(match[0])]);
        }
        return context$1$0.abrupt('continue', 62);

      case 62:
        _iteratorNormalCompletion4 = true;
        context$1$0.next = 36;
        break;

      case 65:
        context$1$0.next = 71;
        break;

      case 67:
        context$1$0.prev = 67;
        context$1$0.t1 = context$1$0['catch'](34);
        _didIteratorError4 = true;
        _iteratorError4 = context$1$0.t1;

      case 71:
        context$1$0.prev = 71;
        context$1$0.prev = 72;

        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }

      case 74:
        context$1$0.prev = 74;

        if (!_didIteratorError4) {
          context$1$0.next = 77;
          break;
        }

        throw _iteratorError4;

      case 77:
        return context$1$0.finish(74);

      case 78:
        return context$1$0.finish(71);

      case 79:

        if (_lodash2['default'].isEmpty(apkStrings)) {
          _loggerJs2['default'].warn('No strings have been found in \'' + apk + '\' resources ' + ('for \'' + configMarker + '\' configuration'));
        } else {
          _loggerJs2['default'].info('Successfully extracted ' + _lodash2['default'].keys(apkStrings).length + ' strings from \'' + apk + '\' resources ' + ('for \'' + configMarker + '\' configuration'));
        }

        localPath = _path2['default'].resolve(out, 'strings.json');
        context$1$0.next = 83;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(out));

      case 83:
        context$1$0.next = 85;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(localPath, JSON.stringify(apkStrings, null, 2), 'utf-8'));

      case 85:
        return context$1$0.abrupt('return', { apkStrings: apkStrings, localPath: localPath });

      case 86:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 12], [34, 67, 71, 79], [72,, 74, 78]]);
};

/**
 * Get the language name of the device under test.
 *
 * @return {string} The name of device language.
 */
apkUtilsMethods.getDeviceLanguage = function callee$0$0() {
  var language;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        language = undefined;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.getApiLevel());

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!(context$1$0.t0 < 23)) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.getDeviceSysLanguage());

      case 7:
        language = context$1$0.sent;

        if (language) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.getDeviceProductLanguage());

      case 11:
        language = context$1$0.sent;

      case 12:
        context$1$0.next = 17;
        break;

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.getDeviceLocale());

      case 16:
        language = context$1$0.sent.split("-")[0];

      case 17:
        return context$1$0.abrupt('return', language);

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Set the language name of the device under test.
 *
 * @param {string} language - The name of the new device language.
 */
apkUtilsMethods.setDeviceLanguage = function callee$0$0(language) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.setDeviceSysLanguage(language));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Get the country name of the device under test.
 *
 * @return {string} The name of device country.
 */
apkUtilsMethods.getDeviceCountry = function callee$0$0() {
  var country;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getDeviceSysCountry());

      case 2:
        country = context$1$0.sent;

        if (country) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.getDeviceProductCountry());

      case 6:
        country = context$1$0.sent;

      case 7:
        return context$1$0.abrupt('return', country);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Set the country name of the device under test.
 *
 * @param {string} country - The name of the new device country.
 */
apkUtilsMethods.setDeviceCountry = function callee$0$0(country) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.setDeviceSysCountry(country));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Get the locale name of the device under test.
 *
 * @return {string} The name of device locale.
 */
apkUtilsMethods.getDeviceLocale = function callee$0$0() {
  var locale;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getDeviceSysLocale());

      case 2:
        locale = context$1$0.sent;

        if (locale) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.getDeviceProductLocale());

      case 6:
        locale = context$1$0.sent;

      case 7:
        return context$1$0.abrupt('return', locale);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Set the locale name of the device under test and the format of the locale is en-US, for example.
 * This method call setDeviceLanguageCountry, so, please use setDeviceLanguageCountry as possible.
 *
 * @param {string} locale - Names of the device language and the country connected with `-`. e.g. en-US.
 */
apkUtilsMethods.setDeviceLocale = function callee$0$0(locale) {
  var validateLocale, split_locale;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        validateLocale = new RegExp(/[a-zA-Z]+-[a-zA-Z0-9]+/);

        if (validateLocale.test(locale)) {
          context$1$0.next = 4;
          break;
        }

        _loggerJs2['default'].warn('setDeviceLocale requires the following format: en-US or ja-JP');
        return context$1$0.abrupt('return');

      case 4:
        split_locale = locale.split("-");
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.setDeviceLanguageCountry(split_locale[0], split_locale[1]));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Make sure current device locale is expected or not.
 *
 * @param {string} language - Language. The language field is case insensitive, but Locale always canonicalizes to lower case.
 * @param {string} country - Country. The language field is case insensitive, but Locale always canonicalizes to lower case.
 *
 * @return {boolean} If current locale is language and country as arguments, return true.
 */
apkUtilsMethods.ensureCurrentLocale = function callee$0$0(language, country) {
  var hasLanguage, hasCountry, apiLevel;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this3 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        hasLanguage = _lodash2['default'].isString(language);
        hasCountry = _lodash2['default'].isString(country);

        if (!(!hasLanguage && !hasCountry)) {
          context$1$0.next = 5;
          break;
        }

        _loggerJs2['default'].warn('ensureCurrentLocale requires language or country');
        return context$1$0.abrupt('return', false);

      case 5:

        // get lower case versions of the strings
        language = (language || '').toLowerCase();
        country = (country || '').toLowerCase();

        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getApiLevel());

      case 9:
        apiLevel = context$1$0.sent;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(5, 1000, function callee$1$0() {
          var curLanguage, curCountry, curLocale;
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.prev = 0;

                if (!(apiLevel < 23)) {
                  context$2$0.next = 19;
                  break;
                }

                curLanguage = undefined, curCountry = undefined;

                if (!hasLanguage) {
                  context$2$0.next = 9;
                  break;
                }

                context$2$0.next = 6;
                return _regeneratorRuntime.awrap(this.getDeviceLanguage());

              case 6:
                curLanguage = context$2$0.sent.toLowerCase();

                if (!(!hasCountry && language === curLanguage)) {
                  context$2$0.next = 9;
                  break;
                }

                return context$2$0.abrupt('return', true);

              case 9:
                if (!hasCountry) {
                  context$2$0.next = 15;
                  break;
                }

                context$2$0.next = 12;
                return _regeneratorRuntime.awrap(this.getDeviceCountry());

              case 12:
                curCountry = context$2$0.sent.toLowerCase();

                if (!(!hasLanguage && country === curCountry)) {
                  context$2$0.next = 15;
                  break;
                }

                return context$2$0.abrupt('return', true);

              case 15:
                if (!(language === curLanguage && country === curCountry)) {
                  context$2$0.next = 17;
                  break;
                }

                return context$2$0.abrupt('return', true);

              case 17:
                context$2$0.next = 24;
                break;

              case 19:
                context$2$0.next = 21;
                return _regeneratorRuntime.awrap(this.getDeviceLocale());

              case 21:
                curLocale = context$2$0.sent.toLowerCase();

                if (!(language + '-' + country === curLocale)) {
                  context$2$0.next = 24;
                  break;
                }

                return context$2$0.abrupt('return', true);

              case 24:
                return context$2$0.abrupt('return', false);

              case 27:
                context$2$0.prev = 27;
                context$2$0.t0 = context$2$0['catch'](0);

                // if there has been an error, restart adb and retry
                _loggerJs2['default'].error('Unable to check device localization: ' + context$2$0.t0.message);
                _loggerJs2['default'].debug('Restarting ADB and retrying...');
                context$2$0.next = 33;
                return _regeneratorRuntime.awrap(this.restartAdb());

              case 33:
                throw context$2$0.t0;

              case 34:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this3, [[0, 27]]);
        }));

      case 12:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Set the locale name of the device under test.
 *
 * @param {string} language - Language. The language field is case insensitive, but Locale always canonicalizes to lower case.
 *                            format: [a-zA-Z]{2,8}. e.g. en, ja : https://developer.android.com/reference/java/util/Locale.html
 * @param {string} country - Country. The country (region) field is case insensitive, but Locale always canonicalizes to upper case.
 *                            format: [a-zA-Z]{2} | [0-9]{3}. e.g. US, JP : https://developer.android.com/reference/java/util/Locale.html
 */
apkUtilsMethods.setDeviceLanguageCountry = function callee$0$0(language, country) {
  var hasLanguage, hasCountry, wasSettingChanged, apiLevel, curLanguage, curCountry, curLocale, locale;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        hasLanguage = language && _lodash2['default'].isString(language);
        hasCountry = country && _lodash2['default'].isString(country);

        if (!(!hasLanguage && !hasCountry)) {
          context$1$0.next = 6;
          break;
        }

        _loggerJs2['default'].warn('setDeviceLanguageCountry requires language or country.');
        _loggerJs2['default'].warn('Got language: \'' + language + '\' and country: \'' + country + '\'');
        return context$1$0.abrupt('return');

      case 6:
        wasSettingChanged = false;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getApiLevel());

      case 9:
        apiLevel = context$1$0.sent;

        language = (language || '').toLowerCase();
        country = (country || '').toUpperCase();

        if (!(apiLevel < 23)) {
          context$1$0.next = 29;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.getDeviceLanguage());

      case 15:
        curLanguage = context$1$0.sent.toLowerCase();
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(this.getDeviceCountry());

      case 18:
        curCountry = context$1$0.sent.toUpperCase();

        if (!(hasLanguage && language !== curLanguage)) {
          context$1$0.next = 23;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.setDeviceLanguage(language));

      case 22:
        wasSettingChanged = true;

      case 23:
        if (!(hasCountry && country !== curCountry)) {
          context$1$0.next = 27;
          break;
        }

        context$1$0.next = 26;
        return _regeneratorRuntime.awrap(this.setDeviceCountry(country));

      case 26:
        wasSettingChanged = true;

      case 27:
        context$1$0.next = 50;
        break;

      case 29:
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap(this.getDeviceLocale());

      case 31:
        curLocale = context$1$0.sent;

        if (!(apiLevel === 23)) {
          context$1$0.next = 42;
          break;
        }

        locale = undefined;

        if (!hasCountry) {
          locale = language;
        } else if (!hasLanguage) {
          locale = country;
        } else {
          locale = language + '-' + country;
        }

        _loggerJs2['default'].debug('Current locale: \'' + curLocale + '\'; requested locale: \'' + locale + '\'');

        if (!(locale.toLowerCase() !== curLocale.toLowerCase())) {
          context$1$0.next = 40;
          break;
        }

        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(this.setDeviceSysLocale(locale));

      case 39:
        wasSettingChanged = true;

      case 40:
        context$1$0.next = 50;
        break;

      case 42:
        if (!(!hasCountry || !hasLanguage)) {
          context$1$0.next = 46;
          break;
        }

        _loggerJs2['default'].warn('setDeviceLanguageCountry requires both language and country to be set for API 24+');
        _loggerJs2['default'].warn('Got language: \'' + language + '\' and country: \'' + country + '\'');
        return context$1$0.abrupt('return');

      case 46:

        _loggerJs2['default'].debug('Current locale: \'' + curLocale + '\'; requested locale: \'' + language + '-' + country + '\'');

        if (!((language + '-' + country).toLowerCase() !== curLocale.toLowerCase())) {
          context$1$0.next = 50;
          break;
        }

        context$1$0.next = 50;
        return _regeneratorRuntime.awrap(this.setDeviceSysLocaleViaSettingApp(language, country));

      case 50:
        if (!wasSettingChanged) {
          context$1$0.next = 54;
          break;
        }

        _loggerJs2['default'].info("Rebooting the device in order to apply new locale via 'setting persist.sys.locale' command.");
        context$1$0.next = 54;
        return _regeneratorRuntime.awrap(this.reboot());

      case 54:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Get the package name from local apk file.
 *
 * @param {string} apk - The full path to existing .apk package on the local
 *                       file system.
 * @return {string} The parsed package name or _null_ if it cannot be parsed.
 */
apkUtilsMethods.getPackageName = function callee$0$0(apk) {
  var args, _ref5, stdout, apkPackage;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        args = ['dump', 'badging', apk];
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.initAapt());

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.binaries.aapt, args));

      case 5:
        _ref5 = context$1$0.sent;
        stdout = _ref5.stdout;
        apkPackage = new RegExp(/package: name='([^']+)'/g).exec(stdout);

        if (apkPackage && apkPackage.length >= 2) {
          apkPackage = apkPackage[1];
        } else {
          apkPackage = null;
        }
        return context$1$0.abrupt('return', apkPackage);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * @typedef {Object} AppInfo
 * @property {string} name - Package name, for example 'com.acme.app'.
 * @property {number} versionCode - Version code.
 * @property {string} versionName - Version name, for example '1.0'.
 */

/**
 * Get the package info from local apk file.
 *
 * @param {string} apkPath - The full path to existing .apk package on the local
 *                           file system.
 * @return {?AppInfo} The parsed application information.
 */
apkUtilsMethods.getApkInfo = function callee$0$0(apkPath) {
  var _ref6, stdout, matches;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(apkPath));

      case 2:
        if (context$1$0.sent) {
          context$1$0.next = 4;
          break;
        }

        throw new Error('The file at path ' + apkPath + ' does not exist or is not accessible');

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.initAapt());

      case 6:
        context$1$0.prev = 6;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.binaries.aapt, ['d', 'badging', apkPath]));

      case 9:
        _ref6 = context$1$0.sent;
        stdout = _ref6.stdout;
        matches = new RegExp(/package: name='([^']+)' versionCode='(\d+)' versionName='([^']+)'/).exec(stdout);

        if (!matches) {
          context$1$0.next = 14;
          break;
        }

        return context$1$0.abrupt('return', {
          name: matches[1],
          versionCode: parseInt(matches[2], 10),
          versionName: matches[3]
        });

      case 14:
        context$1$0.next = 19;
        break;

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](6);

        _loggerJs2['default'].warn('Error "' + context$1$0.t0.message + '" while getting badging info');

      case 19:
        return context$1$0.abrupt('return', {});

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 16]]);
};

/**
 * Get the package info from the installed application.
 *
 * @param {string} pkg - The name of the installed package.
 * @return {?AppInfo} The parsed application information.
 */
apkUtilsMethods.getPackageInfo = function callee$0$0(pkg) {
  var result, stdout, versionNameMatch, versionCodeMatch;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Getting package info for \'' + pkg + '\'');
        result = { name: pkg };
        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.shell(['dumpsys', 'package', pkg]));

      case 5:
        stdout = context$1$0.sent;
        versionNameMatch = new RegExp(/versionName=([\d+\.]+)/).exec(stdout);

        if (versionNameMatch) {
          result.versionName = versionNameMatch[1];
        }
        versionCodeMatch = new RegExp(/versionCode=(\d+)/).exec(stdout);

        if (versionCodeMatch) {
          result.versionCode = parseInt(versionCodeMatch[1], 10);
        }
        return context$1$0.abrupt('return', result);

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](2);

        _loggerJs2['default'].warn('Error \'' + context$1$0.t0.message + '\' while dumping package info');

      case 16:
        return context$1$0.abrupt('return', result);

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 13]]);
};

exports['default'] = apkUtilsMethods;
module.exports = exports['default'];

// if the app is disabled on a real device it will throw a security exception
// https://regex101.com/r/xZ8vF7/1

// figure out the number of retries. Try once if waitMs is less that 750
// 30 times if parsing is not possible

// on some systems this will throw an error if the app already
// exists

// Check version names in case if version codes are not being updated properly

// this method is only used in API < 23

// this method is only used in API < 23

// this method is only used in API < 23

// this method is only used in API >= 23
// API >= 24
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstdXRpbHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozt5QkFBOEIsZUFBZTs7NEJBQ3hCLGNBQWM7O3dCQUNuQixjQUFjOzs7O29CQUNiLE1BQU07Ozs7c0JBQ1QsUUFBUTs7Ozt3QkFDUSxVQUFVOzs2QkFDUCxnQkFBZ0I7O3NCQUM5QixRQUFROzs7O2tCQUNaLElBQUk7Ozs7QUFFbkIsSUFBSSxlQUFlLEdBQUcsRUFBRSxDQUFDOzs7Ozs7OztBQVF6QixlQUFlLENBQUMsY0FBYyxHQUFHLG9CQUFnQixHQUFHO01BQzlDLFNBQVMsRUFHUCxNQUFNLEVBQ04sZUFBZTs7OztBQUpqQixpQkFBUyxHQUFHLEtBQUs7O0FBQ3JCLDhCQUFJLEtBQUssaUNBQStCLEdBQUcsQ0FBRyxDQUFDOzs7eUNBRTFCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQzs7O0FBQTFELGNBQU07QUFDTix1QkFBZSxHQUFHLElBQUksTUFBTSxlQUFhLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxRQUFLLEdBQUcsQ0FBQzs7QUFDbEYsaUJBQVMsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3pDLDhCQUFJLEtBQUssYUFBVSxDQUFDLFNBQVMsR0FBRyxNQUFNLEdBQUcsRUFBRSxDQUFBLGdCQUFhLENBQUM7NENBQ2xELFNBQVM7Ozs7O2NBRVYsSUFBSSxLQUFLLHlEQUF1RCxlQUFFLE9BQU8sQ0FBRzs7Ozs7OztDQUVyRixDQUFDOzs7Ozs7OztBQVFGLGVBQWUsQ0FBQyxRQUFRLEdBQUcsb0JBQWdCLEdBQUcsRUFBRSxHQUFHO01BSzNDLElBQUksRUFFRixHQUFHOzs7O2NBTlAsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUE7Ozs7O2NBQ1IsSUFBSSxLQUFLLENBQUMsd0NBQXdDLENB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QUFJLE9BQU8sa0NBQStCLENBQUM7Ozs0Q0FFekQsRUFBRTs7Ozs7OztDQUNWLENBQUM7Ozs7Ozs7O0FBUUYsZUFBZSxDQUFDLGNBQWMsR0FBRyxvQkFBZ0IsR0FBRztNQUU5QyxNQUFNLEVBRUYsTUFBTSxFQUNOLGdCQUFnQixFQUloQixnQkFBZ0I7Ozs7QUFSeEIsOEJBQUksS0FBSyxpQ0FBOEIsR0FBRyxRQUFJLENBQUM7QUFDM0MsY0FBTSxHQUFHLEVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBQzs7O3lDQUVELElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDOzs7QUFBdEQsY0FBTTtBQUNOLHdCQUFnQixHQUFHLElBQUksTUFBTSxDQUFDLHdCQUF3QixDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQzs7QUFDMUUsWUFBSSxnQkFBZ0IsRUFBRTtBQUNwQixnQkFBTSxDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxQztBQUNLLHdCQUFnQixHQUFHLElBQUksTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQzs7QUFDckUsWUFBSSxnQkFBZ0IsRUFBRTtBQUNwQixnQkFBTSxDQUFDLFdBQVcsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDeEQ7NENBQ00sTUFBTTs7Ozs7O0FBRWIsOEJBQUksSUFBSSxjQUFXLGVBQUksT0FBTyxtQ0FBK0IsQ0FBQzs7OzRDQUV6RCxNQUFNOzs7Ozs7O0NBQ2QsQ0FBQzs7cUJBRWEsZUFBZSIsImZpbGUiOiJsaWIvdG9vbHMvYXBrLXV0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYnVpbGRTdGFydENtZCB9IGZyb20gJy4uL2hlbHBlcnMuanMnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5cbmxldCBhcGtVdGlsc01ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBDaGVjayB3aGV0aGVyIHRoZSBwYXJ0aWN1bGFyIHBhY2thZ2UgaXMgcHJlc2VudCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBrZyAtIFRoZSBuYW1lIG9mIHRoZSBwYWNrYWdlIHRvIGNoZWNrLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgcGFja2FnZSBpcyBpbnN0YWxsZWQuXG4gKi9cbmFwa1V0aWxzTWV0aG9kcy5pc0FwcEluc3RhbGxlZCA9IGFzeW5jIGZ1bmN0aW9uIChwa2cpIHtcbiAgbGV0IGluc3RhbGxlZCA9IGZhbHNlO1xuICBsb2cuZGVidWcoYEdldHRpbmcgaW5zdGFsbCBzdGF0dXMgZm9yICR7cGtnfWApO1xuICB0cnkge1xuICAgIGxldCBzdGRvdXQgPSBhd2FpdCB0aGlzLnNoZWxsKFsncG0nLCAnbGlzdCcsICdwYWNrYWdlcycsIHBrZ10pO1xuICAgIGxldCBhcGtJbnN0YWxsZWRSZ3ggPSBuZXcgUmVnRXhwKGBecGFja2FnZToke3BrZy5yZXBsYWNlKC8oXFwuKS9nLCBcIlxcXFwkMVwiKX0kYCwgJ20nKTtcbiAgICBpbnN0YWxsZWQgPSBhcGtJbnN0YWxsZWRSZ3gudGVzdChzdGRvdXQpO1xuICAgIGxvZy5kZWJ1ZyhgQXBwIGlzJHshaW5zdGFsbGVkID8gJyBub3QnIDogJyd9IGluc3RhbGxlZGApO1xuICAgIHJldHVybiBpbnN0YWxsZWQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm9yIGZpbmRpbmcgaWYgYXBwIGlzIGluc3RhbGxlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIFN0YXJ0IHRoZSBwYXJ0aWN1bGFyIFVSSSBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHVyaSAtIFRoZSBuYW1lIG9mIFVSSSB0byBzdGFydC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgcGFja2FnZSB0byBzdGFydCB0aGUgVVJJIHdpdGguXG4gKi9cbmFwa1V0aWxzTWV0aG9kcy5zdGFydFVyaSA9IGFzeW5jIGZ1bmN0aW9uICh1cmksIHBrZykge1xuICBpZiAoIXVyaSB8fCAhcGtnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVVJJIGFuZCBwYWNrYWdlIGFyZ3VtZW50cyBhcmUgcmVxdWlyZWRcIik7XG4gIH1cbiAgdHJ5IHtcbiAgICBsZXQgYXJncyA9IFtcImFtXCIsIFwic3RhcnRcIiwgXCItV1wiLCBcIi1hXCIsIFwiYW5kcm9pZC5pbnRlbnQuYWN0aW9uLlZJRVdcIiwgXCItZFwiLFxuICAgICAgICAgICAgICAgIHVyaS5yZXBsYWNlKC8mL2csICdcXFxcJicpLCBwa2ddO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuc2hlbGwoYXJncyk7XG4gICAgaWYgKHJlcy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCd1bmFibGUgdG8gcmVzb2x2ZSBpbnRlbnQnKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKHJlcyk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBhdHRlbXB0aW5nIHRvIHN0YXJ0IFVSSS4gT3JpZ2luYWwgZXJyb3I6ICR7ZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBTdGFydCB0aGUgcGFydGljdWxhciBwYWNrYWdlIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqXG4gKiBAcGFyYW0ge29iamVjdH0gc3RhcnRBcHBPcHRpb25zIFt7fV0gLSBTdGFydHVwIG9wdGlvbnMgbWFwcGluZy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEl0IGlzIG1hbmRhdG9yeSB0aGF0ICdhY3Rpdml0eScgYW5kICdwa2cnIHByb3BlcnRpZXMgYXJlIHNldC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFkZGl0aW9uYWwgc3VwcG9ydGVkIHByb3BlcnRpZXMgYXJlOiAncmV0cnknLCAnc3RvcEFwcCcsICd3YWl0UGtnJ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5kICd3YWl0QWN0aXZpdHknLlxuICogQHJldHVybiB7c3RyaW5nfSBUaGUgb3V0cHV0IG9mIHRoZSBjb3JyZXNwb25kaW5nIGFkYiBjb21tYW5kLlxuICovXG5hcGtVdGlsc01ldGhvZHMuc3RhcnRBcHAgPSBhc3luYyBmdW5jdGlvbiAoc3RhcnRBcHBPcHRpb25zID0ge30pIHtcbiAgdHJ5IHtcbiAgICBpZiAoIXN0YXJ0QXBwT3B0aW9ucy5hY3Rpdml0eSB8fCAhc3RhcnRBcHBPcHRpb25zLnBrZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYWN0aXZpdHkgYW5kIHBrZyBpcyByZXF1aXJlZCBmb3IgbGF1bmNoaW5nIGFwcGxpY2F0aW9uXCIpO1xuICAgIH1cbiAgICBzdGFydEFwcE9wdGlvbnMgPSBfLmNsb25lKHN0YXJ0QXBwT3B0aW9ucyk7XG4gICAgc3RhcnRBcHBPcHRpb25zLmFjdGl2aXR5ID0gc3RhcnRBcHBPcHRpb25zLmFjdGl2aXR5LnJlcGxhY2UoJyQnLCAnXFxcXCQnKTtcblxuICAgIC8vIGluaXRpYWxpemluZyBkZWZhdWx0c1xuICAgIF8uZGVmYXVsdHMoc3RhcnRBcHBPcHRpb25zLCB7XG4gICAgICB3YWl0UGtnOiBzdGFydEFwcE9wdGlvbnMucGtnLFxuICAgICAgd2FpdEFjdGl2aXR5OiBmYWxzZSxcbiAgICAgIHJldHJ5OiB0cnVlLFxuICAgICAgc3RvcEFwcDogdHJ1ZVxuICAgIH0pO1xuICAgIC8vIHByZXZlbnRpbmcgbnVsbCB3YWl0cGtnXG4gICAgc3RhcnRBcHBPcHRpb25zLndhaXRQa2cgPSBzdGFydEFwcE9wdGlvbnMud2FpdFBrZyB8fCBzdGFydEFwcE9wdGlvbnMucGtnO1xuICAgIGxldCBhcGlMZXZlbCA9IGF3YWl0IHRoaXMuZ2V0QXBpTGV2ZWwoKTtcbiAgICBsZXQgY21kID0gYnVpbGRTdGFydENtZChzdGFydEFwcE9wdGlvbnMsIGFwaUxldmVsKTtcbiAgICBsZXQgc3Rkb3V0ID0gYXdhaXQgdGhpcy5zaGVsbChjbWQpO1xuICAgIGlmIChzdGRvdXQuaW5kZXhPZihcIkVycm9yOiBBY3Rpdml0eSBjbGFzc1wiKSAhPT0gLTEgJiZcbiAgICAgICAgc3Rkb3V0LmluZGV4T2YoXCJkb2VzIG5vdCBleGlzdFwiKSAhPT0gLTEpIHtcbiAgICAgIGlmIChzdGFydEFwcE9wdGlvbnMucmV0cnkgJiYgc3RhcnRBcHBPcHRpb25zLmFjdGl2aXR5WzBdICE9PSBcIi5cIikge1xuICAgICAgICBsb2cuZGVidWcoXCJXZSB0cmllZCB0byBzdGFydCBhbiBhY3Rpdml0eSB0aGF0IGRvZXNuJ3QgZXhpc3QsIFwiICtcbiAgICAgICAgICAgICAgICAgIFwicmV0cnlpbmcgd2l0aCAuIHByZXBlbmRlZCB0byBhY3Rpdml0eVwiKTtcbiAgICAgICAgc3RhcnRBcHBPcHRpb25zLmFjdGl2aXR5ID0gYC4ke3N0YXJ0QXBwT3B0aW9ucy5hY3Rpdml0eX1gO1xuICAgICAgICBzdGFydEFwcE9wdGlvbnMucmV0cnkgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnRBcHAoc3RhcnRBcHBPcHRpb25zKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFjdGl2aXR5IHVzZWQgdG8gc3RhcnQgYXBwIGRvZXNuJ3QgZXhpc3Qgb3IgY2Fubm90IGJlIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsYXVuY2hlZCEgTWFrZSBzdXJlIGl0IGV4aXN0cyBhbmQgaXMgYSBsYXVuY2hhYmxlIGFjdGl2aXR5XCIpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc3Rkb3V0LmluZGV4T2YoXCJqYXZhLmxhbmcuU2VjdXJpdHlFeGNlcHRpb25cIikgIT09IC0xKSB7XG4gICAgICAvLyBpZiB0aGUgYXBwIGlzIGRpc2FibGVkIG9uIGEgcmVhbCBkZXZpY2UgaXQgd2lsbCB0aHJvdyBhIHNlY3VyaXR5IGV4Y2VwdGlvblxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGVybWlzc2lvbiB0byBzdGFydCBhY3Rpdml0eSBkZW5pZWQuXCIpO1xuICAgIH1cbiAgICBpZiAoc3RhcnRBcHBPcHRpb25zLndhaXRBY3Rpdml0eSkge1xuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yQWN0aXZpdHkoc3RhcnRBcHBPcHRpb25zLndhaXRQa2csIHN0YXJ0QXBwT3B0aW9ucy53YWl0QWN0aXZpdHksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydEFwcE9wdGlvbnMud2FpdER1cmF0aW9uKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm9yIG9jY3VyZWQgd2hpbGUgc3RhcnRpbmcgQXBwLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUGFja2FnZUFjdGl2aXR5SW5mb1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBhcHBQYWNrYWdlIC0gVGhlIG5hbWUgb2YgYXBwbGljYXRpb24gcGFja2FnZSxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBleGFtcGxlICdjb20uYWNtZS5hcHAnLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBhcHBBY3Rpdml0eSAtIFRoZSBuYW1lIG9mIG1haW4gYXBwbGljYXRpb24gYWN0aXZpdHkuXG4gKi9cblxuLyoqXG4gKiBHZXQgdGhlIG5hbWUgb2YgY3VycmVudGx5IGZvY3VzZWQgcGFja2FnZSBhbmQgYWN0aXZpdHkuXG4gKlxuICogQHJldHVybiB7UGFja2FnZUFjdGl2aXR5SW5mb30gVGhlIG1hcHBpbmcsIHdoZXJlIHByb3BlcnR5IG5hbWVzIGFyZSAnYXBwUGFja2FnZScgYW5kICdhcHBBY3Rpdml0eScuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgaXMgYW4gZXJyb3Igd2hpbGUgcGFyc2luZyB0aGUgZGF0YS5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLmdldEZvY3VzZWRQYWNrYWdlQW5kQWN0aXZpdHkgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZy5kZWJ1ZyhcIkdldHRpbmcgZm9jdXNlZCBwYWNrYWdlIGFuZCBhY3Rpdml0eVwiKTtcbiAgbGV0IGNtZCA9IFsnZHVtcHN5cycsICd3aW5kb3cnLCAnd2luZG93cyddO1xuICBsZXQgbnVsbFJlID0gbmV3IFJlZ0V4cCgvbUZvY3VzZWRBcHA9bnVsbC8pO1xuICBsZXQgc2VhcmNoUmUgPSBuZXcgUmVnRXhwKCdtRm9jdXNlZEFwcC4rUmVjb3JkXFxcXHsuKlxcXFxzKFteXFxcXHNcXFxcL1xcXFx9XSspJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1xcXFwvKFteXFxcXHNcXFxcL1xcXFx9XFxcXCxdKylcXFxcLD8oXFxcXHNbXlxcXFxzXFxcXC9cXFxcfV0rKSpcXFxcfScpOyAvLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yL3haOHZGNy8xXG4gIHRyeSB7XG4gICAgbGV0IHN0ZG91dCA9IGF3YWl0IHRoaXMuc2hlbGwoY21kKTtcbiAgICBsZXQgZm91bmROdWxsTWF0Y2ggPSBmYWxzZTtcbiAgICBmb3IgKGxldCBsaW5lIG9mIHN0ZG91dC5zcGxpdChcIlxcblwiKSkge1xuICAgICAgbGV0IGZvdW5kTWF0Y2ggPSBzZWFyY2hSZS5leGVjKGxpbmUpO1xuICAgICAgaWYgKGZvdW5kTWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIHthcHBQYWNrYWdlOiBmb3VuZE1hdGNoWzFdLnRyaW0oKSwgYXBwQWN0aXZpdHk6IGZvdW5kTWF0Y2hbMl0udHJpbSgpfTtcbiAgICAgIH0gZWxzZSBpZiAobnVsbFJlLnRlc3QobGluZSkpIHtcbiAgICAgICAgZm91bmROdWxsTWF0Y2ggPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoZm91bmROdWxsTWF0Y2gpIHtcbiAgICAgIHJldHVybiB7YXBwUGFja2FnZTogbnVsbCwgYXBwQWN0aXZpdHk6IG51bGx9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgcGFyc2UgYWN0aXZpdHkgZnJvbSBkdW1wc3lzXCIpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGdldCBmb2N1c1BhY2thZ2VBbmRBY3Rpdml0eS4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIFdhaXQgZm9yIHRoZSBnaXZlbiBhY3Rpdml0eSB0byBiZSBmb2N1c2VkL25vbi1mb2N1c2VkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgcGFja2FnZSB0byB3YWl0IGZvci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhY3Rpdml0eSAtIFRoZSBuYW1lIG9mIHRoZSBhY3Rpdml0eSwgYmVsb25naW5nIHRvIHRoYXQgcGFja2FnZSxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHdhaXQgZm9yLlxuICogQHBhcmFtIHtib29sZWFufSB3YWl0Rm9yU3RvcCAtIFdoZXRoZXIgdG8gd2FpdCB1bnRpbCB0aGUgYWN0aXZpdHkgaXMgZm9jdXNlZCAodHJ1ZSlcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBpcyBub3QgZm9jdXNlZCAoZmFsc2UpLlxuICogQHBhcmFtIHtudW1iZXJ9IHdhaXRNcyBbMjAwMDBdIC0gTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IGJlZm9yZSB0aW1lb3V0IG9jY3Vycy5cbiAqIEB0aHJvd3Mge2Vycm9yfSBJZiB0aW1lb3V0IGhhcHBlbnMuXG4gKi9cbmFwa1V0aWxzTWV0aG9kcy53YWl0Rm9yQWN0aXZpdHlPck5vdCA9IGFzeW5jIGZ1bmN0aW9uIChwa2csIGFjdGl2aXR5LCB3YWl0Rm9yU3RvcCwgd2FpdE1zID0gMjAwMDApIHtcbiAgaWYgKCFwa2cgfHwgIWFjdGl2aXR5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdQYWNrYWdlIGFuZCBhY3Rpdml0eSByZXF1aXJlZC4nKTtcbiAgfVxuICBsb2cuZGVidWcoYFdhaXRpbmcgdXAgdG8gJHt3YWl0TXN9bXMgZm9yIGFjdGl2aXR5IG1hdGNoaW5nIHBrZzogJyR7cGtnfScgYW5kIGAgK1xuICAgICAgICAgICAgYGFjdGl2aXR5OiAnJHthY3Rpdml0eX0nIHRvJHt3YWl0Rm9yU3RvcCA/ICcgbm90JyA6ICcnfSBiZSBmb2N1c2VkYCk7XG5cbiAgY29uc3Qgc3BsaXROYW1lcyA9IChuYW1lcykgPT4gbmFtZXMuc3BsaXQoJywnKS5tYXAoKG5hbWUpID0+IG5hbWUudHJpbSgpKTtcblxuICBjb25zdCBhbGxQYWNrYWdlcyA9IHNwbGl0TmFtZXMocGtnKTtcbiAgY29uc3QgYWxsQWN0aXZpdGllcyA9IHNwbGl0TmFtZXMoYWN0aXZpdHkpO1xuXG4gIGxldCBwb3NzaWJsZUFjdGl2aXR5TmFtZXMgPSBbXTtcbiAgZm9yIChsZXQgb25lQWN0aXZpdHkgb2YgYWxsQWN0aXZpdGllcykge1xuICAgIGlmIChvbmVBY3Rpdml0eS5zdGFydHNXaXRoKCcuJykpIHtcbiAgICAgIC8vIGFkZCB0aGUgcGFja2FnZSBuYW1lIGlmIGFjdGl2aXR5IGlzIG5vdCBmdWxsIHF1YWxpZmllZFxuICAgICAgZm9yIChsZXQgY3VycmVudFBrZyBvZiBhbGxQYWNrYWdlcykge1xuICAgICAgICBwb3NzaWJsZUFjdGl2aXR5TmFtZXMucHVzaChgJHtjdXJyZW50UGtnfSR7b25lQWN0aXZpdHl9YC5yZXBsYWNlKC9cXC4rL2csICcuJykpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBhY2NlcHQgZnVsbHkgcXVhbGlmaWVkIGFjdGl2aXR5IG5hbWUuXG4gICAgICBwb3NzaWJsZUFjdGl2aXR5TmFtZXMucHVzaChvbmVBY3Rpdml0eSk7XG4gICAgICBwb3NzaWJsZUFjdGl2aXR5TmFtZXMucHVzaChgJHtwa2d9LiR7b25lQWN0aXZpdHl9YCk7XG4gICAgfVxuICB9XG4gIC8qIGpzaGludCBpZ25vcmU6c3RhcnQgKi9cbiAgbG9nLmRlYnVnKGBQb3NzaWJsZSBhY3Rpdml0aWVzLCB0byBiZSBjaGVja2VkOiAke3Bvc3NpYmxlQWN0aXZpdHlOYW1lcy5tYXAoKG5hbWUpID0+IGAnJHtuYW1lfSdgKS5qb2luKCcsICcpfWApO1xuICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqL1xuICBsZXQgcG9zc2libGVBY3Rpdml0eVBhdHRlcm5zID0gcG9zc2libGVBY3Rpdml0eU5hbWVzLm1hcCgocG9zc2libGVBY3Rpdml0eU5hbWUpID0+XG4gICAgbmV3IFJlZ0V4cChgXiR7cG9zc2libGVBY3Rpdml0eU5hbWUucmVwbGFjZSgvXFwuL2csICdcXFxcLicpLnJlcGxhY2UoL1xcKi9nLCAnLio/JykucmVwbGFjZSgvXFwkL2csICdcXFxcJCcpfSRgKVxuICApO1xuXG4gIC8vIGZpZ3VyZSBvdXQgdGhlIG51bWJlciBvZiByZXRyaWVzLiBUcnkgb25jZSBpZiB3YWl0TXMgaXMgbGVzcyB0aGF0IDc1MFxuICAvLyAzMCB0aW1lcyBpZiBwYXJzaW5nIGlzIG5vdCBwb3NzaWJsZVxuICBsZXQgcmV0cmllcyA9IHBhcnNlSW50KHdhaXRNcyAvIDc1MCwgMTApIHx8IDE7XG4gIHJldHJpZXMgPSBpc05hTihyZXRyaWVzKSA/IDMwIDogcmV0cmllcztcbiAgYXdhaXQgcmV0cnlJbnRlcnZhbChyZXRyaWVzLCA3NTAsIGFzeW5jICgpID0+IHtcbiAgICBsZXQge2FwcFBhY2thZ2UsIGFwcEFjdGl2aXR5fSA9IGF3YWl0IHRoaXMuZ2V0Rm9jdXNlZFBhY2thZ2VBbmRBY3Rpdml0eSgpO1xuICAgIGlmIChhcHBBY3Rpdml0eSAmJiBhcHBQYWNrYWdlKSB7XG4gICAgICBsZXQgZnVsbHlRdWFsaWZpZWRBY3Rpdml0eSA9IGFwcEFjdGl2aXR5LnN0YXJ0c1dpdGgoJy4nKSA/IGAke2FwcFBhY2thZ2V9JHthcHBBY3Rpdml0eX1gIDogYXBwQWN0aXZpdHk7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIHBhY2thZ2U6ICcke2FwcFBhY2thZ2V9JyBhbmQgZnVsbHkgcXVhbGlmaWVkIGFjdGl2aXR5IG5hbWUgOiAnJHtmdWxseVF1YWxpZmllZEFjdGl2aXR5fSdgKTtcbiAgICAgIGxldCBmb3VuZEFjdCA9IChfLmluY2x1ZGVzKGFsbFBhY2thZ2VzLCBhcHBQYWNrYWdlKSAmJlxuICAgICAgICAgICAgICAgICAgICAgIF8uZmluZEluZGV4KHBvc3NpYmxlQWN0aXZpdHlQYXR0ZXJucywgKHBvc3NpYmxlUGF0dGVybikgPT4gcG9zc2libGVQYXR0ZXJuLnRlc3QoZnVsbHlRdWFsaWZpZWRBY3Rpdml0eSkpICE9PSAtMSk7XG4gICAgICBpZiAoKCF3YWl0Rm9yU3RvcCAmJiBmb3VuZEFjdCkgfHwgKHdhaXRGb3JTdG9wICYmICFmb3VuZEFjdCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBsb2cuZGVidWcoJ0luY29ycmVjdCBwYWNrYWdlIGFuZCBhY3Rpdml0eS4gUmV0cnlpbmcuJyk7XG4gICAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqL1xuICAgIHRocm93IG5ldyBFcnJvcihgJHtwb3NzaWJsZUFjdGl2aXR5TmFtZXMubWFwKChuYW1lKSA9PiBgJyR7bmFtZX0nYCkuam9pbignIG9yICcpfSBuZXZlciAke3dhaXRGb3JTdG9wID8gJ3N0b3BwZWQnIDogJ3N0YXJ0ZWQnfWApO1xuICAgIC8qIGpzaGludCBpZ25vcmU6ZW5kICovXG4gIH0pO1xufTtcblxuLyoqXG4gKiBXYWl0IGZvciB0aGUgZ2l2ZW4gYWN0aXZpdHkgdG8gYmUgZm9jdXNlZFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgcGFja2FnZSB0byB3YWl0IGZvci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhY3Rpdml0eSAtIFRoZSBuYW1lIG9mIHRoZSBhY3Rpdml0eSwgYmVsb25naW5nIHRvIHRoYXQgcGFja2FnZSxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHdhaXQgZm9yLlxuICogQHBhcmFtIHtudW1iZXJ9IHdhaXRNcyBbMjAwMDBdIC0gTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IGJlZm9yZSB0aW1lb3V0IG9jY3Vycy5cbiAqIEB0aHJvd3Mge2Vycm9yfSBJZiB0aW1lb3V0IGhhcHBlbnMuXG4gKi9cbmFwa1V0aWxzTWV0aG9kcy53YWl0Rm9yQWN0aXZpdHkgPSBhc3luYyBmdW5jdGlvbiAocGtnLCBhY3QsIHdhaXRNcyA9IDIwMDAwKSB7XG4gIGF3YWl0IHRoaXMud2FpdEZvckFjdGl2aXR5T3JOb3QocGtnLCBhY3QsIGZhbHNlLCB3YWl0TXMpO1xufTtcblxuLyoqXG4gKiBXYWl0IGZvciB0aGUgZ2l2ZW4gYWN0aXZpdHkgdG8gYmUgbm9uLWZvY3VzZWQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBrZyAtIFRoZSBuYW1lIG9mIHRoZSBwYWNrYWdlIHRvIHdhaXQgZm9yLlxuICogQHBhcmFtIHtzdHJpbmd9IGFjdGl2aXR5IC0gVGhlIG5hbWUgb2YgdGhlIGFjdGl2aXR5LCBiZWxvbmdpbmcgdG8gdGhhdCBwYWNrYWdlLFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gd2FpdCBmb3IuXG4gKiBAcGFyYW0ge251bWJlcn0gd2FpdE1zIFsyMDAwMF0gLSBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgYmVmb3JlIHRpbWVvdXQgb2NjdXJzLlxuICogQHRocm93cyB7ZXJyb3J9IElmIHRpbWVvdXQgaGFwcGVucy5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLndhaXRGb3JOb3RBY3Rpdml0eSA9IGFzeW5jIGZ1bmN0aW9uIChwa2csIGFjdCwgd2FpdE1zID0gMjAwMDApIHtcbiAgYXdhaXQgdGhpcy53YWl0Rm9yQWN0aXZpdHlPck5vdChwa2csIGFjdCwgdHJ1ZSwgd2FpdE1zKTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gVW5pbnN0YWxsT3B0aW9uc1xuICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVvdXQgWzIwMDAwXSAtIFRoZSBjb3VudCBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAgaXMgdW5pbnN0YWxsZWQuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGtlZXBEYXRhIFtmYWxzZV0gLSBTZXQgdG8gdHJ1ZSBpbiBvcmRlciB0byBrZWVwIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gZGF0YSBhbmQgY2FjaGUgZm9sZGVycyBhZnRlciB1bmluc3RhbGwuXG4gKi9cblxuY29uc3QgQVBLX1VOSU5TVEFMTF9USU1FT1VUID0gMjAwMDA7XG5cbi8qKlxuICogVW5pbnN0YWxsIHRoZSBnaXZlbiBwYWNrYWdlIGZyb20gdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgcGFja2FnZSB0byBiZSB1bmluc3RhbGxlZC5cbiAqIEBwYXJhbSB7P1VuaW5zdGFsbE9wdGlvbnN9IG9wdGlvbnMgLSBUaGUgc2V0IG9mIHVuaW5zdGFsbGF0aW9uIG9wdGlvbnMuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBwYWNrYWdlIHdhcyBmb3VuZCBvbiB0aGUgZGV2aWNlIGFuZFxuICogICAgICAgICAgICAgICAgICAgc3VjY2Vzc2Z1bGx5IHVuaW5zdGFsbGVkLlxuICovXG5hcGtVdGlsc01ldGhvZHMudW5pbnN0YWxsQXBrID0gYXN5bmMgZnVuY3Rpb24gKHBrZywgb3B0aW9ucyA9IHt9KSB7XG4gIGxvZy5kZWJ1ZyhgVW5pbnN0YWxsaW5nICR7cGtnfWApO1xuICBpZiAoIWF3YWl0IHRoaXMuaXNBcHBJbnN0YWxsZWQocGtnKSkge1xuICAgIGxvZy5pbmZvKGAke3BrZ30gd2FzIG5vdCB1bmluc3RhbGxlZCwgYmVjYXVzZSBpdCB3YXMgbm90IHByZXNlbnQgb24gdGhlIGRldmljZWApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGxldCB0aW1lb3V0ID0gQVBLX1VOSU5TVEFMTF9USU1FT1VUO1xuICBpZiAodXRpbC5oYXNWYWx1ZShvcHRpb25zLnRpbWVvdXQpICYmICFpc05hTihvcHRpb25zLnRpbWVvdXQpKSB7XG4gICAgdGltZW91dCA9IHBhcnNlSW50KG9wdGlvbnMudGltZW91dCwgMTApO1xuICB9XG4gIGNvbnN0IGNtZCA9IFsndW5pbnN0YWxsJ107XG4gIGlmIChvcHRpb25zLmtlZXBEYXRhKSB7XG4gICAgY21kLnB1c2goJy1rJyk7XG4gIH1cbiAgY21kLnB1c2gocGtnKTtcblxuICBsZXQgc3Rkb3V0O1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuZm9yY2VTdG9wKHBrZyk7XG4gICAgc3Rkb3V0ID0gKGF3YWl0IHRoaXMuYWRiRXhlYyhjbWQsIHt0aW1lb3V0fSkpLnRyaW0oKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHVuaW5zdGFsbCBBUEsuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxuICBsb2cuZGVidWcoYCdhZGIgJHtjbWQuam9pbignICcpfScgY29tbWFuZCBvdXRwdXQ6ICR7c3Rkb3V0fWApO1xuICBpZiAoc3Rkb3V0LmluY2x1ZGVzKFwiU3VjY2Vzc1wiKSkge1xuICAgIGxvZy5pbmZvKGAke3BrZ30gd2FzIHN1Y2Nlc3NmdWxseSB1bmluc3RhbGxlZGApO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGxvZy5pbmZvKGAke3BrZ30gd2FzIG5vdCB1bmluc3RhbGxlZGApO1xuICByZXR1cm4gZmFsc2U7XG59O1xuXG4vKipcbiAqIEluc3RhbGwgdGhlIHBhY2thZ2UgYWZ0ZXIgaXQgd2FzIHB1c2hlZCB0byB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwa1BhdGhPbkRldmljZSAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIHBhY2thZ2Ugb24gdGhlIGRldmljZSBmaWxlIHN5c3RlbS5cbiAqIEBwYXJhbSB7b2JqZWN0fSBvcHRzIFt7fV0gLSBBZGRpdGlvbmFsIGV4ZWMgb3B0aW9ucy4gU2VlIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL25vZGUtdGVlbl9wcm9jZXNzfVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBtb3JlIGRldGFpbHMgb24gdGhpcyBwYXJhbWV0ZXIuXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgdGhlcmUgd2FzIGEgZmFpbHVyZSBkdXJpbmcgYXBwbGljYXRpb24gaW5zdGFsbC5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLmluc3RhbGxGcm9tRGV2aWNlUGF0aCA9IGFzeW5jIGZ1bmN0aW9uIChhcGtQYXRoT25EZXZpY2UsIG9wdHMgPSB7fSkge1xuICBsZXQgc3Rkb3V0ID0gYXdhaXQgdGhpcy5zaGVsbChbJ3BtJywgJ2luc3RhbGwnLCAnLXInLCBhcGtQYXRoT25EZXZpY2VdLCBvcHRzKTtcbiAgaWYgKHN0ZG91dC5pbmRleE9mKFwiRmFpbHVyZVwiKSAhPT0gLTEpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFJlbW90ZSBpbnN0YWxsIGZhaWxlZDogJHtzdGRvdXR9YCk7XG4gIH1cbn07XG5cbmNvbnN0IEFQS19JTlNUQUxMX1RJTUVPVVQgPSA2MDAwMDtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBJbnN0YWxsT3B0aW9uc1xuICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVvdXQgWzYwMDAwXSAtIFRoZSBjb3VudCBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAgaXMgaW5zdGFsbGVkLlxuICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd1Rlc3RQYWNrYWdlcyBbZmFsc2VdIC0gU2V0IHRvIHRydWUgaW4gb3JkZXIgdG8gYWxsb3cgdGVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFja2FnZXMgaW5zdGFsbGF0aW9uLlxuICogQHByb3BlcnR5IHtib29sZWFufSB1c2VTZGNhcmQgW2ZhbHNlXSAtIFNldCB0byB0cnVlIHRvIGluc3RhbGwgdGhlIGFwcCBvbiBzZGNhcmRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0ZWFkIG9mIHRoZSBkZXZpY2UgbWVtb3J5LlxuICogQHByb3BlcnR5IHtib29sZWFufSBncmFudFBlcm1pc3Npb25zIFtmYWxzZV0gLSBTZXQgdG8gdHJ1ZSBpbiBvcmRlciB0byBncmFudCBhbGwgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zIHJlcXVlc3RlZCBpbiB0aGUgYXBwbGljYXRpb24ncyBtYW5pZmVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvbWF0aWNhbGx5IGFmdGVyIHRoZSBpbnN0YWxsYXRpb24gaXMgY29tcGxldGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVyIEFuZHJvaWQgNisuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlcGxhY2UgW3RydWVdIC0gU2V0IGl0IHRvIGZhbHNlIGlmIHlvdSBkb24ndCB3YW50XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIGFwcGxpY2F0aW9uIHRvIGJlIHVwZ3JhZGVkL3JlaW5zdGFsbGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXQgaXMgYWxyZWFkeSBwcmVzZW50IG9uIHRoZSBkZXZpY2UuXG4gKi9cblxuLyoqXG4gKiBJbnN0YWxsIHRoZSBwYWNrYWdlIGZyb20gdGhlIGxvY2FsIGZpbGUgc3lzdGVtLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBwYWNrYWdlLlxuICogQHBhcmFtIHtib29sZWFufSByZXBhbGNlIFt0cnVlXSAtIFdoZXRoZXIgdG8gcmVwbGFjZSB0aGUgcGFja2FnZSBpZiBpdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscmVhZHkgaW5zdGFsbGVkLiBUcnVlIGJ5IGRlZmF1bHQuXG4gKiBAcGFyYW0gez9JbnN0YWxsT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBzZXQgb2YgaW5zdGFsbGF0aW9uIG9wdGlvbnMuXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgYW4gdW5leHBlY3RlZCBlcnJvciBoYXBwZW5zIGR1cmluZyBpbnN0YWxsLlxuICovXG5hcGtVdGlsc01ldGhvZHMuaW5zdGFsbCA9IGFzeW5jIGZ1bmN0aW9uIChhcGssIG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIXV0aWwuaGFzVmFsdWUob3B0aW9ucy5yZXBsYWNlKSkge1xuICAgIG9wdGlvbnMucmVwbGFjZSA9IHRydWU7XG4gIH1cbiAgbGV0IHRpbWVvdXQgPSBBUEtfSU5TVEFMTF9USU1FT1VUO1xuICBpZiAodXRpbC5oYXNWYWx1ZShvcHRpb25zLnRpbWVvdXQpICYmICFpc05hTihvcHRpb25zLnRpbWVvdXQpKSB7XG4gICAgdGltZW91dCA9IHBhcnNlSW50KG9wdGlvbnMudGltZW91dCwgMTApO1xuICB9XG5cbiAgY29uc3QgYWRkaXRpb25hbEFyZ3MgPSBbXTtcbiAgaWYgKG9wdGlvbnMuYWxsb3dUZXN0UGFja2FnZXMpIHtcbiAgICBhZGRpdGlvbmFsQXJncy5wdXNoKCctdCcpO1xuICB9XG4gIGlmIChvcHRpb25zLnVzZVNkY2FyZCkge1xuICAgIGFkZGl0aW9uYWxBcmdzLnB1c2goJy1zJyk7XG4gIH1cbiAgaWYgKG9wdGlvbnMuZ3JhbnRQZXJtaXNzaW9ucykge1xuICAgIGNvbnN0IGFwaUxldmVsID0gYXdhaXQgdGhpcy5nZXRBcGlMZXZlbCgpO1xuICAgIGlmIChhcGlMZXZlbCA8IDIzKSB7XG4gICAgICBsb2cuZGVidWcoYFNraXBwaW5nIGdyYW50aW5nIHBlcm1pc3Npb25zIGZvciAnJHthcGt9Jywgc2luY2UgYCArXG4gICAgICAgICAgICAgICAgYHRoZSBjdXJyZW50IEFQSSBsZXZlbCAke2FwaUxldmVsfSBkb2VzIG5vdCBzdXBwb3J0IGFwcGxpY2F0aW9ucyBgICtcbiAgICAgICAgICAgICAgICBgcGVybWlzc2lvbnMgY3VzdG9taXphdGlvbmApO1xuICAgIH0gZWxzZSB7XG4gICAgICBhZGRpdGlvbmFsQXJncy5wdXNoKCctZycpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGV4ZWN1dGVJbnN0YWxsID0gYXN5bmMgKGFyZ3MpID0+IHtcbiAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCB0aGlzLmFkYkV4ZWMoWydpbnN0YWxsJywgLi4uYXJncywgYXBrXSwge3RpbWVvdXR9KTtcbiAgICBjb25zdCB0cnVuY2F0ZWRPdXRwdXQgPSAoIV8uaXNTdHJpbmcob3V0cHV0KSB8fCBvdXRwdXQubGVuZ3RoIDw9IDMwMCkgP1xuICAgICAgb3V0cHV0IDogYCR7b3V0cHV0LnN1YnN0cigwLCAxNTApfS4uLiR7b3V0cHV0LnN1YnN0cihvdXRwdXQubGVuZ3RoIC0gMTUwKX1gO1xuICAgIGxvZy5kZWJ1ZyhgSW5zdGFsbCBjb21tYW5kIHN0ZG91dDogJHt0cnVuY2F0ZWRPdXRwdXR9YCk7XG4gICAgaWYgKF8uaXNTdHJpbmcob3V0cHV0KSAmJiBvdXRwdXQuaW5jbHVkZXMoJ0lOU1RBTExfRkFJTEVEJykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihvdXRwdXQpO1xuICAgIH1cbiAgfTtcblxuICBpZiAob3B0aW9ucy5yZXBsYWNlKSB7XG4gICAgcmV0dXJuIGF3YWl0IGV4ZWN1dGVJbnN0YWxsKFsnLXInLCAuLi5hZGRpdGlvbmFsQXJnc10pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjdXRlSW5zdGFsbChhZGRpdGlvbmFsQXJncyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIG9uIHNvbWUgc3lzdGVtcyB0aGlzIHdpbGwgdGhyb3cgYW4gZXJyb3IgaWYgdGhlIGFwcCBhbHJlYWR5XG4gICAgLy8gZXhpc3RzXG4gICAgaWYgKCFlcnIubWVzc2FnZS5pbmNsdWRlcygnSU5TVEFMTF9GQUlMRURfQUxSRUFEWV9FWElTVFMnKSkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEFwcGxpY2F0aW9uICcke2Fwa30nIGFscmVhZHkgaW5zdGFsbGVkLiBDb250aW51aW5nLmApO1xuICB9XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEluc3RhbGxPclVwZ3JhZGVPcHRpb25zXG4gKiBAcHJvcGVydHkge251bWJlcn0gdGltZW91dCBbNjAwMDBdIC0gVGhlIGNvdW50IG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcCBpcyBpbnN0YWxsZWQuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsbG93VGVzdFBhY2thZ2VzIFtmYWxzZV0gLSBTZXQgdG8gdHJ1ZSBpbiBvcmRlciB0byBhbGxvdyB0ZXN0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWNrYWdlcyBpbnN0YWxsYXRpb24uXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzZVNkY2FyZCBbZmFsc2VdIC0gU2V0IHRvIHRydWUgdG8gaW5zdGFsbCB0aGUgYXBwIG9uIHNkY2FyZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RlYWQgb2YgdGhlIGRldmljZSBtZW1vcnkuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGdyYW50UGVybWlzc2lvbnMgW2ZhbHNlXSAtIFNldCB0byB0cnVlIGluIG9yZGVyIHRvIGdyYW50IGFsbCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVybWlzc2lvbnMgcmVxdWVzdGVkIGluIHRoZSBhcHBsaWNhdGlvbidzIG1hbmlmZXN0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9tYXRpY2FsbHkgYWZ0ZXIgdGhlIGluc3RhbGxhdGlvbiBpcyBjb21wbGV0ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5kZXIgQW5kcm9pZCA2Ky5cbiAqL1xuXG4vKipcbiAqIEluc3RhbGwgdGhlIHBhY2thZ2UgZnJvbSB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gb2YgdXBncmFkZSBpdCBpZiBhbiBvbGRlclxuICogdmVyc2lvbiBvZiB0aGUgc2FtZSBwYWNrYWdlIGlzIGFscmVhZHkgaW5zdGFsbGVkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBwYWNrYWdlLlxuICogQHBhcmFtIHs/c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFsbGVkIHBhY2thZ2UuIFRoZSBtZXRob2Qgd2lsbFxuICogICAgICAgICAgICAgICAgICAgICAgICBwZXJmb3JtIGZhc3RlciBpZiBpdCBpcyBzZXQuXG4gKiBAcGFyYW0gez9JbnN0YWxsT3JVcGdyYWRlT3B0aW9uc30gb3B0aW9ucyAtIFNldCBvZiBpbnN0YWxsIG9wdGlvbnMuXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgYW4gdW5leHBlY3RlZCBlcnJvciBoYXBwZW5zIGR1cmluZyBpbnN0YWxsLlxuICovXG5hcGtVdGlsc01ldGhvZHMuaW5zdGFsbE9yVXBncmFkZSA9IGFzeW5jIGZ1bmN0aW9uIChhcGssIHBrZyA9IG51bGwsIG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIXV0aWwuaGFzVmFsdWUob3B0aW9ucy50aW1lb3V0KSkge1xuICAgIG9wdGlvbnMudGltZW91dCA9IEFQS19JTlNUQUxMX1RJTUVPVVQ7XG4gIH1cblxuICBsZXQgYXBrSW5mbyA9IG51bGw7XG4gIGlmICghcGtnKSB7XG4gICAgYXBrSW5mbyA9IGF3YWl0IHRoaXMuZ2V0QXBrSW5mbyhhcGspO1xuICAgIHBrZyA9IGFwa0luZm8ubmFtZTtcbiAgfVxuICBpZiAoIXBrZykge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgcmVhZCB0aGUgcGFja2FnZSBuYW1lIG9mICR7YXBrfS4gQXNzdW1pbmcgY29ycmVjdCBhcHAgdmVyc2lvbiBpcyBhbHJlYWR5IGluc3RhbGxlZGApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghYXdhaXQgdGhpcy5pc0FwcEluc3RhbGxlZChwa2cpKSB7XG4gICAgbG9nLmRlYnVnKGBBcHAgJyR7YXBrfScgbm90IGluc3RhbGxlZC4gSW5zdGFsbGluZ2ApO1xuICAgIGF3YWl0IHRoaXMuaW5zdGFsbChhcGssIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHtyZXBsYWNlOiBmYWxzZX0pKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7dmVyc2lvbkNvZGU6cGtnVmVyc2lvbkNvZGUsIHZlcnNpb25OYW1lOnBrZ1ZlcnNpb25OYW1lU3RyfSA9IGF3YWl0IHRoaXMuZ2V0UGFja2FnZUluZm8ocGtnKTtcbiAgY29uc3QgcGtnVmVyc2lvbk5hbWUgPSBzZW12ZXIudmFsaWQoc2VtdmVyLmNvZXJjZShwa2dWZXJzaW9uTmFtZVN0cikpO1xuICBpZiAoIWFwa0luZm8pIHtcbiAgICBhcGtJbmZvID0gYXdhaXQgdGhpcy5nZXRBcGtJbmZvKGFwayk7XG4gIH1cbiAgY29uc3Qge3ZlcnNpb25Db2RlOmFwa1ZlcnNpb25Db2RlLCB2ZXJzaW9uTmFtZTphcGtWZXJzaW9uTmFtZVN0cn0gPSBhcGtJbmZvO1xuICBjb25zdCBhcGtWZXJzaW9uTmFtZSA9IHNlbXZlci52YWxpZChzZW12ZXIuY29lcmNlKGFwa1ZlcnNpb25OYW1lU3RyKSk7XG5cbiAgaWYgKCFfLmlzTnVtYmVyKGFwa1ZlcnNpb25Db2RlKSB8fCAhXy5pc051bWJlcihwa2dWZXJzaW9uQ29kZSkpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHJlYWQgdmVyc2lvbiBjb2RlcyBvZiAnJHthcGt9JyBhbmQvb3IgJyR7cGtnfSdgKTtcbiAgICBpZiAoIV8uaXNTdHJpbmcoYXBrVmVyc2lvbk5hbWUpIHx8ICFfLmlzU3RyaW5nKHBrZ1ZlcnNpb25OYW1lKSkge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCByZWFkIHZlcnNpb24gbmFtZXMgb2YgJyR7YXBrfScgYW5kL29yICcke3BrZ30nLiBBc3N1bWluZyBjb3JyZWN0IGFwcCB2ZXJzaW9uIGlzIGFscmVhZHkgaW5zdGFsbGVkYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIGlmIChfLmlzTnVtYmVyKGFwa1ZlcnNpb25Db2RlKSAmJiBfLmlzTnVtYmVyKHBrZ1ZlcnNpb25Db2RlKSAmJiBwa2dWZXJzaW9uQ29kZSA+IGFwa1ZlcnNpb25Db2RlKSB7XG4gICAgbG9nLmRlYnVnKGBUaGUgaW5zdGFsbGVkICcke3BrZ30nIHBhY2thZ2UgZG9lcyBub3QgcmVxdWlyZSB1cGdyYWRlICgke3BrZ1ZlcnNpb25Db2RlfSA+ICR7YXBrVmVyc2lvbkNvZGV9KWApO1xuICAgIHJldHVybjtcbiAgfVxuICAvLyBDaGVjayB2ZXJzaW9uIG5hbWVzIGluIGNhc2UgaWYgdmVyc2lvbiBjb2RlcyBhcmUgbm90IGJlaW5nIHVwZGF0ZWQgcHJvcGVybHlcbiAgaWYgKF8uaXNTdHJpbmcoYXBrVmVyc2lvbk5hbWUpICYmIF8uaXNTdHJpbmcocGtnVmVyc2lvbk5hbWUpKSB7XG4gICAgaWYgKHNlbXZlci5zYXRpc2ZpZXMocGtnVmVyc2lvbk5hbWUsIGA+PSR7YXBrVmVyc2lvbk5hbWV9YCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlIGluc3RhbGxlZCAnJHtwa2d9JyBwYWNrYWdlIGRvZXMgbm90IHJlcXVpcmUgdXBncmFkZSAoJyR7cGtnVmVyc2lvbk5hbWV9JyA+PSAnJHthcGtWZXJzaW9uTmFtZX0nKWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfSBlbHNlIGlmIChfLmlzTnVtYmVyKGFwa1ZlcnNpb25Db2RlKSAmJiBfLmlzTnVtYmVyKHBrZ1ZlcnNpb25Db2RlKSAmJiBwa2dWZXJzaW9uQ29kZSA9PT0gYXBrVmVyc2lvbkNvZGUpIHtcbiAgICBsb2cuZGVidWcoYFRoZSBpbnN0YWxsZWQgJyR7cGtnfScgcGFja2FnZSBkb2VzIG5vdCByZXF1aXJlIHVwZ3JhZGUgKCR7cGtnVmVyc2lvbkNvZGV9ID09PSAke2Fwa1ZlcnNpb25Db2RlfSlgKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoYFRoZSBpbnN0YWxsZWQgJyR7cGtnfScgcGFja2FnZSBpcyBvbGRlciB0aGFuICcke2Fwa30nIGAgK1xuICAgICAgICAgICAgYCgke3BrZ1ZlcnNpb25Db2RlfSA8ICR7YXBrVmVyc2lvbkNvZGV9IG9yICcke3BrZ1ZlcnNpb25OYW1lfScgPCAnJHthcGtWZXJzaW9uTmFtZX0nKScuIGAgK1xuICAgICAgICAgICAgYEV4ZWN1dGluZyB1cGdyYWRlYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbnN0YWxsKGFwaywgT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucywge3JlcGxhY2U6IHRydWV9KSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgdXBncmFkZSAnJHtwa2d9JyBiZWNhdXNlIG9mICcke2Vyci5tZXNzYWdlfScuIFRyeWluZyBmdWxsIHJlaW5zdGFsbGApO1xuICAgIGlmICghYXdhaXQgdGhpcy51bmluc3RhbGxBcGsocGtnKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtwa2d9JyBwYWNrYWdlIGNhbm5vdCBiZSB1bmluc3RhbGxlZGApO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLmluc3RhbGwoYXBrLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zLCB7cmVwbGFjZTogZmFsc2V9KSk7XG4gIH1cbn07XG5cbi8qKlxuICogRXh0cmFjdCBzdHJpbmcgcmVzb3VyY2VzIGZyb20gdGhlIGdpdmVuIHBhY2thZ2Ugb24gbG9jYWwgZmlsZSBzeXN0ZW0uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIHBhY2thZ2UuXG4gKiBAcGFyYW0gez9zdHJpbmd9IGxhbmd1YWdlIC0gVGhlIG5hbWUgb2YgdGhlIGxhbmd1YWdlIHRvIGV4dHJhY3QgdGhlIHJlc291cmNlcyBmb3IuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgbGFuZ3VhZ2UgaXMgdXNlZCBpZiB0aGlzIGVxdWFscyB0byBgbnVsbGAvYHVuZGVmaW5lZGBcbiAqIEBwYXJhbSB7c3RyaW5nfSBvdXQgLSBUaGUgbmFtZSBvZiB0aGUgZGVzdGluYXRpb24gZm9sZGVyIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSB0b1xuICogICAgICAgICAgICAgICAgICAgICAgIHN0b3JlIHRoZSBleHRyYWN0ZWQgZmlsZSB0by5cbiAqIEByZXR1cm4ge09iamVjdH0gQSBtYXBwaW5nIG9iamVjdCwgd2hlcmUgcHJvcGVydGllcyBhcmU6ICdhcGtTdHJpbmdzJywgY29udGFpbmluZ1xuICogICAgICAgICAgICAgICAgICBwYXJzZWQgcmVzb3VyY2UgZmlsZSByZXByZXNlbnRlZCBhcyBKU09OIG9iamVjdCwgYW5kICdsb2NhbFBhdGgnLFxuICogICAgICAgICAgICAgICAgICBjb250YWluaW5nIHRoZSBwYXRoIHRvIHRoZSBleHRyYWN0ZWQgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0uXG4gKi9cbmFwa1V0aWxzTWV0aG9kcy5leHRyYWN0U3RyaW5nc0Zyb21BcGsgPSBhc3luYyBmdW5jdGlvbiAoYXBrLCBsYW5ndWFnZSwgb3V0KSB7XG4gIGxvZy5kZWJ1ZyhgRXh0cmFjdGluZyBzdHJpbmdzIGZvciBsYW5ndWFnZTogJHtsYW5ndWFnZSB8fCAnZGVmYXVsdCd9YCk7XG4gIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcbiAgbGV0IHJhd0FhcHRPdXRwdXQ7XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgW1xuICAgICAgJ2QnLFxuICAgICAgJy0tdmFsdWVzJyxcbiAgICAgICdyZXNvdXJjZXMnLFxuICAgICAgYXBrLFxuICAgIF0pO1xuICAgIHJhd0FhcHRPdXRwdXQgPSBzdGRvdXQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBleHRyYWN0IHJlc291cmNlcyBmcm9tICcke2Fwa30nLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cblxuICBjb25zdCBkZWZhdWx0Q29uZmlnTWFya2VyID0gJyhkZWZhdWx0KSc7XG4gIGxldCBjb25maWdNYXJrZXIgPSBsYW5ndWFnZSB8fCBkZWZhdWx0Q29uZmlnTWFya2VyO1xuICBpZiAoY29uZmlnTWFya2VyLmluY2x1ZGVzKCctJykgJiYgIWNvbmZpZ01hcmtlci5pbmNsdWRlcygnLXInKSkge1xuICAgIGNvbmZpZ01hcmtlciA9IGNvbmZpZ01hcmtlci5yZXBsYWNlKCctJywgJy1yJyk7XG4gIH1cbiAgaWYgKGNvbmZpZ01hcmtlci50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoJ2VuJykpIHtcbiAgICAvLyBBc3N1bWUgdGhlICdlbicgY29uZmlndXJhdGlvbiBpcyB0aGUgZGVmYXVsdCBvbmVcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBbXG4gICAgICAnZCcsXG4gICAgICAnY29uZmlndXJhdGlvbnMnLFxuICAgICAgYXBrLFxuICAgIF0pO1xuICAgIGNvbnN0IGNvbmZpZ3MgPSBzdGRvdXQuc3BsaXQob3MuRU9MKTtcbiAgICBpZiAoIWNvbmZpZ3MuaW5jbHVkZXMoY29uZmlnTWFya2VyKSkge1xuICAgICAgbG9nLmRlYnVnKGBUaGVyZSBpcyBubyAnJHtjb25maWdNYXJrZXJ9JyBjb25maWd1cmF0aW9uLiBgICtcbiAgICAgICAgICAgICAgICBgUmVwbGFjaW5nIGl0IHdpdGggJyR7ZGVmYXVsdENvbmZpZ01hcmtlcn0nYCk7XG4gICAgICBjb25maWdNYXJrZXIgPSBkZWZhdWx0Q29uZmlnTWFya2VyO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGFwa1N0cmluZ3MgPSB7fTtcbiAgbGV0IGlzSW5Db25maWcgPSBmYWxzZTtcbiAgbGV0IGN1cnJlbnRSZXNvdXJjZUlkID0gbnVsbDtcbiAgbGV0IGlzSW5QbHVyYWxHcm91cCA9IGZhbHNlO1xuICBjb25zdCBzdGFydHNXaXRoQW55ID0gKHMsIGFycikgPT4gYXJyLnJlZHVjZSgoYWNjLCB4KSA9PiBhY2MgfHwgcy5zdGFydHNXaXRoKHgpLCBmYWxzZSk7XG4gIGNvbnN0IG5vcm1hbGl6ZVN0cmluZ01hdGNoID0gKHMpID0+IHMucmVwbGFjZSgvXCIkLywgJycpLnJlcGxhY2UoL15cIi8sICcnKS5yZXBsYWNlKC9cXFxcXCIvZywgJ1wiJyk7XG4gIGZvciAoY29uc3QgbGluZSBvZiByYXdBYXB0T3V0cHV0LnNwbGl0KG9zLkVPTCkpIHtcbiAgICBjb25zdCB0cmltbWVkTGluZSA9IGxpbmUudHJpbSgpO1xuICAgIGlmIChfLmlzRW1wdHkodHJpbW1lZExpbmUpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoc3RhcnRzV2l0aEFueSh0cmltbWVkTGluZSwgWydjb25maWcnLCAndHlwZScsICdzcGVjJywgJ1BhY2thZ2UnXSkpIHtcbiAgICAgIGlzSW5Db25maWcgPSB0cmltbWVkTGluZS5zdGFydHNXaXRoKGBjb25maWcgJHtjb25maWdNYXJrZXJ9OmApO1xuICAgICAgY3VycmVudFJlc291cmNlSWQgPSBudWxsO1xuICAgICAgaXNJblBsdXJhbEdyb3VwID0gZmFsc2U7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoIWlzSW5Db25maWcpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmICh0cmltbWVkTGluZS5zdGFydHNXaXRoKCdyZXNvdXJjZScpKSB7XG4gICAgICBpc0luUGx1cmFsR3JvdXAgPSBmYWxzZTtcbiAgICAgIGN1cnJlbnRSZXNvdXJjZUlkID0gbnVsbDtcblxuICAgICAgaWYgKHRyaW1tZWRMaW5lLmluY2x1ZGVzKCc6c3RyaW5nLycpKSB7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gLzpzdHJpbmdcXC8oXFxTKyk6Ly5leGVjKHRyaW1tZWRMaW5lKTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgY3VycmVudFJlc291cmNlSWQgPSBtYXRjaFsxXTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0cmltbWVkTGluZS5pbmNsdWRlcygnOnBsdXJhbHMvJykpIHtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSAvOnBsdXJhbHNcXC8oXFxTKyk6Ly5leGVjKHRyaW1tZWRMaW5lKTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgY3VycmVudFJlc291cmNlSWQgPSBtYXRjaFsxXTtcbiAgICAgICAgICBpc0luUGx1cmFsR3JvdXAgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudFJlc291cmNlSWQgJiYgdHJpbW1lZExpbmUuc3RhcnRzV2l0aCgnKHN0cmluZycpKSB7XG4gICAgICBjb25zdCBtYXRjaCA9IC9cIlteXCJcXFxcXSooPzpcXFxcLlteXCJcXFxcXSopKlwiLy5leGVjKHRyaW1tZWRMaW5lKTtcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBhcGtTdHJpbmdzW2N1cnJlbnRSZXNvdXJjZUlkXSA9IG5vcm1hbGl6ZVN0cmluZ01hdGNoKG1hdGNoWzBdKTtcbiAgICAgIH1cbiAgICAgIGN1cnJlbnRSZXNvdXJjZUlkID0gbnVsbDtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50UmVzb3VyY2VJZCAmJiBpc0luUGx1cmFsR3JvdXAgJiYgdHJpbW1lZExpbmUuaW5jbHVkZXMoJzogKHN0cmluZycpKSB7XG4gICAgICBjb25zdCBtYXRjaCA9IC9cIlteXCJcXFxcXSooPzpcXFxcLlteXCJcXFxcXSopKlwiLy5leGVjKHRyaW1tZWRMaW5lKTtcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBhcGtTdHJpbmdzW2N1cnJlbnRSZXNvdXJjZUlkXSA9IFtcbiAgICAgICAgICAuLi4oYXBrU3RyaW5nc1tjdXJyZW50UmVzb3VyY2VJZF0gfHwgW10pLFxuICAgICAgICAgIG5vcm1hbGl6ZVN0cmluZ01hdGNoKG1hdGNoWzBdKSxcbiAgICAgICAgXTtcbiAgICAgIH1cbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgfVxuXG4gIGlmIChfLmlzRW1wdHkoYXBrU3RyaW5ncykpIHtcbiAgICBsb2cud2FybihgTm8gc3RyaW5ncyBoYXZlIGJlZW4gZm91bmQgaW4gJyR7YXBrfScgcmVzb3VyY2VzIGAgK1xuICAgICAgICAgICAgIGBmb3IgJyR7Y29uZmlnTWFya2VyfScgY29uZmlndXJhdGlvbmApO1xuICB9IGVsc2Uge1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgZXh0cmFjdGVkICR7Xy5rZXlzKGFwa1N0cmluZ3MpLmxlbmd0aH0gc3RyaW5ncyBmcm9tICcke2Fwa30nIHJlc291cmNlcyBgICtcbiAgICAgICAgICAgICBgZm9yICcke2NvbmZpZ01hcmtlcn0nIGNvbmZpZ3VyYXRpb25gKTtcbiAgfVxuXG4gIGNvbnN0IGxvY2FsUGF0aCA9IHBhdGgucmVzb2x2ZShvdXQsICdzdHJpbmdzLmpzb24nKTtcbiAgYXdhaXQgbWtkaXJwKG91dCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShsb2NhbFBhdGgsIEpTT04uc3RyaW5naWZ5KGFwa1N0cmluZ3MsIG51bGwsIDIpLCAndXRmLTgnKTtcbiAgcmV0dXJuIHthcGtTdHJpbmdzLCBsb2NhbFBhdGh9O1xufTtcblxuLyoqXG4gKiBHZXQgdGhlIGxhbmd1YWdlIG5hbWUgb2YgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICpcbiAqIEByZXR1cm4ge3N0cmluZ30gVGhlIG5hbWUgb2YgZGV2aWNlIGxhbmd1YWdlLlxuICovXG5hcGtVdGlsc01ldGhvZHMuZ2V0RGV2aWNlTGFuZ3VhZ2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBsYW5ndWFnZTtcbiAgaWYgKGF3YWl0IHRoaXMuZ2V0QXBpTGV2ZWwoKSA8IDIzKSB7XG4gICAgbGFuZ3VhZ2UgPSBhd2FpdCB0aGlzLmdldERldmljZVN5c0xhbmd1YWdlKCk7XG4gICAgaWYgKCFsYW5ndWFnZSkge1xuICAgICAgbGFuZ3VhZ2UgPSBhd2FpdCB0aGlzLmdldERldmljZVByb2R1Y3RMYW5ndWFnZSgpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsYW5ndWFnZSA9IChhd2FpdCB0aGlzLmdldERldmljZUxvY2FsZSgpKS5zcGxpdChcIi1cIilbMF07XG4gIH1cbiAgcmV0dXJuIGxhbmd1YWdlO1xufTtcblxuLyoqXG4gKiBTZXQgdGhlIGxhbmd1YWdlIG5hbWUgb2YgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBsYW5ndWFnZSAtIFRoZSBuYW1lIG9mIHRoZSBuZXcgZGV2aWNlIGxhbmd1YWdlLlxuICovXG5hcGtVdGlsc01ldGhvZHMuc2V0RGV2aWNlTGFuZ3VhZ2UgPSBhc3luYyBmdW5jdGlvbiAobGFuZ3VhZ2UpIHtcbiAgLy8gdGhpcyBtZXRob2QgaXMgb25seSB1c2VkIGluIEFQSSA8IDIzXG4gIGF3YWl0IHRoaXMuc2V0RGV2aWNlU3lzTGFuZ3VhZ2UobGFuZ3VhZ2UpO1xufTtcblxuLyoqXG4gKiBHZXQgdGhlIGNvdW50cnkgbmFtZSBvZiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHJldHVybiB7c3RyaW5nfSBUaGUgbmFtZSBvZiBkZXZpY2UgY291bnRyeS5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLmdldERldmljZUNvdW50cnkgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIC8vIHRoaXMgbWV0aG9kIGlzIG9ubHkgdXNlZCBpbiBBUEkgPCAyM1xuICBsZXQgY291bnRyeSA9IGF3YWl0IHRoaXMuZ2V0RGV2aWNlU3lzQ291bnRyeSgpO1xuICBpZiAoIWNvdW50cnkpIHtcbiAgICBjb3VudHJ5ID0gYXdhaXQgdGhpcy5nZXREZXZpY2VQcm9kdWN0Q291bnRyeSgpO1xuICB9XG4gIHJldHVybiBjb3VudHJ5O1xufTtcblxuLyoqXG4gKiBTZXQgdGhlIGNvdW50cnkgbmFtZSBvZiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGNvdW50cnkgLSBUaGUgbmFtZSBvZiB0aGUgbmV3IGRldmljZSBjb3VudHJ5LlxuICovXG5hcGtVdGlsc01ldGhvZHMuc2V0RGV2aWNlQ291bnRyeSA9IGFzeW5jIGZ1bmN0aW9uIChjb3VudHJ5KSB7XG4gIC8vIHRoaXMgbWV0aG9kIGlzIG9ubHkgdXNlZCBpbiBBUEkgPCAyM1xuICBhd2FpdCB0aGlzLnNldERldmljZVN5c0NvdW50cnkoY291bnRyeSk7XG59O1xuXG4vKipcbiAqIEdldCB0aGUgbG9jYWxlIG5hbWUgb2YgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICpcbiAqIEByZXR1cm4ge3N0cmluZ30gVGhlIG5hbWUgb2YgZGV2aWNlIGxvY2FsZS5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLmdldERldmljZUxvY2FsZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgLy8gdGhpcyBtZXRob2QgaXMgb25seSB1c2VkIGluIEFQSSA+PSAyM1xuICBsZXQgbG9jYWxlID0gYXdhaXQgdGhpcy5nZXREZXZpY2VTeXNMb2NhbGUoKTtcbiAgaWYgKCFsb2NhbGUpIHtcbiAgICBsb2NhbGUgPSBhd2FpdCB0aGlzLmdldERldmljZVByb2R1Y3RMb2NhbGUoKTtcbiAgfVxuICByZXR1cm4gbG9jYWxlO1xufTtcblxuLyoqXG4gKiBTZXQgdGhlIGxvY2FsZSBuYW1lIG9mIHRoZSBkZXZpY2UgdW5kZXIgdGVzdCBhbmQgdGhlIGZvcm1hdCBvZiB0aGUgbG9jYWxlIGlzIGVuLVVTLCBmb3IgZXhhbXBsZS5cbiAqIFRoaXMgbWV0aG9kIGNhbGwgc2V0RGV2aWNlTGFuZ3VhZ2VDb3VudHJ5LCBzbywgcGxlYXNlIHVzZSBzZXREZXZpY2VMYW5ndWFnZUNvdW50cnkgYXMgcG9zc2libGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGxvY2FsZSAtIE5hbWVzIG9mIHRoZSBkZXZpY2UgbGFuZ3VhZ2UgYW5kIHRoZSBjb3VudHJ5IGNvbm5lY3RlZCB3aXRoIGAtYC4gZS5nLiBlbi1VUy5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLnNldERldmljZUxvY2FsZSA9IGFzeW5jIGZ1bmN0aW9uIChsb2NhbGUpIHtcbiAgY29uc3QgdmFsaWRhdGVMb2NhbGUgPSBuZXcgUmVnRXhwKC9bYS16QS1aXSstW2EtekEtWjAtOV0rLyk7XG4gIGlmICghdmFsaWRhdGVMb2NhbGUudGVzdChsb2NhbGUpKSB7XG4gICAgbG9nLndhcm4oYHNldERldmljZUxvY2FsZSByZXF1aXJlcyB0aGUgZm9sbG93aW5nIGZvcm1hdDogZW4tVVMgb3IgamEtSlBgKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQgc3BsaXRfbG9jYWxlID0gbG9jYWxlLnNwbGl0KFwiLVwiKTtcbiAgYXdhaXQgdGhpcy5zZXREZXZpY2VMYW5ndWFnZUNvdW50cnkoc3BsaXRfbG9jYWxlWzBdLCBzcGxpdF9sb2NhbGVbMV0pO1xufTtcblxuLyoqXG4gKiBNYWtlIHN1cmUgY3VycmVudCBkZXZpY2UgbG9jYWxlIGlzIGV4cGVjdGVkIG9yIG5vdC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbGFuZ3VhZ2UgLSBMYW5ndWFnZS4gVGhlIGxhbmd1YWdlIGZpZWxkIGlzIGNhc2UgaW5zZW5zaXRpdmUsIGJ1dCBMb2NhbGUgYWx3YXlzIGNhbm9uaWNhbGl6ZXMgdG8gbG93ZXIgY2FzZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBjb3VudHJ5IC0gQ291bnRyeS4gVGhlIGxhbmd1YWdlIGZpZWxkIGlzIGNhc2UgaW5zZW5zaXRpdmUsIGJ1dCBMb2NhbGUgYWx3YXlzIGNhbm9uaWNhbGl6ZXMgdG8gbG93ZXIgY2FzZS5cbiAqXG4gKiBAcmV0dXJuIHtib29sZWFufSBJZiBjdXJyZW50IGxvY2FsZSBpcyBsYW5ndWFnZSBhbmQgY291bnRyeSBhcyBhcmd1bWVudHMsIHJldHVybiB0cnVlLlxuICovXG5hcGtVdGlsc01ldGhvZHMuZW5zdXJlQ3VycmVudExvY2FsZSA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSwgY291bnRyeSkge1xuICBjb25zdCBoYXNMYW5ndWFnZSA9IF8uaXNTdHJpbmcobGFuZ3VhZ2UpO1xuICBjb25zdCBoYXNDb3VudHJ5ID0gXy5pc1N0cmluZyhjb3VudHJ5KTtcblxuICBpZiAoIWhhc0xhbmd1YWdlICYmICFoYXNDb3VudHJ5KSB7XG4gICAgbG9nLndhcm4oJ2Vuc3VyZUN1cnJlbnRMb2NhbGUgcmVxdWlyZXMgbGFuZ3VhZ2Ugb3IgY291bnRyeScpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIGdldCBsb3dlciBjYXNlIHZlcnNpb25zIG9mIHRoZSBzdHJpbmdzXG4gIGxhbmd1YWdlID0gKGxhbmd1YWdlIHx8ICcnKS50b0xvd2VyQ2FzZSgpO1xuICBjb3VudHJ5ID0gKGNvdW50cnkgfHwgJycpLnRvTG93ZXJDYXNlKCk7XG5cbiAgY29uc3QgYXBpTGV2ZWwgPSBhd2FpdCB0aGlzLmdldEFwaUxldmVsKCk7XG5cbiAgcmV0dXJuIGF3YWl0IHJldHJ5SW50ZXJ2YWwoNSwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoYXBpTGV2ZWwgPCAyMykge1xuICAgICAgICBsZXQgY3VyTGFuZ3VhZ2UsIGN1ckNvdW50cnk7XG4gICAgICAgIGlmIChoYXNMYW5ndWFnZSkge1xuICAgICAgICAgIGN1ckxhbmd1YWdlID0gKGF3YWl0IHRoaXMuZ2V0RGV2aWNlTGFuZ3VhZ2UoKSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICBpZiAoIWhhc0NvdW50cnkgJiYgbGFuZ3VhZ2UgPT09IGN1ckxhbmd1YWdlKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGhhc0NvdW50cnkpIHtcbiAgICAgICAgICBjdXJDb3VudHJ5ID0gKGF3YWl0IHRoaXMuZ2V0RGV2aWNlQ291bnRyeSgpKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgIGlmICghaGFzTGFuZ3VhZ2UgJiYgY291bnRyeSA9PT0gY3VyQ291bnRyeSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChsYW5ndWFnZSA9PT0gY3VyTGFuZ3VhZ2UgJiYgY291bnRyeSA9PT0gY3VyQ291bnRyeSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBjdXJMb2NhbGUgPSAoYXdhaXQgdGhpcy5nZXREZXZpY2VMb2NhbGUoKSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKGAke2xhbmd1YWdlfS0ke2NvdW50cnl9YCA9PT0gY3VyTG9jYWxlKSAge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZiB0aGVyZSBoYXMgYmVlbiBhbiBlcnJvciwgcmVzdGFydCBhZGIgYW5kIHJldHJ5XG4gICAgICBsb2cuZXJyb3IoYFVuYWJsZSB0byBjaGVjayBkZXZpY2UgbG9jYWxpemF0aW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nLmRlYnVnKCdSZXN0YXJ0aW5nIEFEQiBhbmQgcmV0cnlpbmcuLi4nKTtcbiAgICAgIGF3YWl0IHRoaXMucmVzdGFydEFkYigpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSk7XG59O1xuXG4vKipcbiAqIFNldCB0aGUgbG9jYWxlIG5hbWUgb2YgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBsYW5ndWFnZSAtIExhbmd1YWdlLiBUaGUgbGFuZ3VhZ2UgZmllbGQgaXMgY2FzZSBpbnNlbnNpdGl2ZSwgYnV0IExvY2FsZSBhbHdheXMgY2Fub25pY2FsaXplcyB0byBsb3dlciBjYXNlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0OiBbYS16QS1aXXsyLDh9LiBlLmcuIGVuLCBqYSA6IGh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3JlZmVyZW5jZS9qYXZhL3V0aWwvTG9jYWxlLmh0bWxcbiAqIEBwYXJhbSB7c3RyaW5nfSBjb3VudHJ5IC0gQ291bnRyeS4gVGhlIGNvdW50cnkgKHJlZ2lvbikgZmllbGQgaXMgY2FzZSBpbnNlbnNpdGl2ZSwgYnV0IExvY2FsZSBhbHdheXMgY2Fub25pY2FsaXplcyB0byB1cHBlciBjYXNlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0OiBbYS16QS1aXXsyfSB8IFswLTldezN9LiBlLmcuIFVTLCBKUCA6IGh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3JlZmVyZW5jZS9qYXZhL3V0aWwvTG9jYWxlLmh0bWxcbiAqL1xuYXBrVXRpbHNNZXRob2RzLnNldERldmljZUxhbmd1YWdlQ291bnRyeSA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSwgY291bnRyeSkge1xuICBsZXQgaGFzTGFuZ3VhZ2UgPSBsYW5ndWFnZSAmJiBfLmlzU3RyaW5nKGxhbmd1YWdlKTtcbiAgbGV0IGhhc0NvdW50cnkgPSBjb3VudHJ5ICYmIF8uaXNTdHJpbmcoY291bnRyeSk7XG4gIGlmICghaGFzTGFuZ3VhZ2UgJiYgIWhhc0NvdW50cnkpIHtcbiAgICBsb2cud2Fybihgc2V0RGV2aWNlTGFuZ3VhZ2VDb3VudHJ5IHJlcXVpcmVzIGxhbmd1YWdlIG9yIGNvdW50cnkuYCk7XG4gICAgbG9nLndhcm4oYEdvdCBsYW5ndWFnZTogJyR7bGFuZ3VhZ2V9JyBhbmQgY291bnRyeTogJyR7Y291bnRyeX0nYCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxldCB3YXNTZXR0aW5nQ2hhbmdlZCA9IGZhbHNlO1xuICBsZXQgYXBpTGV2ZWwgPSBhd2FpdCB0aGlzLmdldEFwaUxldmVsKCk7XG5cbiAgbGFuZ3VhZ2UgPSAobGFuZ3VhZ2UgfHwgJycpLnRvTG93ZXJDYXNlKCk7XG4gIGNvdW50cnkgPSAoY291bnRyeSB8fCAnJykudG9VcHBlckNhc2UoKTtcblxuICBpZiAoYXBpTGV2ZWwgPCAyMykge1xuICAgIGxldCBjdXJMYW5ndWFnZSA9IChhd2FpdCB0aGlzLmdldERldmljZUxhbmd1YWdlKCkpLnRvTG93ZXJDYXNlKCk7XG4gICAgbGV0IGN1ckNvdW50cnkgPSAoYXdhaXQgdGhpcy5nZXREZXZpY2VDb3VudHJ5KCkpLnRvVXBwZXJDYXNlKCk7XG4gICAgaWYgKGhhc0xhbmd1YWdlICYmIGxhbmd1YWdlICE9PSBjdXJMYW5ndWFnZSkge1xuICAgICAgYXdhaXQgdGhpcy5zZXREZXZpY2VMYW5ndWFnZShsYW5ndWFnZSk7XG4gICAgICB3YXNTZXR0aW5nQ2hhbmdlZCA9IHRydWU7XG4gICAgfVxuICAgIGlmIChoYXNDb3VudHJ5ICYmIGNvdW50cnkgIT09IGN1ckNvdW50cnkpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0RGV2aWNlQ291bnRyeShjb3VudHJ5KTtcbiAgICAgIHdhc1NldHRpbmdDaGFuZ2VkID0gdHJ1ZTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbGV0IGN1ckxvY2FsZSA9IGF3YWl0IHRoaXMuZ2V0RGV2aWNlTG9jYWxlKCk7XG5cbiAgICBpZiAoYXBpTGV2ZWwgPT09IDIzKSB7XG4gICAgICBsZXQgbG9jYWxlO1xuICAgICAgaWYgKCFoYXNDb3VudHJ5KSB7XG4gICAgICAgIGxvY2FsZSA9IGxhbmd1YWdlO1xuICAgICAgfSBlbHNlIGlmICghaGFzTGFuZ3VhZ2UpIHtcbiAgICAgICAgbG9jYWxlID0gY291bnRyeTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvY2FsZSA9IGAke2xhbmd1YWdlfS0ke2NvdW50cnl9YDtcbiAgICAgIH1cblxuICAgICAgbG9nLmRlYnVnKGBDdXJyZW50IGxvY2FsZTogJyR7Y3VyTG9jYWxlfSc7IHJlcXVlc3RlZCBsb2NhbGU6ICcke2xvY2FsZX0nYCk7XG4gICAgICBpZiAobG9jYWxlLnRvTG93ZXJDYXNlKCkgIT09IGN1ckxvY2FsZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2V0RGV2aWNlU3lzTG9jYWxlKGxvY2FsZSk7XG4gICAgICAgIHdhc1NldHRpbmdDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9IGVsc2UgeyAvLyBBUEkgPj0gMjRcbiAgICAgIGlmICghaGFzQ291bnRyeSB8fCAhaGFzTGFuZ3VhZ2UpIHtcbiAgICAgICAgbG9nLndhcm4oYHNldERldmljZUxhbmd1YWdlQ291bnRyeSByZXF1aXJlcyBib3RoIGxhbmd1YWdlIGFuZCBjb3VudHJ5IHRvIGJlIHNldCBmb3IgQVBJIDI0K2ApO1xuICAgICAgICBsb2cud2FybihgR290IGxhbmd1YWdlOiAnJHtsYW5ndWFnZX0nIGFuZCBjb3VudHJ5OiAnJHtjb3VudHJ5fSdgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBsb2cuZGVidWcoYEN1cnJlbnQgbG9jYWxlOiAnJHtjdXJMb2NhbGV9JzsgcmVxdWVzdGVkIGxvY2FsZTogJyR7bGFuZ3VhZ2V9LSR7Y291bnRyeX0nYCk7XG4gICAgICBpZiAoYCR7bGFuZ3VhZ2V9LSR7Y291bnRyeX1gLnRvTG93ZXJDYXNlKCkgIT09IGN1ckxvY2FsZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2V0RGV2aWNlU3lzTG9jYWxlVmlhU2V0dGluZ0FwcChsYW5ndWFnZSwgY291bnRyeSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHdhc1NldHRpbmdDaGFuZ2VkKSB7XG4gICAgbG9nLmluZm8oXCJSZWJvb3RpbmcgdGhlIGRldmljZSBpbiBvcmRlciB0byBhcHBseSBuZXcgbG9jYWxlIHZpYSAnc2V0dGluZyBwZXJzaXN0LnN5cy5sb2NhbGUnIGNvbW1hbmQuXCIpO1xuICAgIGF3YWl0IHRoaXMucmVib290KCk7XG4gIH1cbn07XG5cbi8qKlxuICogR2V0IHRoZSBwYWNrYWdlIG5hbWUgZnJvbSBsb2NhbCBhcGsgZmlsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byBleGlzdGluZyAuYXBrIHBhY2thZ2Ugb24gdGhlIGxvY2FsXG4gKiAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzeXN0ZW0uXG4gKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBwYXJzZWQgcGFja2FnZSBuYW1lIG9yIF9udWxsXyBpZiBpdCBjYW5ub3QgYmUgcGFyc2VkLlxuICovXG5hcGtVdGlsc01ldGhvZHMuZ2V0UGFja2FnZU5hbWUgPSBhc3luYyBmdW5jdGlvbiAoYXBrKSB7XG4gIGxldCBhcmdzID0gWydkdW1wJywgJ2JhZGdpbmcnLCBhcGtdO1xuICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgbGV0IGFwa1BhY2thZ2UgPSBuZXcgUmVnRXhwKC9wYWNrYWdlOiBuYW1lPScoW14nXSspJy9nKS5leGVjKHN0ZG91dCk7XG4gIGlmIChhcGtQYWNrYWdlICYmIGFwa1BhY2thZ2UubGVuZ3RoID49IDIpIHtcbiAgICBhcGtQYWNrYWdlID0gYXBrUGFja2FnZVsxXTtcbiAgfSBlbHNlIHtcbiAgICBhcGtQYWNrYWdlID0gbnVsbDtcbiAgfVxuICByZXR1cm4gYXBrUGFja2FnZTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQXBwSW5mb1xuICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBQYWNrYWdlIG5hbWUsIGZvciBleGFtcGxlICdjb20uYWNtZS5hcHAnLlxuICogQHByb3BlcnR5IHtudW1iZXJ9IHZlcnNpb25Db2RlIC0gVmVyc2lvbiBjb2RlLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHZlcnNpb25OYW1lIC0gVmVyc2lvbiBuYW1lLCBmb3IgZXhhbXBsZSAnMS4wJy5cbiAqL1xuXG4vKipcbiAqIEdldCB0aGUgcGFja2FnZSBpbmZvIGZyb20gbG9jYWwgYXBrIGZpbGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwa1BhdGggLSBUaGUgZnVsbCBwYXRoIHRvIGV4aXN0aW5nIC5hcGsgcGFja2FnZSBvbiB0aGUgbG9jYWxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzeXN0ZW0uXG4gKiBAcmV0dXJuIHs/QXBwSW5mb30gVGhlIHBhcnNlZCBhcHBsaWNhdGlvbiBpbmZvcm1hdGlvbi5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLmdldEFwa0luZm8gPSBhc3luYyBmdW5jdGlvbiAoYXBrUGF0aCkge1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhhcGtQYXRoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGZpbGUgYXQgcGF0aCAke2Fwa1BhdGh9IGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cbiAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuICB0cnkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFsnZCcsICdiYWRnaW5nJywgYXBrUGF0aF0pO1xuICAgIGNvbnN0IG1hdGNoZXMgPSBuZXcgUmVnRXhwKC9wYWNrYWdlOiBuYW1lPScoW14nXSspJyB2ZXJzaW9uQ29kZT0nKFxcZCspJyB2ZXJzaW9uTmFtZT0nKFteJ10rKScvKS5leGVjKHN0ZG91dCk7XG4gICAgaWYgKG1hdGNoZXMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IG1hdGNoZXNbMV0sXG4gICAgICAgIHZlcnNpb25Db2RlOiBwYXJzZUludChtYXRjaGVzWzJdLCAxMCksXG4gICAgICAgIHZlcnNpb25OYW1lOiBtYXRjaGVzWzNdXG4gICAgICB9O1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYEVycm9yIFwiJHtlcnIubWVzc2FnZX1cIiB3aGlsZSBnZXR0aW5nIGJhZGdpbmcgaW5mb2ApO1xuICB9XG4gIHJldHVybiB7fTtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBwYWNrYWdlIGluZm8gZnJvbSB0aGUgaW5zdGFsbGVkIGFwcGxpY2F0aW9uLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFsbGVkIHBhY2thZ2UuXG4gKiBAcmV0dXJuIHs/QXBwSW5mb30gVGhlIHBhcnNlZCBhcHBsaWNhdGlvbiBpbmZvcm1hdGlvbi5cbiAqL1xuYXBrVXRpbHNNZXRob2RzLmdldFBhY2thZ2VJbmZvID0gYXN5bmMgZnVuY3Rpb24gKHBrZykge1xuICBsb2cuZGVidWcoYEdldHRpbmcgcGFja2FnZSBpbmZvIGZvciAnJHtwa2d9J2ApO1xuICBsZXQgcmVzdWx0ID0ge25hbWU6IHBrZ307XG4gIHRyeSB7XG4gICAgY29uc3Qgc3Rkb3V0ID0gYXdhaXQgdGhpcy5zaGVsbChbJ2R1bXBzeXMnLCAncGFja2FnZScsIHBrZ10pO1xuICAgIGNvbnN0IHZlcnNpb25OYW1lTWF0Y2ggPSBuZXcgUmVnRXhwKC92ZXJzaW9uTmFtZT0oW1xcZCtcXC5dKykvKS5leGVjKHN0ZG91dCk7XG4gICAgaWYgKHZlcnNpb25OYW1lTWF0Y2gpIHtcbiAgICAgIHJlc3VsdC52ZXJzaW9uTmFtZSA9IHZlcnNpb25OYW1lTWF0Y2hbMV07XG4gICAgfVxuICAgIGNvbnN0IHZlcnNpb25Db2RlTWF0Y2ggPSBuZXcgUmVnRXhwKC92ZXJzaW9uQ29kZT0oXFxkKykvKS5leGVjKHN0ZG91dCk7XG4gICAgaWYgKHZlcnNpb25Db2RlTWF0Y2gpIHtcbiAgICAgIHJlc3VsdC52ZXJzaW9uQ29kZSA9IHBhcnNlSW50KHZlcnNpb25Db2RlTWF0Y2hbMV0sIDEwKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYEVycm9yICcke2Vyci5tZXNzYWdlfScgd2hpbGUgZHVtcGluZyBwYWNrYWdlIGluZm9gKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgYXBrVXRpbHNNZXRob2RzO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
