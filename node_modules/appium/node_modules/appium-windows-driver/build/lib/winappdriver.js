'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _appiumBaseDriver = require('appium-base-driver');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _teen_process = require('teen_process');

var _installer = require('./installer');

var _asyncbox = require('asyncbox');

var _child_process = require('child_process');

var _child_process2 = _interopRequireDefault(_child_process);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var REQUIRED_PARAMS = []; // XXYD 1-5-2018: removed app from required params because you can alternatively use appTopLevelWindow
var DEFAULT_WAD_HOST = '127.0.0.1';
var DEFAULT_WAD_PORT = 4724; //  should be non-4723 to avoid conflict on the same box

var WinAppDriver = (function (_events$EventEmitter) {
  _inherits(WinAppDriver, _events$EventEmitter);

  function WinAppDriver() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, WinAppDriver);

    var host = opts.host;
    var port = opts.port;

    _get(Object.getPrototypeOf(WinAppDriver.prototype), 'constructor', this).call(this);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQUIRED_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !opts[req]) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.proxyHost = host || DEFAULT_WAD_HOST;
    this.proxyPort = port || DEFAULT_WAD_PORT;
    this.proc = null;
    this.state = WinAppDriver.STATE_STOPPED;
    this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.proxyHost, port: this.proxyPort });
  }

  _createClass(WinAppDriver, [{
    key: 'start',
    value: function start() {
      var args, startDetector, processIsAlive, _arr, _loop, _i;

      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _installer.verifyWAD)());

          case 2:
            if (context$2$0.sent) {
              context$2$0.next = 4;
              break;
            }

            throw new Error("Could not verify WinAppDriver install; re-run install");

          case 4:

            this.changeState(WinAppDriver.STATE_STARTING);

            // XXXYD TODO: would be better if WinAppDriver didn't require passing in /wd/hub as a param
            args = [this.proxyPort + "/wd/hub"];

            startDetector = function startDetector(stdout) {
              return stdout.indexOf("listening for requests") !== -1;
            };

            processIsAlive = false;
            context$2$0.prev = 8;
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.killAll());

          case 11:

            // set up our subprocess object
            this.proc = new _teen_process.SubProcess(_installer.WAD_INSTALL_PATH, args, {
              encoding: 'ucs2'
            });
            processIsAlive = true;

            // handle log output
            _arr = ['STDOUT', 'STDERR'];

            _loop = function () {
              var stream = _arr[_i];
              _this.proc.on('lines-' + stream.toLowerCase(), function (lines) {
                var _iteratorNormalCompletion2 = true;
                var _didIteratorError2 = false;
                var _iteratorError2 = undefined;

                try {
                  for (var _iterator2 = _getIterator(lines), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                    var l = _step2.value;

                    _logger2['default'].info('[' + stream + '] ' + l.trim());
                  }
                } catch (err) {
                  _didIteratorError2 = true;
                  _iteratorError2 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                      _iterator2['return']();
                    }
                  } finally {
                    if (_didIteratorError2) {
                      throw _iteratorError2;
                    }
                  }
                }
              });
            };

            for (_i = 0; _i < _arr.length; _i++) {
              _loop();
            }

            // handle out-of-bound exit by simply emitting a stopped state
            this.proc.on('exit', function (code, signal) {
              processIsAlive = false;
              if (_this.state !== WinAppDriver.STATE_STOPPED && _this.state !== WinAppDriver.STATE_STOPPING) {
                var msg = 'WinAppDriver exited unexpectedly with code ' + code + ', ' + ('signal ' + signal);
                _logger2['default'].error(msg);
                _this.changeState(WinAppDriver.STATE_STOPPED);
              }
            });
            _logger2['default'].info('Spawning winappdriver with: ' + args.join(' '));

            // start subproc and wait for startDetector
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.proc.start(startDetector));

          case 20:
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.waitForOnline());

          case 22:
            context$2$0.next = 31;
            break;

          case 24:
            context$2$0.prev = 24;
            context$2$0.t0 = context$2$0['catch'](8);

            this.emit(WinAppDriver.EVENT_ERROR, context$2$0.t0);
            // just because we had an error doesn't mean the winappdriver process
            // finished; we should clean up if necessary

            if (!processIsAlive) {
              context$2$0.next = 30;
              break;
            }

            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.proc.stop());

          case 30:
            _logger2['default'].errorAndThrow(context$2$0.t0);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[8, 24]]);
    }
  }, {
    key: 'sessionId',
    value: function sessionId() {
      if (this.state !== WinAppDriver.STATE_ONLINE) {
        return null;
      }

      return this.jwproxy.sessionId;
    }
  }, {
    key: 'waitForOnline',
    value: function waitForOnline() {
      var winappdriverStopped;
      return _regeneratorRuntime.async(function waitForOnline$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            winappdriverStopped = false;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 200, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!([WinAppDriver.STATE_STOPPED, WinAppDriver.STATE_ONLINE].indexOf(this.state) >= 0)) {
                      context$3$0.next = 3;
                      break;
                    }

                    // we are either stopped, stopping, or we're online
                    winappdriverStopped = this.state === WinAppDriver.STATE_STOPPED;
                    return context$3$0.abrupt('return');

                  case 3:
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(this.getStatus());

                  case 5:
                    if (!context$3$0.sent) {
                      context$3$0.next = 7;
                      break;
                    }

                    this.changeState(WinAppDriver.STATE_ONLINE);

                  case 7:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 3:
            if (!winappdriverStopped) {
              context$2$0.next = 5;
              break;
            }

            throw new Error('WinAppDriver crashed during startup.');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      var resBlock;
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.proxy('/status', 'GET'));

          case 2:
            resBlock = context$2$0.sent;

            if (!(resBlock[0].statusCode === 200)) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].info('Status call returned 200. we\'re online and ready to run tests');
            return context$2$0.abrupt('return', true);

          case 6:
            return context$2$0.abrupt('return', false);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      var emitStates = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (emitStates) {
              this.changeState(WinAppDriver.STATE_STOPPING);
            }
            context$2$0.prev = 1;

            if (!this.proc) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proc.stop());

          case 5:
            if (emitStates) {
              this.changeState(WinAppDriver.STATE_STOPPED);
            }
            context$2$0.next = 11;
            break;

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].error(context$2$0.t0);

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 8]]);
    }
  }, {
    key: 'changeState',
    value: function changeState(state) {
      this.state = state;
      _logger2['default'].debug('WinAppDriver changed state to \'' + state + '\'');
      this.emit(WinAppDriver.EVENT_CHANGED, { state: state });
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(url, method, body) {
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.command(url, method, body));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'proxyReq',
    value: function proxyReq(req, res) {
      return _regeneratorRuntime.async(function proxyReq$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.proxyReqRes(req, res));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'killAll',
    value: function killAll() {
      var cmd;
      return _regeneratorRuntime.async(function killAll$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = undefined;

            // js hint cannot handle backticks, even escaped, within template literals
            cmd = "FOR /F \"usebackq tokens=5\" %a in (`netstat -nao ^| " + "findstr /R /C:\"" + this.proxyPort + " \"`) do (" + "FOR /F \"usebackq\" %b in (`TASKLIST /FI \"PID eq %a\" ^| " + "findstr /I winappdriver.exe`) do (IF NOT %b==\"\" TASKKILL " + "/F /PID %a))";
            _logger2['default'].info('Killing any old WinAppDrivers on same port, running: ' + cmd);
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].promisify(_child_process2['default'].exec)(cmd));

          case 6:
            _logger2['default'].info("Successfully cleaned up old WinAppDrivers");
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](3);

            _logger2['default'].info("No old WinAppDrivers seemed to exist");

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 9]]);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting WinAppDriver server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation WinAppDriver deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return WinAppDriver;
})(_events2['default'].EventEmitter);

WinAppDriver.EVENT_ERROR = 'winappdriver_error';
WinAppDriver.EVENT_CHANGED = 'stateChanged';
WinAppDriver.STATE_STOPPED = 'stopped';
WinAppDriver.STATE_STARTING = 'starting';
WinAppDriver.STATE_ONLINE = 'online';
WinAppDriver.STATE_STOPPING = 'stopping';

exports.WinAppDriver = WinAppDriver;
exports.DEFAULT_WAD_HOST = DEFAULT_WAD_HOST;
exports.DEFAULT_WAD_PORT = DEFAULT_WAD_PORT;
exports['default'] = WinAppDriver;

// we need to make sure WAD hasn't crashed

// use cp.exec instead of teen process because of crazy windows quoting
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93aW5hcHBkcml2ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQW1CLFFBQVE7Ozs7Z0NBQ0gsb0JBQW9COztzQkFDNUIsVUFBVTs7Ozs0QkFDQyxjQUFjOzt5QkFDRyxhQUFhOzt3QkFDM0IsVUFBVTs7NkJBQ3pCLGVBQWU7Ozs7d0JBQ2hCLFVBQVU7Ozs7QUFFeEIsSUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDO0FBQzNCLElBQU0sZ0JBQWdCLEdBQUcsV0FBVyxDQUFDO0FBQ3JDLElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDOztJQUV4QixZQUFZO1lBQVosWUFBWTs7QUFDSixXQURSLFlBQVksR0FDUTtRQUFYLElBQUkseURBQUcsRUFBRTs7MEJBRGxCLFlBQVk7O1FBRVAsSUFBSSxHQUFVLElBQUksQ0FBbEIsSUFBSTtRQUFFLElBQUksR0FBSSxJQUFJLENBQVosSUFBSTs7QUFDakIsK0JBSEUsWUFBWSw2Q0FHTjs7Ozs7OztBQUVSLHdDQUFnQixlQUFlLDRHQUFFO1lBQXhCLEdBQUc7O0FBQ1YsWUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUN2QixnQkFBTSxJQUFJLEtBQUssZUFBWSxHQUFHLHFCQUFpQixDQUFDO1NBQ2pEO0FBQ0QsWUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztPQUN2Qjs7Ozs7Ozs7Ozs7Ozs7OztBQUVELFFBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLGdCQUFnQixDQUFDO0FBQzFDLFFBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLGdCQUFnQixDQUFDO0FBQzFDLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLFFBQUksQ0FBQyxLQUFLLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQztBQUN4QyxRQUFJLENBQUMsT0FBTyxHQUFHLDhCQUFZLEVBQUMsTUFB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QyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDOzs7Ozs7Ozs7O0FBRXpDLGdDQUFJLElBQUksQ0FBQyxpR0FDWSxDQUFDLENBQUM7Ozs7Ozs7S0FFMUI7OztTQXJMRyxZQUFZO0dBQVMsb0JBQU8sWUFBWTs7QUF3TDlDLFlBQVksQ0FBQyxXQUFXLEdBQUcsb0JBQW9CLENBQUM7QUFDaEQsWUFBWSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUM7QUFDNUMsWUFBWSxDQUFDLGFBQWEsR0FBRyxTQUFTLENBQUM7QUFDdkMsWUFBWSxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUM7QUFDekMsWUFBWSxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUM7QUFDckMsWUFBWSxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUM7O1FBRWhDLFlBQVksR0FBWixZQUFZO1FBQUUsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQUFFLGdCQUFnQixHQUFoQixnQkFBZ0I7cUJBQzFDLFlBQVkiLCJmaWxlIjoibGliL3dpbmFwcGRyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IFdBRF9JTlNUQUxMX1BBVEgsIHZlcmlmeVdBRCB9IGZyb20gJy4vaW5zdGFsbGVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IFJFUVVJUkVEX1BBUkFNUyA9IFtdOyAvLyBYWFlEIDEtNS0yMDE4OiByZW1vdmVkIGFwcCBmcm9tIHJlcXVpcmVkIHBhcmFtcyBiZWNhdXNlIHlvdSBjYW4gYWx0ZXJuYXRpdmVseSB1c2UgYXBwVG9wTGV2ZWxXaW5kb3dcbmNvbnN0IERFRkFVTFRfV0FEX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IERFRkFVTFRfV0FEX1BPUlQgPSA0NzI0OyAvLyAgc2hvdWxkIGJlIG5vbi00NzIzIHRvIGF2b2lkIGNvbmZsaWN0IG9uIHRoZSBzYW1lIGJveFxuXG5jbGFzcyBXaW5BcHBEcml2ZXIgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHtob3N0LCBwb3J0fSA9IG9wdHM7XG4gICAgc3VwZXIoKTtcblxuICAgIGZvciAobGV0IHJlcSBvZiBSRVFVSVJFRF9QQVJBTVMpIHtcbiAgICAgIGlmICghb3B0cyB8fCAhb3B0c1tyZXFdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xuICAgICAgfVxuICAgICAgdGhpc1tyZXFdID0gb3B0c1tyZXFdO1xuICAgIH1cblxuICAgIHRoaXMucHJveHlIb3N0ID0gaG9zdCB8fCBERUZBVUxUX1dBRF9IT1NUO1xuICAgIHRoaXMucHJveHlQb3J0ID0gcG9ydCB8fCBERUZBVUxUX1dBRF9QT1JUO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgdGhpcy5zdGF0ZSA9IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEO1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMucHJveHlIb3N0LCBwb3J0OiB0aGlzLnByb3h5UG9ydH0pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGlmICghYXdhaXQgdmVyaWZ5V0FEKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvdWxkIG5vdCB2ZXJpZnkgV2luQXBwRHJpdmVyIGluc3RhbGw7IHJlLXJ1biBpbnN0YWxsXCIpO1xuICAgIH1cbiAgICAgICAgXG4gICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfU1RBUlRJTkcpO1xuICAgIFxuICAgIC8vIFhYWFlEIFRPRE86IHdvdWxkIGJlIGJldHRlciBpZiBXaW5BcHBEcml2ZXIgZGlkbid0IHJlcXVpcmUgcGFzc2luZyBpbiAvd2QvaHViIGFzIGEgcGFyYW1cbiAgICBsZXQgYXJncyA9IFt0aGlzLnByb3h5UG9ydCArIFwiL3dkL2h1YlwiXTtcblxuICAgIGNvbnN0IHN0YXJ0RGV0ZWN0b3IgPSAoc3Rkb3V0KSA9PiB7XG4gICAgICByZXR1cm4gc3Rkb3V0LmluZGV4T2YoXCJsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzXCIpICE9PSAtMTsgICAgICAgIFxuICAgIH07XG5cbiAgICBsZXQgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5raWxsQWxsKCk7XG5cbiAgICAgIC8vIHNldCB1cCBvdXIgc3VicHJvY2VzcyBvYmplY3RcbiAgICAgIHRoaXMucHJvYyA9IG5ldyBTdWJQcm9jZXNzKFdBRF9JTlNUQUxMX1BBVEgsIGFyZ3MsIHtcbiAgICAgICAgZW5jb2Rpbmc6ICd1Y3MyJ1xuICAgICAgfSk7XG4gICAgICBwcm9jZXNzSXNBbGl2ZSA9IHRydWU7XG5cbiAgICAgIC8vIGhhbmRsZSBsb2cgb3V0cHV0XG4gICAgICBmb3IgKGxldCBzdHJlYW0gb2YgWydTVERPVVQnLCAnU1RERVJSJ10pIHtcbiAgICAgICAgdGhpcy5wcm9jLm9uKGBsaW5lcy0ke3N0cmVhbS50b0xvd2VyQ2FzZSgpfWAsIChsaW5lcykgPT4ge1xuICAgICAgICAgIGZvciAobGV0IGwgb2YgbGluZXMpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKGBbJHtzdHJlYW19XSAke2wudHJpbSgpfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIGhhbmRsZSBvdXQtb2YtYm91bmQgZXhpdCBieSBzaW1wbHkgZW1pdHRpbmcgYSBzdG9wcGVkIHN0YXRlXG4gICAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHByb2Nlc3NJc0FsaXZlID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSBXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCAmJlxuICAgICAgICAgICAgdGhpcy5zdGF0ZSAhPT0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQSU5HKSB7XG4gICAgICAgICAgbGV0IG1zZyA9IGBXaW5BcHBEcml2ZXIgZXhpdGVkIHVuZXhwZWN0ZWRseSB3aXRoIGNvZGUgJHtjb2RlfSwgYCArXG4gICAgICAgICAgICAgICAgICAgIGBzaWduYWwgJHtzaWduYWx9YDtcbiAgICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgICB0aGlzLmNoYW5nZVN0YXRlKFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBsb2cuaW5mbyhgU3Bhd25pbmcgd2luYXBwZHJpdmVyIHdpdGg6ICR7YXJncy5qb2luKCcgJyl9YCk7XG5cbiAgICAgIC8vIHN0YXJ0IHN1YnByb2MgYW5kIHdhaXQgZm9yIHN0YXJ0RGV0ZWN0b3JcbiAgICAgIGF3YWl0IHRoaXMucHJvYy5zdGFydChzdGFydERldGVjdG9yKTtcbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvck9ubGluZSgpO1xuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5lbWl0KFdpbkFwcERyaXZlci5FVkVOVF9FUlJPUiwgZSk7XG4gICAgICAvLyBqdXN0IGJlY2F1c2Ugd2UgaGFkIGFuIGVycm9yIGRvZXNuJ3QgbWVhbiB0aGUgd2luYXBwZHJpdmVyIHByb2Nlc3NcbiAgICAgIC8vIGZpbmlzaGVkOyB3ZSBzaG91bGQgY2xlYW4gdXAgaWYgbmVjZXNzYXJ5XG4gICAgICBpZiAocHJvY2Vzc0lzQWxpdmUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICAgIH1cbiAgfSAgICAgIFxuXG4gIHNlc3Npb25JZCAoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFdpbkFwcERyaXZlci5TVEFURV9PTkxJTkUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmp3cHJveHkuc2Vzc2lvbklkO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvck9ubGluZSAoKSB7XG5cbiAgICAvLyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSBXQUQgaGFzbid0IGNyYXNoZWRcbiAgICBsZXQgd2luYXBwZHJpdmVyU3RvcHBlZCA9IGZhbHNlO1xuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMjAsIDIwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKFtXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCwgV2luQXBwRHJpdmVyLlNUQVRFX09OTElORV0uaW5kZXhPZih0aGlzLnN0YXRlKSA+PSAwKSB7XG4gICAgICAgIC8vIHdlIGFyZSBlaXRoZXIgc3RvcHBlZCwgc3RvcHBpbmcsIG9yIHdlJ3JlIG9ubGluZVxuICAgICAgICB3aW5hcHBkcml2ZXJTdG9wcGVkID0gdGhpcy5zdGF0ZSA9PT0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQ7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKGF3YWl0IHRoaXMuZ2V0U3RhdHVzKCkpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfT05MSU5FKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmICh3aW5hcHBkcml2ZXJTdG9wcGVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dpbkFwcERyaXZlciBjcmFzaGVkIGR1cmluZyBzdGFydHVwLicpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7XG4gICAgY29uc3QgcmVzQmxvY2sgPSBhd2FpdCB0aGlzLmp3cHJveHkucHJveHkoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgaWYgKHJlc0Jsb2NrWzBdLnN0YXR1c0NvZGUgPT09IDIwMCl7XG4gICAgICAgIGxvZy5pbmZvKGBTdGF0dXMgY2FsbCByZXR1cm5lZCAyMDAuIHdlJ3JlIG9ubGluZSBhbmQgcmVhZHkgdG8gcnVuIHRlc3RzYCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICB9XG4gICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcbiAgfVxuXG4gIGFzeW5jIHN0b3AgKGVtaXRTdGF0ZXMgPSB0cnVlKSB7XG4gICAgaWYgKGVtaXRTdGF0ZXMpIHtcbiAgICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQSU5HKTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcbiAgICAgIH1cbiAgICAgIGlmIChlbWl0U3RhdGVzKSB7XG4gICAgICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5lcnJvcihlKTtcbiAgICB9XG4gIH1cblxuICBjaGFuZ2VTdGF0ZSAoc3RhdGUpIHtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgbG9nLmRlYnVnKGBXaW5BcHBEcml2ZXIgY2hhbmdlZCBzdGF0ZSB0byAnJHtzdGF0ZX0nYCk7XG4gICAgdGhpcy5lbWl0KFdpbkFwcERyaXZlci5FVkVOVF9DSEFOR0VELCB7c3RhdGV9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcSAocmVxLCByZXMpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxBbGwgKCkge1xuICAgIGxldCBjbWQ7XG4gICAgLy8ganMgaGludCBjYW5ub3QgaGFuZGxlIGJhY2t0aWNrcywgZXZlbiBlc2NhcGVkLCB3aXRoaW4gdGVtcGxhdGUgbGl0ZXJhbHNcbiAgICBjbWQgPSBcIkZPUiAvRiBcXFwidXNlYmFja3EgdG9rZW5zPTVcXFwiICVhIGluIChgbmV0c3RhdCAtbmFvIF58IFwiICtcbiAgICAgICAgICBcImZpbmRzdHIgL1IgL0M6XFxcIlwiICsgdGhpcy5wcm94eVBvcnQgKyBcIiBcXFwiYCkgZG8gKFwiICtcbiAgICAgICAgICBcIkZPUiAvRiBcXFwidXNlYmFja3FcXFwiICViIGluIChgVEFTS0xJU1QgL0ZJIFxcXCJQSUQgZXEgJWFcXFwiIF58IFwiICtcbiAgICAgICAgICBcImZpbmRzdHIgL0kgd2luYXBwZHJpdmVyLmV4ZWApIGRvIChJRiBOT1QgJWI9PVxcXCJcXFwiIFRBU0tLSUxMIFwiICtcbiAgICAgICAgICBcIi9GIC9QSUQgJWEpKVwiO1xuICAgIGxvZy5pbmZvKGBLaWxsaW5nIGFueSBvbGQgV2luQXBwRHJpdmVycyBvbiBzYW1lIHBvcnQsIHJ1bm5pbmc6ICR7Y21kfWApO1xuICAgIHRyeSB7XG4gICAgICAvLyB1c2UgY3AuZXhlYyBpbnN0ZWFkIG9mIHRlZW4gcHJvY2VzcyBiZWNhdXNlIG9mIGNyYXp5IHdpbmRvd3MgcXVvdGluZ1xuICAgICAgYXdhaXQgKEIucHJvbWlzaWZ5KGNwLmV4ZWMpKShjbWQpO1xuICAgICAgbG9nLmluZm8oXCJTdWNjZXNzZnVsbHkgY2xlYW5lZCB1cCBvbGQgV2luQXBwRHJpdmVyc1wiKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5pbmZvKFwiTm8gb2xkIFdpbkFwcERyaXZlcnMgc2VlbWVkIHRvIGV4aXN0XCIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZy5kZWJ1ZygnRGVsZXRpbmcgV2luQXBwRHJpdmVyIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBXaW5BcHBEcml2ZXIgZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cbn1cblxuV2luQXBwRHJpdmVyLkVWRU5UX0VSUk9SID0gJ3dpbmFwcGRyaXZlcl9lcnJvcic7XG5XaW5BcHBEcml2ZXIuRVZFTlRfQ0hBTkdFRCA9ICdzdGF0ZUNoYW5nZWQnO1xuV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQgPSAnc3RvcHBlZCc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfU1RBUlRJTkcgPSAnc3RhcnRpbmcnO1xuV2luQXBwRHJpdmVyLlNUQVRFX09OTElORSA9ICdvbmxpbmUnO1xuV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQSU5HID0gJ3N0b3BwaW5nJztcblxuZXhwb3J0IHsgV2luQXBwRHJpdmVyLCBERUZBVUxUX1dBRF9IT1NULCBERUZBVUxUX1dBRF9QT1JUfTtcbmV4cG9ydCBkZWZhdWx0IFdpbkFwcERyaXZlcjtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
