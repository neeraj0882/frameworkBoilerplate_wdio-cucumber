require('source-map-support').install();

'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _appiumSupport = require('appium-support');

var _libInstall = require('../lib/install');

var _libChromedriver = require('../lib/chromedriver');

var _libChromedriver2 = _interopRequireDefault(_libChromedriver);

var should = _chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

function assertNoPreviousDirs() {
  var err;
  return _regeneratorRuntime.async(function assertNoPreviousDirs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        err = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.stat(_libInstall.CD_BASE_DIR));

      case 4:
        context$1$0.next = 9;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

        err = context$1$0.t0;

      case 9:
        should.exist(err);
        err.code.should.eql("ENOENT");

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

describe('install scripts', function () {
  this.timeout(2000000);
  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(_libInstall.CD_BASE_DIR));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });
  it('should install for this platform', function callee$1$0() {
    var cdPath, cdStat, cd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(assertNoPreviousDirs());

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libInstall.install)());

        case 4:
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap((0, _libInstall.getChromedriverBinaryPath)());

        case 6:
          cdPath = context$2$0.sent;
          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.stat(cdPath));

        case 9:
          cdStat = context$2$0.sent;

          cdStat.size.should.be.above(500000);
          cdPath.should.contain((0, _libInstall.getCurPlatform)());
          cd = new _libChromedriver2['default']();
          context$2$0.next = 15;
          return _regeneratorRuntime.awrap(cd.initChromedriverPath());

        case 15:
          cd.chromedriver.should.equal(cdPath);

        case 16:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });
  it('should install for all platforms', function callee$1$0() {
    var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, platform, arch, cdPath, cdStat;

    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          this.timeout(120000);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(assertNoPreviousDirs());

        case 3:
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap((0, _libInstall.installAll)());

        case 5:
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$2$0.prev = 8;
          _iterator = _getIterator((0, _libInstall.getPlatforms)());

        case 10:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$2$0.next = 26;
            break;
          }

          _step$value = _slicedToArray(_step.value, 2);
          platform = _step$value[0];
          arch = _step$value[1];
          context$2$0.next = 16;
          return _regeneratorRuntime.awrap((0, _libInstall.getChromedriverBinaryPath)(platform, arch));

        case 16:
          cdPath = context$2$0.sent;
          context$2$0.next = 19;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.stat(cdPath));

        case 19:
          cdStat = context$2$0.sent;

          cdStat.size.should.be.above(500000);
          cdPath.should.contain(platform);
          if (platform === "linux") {
            cdPath.should.contain(arch);
          } else {
            cdPath.should.not.contain(arch);
          }

        case 23:
          _iteratorNormalCompletion = true;
          context$2$0.next = 10;
          break;

        case 26:
          context$2$0.next = 32;
          break;

        case 28:
          context$2$0.prev = 28;
          context$2$0.t0 = context$2$0['catch'](8);
          _didIteratorError = true;
          _iteratorError = context$2$0.t0;

        case 32:
          context$2$0.prev = 32;
          context$2$0.prev = 33;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 35:
          context$2$0.prev = 35;

          if (!_didIteratorError) {
            context$2$0.next = 38;
            break;
          }

          throw _iteratorError;

        case 38:
          return context$2$0.finish(35);

        case 39:
          return context$2$0.finish(32);

        case 40:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[8, 28, 32, 40], [33,, 35, 39]]);
  });
  it('should throw an error in chromedriver if nothing is installed', function callee$1$0() {
    var cd, err;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(assertNoPreviousDirs());

        case 2:
          cd = new _libChromedriver2['default']();
          err = undefined;
          context$2$0.prev = 4;
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(cd.initChromedriverPath());

        case 7:
          context$2$0.next = 12;
          break;

        case 9:
          context$2$0.prev = 9;
          context$2$0.t0 = context$2$0['catch'](4);

          err = context$2$0.t0;

        case 12:
          should.exist(err);
          err.message.should.contain("path");

        case 14:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[4, 9]]);
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvaW5zdGFsbC1lMmUtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O29CQUVpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7Ozs2QkFDMUIsZ0JBQWdCOzswQkFFVSxnQkFBZ0I7OytCQUNwQyxxQkFBcUI7Ozs7QUFHOUMsSUFBSSxNQUFNLEdBQUcsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDM0Isa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsU0FBZSxvQkFBb0I7TUFDN0IsR0FBRzs7OztBQUFILFdBQUc7Ozt5Q0FFQyxrQkFBRyxJQUFJLHlCQUFhOzs7Ozs7Ozs7O0FBRTFCLFdBQUcsaUJBQUksQ0FBQzs7O0FBRVYsY0FBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsQixXQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7Ozs7Q0FDL0I7O0FBRUQsUUFBUSxDQUFDLGlCQUFpQixFQUFFLFlBQVk7QUFDdEMsTUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0QixZQUFVLENBQUM7Ozs7OzJDQUNILGtCQUFHLE1BQU0seUJBQWE7Ozs7Ozs7R0FDN0IsQ0FBQyxDQUFDO0FBQ0gsSUFBRSxDQUFDLGtDQUFrQyxFQUFFO1FBR2pDLE1BQU0sRUFDTixNQUFNLEVBR04sRUFBRTs7Ozs7MkNBTkEsb0JBQW9CLEVBQUU7Ozs7MkNBQ3RCLDBCQUFTOzs7OzJDQUNJLDRDQUEyQjs7O0FBQTFDLGdCQUFNOzsyQ0FDUyxrQkFBRyxJQUFJLENBQUMsTUFBTSxDQUFDOzs7QUFBOUIsZ0JBQU07O0FBQ1YsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDcEMsZ0JBQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLGlDQUFnQixDQUFDLENBQUM7QUFDcEMsWUFBRSxHQUFHLGtDQUFrQjs7MkNBQ3JCLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRTs7O0FBQy9CLFlBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQzs7Ozs7OztHQUN0QyxDQUFDLENBQUM7QUFDSCxJQUFFLENBQUMsa0NBQWtDLEVBQUU7cUdBSzNCLFFBQVEsRUFBRSxJQUFJLEVBQ2xCLE1BQU0sRUFDTixNQUFNOzs7OztBQU5aLGNBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7OzJDQUNmLG9CQUFvQixFQUFFOzs7OzJDQUN0Qiw2QkFBWTs7Ozs7OzttQ0FFVywrQkFBYzs7Ozs7Ozs7O0FBQWpDLGtCQUFRO0FBQUUsY0FBSTs7MkNBQ0gsMkNBQTBCLFFBQVEsRUFBRSxJQUFJLENBQUM7OztBQUF4RCxnQkFBTTs7MkNBQ1Msa0JBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQzs7O0FBQTlCLGdCQUFNOztBQUNWLGdCQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3BDLGdCQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNoQyxjQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUU7QUFDeEIsa0JBQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1dBQzdCLE1BQU07QUFDTCxrQkFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1dBQ2pDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBRUosQ0FBQyxDQUFDO0FBQ0gsSUFBRSxDQUFDLCtEQUErRCxFQUFFO1FBRTlELEVBQUUsRUFDRixHQUFHOzs7OzsyQ0FGRCxvQkFBb0IsRUFBRTs7O0FBQ3hCLFlBQUUsR0FBRyxrQ0FBa0I7QUFDdkIsYUFBRzs7OzJDQUVDLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRTs7Ozs7Ozs7OztBQUUvQixhQUFHLGlCQUFJLENBQUM7OztBQUVWLGdCQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2xCLGFBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQzs7Ozs7OztHQUNwQyxDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9pbnN0YWxsLWUyZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgQ0RfQkFTRV9ESVIsIGluc3RhbGwsIGluc3RhbGxBbGwsIGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgsXG4gICAgICAgICBnZXRDdXJQbGF0Zm9ybSwgZ2V0UGxhdGZvcm1zIH0gZnJvbSAnLi4vbGliL2luc3RhbGwnO1xuaW1wb3J0IENocm9tZWRyaXZlciBmcm9tICcuLi9saWIvY2hyb21lZHJpdmVyJztcblxuXG5sZXQgc2hvdWxkID0gY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxuYXN5bmMgZnVuY3Rpb24gYXNzZXJ0Tm9QcmV2aW91c0RpcnMgKCkge1xuICBsZXQgZXJyO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnN0YXQoQ0RfQkFTRV9ESVIpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgZXJyID0gZTtcbiAgfVxuICBzaG91bGQuZXhpc3QoZXJyKTtcbiAgZXJyLmNvZGUuc2hvdWxkLmVxbChcIkVOT0VOVFwiKTtcbn1cblxuZGVzY3JpYmUoJ2luc3RhbGwgc2NyaXB0cycsIGZ1bmN0aW9uICgpIHtcbiAgdGhpcy50aW1lb3V0KDIwMDAwMDApO1xuICBiZWZvcmVFYWNoKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBhd2FpdCBmcy5yaW1yYWYoQ0RfQkFTRV9ESVIpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBpbnN0YWxsIGZvciB0aGlzIHBsYXRmb3JtJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IGFzc2VydE5vUHJldmlvdXNEaXJzKCk7XG4gICAgYXdhaXQgaW5zdGFsbCgpO1xuICAgIGxldCBjZFBhdGggPSBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKCk7XG4gICAgbGV0IGNkU3RhdCA9IGF3YWl0IGZzLnN0YXQoY2RQYXRoKTtcbiAgICBjZFN0YXQuc2l6ZS5zaG91bGQuYmUuYWJvdmUoNTAwMDAwKTtcbiAgICBjZFBhdGguc2hvdWxkLmNvbnRhaW4oZ2V0Q3VyUGxhdGZvcm0oKSk7XG4gICAgbGV0IGNkID0gbmV3IENocm9tZWRyaXZlcigpO1xuICAgIGF3YWl0IGNkLmluaXRDaHJvbWVkcml2ZXJQYXRoKCk7XG4gICAgY2QuY2hyb21lZHJpdmVyLnNob3VsZC5lcXVhbChjZFBhdGgpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBpbnN0YWxsIGZvciBhbGwgcGxhdGZvcm1zJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudGltZW91dCgxMjAwMDApO1xuICAgIGF3YWl0IGFzc2VydE5vUHJldmlvdXNEaXJzKCk7XG4gICAgYXdhaXQgaW5zdGFsbEFsbCgpO1xuXG4gICAgZm9yIChsZXQgW3BsYXRmb3JtLCBhcmNoXSBvZiBnZXRQbGF0Zm9ybXMoKSkge1xuICAgICAgbGV0IGNkUGF0aCA9IGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgocGxhdGZvcm0sIGFyY2gpO1xuICAgICAgbGV0IGNkU3RhdCA9IGF3YWl0IGZzLnN0YXQoY2RQYXRoKTtcbiAgICAgIGNkU3RhdC5zaXplLnNob3VsZC5iZS5hYm92ZSg1MDAwMDApO1xuICAgICAgY2RQYXRoLnNob3VsZC5jb250YWluKHBsYXRmb3JtKTtcbiAgICAgIGlmIChwbGF0Zm9ybSA9PT0gXCJsaW51eFwiKSB7XG4gICAgICAgIGNkUGF0aC5zaG91bGQuY29udGFpbihhcmNoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNkUGF0aC5zaG91bGQubm90LmNvbnRhaW4oYXJjaCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciBpbiBjaHJvbWVkcml2ZXIgaWYgbm90aGluZyBpcyBpbnN0YWxsZWQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgYXNzZXJ0Tm9QcmV2aW91c0RpcnMoKTtcbiAgICBsZXQgY2QgPSBuZXcgQ2hyb21lZHJpdmVyKCk7XG4gICAgbGV0IGVycjtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgY2QuaW5pdENocm9tZWRyaXZlclBhdGgoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBlcnIgPSBlO1xuICAgIH1cbiAgICBzaG91bGQuZXhpc3QoZXJyKTtcbiAgICBlcnIubWVzc2FnZS5zaG91bGQuY29udGFpbihcInBhdGhcIik7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
