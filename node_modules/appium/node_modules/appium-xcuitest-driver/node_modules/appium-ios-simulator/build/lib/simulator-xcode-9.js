'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _simulatorXcode8 = require('./simulator-xcode-8');

var _simulatorXcode82 = _interopRequireDefault(_simulatorXcode8);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _asyncLock = require('async-lock');

var _asyncLock2 = _interopRequireDefault(_asyncLock);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _nodeSimctl = require('node-simctl');

var _asyncbox = require('asyncbox');

var SIMULATOR_SHUTDOWN_TIMEOUT = 15 * 1000;
var startupLock = new _asyncLock2['default']();
var preferencesPlistGuard = new _asyncLock2['default']();

var SimulatorXcode9 = (function (_SimulatorXcode8) {
  _inherits(SimulatorXcode9, _SimulatorXcode8);

  function SimulatorXcode9(udid, xcodeVersion) {
    _classCallCheck(this, SimulatorXcode9);

    _get(Object.getPrototypeOf(SimulatorXcode9.prototype), 'constructor', this).call(this, udid, xcodeVersion);
  }

  /**
   * @typedef {Object} DevicePreferences
   * @property {number} SimulatorExternalDisplay - TBD. Example value: 2.114
   * @property {string} ChromeTint - TBD. Example value: ''
   * @property {number} SimulatorWindowLastScale - Scale value for the particular Simulator window.
   *                                               1.0 means 100% scale.
   * @property {string} SimulatorWindowOrientation - Simulator window orientation. Possible values are:
   *                                                 'Portrait', 'LandscapeLeft', 'PortraitUpsideDown' and 'LandscapeRight'.
   * @property {number} SimulatorWindowRotationAngle - Window rotation angle. This value is expected to be in sync
   *                                                   with _SimulatorWindowOrientation_. The corresponding values are:
   *                                                   0, 90, 180 and 270.
   * @property {string} SimulatorWindowCenter - The coordinates of Simulator's window center in pixels,
   *                                            for example '{-1294.5, 775.5}'.
   */

  /**
   * @typedef {Object} CommonPreferences
   * @property {boolean} ConnectHardwareKeyboard - Whether to connect hardware keyboard
   */

  /**
   * Executes given Simulator with options. The Simulator will not be restarted if
   * it is already running and the current UI state matches to `isHeadless` option.
   * @override
   *
   * @param {object} opts - One or more of available Simulator options:
   *   - {string} scaleFactor: can be one of ['1.0', '0.75', '0.5', '0.33', '0.25'].
   *   Defines the window scale value for the UI client window for the current Simulator.
   *   Equals to null by default, which keeps the current scale unchanged.
   *   - {boolean} connectHardwareKeyboard: whether to connect the hardware keyboard to the
   *   Simulator UI client. Equals to false by default.
   *   - {number} startupTimeout: number of milliseconds to wait until Simulator booting
   *   process is completed. The default timeout will be used if not set explicitly.
   *   - {boolean} isHeadless: whether to start the Simulator in headless mode (with UI
   *   client invisible). `false` by default.
   *   - {DevicePreferences} devicePreferences: preferences of the newly created Simulator
   *   device
   */

  _createClass(SimulatorXcode9, [{
    key: 'run',
    value: function run() {
      var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
      var commonPreferences, bootSimulator, waitForShutdown, shouldWaitForBoot, startTime;
      return _regeneratorRuntime.async(function run$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            opts = _Object$assign({
              devicePreferences: {},
              isHeadless: false,
              startupTimeout: this.startupTimeout
            }, opts);
            if (opts.scaleFactor) {
              opts.devicePreferences.SimulatorWindowLastScale = parseFloat(opts.scaleFactor);
            }
            commonPreferences = _lodash2['default'].isBoolean(opts.connectHardwareKeyboard) ? { ConnectHardwareKeyboard: opts.connectHardwareKeyboard } : {};

            if (!(!_lodash2['default'].isEmpty(opts.devicePreferences) || !_lodash2['default'].isEmpty(commonPreferences))) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.updatePreferences(opts.devicePreferences, commonPreferences));

          case 6:
            bootSimulator = function bootSimulator() {
              return _regeneratorRuntime.async(function bootSimulator$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap((0, _nodeSimctl.bootDevice)(this.udid));

                  case 3:
                    context$3$0.next = 8;
                    break;

                  case 5:
                    context$3$0.prev = 5;
                    context$3$0.t0 = context$3$0['catch'](0);

                    _logger2['default'].warn('\'xcrun simctl boot ' + this.udid + '\' command has returned non-zero code. The problem was: ' + context$3$0.t0.stderr);

                  case 8:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this, [[0, 5]]);
            };

            waitForShutdown = function waitForShutdown() {
              return _regeneratorRuntime.async(function waitForShutdown$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$3$0() {
                      var _ref, state;

                      return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            context$4$0.next = 2;
                            return _regeneratorRuntime.awrap(this.stat());

                          case 2:
                            _ref = context$4$0.sent;
                            state = _ref.state;
                            return context$4$0.abrupt('return', state === 'Shutdown');

                          case 5:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this2);
                    }, { waitMs: SIMULATOR_SHUTDOWN_TIMEOUT, intervalMs: 500 }));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            };

            shouldWaitForBoot = true;
            startTime = process.hrtime();
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(startupLock.acquire(this.uiClientBundleId, function callee$2$0() {
              var stat, serverState, isServerRunning, isUIClientRunning;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.stat());

                  case 2:
                    stat = context$3$0.sent;
                    serverState = stat.state;
                    isServerRunning = serverState === 'Booted';
                    context$3$0.next = 7;
                    return _regeneratorRuntime.awrap(this.isUIClientRunning());

                  case 7:
                    isUIClientRunning = context$3$0.sent;

                    if (!opts.isHeadless) {
                      context$3$0.next = 24;
                      break;
                    }

                    if (!(isServerRunning && !isUIClientRunning)) {
                      context$3$0.next = 13;
                      break;
                    }

                    _logger2['default'].info('Simulator with UDID ' + this.udid + ' already booted in headless mode.');
                    shouldWaitForBoot = false;
                    return context$3$0.abrupt('return');

                  case 13:
                    context$3$0.next = 15;
                    return _regeneratorRuntime.awrap(this.killUIClient());

                  case 15:
                    if (!context$3$0.sent) {
                      context$3$0.next = 19;
                      break;
                    }

                    // Stopping the UI client also kills all running servers. Sad but true
                    _logger2['default'].info('Detected the UI client was running and killed it. Verifying the Simulator is in Shutdown state...');
                    context$3$0.next = 19;
                    return _regeneratorRuntime.awrap(waitForShutdown());

                  case 19:
                    _logger2['default'].info('Booting Simulator with UDID ' + this.udid + ' in headless mode. All UI-related capabilities are going to be ignored.');
                    context$3$0.next = 22;
                    return _regeneratorRuntime.awrap(bootSimulator());

                  case 22:
                    context$3$0.next = 47;
                    break;

                  case 24:
                    if (!(isServerRunning && isUIClientRunning)) {
                      context$3$0.next = 28;
                      break;
                    }

                    _logger2['default'].info('Both Simulator with UDID ' + this.udid + ' and the UI client are currently running');
                    shouldWaitForBoot = false;
                    return context$3$0.abrupt('return');

                  case 28:
                    if (!(['Shutdown', 'Booted'].indexOf(serverState) === -1)) {
                      context$3$0.next = 41;
                      break;
                    }

                    if (!(serverState !== 'Shutting Down')) {
                      context$3$0.next = 39;
                      break;
                    }

                    _logger2['default'].info('Simulator ' + this.udid + ' is in \'' + serverState + '\' state. Trying to shutdown...');
                    context$3$0.prev = 31;
                    context$3$0.next = 34;
                    return _regeneratorRuntime.awrap(this.shutdown());

                  case 34:
                    context$3$0.next = 39;
                    break;

                  case 36:
                    context$3$0.prev = 36;
                    context$3$0.t0 = context$3$0['catch'](31);

                    _logger2['default'].warn('Error on Simulator shutdown: ' + context$3$0.t0.message);

                  case 39:
                    context$3$0.next = 41;
                    return _regeneratorRuntime.awrap(waitForShutdown());

                  case 41:
                    _logger2['default'].info('Booting Simulator with UDID ' + this.udid + '...');
                    context$3$0.next = 44;
                    return _regeneratorRuntime.awrap(bootSimulator());

                  case 44:
                    if (isUIClientRunning) {
                      context$3$0.next = 47;
                      break;
                    }

                    context$3$0.next = 47;
                    return _regeneratorRuntime.awrap(this.startUIClient(opts));

                  case 47:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this, [[31, 36]]);
            }));

          case 12:
            if (!shouldWaitForBoot) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.waitForBoot(opts.startupTimeout, bootSimulator));

          case 15:
            _logger2['default'].info('Simulator with UDID ' + this.udid + ' booted in ' + process.hrtime(startTime)[0] + ' seconds');

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Perform verification of device preferences correctness.
     *
     * @param {DevicePreferences} prefs [{}] - The preferences to be verified
     * @throws {Error} If any of the given preference values does not match the expected
     * format.
     */
  }, {
    key: 'verifyDevicePreferences',
    value: function verifyDevicePreferences() {
      var prefs = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

      if (_lodash2['default'].isEmpty(prefs)) {
        return;
      }

      if (!_lodash2['default'].isUndefined(prefs.SimulatorWindowLastScale)) {
        if (!_lodash2['default'].isNumber(prefs.SimulatorWindowLastScale) || prefs.SimulatorWindowLastScale <= 0) {
          _logger2['default'].errorAndThrow('SimulatorWindowLastScale is expected to be a positive float value. ' + ('\'' + prefs.SimulatorWindowLastScale + '\' is assigned instead.'));
        }
      }

      if (!_lodash2['default'].isUndefined(prefs.SimulatorWindowCenter)) {
        // https://regex101.com/r/2ZXOij/2
        var verificationPattern = /\{\-?\d+(\.\d+)?,\-?\d+(\.\d+)?\}/;
        if (!_lodash2['default'].isString(prefs.SimulatorWindowCenter) || !verificationPattern.test(prefs.SimulatorWindowCenter)) {
          _logger2['default'].errorAndThrow('SimulatorWindowCenter is expected to match "{floatXPosition,floatYPosition}" format (without spaces). ' + ('\'' + prefs.SimulatorWindowCenter + '\' is assigned instead.'));
        }
      }

      if (!_lodash2['default'].isUndefined(prefs.SimulatorWindowOrientation)) {
        var acceptableValues = ['Portrait', 'LandscapeLeft', 'PortraitUpsideDown', 'LandscapeRight'];
        if (acceptableValues.indexOf(prefs.SimulatorWindowOrientation) === -1) {
          _logger2['default'].errorAndThrow('SimulatorWindowOrientation is expected to be one of ' + acceptableValues + '. ' + ('\'' + prefs.SimulatorWindowOrientation + '\' is assigned instead.'));
        }
      }

      if (!_lodash2['default'].isUndefined(prefs.SimulatorWindowRotationAngle)) {
        if (!_lodash2['default'].isNumber(prefs.SimulatorWindowRotationAngle)) {
          _logger2['default'].errorAndThrow('SimulatorWindowRotationAngle is expected to be a valid number. ' + ('\'' + prefs.SimulatorWindowRotationAngle + '\' is assigned instead.'));
        }
      }
    }

    /**
     * Update the common iOS Simulator preferences file with new values.
     * It is necessary to restart the corresponding Simulator before
     * these changes are applied.
     *
     * @param {DevicePreferences} devicePrefs [{}] - The mapping, which represents new device preference values
     *                                               for the given Simulator.
     * @param {CommonPreferences} commonPrefs [{}] - The mapping, which represents new common preference values
     *                                               for all Simulators.
     * @return {boolean} True if the preferences were successfully updated.
     */
  }, {
    key: 'updatePreferences',
    value: function updatePreferences() {
      var devicePrefs = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
      var commonPrefs = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var homeFolderPath, plistPath, newPrefs;
      return _regeneratorRuntime.async(function updatePreferences$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!_lodash2['default'].isEmpty(devicePrefs)) {
              _logger2['default'].debug('Setting preferences of ' + this.udid + ' Simulator to ' + JSON.stringify(devicePrefs));
            }
            if (!_lodash2['default'].isEmpty(commonPrefs)) {
              _logger2['default'].debug('Setting common Simulator preferences to ' + JSON.stringify(commonPrefs));
            }
            homeFolderPath = process.env.HOME;

            if (homeFolderPath) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].warn('Cannot get the path to HOME folder from the process environment. ' + 'Ignoring Simulator preferences update.');
            return context$2$0.abrupt('return', false);

          case 6:
            this.verifyDevicePreferences(devicePrefs);
            plistPath = _path2['default'].resolve(homeFolderPath, 'Library', 'Preferences', 'com.apple.iphonesimulator.plist');
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(plistPath));

          case 10:
            if (context$2$0.sent) {
              context$2$0.next = 13;
              break;
            }

            _logger2['default'].warn('Simulator preferences file \'' + plistPath + '\' is not accessible. ' + 'Ignoring Simulator preferences update.');
            return context$2$0.abrupt('return', false);

          case 13:
            newPrefs = {};

            if (!_lodash2['default'].isEmpty(devicePrefs)) {
              newPrefs.DevicePreferences = _defineProperty({}, this.udid.toUpperCase(), devicePrefs);
            }
            newPrefs = _lodash2['default'].merge(newPrefs, commonPrefs);
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(preferencesPlistGuard.acquire(SimulatorXcode9.name, function callee$2$0() {
              var currentPlistContent;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(_appiumSupport.plist.parsePlistFile(plistPath));

                  case 3:
                    currentPlistContent = context$3$0.sent;
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(plistPath, _lodash2['default'].merge(currentPlistContent, newPrefs), true));

                  case 6:
                    _logger2['default'].debug('Updated ' + this.udid + ' Simulator preferences at \'' + plistPath + '\' with ' + JSON.stringify(newPrefs));
                    return context$3$0.abrupt('return', true);

                  case 10:
                    context$3$0.prev = 10;
                    context$3$0.t0 = context$3$0['catch'](0);

                    _logger2['default'].warn('Cannot update ' + this.udid + ' Simulator preferences at \'' + plistPath + '\'. ' + ('Try to delete the file manually in order to reset it. Original error: ' + context$3$0.t0.message));
                    return context$3$0.abrupt('return', false);

                  case 14:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[0, 10]]);
            }));

          case 18:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Shut down the current Simulator.
     * @override
     */
  }, {
    key: 'shutdown',
    value: function shutdown() {
      var _ref2, state;

      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stat());

          case 2:
            _ref2 = context$2$0.sent;
            state = _ref2.state;

            if (!(state === 'Shutdown')) {
              context$2$0.next = 6;
              break;
            }

            return context$2$0.abrupt('return');

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.shutdown)(this.udid));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Reset the current Simulator to the clean state.
     * @override
     */
  }, {
    key: 'clean',
    value: function clean() {
      return _regeneratorRuntime.async(function clean$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Cleaning simulator ' + this.udid);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.eraseDevice)(this.udid, 10000));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Generate Apple script, which selects the necessary Simulator window
     * if multiple windows are opened.
     * @override
     */
  }, {
    key: 'generateWindowActivationScript',
    value: function generateWindowActivationScript() {
      var _ref3, name, sdk;

      return _regeneratorRuntime.async(function generateWindowActivationScript$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stat());

          case 2:
            _ref3 = context$2$0.sent;
            name = _ref3.name;
            sdk = _ref3.sdk;
            return context$2$0.abrupt('return', '\n      tell application "System Events"\n        tell process "Simulator"\n          set frontmost to false\n          set frontmost to true\n          click (menu item 1 where (its name contains "' + name + ' -" and its name contains "' + sdk + '")) of menu 1 of menu bar item "Window" of menu bar 1\n        end tell\n      end tell\n    ');

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get the current state of Touch ID Enrollment feature.
     * @override
     */
  }, {
    key: 'isTouchIDEnrolled',
    value: function isTouchIDEnrolled() {
      var output;
      return _regeneratorRuntime.async(function isTouchIDEnrolled$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.executeUIClientScript('\n      tell application "System Events"\n        tell process "Simulator"\n          set dstMenuItem to menu item "Enrolled" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1\n          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"\n        end tell\n      end tell\n    '));

          case 2:
            output = context$2$0.sent;

            _logger2['default'].debug('Touch ID enrolled state: ' + output);
            return context$2$0.abrupt('return', _lodash2['default'].isString(output) && output.trim() === 'true');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Execute a special Apple script, which changes Touch ID feature testing in Simulator UI client.
     * @override
     */
  }, {
    key: 'enrollTouchID',
    value: function enrollTouchID() {
      var isEnabled = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function enrollTouchID$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.executeUIClientScript('\n      tell application "System Events"\n        tell process "Simulator"\n          set dstMenuItem to menu item "Enrolled" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1\n          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"\n          if ' + (isEnabled ? 'not ' : '') + 'isChecked then\n            click dstMenuItem\n          end if\n        end tell\n      end tell\n    '));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return SimulatorXcode9;
})(_simulatorXcode82['default']);

exports['default'] = SimulatorXcode9;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OytCQUE0QixxQkFBcUI7Ozs7c0JBQ25DLFFBQVE7Ozs7b0JBQ0wsTUFBTTs7Ozs2QkFDRyxnQkFBZ0I7O3lCQUNwQixZQUFZOzs7O3NCQUNsQixVQUFVOzs7OzBCQUMwQyxhQUFhOzt3QkFDaEQsVUFBVTs7QUFHM0MsSUFBTSwwQkFBMEIsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQzdDLElBQU0sV0FBVyxHQUFHLDRCQUFlLENBQUM7QUFDcEMsSUFBTSxxQkFBcUIsR0FBRyw0QkFBZSxDQUFDOztJQUV4QyxlQUFlO1lBQWYsZUFBZTs7QUFDUCxXQURSLGVBQWUsQ0FDTixJQUFJLEVBQUUsWUFBWSxFQUFFOzBCQUQ3QixlQUFlOztBQUVqQiwrQkFGRSxlQUFlLDZDQUVYLElBQUksRUFBRSxZQUFZLEVBQUU7R0FDM0I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2VBSEcsZUFBZTs7V0EyQ1Q7VUFBQyxJQUFJLHlEQUFHLEVBQUU7VUFTWixpQkFBaUIsRUFNakIsYUFBYSxFQU9iLGVBQWUsRUFNakIsaUJBQWlCLEVBQ2YsU0FBUzs7Ozs7O0FBNUJmLGdCQUFJLEdBQUcsZUFBYztBQUNuQiwrQkFBaUIsRUFBRSxFQUFFO0FBQ3JCLHdCQUFVLEVBQUUsS0FBSztBQUNqQiw0QkFBYyxFQUFFLElBQUksQ0FBQyxjQUFjO2FBQ3BDLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDVCxnQkFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO0FBQ3BCLGtCQUFJLENBQUMsaUJBQWlCLENBQUMsd0JBQXdCLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUNoRjtBQUNLLDZCQUFpQixHQUFHLG9CQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsR0FDakUsRUFBQyx1QkFBdUIsRUFB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Ozs7S0FDaEM7Ozs7Ozs7O1dBTVc7Ozs7QUFDVixnQ0FBSSxJQUFJLHlCQUF1QixJQUFJLENBQUMsSUFBSSxDQUFHLENBQUM7OzZDQUN0Qyw2QkFBWSxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQzs7Ozs7OztLQUNwQzs7Ozs7Ozs7O1dBT29DO2lCQUM1QixJQUFJLEVBQUUsR0FBRzs7Ozs7OzZDQUFVLElBQUksQ0FBQyxJQUFJLEVBQUU7Ozs7QUFBOUIsZ0JBQUksU0FBSixJQUFJO0FBQUUsZUFBRyxTQUFILEdBQUc7MlBBTXFDLElBQUksbUNBQThCLEdBQUc7Ozs7Ozs7S0FJM0Y7Ozs7Ozs7O1dBTXVCO1VBQ2hCLE1BQU07Ozs7OzZDQUFTLElBQUksQ0FBQyxxQkFBcUIsMlZBTzdDOzs7QUFQSSxrQkFBTTs7QUFRWixnQ0FBSSxLQUFLLCtCQUE2QixNQUFNLENBQUcsQ0FBQztnREFDekMsb0JBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxNQUFNOzs7Ozs7O0tBQ3REOzs7Ozs7OztXQU1tQjtVQUFDLFNBQVMseURBQUcsSUFBSTs7Ozs7NkNBQzdCLElBQUksQ0FBQyxxQkFBcUIscVVBS3JCLFNBQVMsR0FBRyxNQUFNLEdBQUcsRUFBRSxDQUFBLDZHQUtoQzs7Ozs7OztLQUNIOzs7U0FoU0csZUFBZTs7O3FCQW1TTixlQUFlIiwiZmlsZSI6ImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTaW11bGF0b3JYY29kZTggZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtOCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcywgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBzaHV0ZG93biBhcyBzaW1jdGxTaHV0ZG93biwgYm9vdERldmljZSwgZXJhc2VEZXZpY2UgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5cbmNvbnN0IFNJTVVMQVRPUl9TSFVURE9XTl9USU1FT1VUID0gMTUgKiAxMDAwO1xuY29uc3Qgc3RhcnR1cExvY2sgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBwcmVmZXJlbmNlc1BsaXN0R3VhcmQgPSBuZXcgQXN5bmNMb2NrKCk7XG5cbmNsYXNzIFNpbXVsYXRvclhjb2RlOSBleHRlbmRzIFNpbXVsYXRvclhjb2RlOCB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB4Y29kZVZlcnNpb24pIHtcbiAgICBzdXBlcih1ZGlkLCB4Y29kZVZlcnNpb24pO1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IERldmljZVByZWZlcmVuY2VzXG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBTaW11bGF0b3JFeHRlcm5hbERpc3BsYXkgLSBUQkQuIEV4YW1wbGUgdmFsdWU6IDIuMTE0XG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBDaHJvbWVUaW50IC0gVEJELiBFeGFtcGxlIHZhbHVlOiAnJ1xuICAgKiBAcHJvcGVydHkge251bWJlcn0gU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlIC0gU2NhbGUgdmFsdWUgZm9yIHRoZSBwYXJ0aWN1bGFyIFNpbXVsYXRvciB3aW5kb3cuXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLjAgbWVhbnMgMTAwJSBzY2FsZS5cbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IFNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uIC0gU2ltdWxhdG9yIHdpbmRvdyBvcmllbnRhdGlvbi4gUG9zc2libGUgdmFsdWVzIGFyZTpcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1BvcnRyYWl0JywgJ0xhbmRzY2FwZUxlZnQnLCAnUG9ydHJhaXRVcHNpZGVEb3duJyBhbmQgJ0xhbmRzY2FwZVJpZ2h0Jy5cbiAgICogQHByb3BlcnR5IHtudW1iZXJ9IFNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGUgLSBXaW5kb3cgcm90YXRpb24gYW5nbGUuIFRoaXMgdmFsdWUgaXMgZXhwZWN0ZWQgdG8gYmUgaW4gc3luY1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggX1NpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uXy4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzIGFyZTpcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLCA5MCwgMTgwIGFuZCAyNzAuXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBTaW11bGF0b3JXaW5kb3dDZW50ZXIgLSBUaGUgY29vcmRpbmF0ZXMgb2YgU2ltdWxhdG9yJ3Mgd2luZG93IGNlbnRlciBpbiBwaXhlbHMsXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZXhhbXBsZSAney0xMjk0LjUsIDc3NS41fScuXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDb21tb25QcmVmZXJlbmNlc1xuICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IENvbm5lY3RIYXJkd2FyZUtleWJvYXJkIC0gV2hldGhlciB0byBjb25uZWN0IGhhcmR3YXJlIGtleWJvYXJkXG4gICAqL1xuXG4gIC8qKlxuICAgKiBFeGVjdXRlcyBnaXZlbiBTaW11bGF0b3Igd2l0aCBvcHRpb25zLiBUaGUgU2ltdWxhdG9yIHdpbGwgbm90IGJlIHJlc3RhcnRlZCBpZlxuICAgKiBpdCBpcyBhbHJlYWR5IHJ1bm5pbmcgYW5kIHRoZSBjdXJyZW50IFVJIHN0YXRlIG1hdGNoZXMgdG8gYGlzSGVhZGxlc3NgIG9wdGlvbi5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRzIC0gT25lIG9yIG1vcmUgb2YgYXZhaWxhYmxlIFNpbXVsYXRvciBvcHRpb25zOlxuICAgKiAgIC0ge3N0cmluZ30gc2NhbGVGYWN0b3I6IGNhbiBiZSBvbmUgb2YgWycxLjAnLCAnMC43NScsICcwLjUnLCAnMC4zMycsICcwLjI1J10uXG4gICAqICAgRGVmaW5lcyB0aGUgd2luZG93IHNjYWxlIHZhbHVlIGZvciB0aGUgVUkgY2xpZW50IHdpbmRvdyBmb3IgdGhlIGN1cnJlbnQgU2ltdWxhdG9yLlxuICAgKiAgIEVxdWFscyB0byBudWxsIGJ5IGRlZmF1bHQsIHdoaWNoIGtlZXBzIHRoZSBjdXJyZW50IHNjYWxlIHVuY2hhbmdlZC5cbiAgICogICAtIHtib29sZWFufSBjb25uZWN0SGFyZHdhcmVLZXlib2FyZDogd2hldGhlciB0byBjb25uZWN0IHRoZSBoYXJkd2FyZSBrZXlib2FyZCB0byB0aGVcbiAgICogICBTaW11bGF0b3IgVUkgY2xpZW50LiBFcXVhbHMgdG8gZmFsc2UgYnkgZGVmYXVsdC5cbiAgICogICAtIHtudW1iZXJ9IHN0YXJ0dXBUaW1lb3V0OiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgU2ltdWxhdG9yIGJvb3RpbmdcbiAgICogICBwcm9jZXNzIGlzIGNvbXBsZXRlZC4gVGhlIGRlZmF1bHQgdGltZW91dCB3aWxsIGJlIHVzZWQgaWYgbm90IHNldCBleHBsaWNpdGx5LlxuICAgKiAgIC0ge2Jvb2xlYW59IGlzSGVhZGxlc3M6IHdoZXRoZXIgdG8gc3RhcnQgdGhlIFNpbXVsYXRvciBpbiBoZWFkbGVzcyBtb2RlICh3aXRoIFVJXG4gICAqICAgY2xpZW50IGludmlzaWJsZSkuIGBmYWxzZWAgYnkgZGVmYXVsdC5cbiAgICogICAtIHtEZXZpY2VQcmVmZXJlbmNlc30gZGV2aWNlUHJlZmVyZW5jZXM6IHByZWZlcmVuY2VzIG9mIHRoZSBuZXdseSBjcmVhdGVkIFNpbXVsYXRvclxuICAgKiAgIGRldmljZVxuICAgKi9cbiAgYXN5bmMgcnVuIChvcHRzID0ge30pIHtcbiAgICBvcHRzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICBkZXZpY2VQcmVmZXJlbmNlczoge30sXG4gICAgICBpc0hlYWRsZXNzOiBmYWxzZSxcbiAgICAgIHN0YXJ0dXBUaW1lb3V0OiB0aGlzLnN0YXJ0dXBUaW1lb3V0LFxuICAgIH0sIG9wdHMpO1xuICAgIGlmIChvcHRzLnNjYWxlRmFjdG9yKSB7XG4gICAgICBvcHRzLmRldmljZVByZWZlcmVuY2VzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSA9IHBhcnNlRmxvYXQob3B0cy5zY2FsZUZhY3Rvcik7XG4gICAgfVxuICAgIGNvbnN0IGNvbW1vblByZWZlcmVuY2VzID0gXy5pc0Jvb2xlYW4ob3B0cy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZCkgP1xuICAgICAge0Nvbm5lY3RIYXJkd2FyZUtleWJvYXJkOiBvcHRzLmNvbm5lY3RIYXJkd2FyZUtleWJvYXJkfSA6XG4gICAgICB7fTtcbiAgICBpZiAoIV8uaXNFbXB0eShvcHRzLmRldmljZVByZWZlcmVuY2VzKSB8fCAhXy5pc0VtcHR5KGNvbW1vblByZWZlcmVuY2VzKSkge1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGVQcmVmZXJlbmNlcyhvcHRzLmRldmljZVByZWZlcmVuY2VzLCBjb21tb25QcmVmZXJlbmNlcyk7XG4gICAgfVxuICAgIGNvbnN0IGJvb3RTaW11bGF0b3IgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBib290RGV2aWNlKHRoaXMudWRpZCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLndhcm4oYCd4Y3J1biBzaW1jdGwgYm9vdCAke3RoaXMudWRpZH0nIGNvbW1hbmQgaGFzIHJldHVybmVkIG5vbi16ZXJvIGNvZGUuIFRoZSBwcm9ibGVtIHdhczogJHtlcnIuc3RkZXJyfWApO1xuICAgICAgfVxuICAgIH07XG4gICAgY29uc3Qgd2FpdEZvclNodXRkb3duID0gYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHtzdGF0ZX0gPSBhd2FpdCB0aGlzLnN0YXQoKTtcbiAgICAgICAgcmV0dXJuIHN0YXRlID09PSAnU2h1dGRvd24nO1xuICAgICAgfSwge3dhaXRNczogU0lNVUxBVE9SX1NIVVRET1dOX1RJTUVPVVQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH07XG4gICAgbGV0IHNob3VsZFdhaXRGb3JCb290ID0gdHJ1ZTtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgIGF3YWl0IHN0YXJ0dXBMb2NrLmFjcXVpcmUodGhpcy51aUNsaWVudEJ1bmRsZUlkLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzdGF0ID0gYXdhaXQgdGhpcy5zdGF0KCk7XG4gICAgICBjb25zdCBzZXJ2ZXJTdGF0ZSA9IHN0YXQuc3RhdGU7XG4gICAgICBjb25zdCBpc1NlcnZlclJ1bm5pbmcgPSBzZXJ2ZXJTdGF0ZSA9PT0gJ0Jvb3RlZCc7XG4gICAgICBjb25zdCBpc1VJQ2xpZW50UnVubmluZyA9IGF3YWl0IHRoaXMuaXNVSUNsaWVudFJ1bm5pbmcoKTtcbiAgICAgIGlmIChvcHRzLmlzSGVhZGxlc3MpIHtcbiAgICAgICAgaWYgKGlzU2VydmVyUnVubmluZyAmJiAhaXNVSUNsaWVudFJ1bm5pbmcpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIHdpdGggVURJRCAke3RoaXMudWRpZH0gYWxyZWFkeSBib290ZWQgaW4gaGVhZGxlc3MgbW9kZS5gKTtcbiAgICAgICAgICBzaG91bGRXYWl0Rm9yQm9vdCA9IGZhbHNlO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXdhaXQgdGhpcy5raWxsVUlDbGllbnQoKSkge1xuICAgICAgICAgIC8vIFN0b3BwaW5nIHRoZSBVSSBjbGllbnQgYWxzbyBraWxscyBhbGwgcnVubmluZyBzZXJ2ZXJzLiBTYWQgYnV0IHRydWVcbiAgICAgICAgICBsb2cuaW5mbyhgRGV0ZWN0ZWQgdGhlIFVJIGNsaWVudCB3YXMgcnVubmluZyBhbmQga2lsbGVkIGl0LiBWZXJpZnlpbmcgdGhlIFNpbXVsYXRvciBpcyBpbiBTaHV0ZG93biBzdGF0ZS4uLmApO1xuICAgICAgICAgIGF3YWl0IHdhaXRGb3JTaHV0ZG93bigpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBCb290aW5nIFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9IGluIGhlYWRsZXNzIG1vZGUuIEFsbCBVSS1yZWxhdGVkIGNhcGFiaWxpdGllcyBhcmUgZ29pbmcgdG8gYmUgaWdub3JlZC5gKTtcbiAgICAgICAgYXdhaXQgYm9vdFNpbXVsYXRvcigpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGlzU2VydmVyUnVubmluZyAmJiBpc1VJQ2xpZW50UnVubmluZykge1xuICAgICAgICAgIGxvZy5pbmZvKGBCb3RoIFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9IGFuZCB0aGUgVUkgY2xpZW50IGFyZSBjdXJyZW50bHkgcnVubmluZ2ApO1xuICAgICAgICAgIHNob3VsZFdhaXRGb3JCb290ID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChbJ1NodXRkb3duJywgJ0Jvb3RlZCddLmluZGV4T2Yoc2VydmVyU3RhdGUpID09PSAtMSkge1xuICAgICAgICAgIGlmIChzZXJ2ZXJTdGF0ZSAhPT0gJ1NodXR0aW5nIERvd24nKSB7XG4gICAgICAgICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yICR7dGhpcy51ZGlkfSBpcyBpbiAnJHtzZXJ2ZXJTdGF0ZX0nIHN0YXRlLiBUcnlpbmcgdG8gc2h1dGRvd24uLi5gKTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuc2h1dGRvd24oKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICBsb2cud2FybihgRXJyb3Igb24gU2ltdWxhdG9yIHNodXRkb3duOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBhd2FpdCB3YWl0Rm9yU2h1dGRvd24oKTtcbiAgICAgICAgfVxuICAgICAgICBsb2cuaW5mbyhgQm9vdGluZyBTaW11bGF0b3Igd2l0aCBVRElEICR7dGhpcy51ZGlkfS4uLmApO1xuICAgICAgICBhd2FpdCBib290U2ltdWxhdG9yKCk7XG4gICAgICAgIGlmICghaXNVSUNsaWVudFJ1bm5pbmcpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0VUlDbGllbnQob3B0cyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChzaG91bGRXYWl0Rm9yQm9vdCkge1xuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yQm9vdChvcHRzLnN0YXJ0dXBUaW1lb3V0LCBib290U2ltdWxhdG9yKTtcbiAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCBVRElEICR7dGhpcy51ZGlkfSBib290ZWQgaW4gJHtwcm9jZXNzLmhydGltZShzdGFydFRpbWUpWzBdfSBzZWNvbmRzYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gdmVyaWZpY2F0aW9uIG9mIGRldmljZSBwcmVmZXJlbmNlcyBjb3JyZWN0bmVzcy5cbiAgICpcbiAgICogQHBhcmFtIHtEZXZpY2VQcmVmZXJlbmNlc30gcHJlZnMgW3t9XSAtIFRoZSBwcmVmZXJlbmNlcyB0byBiZSB2ZXJpZmllZFxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgYW55IG9mIHRoZSBnaXZlbiBwcmVmZXJlbmNlIHZhbHVlcyBkb2VzIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWRcbiAgICogZm9ybWF0LlxuICAgKi9cbiAgdmVyaWZ5RGV2aWNlUHJlZmVyZW5jZXMgKHByZWZzID0ge30pIHtcbiAgICBpZiAoXy5pc0VtcHR5KHByZWZzKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUpKSB7XG4gICAgICBpZiAoIV8uaXNOdW1iZXIocHJlZnMuU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlKSB8fCBwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgPD0gMCkge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlIGlzIGV4cGVjdGVkIHRvIGJlIGEgcG9zaXRpdmUgZmxvYXQgdmFsdWUuIGAgK1xuICAgICAgICAgIGAnJHtwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGV9JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXIpKSB7XG4gICAgICAvLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yLzJaWE9pai8yXG4gICAgICBjb25zdCB2ZXJpZmljYXRpb25QYXR0ZXJuID0gL1xce1xcLT9cXGQrKFxcLlxcZCspPyxcXC0/XFxkKyhcXC5cXGQrKT9cXH0vO1xuICAgICAgaWYgKCFfLmlzU3RyaW5nKHByZWZzLlNpbXVsYXRvcldpbmRvd0NlbnRlcikgfHwgIXZlcmlmaWNhdGlvblBhdHRlcm4udGVzdChwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXIpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dDZW50ZXIgaXMgZXhwZWN0ZWQgdG8gbWF0Y2ggXCJ7ZmxvYXRYUG9zaXRpb24sZmxvYXRZUG9zaXRpb259XCIgZm9ybWF0ICh3aXRob3V0IHNwYWNlcykuIGAgK1xuICAgICAgICAgIGAnJHtwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXJ9JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbikpIHtcbiAgICAgIGNvbnN0IGFjY2VwdGFibGVWYWx1ZXMgPSBbJ1BvcnRyYWl0JywgJ0xhbmRzY2FwZUxlZnQnLCAnUG9ydHJhaXRVcHNpZGVEb3duJywgJ0xhbmRzY2FwZVJpZ2h0J107XG4gICAgICBpZiAoYWNjZXB0YWJsZVZhbHVlcy5pbmRleE9mKHByZWZzLlNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uKSA9PT0gLTEpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uIGlzIGV4cGVjdGVkIHRvIGJlIG9uZSBvZiAke2FjY2VwdGFibGVWYWx1ZXN9LiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb259JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlKSkge1xuICAgICAgaWYgKCFfLmlzTnVtYmVyKHByZWZzLlNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGUpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlIGlzIGV4cGVjdGVkIHRvIGJlIGEgdmFsaWQgbnVtYmVyLiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZX0nIGlzIGFzc2lnbmVkIGluc3RlYWQuYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgY29tbW9uIGlPUyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgZmlsZSB3aXRoIG5ldyB2YWx1ZXMuXG4gICAqIEl0IGlzIG5lY2Vzc2FyeSB0byByZXN0YXJ0IHRoZSBjb3JyZXNwb25kaW5nIFNpbXVsYXRvciBiZWZvcmVcbiAgICogdGhlc2UgY2hhbmdlcyBhcmUgYXBwbGllZC5cbiAgICpcbiAgICogQHBhcmFtIHtEZXZpY2VQcmVmZXJlbmNlc30gZGV2aWNlUHJlZnMgW3t9XSAtIFRoZSBtYXBwaW5nLCB3aGljaCByZXByZXNlbnRzIG5ldyBkZXZpY2UgcHJlZmVyZW5jZSB2YWx1ZXNcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZ2l2ZW4gU2ltdWxhdG9yLlxuICAgKiBAcGFyYW0ge0NvbW1vblByZWZlcmVuY2VzfSBjb21tb25QcmVmcyBbe31dIC0gVGhlIG1hcHBpbmcsIHdoaWNoIHJlcHJlc2VudHMgbmV3IGNvbW1vbiBwcmVmZXJlbmNlIHZhbHVlc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGFsbCBTaW11bGF0b3JzLlxuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBwcmVmZXJlbmNlcyB3ZXJlIHN1Y2Nlc3NmdWxseSB1cGRhdGVkLlxuICAgKi9cbiAgYXN5bmMgdXBkYXRlUHJlZmVyZW5jZXMgKGRldmljZVByZWZzID0ge30sIGNvbW1vblByZWZzID0ge30pIHtcbiAgICBpZiAoIV8uaXNFbXB0eShkZXZpY2VQcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBwcmVmZXJlbmNlcyBvZiAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHRvICR7SlNPTi5zdHJpbmdpZnkoZGV2aWNlUHJlZnMpfWApO1xuICAgIH1cbiAgICBpZiAoIV8uaXNFbXB0eShjb21tb25QcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBjb21tb24gU2ltdWxhdG9yIHByZWZlcmVuY2VzIHRvICR7SlNPTi5zdHJpbmdpZnkoY29tbW9uUHJlZnMpfWApO1xuICAgIH1cbiAgICBjb25zdCBob21lRm9sZGVyUGF0aCA9IHByb2Nlc3MuZW52LkhPTUU7XG4gICAgaWYgKCFob21lRm9sZGVyUGF0aCkge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBnZXQgdGhlIHBhdGggdG8gSE9NRSBmb2xkZXIgZnJvbSB0aGUgcHJvY2VzcyBlbnZpcm9ubWVudC4gYCArXG4gICAgICAgIGBJZ25vcmluZyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgdXBkYXRlLmApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnZlcmlmeURldmljZVByZWZlcmVuY2VzKGRldmljZVByZWZzKTtcbiAgICBjb25zdCBwbGlzdFBhdGggPSBwYXRoLnJlc29sdmUoaG9tZUZvbGRlclBhdGgsICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5pcGhvbmVzaW11bGF0b3IucGxpc3QnKTtcbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhwbGlzdFBhdGgpKSB7XG4gICAgICBsb2cud2FybihgU2ltdWxhdG9yIHByZWZlcmVuY2VzIGZpbGUgJyR7cGxpc3RQYXRofScgaXMgbm90IGFjY2Vzc2libGUuIGAgK1xuICAgICAgICBgSWdub3JpbmcgU2ltdWxhdG9yIHByZWZlcmVuY2VzIHVwZGF0ZS5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbGV0IG5ld1ByZWZzID0ge307XG4gICAgaWYgKCFfLmlzRW1wdHkoZGV2aWNlUHJlZnMpKSB7XG4gICAgICBuZXdQcmVmcy5EZXZpY2VQcmVmZXJlbmNlcyA9IHtbdGhpcy51ZGlkLnRvVXBwZXJDYXNlKCldOiBkZXZpY2VQcmVmc307XG4gICAgfVxuICAgIG5ld1ByZWZzID0gXy5tZXJnZShuZXdQcmVmcywgY29tbW9uUHJlZnMpO1xuICAgIHJldHVybiBhd2FpdCBwcmVmZXJlbmNlc1BsaXN0R3VhcmQuYWNxdWlyZShTaW11bGF0b3JYY29kZTkubmFtZSwgYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY3VycmVudFBsaXN0Q29udGVudCA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKHBsaXN0UGF0aCk7XG4gICAgICAgIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZShwbGlzdFBhdGgsIF8ubWVyZ2UoY3VycmVudFBsaXN0Q29udGVudCwgbmV3UHJlZnMpLCB0cnVlKTtcbiAgICAgICAgbG9nLmRlYnVnKGBVcGRhdGVkICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScgd2l0aCAke0pTT04uc3RyaW5naWZ5KG5ld1ByZWZzKX1gKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgdXBkYXRlICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScuIGAgK1xuICAgICAgICAgICAgICAgICBgVHJ5IHRvIGRlbGV0ZSB0aGUgZmlsZSBtYW51YWxseSBpbiBvcmRlciB0byByZXNldCBpdC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU2h1dCBkb3duIHRoZSBjdXJyZW50IFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgY29uc3Qge3N0YXRlfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgIGlmIChzdGF0ZSA9PT0gJ1NodXRkb3duJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhd2FpdCBzaW1jdGxTaHV0ZG93bih0aGlzLnVkaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IHRoZSBjdXJyZW50IFNpbXVsYXRvciB0byB0aGUgY2xlYW4gc3RhdGUuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgY2xlYW4gKCkge1xuICAgIGxvZy5pbmZvKGBDbGVhbmluZyBzaW11bGF0b3IgJHt0aGlzLnVkaWR9YCk7XG4gICAgYXdhaXQgZXJhc2VEZXZpY2UodGhpcy51ZGlkLCAxMDAwMCk7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgQXBwbGUgc2NyaXB0LCB3aGljaCBzZWxlY3RzIHRoZSBuZWNlc3NhcnkgU2ltdWxhdG9yIHdpbmRvd1xuICAgKiBpZiBtdWx0aXBsZSB3aW5kb3dzIGFyZSBvcGVuZWQuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgZ2VuZXJhdGVXaW5kb3dBY3RpdmF0aW9uU2NyaXB0ICgpIHtcbiAgICBjb25zdCB7bmFtZSwgc2RrfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgIHJldHVybiBgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgc2V0IGZyb250bW9zdCB0byBmYWxzZVxuICAgICAgICAgIHNldCBmcm9udG1vc3QgdG8gdHJ1ZVxuICAgICAgICAgIGNsaWNrIChtZW51IGl0ZW0gMSB3aGVyZSAoaXRzIG5hbWUgY29udGFpbnMgXCIke25hbWV9IC1cIiBhbmQgaXRzIG5hbWUgY29udGFpbnMgXCIke3Nka31cIikpIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiV2luZG93XCIgb2YgbWVudSBiYXIgMVxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgY3VycmVudCBzdGF0ZSBvZiBUb3VjaCBJRCBFbnJvbGxtZW50IGZlYXR1cmUuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgaXNUb3VjaElERW5yb2xsZWQgKCkge1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiRW5yb2xsZWRcIiBvZiBtZW51IDEgb2YgbWVudSBpdGVtIFwiVG91Y2ggSURcIiBvZiBtZW51IDEgb2YgbWVudSBiYXIgaXRlbSBcIkhhcmR3YXJlXCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIHNldCBpc0NoZWNrZWQgdG8gKHZhbHVlIG9mIGF0dHJpYnV0ZSBcIkFYTWVudUl0ZW1NYXJrQ2hhclwiIG9mIGRzdE1lbnVJdGVtKSBpcyBcIuKck1wiXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICAgIGxvZy5kZWJ1ZyhgVG91Y2ggSUQgZW5yb2xsZWQgc3RhdGU6ICR7b3V0cHV0fWApO1xuICAgIHJldHVybiBfLmlzU3RyaW5nKG91dHB1dCkgJiYgb3V0cHV0LnRyaW0oKSA9PT0gJ3RydWUnO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgYSBzcGVjaWFsIEFwcGxlIHNjcmlwdCwgd2hpY2ggY2hhbmdlcyBUb3VjaCBJRCBmZWF0dXJlIHRlc3RpbmcgaW4gU2ltdWxhdG9yIFVJIGNsaWVudC5cbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBlbnJvbGxUb3VjaElEIChpc0VuYWJsZWQgPSB0cnVlKSB7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlVUlDbGllbnRTY3JpcHQoYFxuICAgICAgdGVsbCBhcHBsaWNhdGlvbiBcIlN5c3RlbSBFdmVudHNcIlxuICAgICAgICB0ZWxsIHByb2Nlc3MgXCJTaW11bGF0b3JcIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gXCJFbnJvbGxlZFwiIG9mIG1lbnUgMSBvZiBtZW51IGl0ZW0gXCJUb3VjaCBJRFwiIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiSGFyZHdhcmVcIiBvZiBtZW51IGJhciAxXG4gICAgICAgICAgc2V0IGlzQ2hlY2tlZCB0byAodmFsdWUgb2YgYXR0cmlidXRlIFwiQVhNZW51SXRlbU1hcmtDaGFyXCIgb2YgZHN0TWVudUl0ZW0pIGlzIFwi4pyTXCJcbiAgICAgICAgICBpZiAke2lzRW5hYmxlZCA/ICdub3QgJyA6ICcnfWlzQ2hlY2tlZCB0aGVuXG4gICAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICAgIGVuZCBpZlxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTaW11bGF0b3JYY29kZTk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
