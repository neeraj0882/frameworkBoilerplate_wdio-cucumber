'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _utils = require('./utils');

var openssl = _bluebird2['default'].promisify(require('openssl-wrapper').exec);

var tset = '<?xml version="1.0" encoding="UTF-8"?>\n\n    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n    <plist version="1.0">\n    <array/>\n</plist>';

/**
 * Library for programatically adding certificates
 */

var Certificate = (function () {
  function Certificate(pemFilename) {
    _classCallCheck(this, Certificate);

    this.pemFilename = pemFilename;
  }

  /**
   * Interface for adding and removing records to TrustStore.sqlite3 databases that Keychains use
   */

  /**
   * Add a certificate to the TrustStore
   */

  _createClass(Certificate, [{
    key: 'add',
    value: function add(dir) {
      var data, subject, sha1, trustStore;
      return _regeneratorRuntime.async(function add$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getDerData(this.pemFilename));

          case 2:
            data = context$2$0.sent.toString('hex');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 5:
            subject = context$2$0.sent;
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.getFingerPrint(this.data));

          case 8:
            sha1 = context$2$0.sent.toString('hex');
            trustStore = new TrustStore(dir);
            return context$2$0.abrupt('return', trustStore.addRecord(sha1, tset, subject, data));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Checks if keychain at given directory has this certificate
     */
  }, {
    key: 'has',
    value: function has(dir) {
      var subject, trustStore, previousFingerprint, currentFingerprint;
      return _regeneratorRuntime.async(function has$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 2:
            subject = context$2$0.sent;
            trustStore = new TrustStore(dir);
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(trustStore.hasRecords(subject));

          case 6:
            if (context$2$0.sent) {
              context$2$0.next = 8;
              break;
            }

            return context$2$0.abrupt('return', false);

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(trustStore.getFingerPrintFromRecord(subject));

          case 10:
            previousFingerprint = context$2$0.sent;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.getFingerPrint());

          case 13:
            currentFingerprint = context$2$0.sent;
            return context$2$0.abrupt('return', previousFingerprint.toString() === currentFingerprint.toString());

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Remove certificate from the TrustStore
     */
  }, {
    key: 'remove',
    value: function remove(dir) {
      var subject, trustStore;
      return _regeneratorRuntime.async(function remove$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 2:
            subject = context$2$0.sent;
            trustStore = new TrustStore(dir);
            return context$2$0.abrupt('return', trustStore.removeRecord(subject));

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Translate PEM file to DER buffer
     */
  }, {
    key: 'getDerData',
    value: function getDerData() {
      return _regeneratorRuntime.async(function getDerData$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.data) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.data);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(openssl('x509', {
              outform: 'der',
              'in': this.pemFilename
            }));

          case 4:
            this.data = context$2$0.sent;
            return context$2$0.abrupt('return', this.data);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get SHA1 fingerprint from der data before
     */
  }, {
    key: 'getFingerPrint',
    value: function getFingerPrint() {
      var data, shasum;
      return _regeneratorRuntime.async(function getFingerPrint$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.fingerprint) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.fingerprint);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getDerData());

          case 4:
            data = context$2$0.sent;
            shasum = _crypto2['default'].createHash('sha1');

            shasum.update(data);
            this.fingerprint = shasum.digest();
            return context$2$0.abrupt('return', this.fingerprint);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Parse the subject from the der data
     */
  }, {
    key: 'getSubject',
    value: function getSubject() {
      var subject, subRegex;
      return _regeneratorRuntime.async(function getSubject$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.subject) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.subject);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(openssl('x509', {
              noout: true,
              subject: true,
              'in': this.pemFilename
            }));

          case 4:
            subject = context$2$0.sent;
            subRegex = /^subject[\w\W]*\/CN=([\w\W]*)(\n)?/;

            this.subject = subject.toString().match(subRegex)[1];
            return context$2$0.abrupt('return', this.subject);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return Certificate;
})();

var TrustStore = (function () {
  function TrustStore(sharedResourceDir) {
    _classCallCheck(this, TrustStore);

    this.sharedResourceDir = sharedResourceDir;
  }

  /**
   * Get TrustStore database associated with this simulator
   */

  _createClass(TrustStore, [{
    key: 'getDB',
    value: function getDB() {
      var keychainsPath;
      return _regeneratorRuntime.async(function getDB$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.db) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.db);

          case 2:
            keychainsPath = _path2['default'].resolve(this.sharedResourceDir, 'Library', 'Keychains');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(keychainsPath));

          case 5:
            if (context$2$0.sent) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(keychainsPath));

          case 8:

            // Open sqlite database
            this.db = _path2['default'].resolve(keychainsPath, 'TrustStore.sqlite3');

            // If it doesn't have a tsettings table, create one
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(this.db, 'CREATE TABLE IF NOT EXISTS tsettings (sha1 BLOB NOT NULL DEFAULT \'\', subj BLOB NOT NULL DEFAULT \'\', tset BLOB, data BLOB, PRIMARY KEY(sha1));'));

          case 11:
            context$2$0.prev = 11;
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(this.db, 'CREATE INDEX isubj ON tsettings(subj);'));

          case 14:
            context$2$0.next = 18;
            break;

          case 16:
            context$2$0.prev = 16;
            context$2$0.t0 = context$2$0['catch'](11);

          case 18:
            return context$2$0.abrupt('return', this.db);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[11, 16]]);
    }

    /**
     * Add record to tsettings
     */
  }, {
    key: 'addRecord',
    value: function addRecord(sha1, tset, subj, data) {
      var db;
      return _regeneratorRuntime.async(function addRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getDB());

          case 2:
            db = context$2$0.sent;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.hasRecords(subj));

          case 5:
            if (!context$2$0.sent) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(db, 'UPDATE tsettings SET sha1=x\'?\', tset=\'?\', data=x\'?\' WHERE subj=\'?\'', sha1, tset, data, subj));

          case 8:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 11:
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(db, 'INSERT INTO tsettings (sha1, subj, tset, data) VALUES (x\'?\', \'?\', \'?\', x\'?\')', sha1, subj, tset, data));

          case 13:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Remove record from tsettings that matches the subject
     * @param {string} subj
     */
  }, {
    key: 'removeRecord',
    value: function removeRecord(subj) {
      return _regeneratorRuntime.async(function removeRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _regeneratorRuntime;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getDB());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = subj;
            context$2$0.t3 = (0, _utils.execSQLiteQuery)(context$2$0.t1, 'DELETE FROM tsettings WHERE subj = \'?\'', context$2$0.t2);
            context$2$0.next = 8;
            return context$2$0.t0.awrap.call(context$2$0.t0, context$2$0.t3);

          case 8:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get a record from tsettings that matches the subj
     * @param {string} subj
     */
  }, {
    key: 'hasRecords',
    value: function hasRecords(subj) {
      return _regeneratorRuntime.async(function hasRecords$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getRecordCount(subj));

          case 2:
            context$2$0.t0 = context$2$0.sent;
            return context$2$0.abrupt('return', context$2$0.t0 > 0);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get count of how many records have this subject
     * @param {string} subj
     */
  }, {
    key: 'getRecordCount',
    value: function getRecordCount(subj) {
      var result;
      return _regeneratorRuntime.async(function getRecordCount$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _regeneratorRuntime;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getDB());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = subj;
            context$2$0.t3 = (0, _utils.execSQLiteQuery)(context$2$0.t1, 'SELECT count(*) FROM tsettings WHERE subj = \'?\'', context$2$0.t2);
            context$2$0.next = 8;
            return context$2$0.t0.awrap.call(context$2$0.t0, context$2$0.t3);

          case 8:
            result = context$2$0.sent.stdout;
            return context$2$0.abrupt('return', parseInt(result.split('=')[1], 10));

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get the SHA1 fingerprint for the record that has this subject
     * @param {string} subj
     */
  }, {
    key: 'getFingerPrintFromRecord',
    value: function getFingerPrintFromRecord(subj) {
      var result;
      return _regeneratorRuntime.async(function getFingerPrintFromRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _regeneratorRuntime;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getDB());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = subj;
            context$2$0.t3 = (0, _utils.execSQLiteQuery)(context$2$0.t1, 'SELECT sha1 FROM tsettings WHERE subj=\'?\'', context$2$0.t2);
            context$2$0.next = 8;
            return context$2$0.t0.awrap.call(context$2$0.t0, context$2$0.t3);

          case 8:
            result = context$2$0.sent.stdout;

            if (!result) {
              context$2$0.next = 11;
              break;
            }

            return context$2$0.abrupt('return', new Buffer(result.split('=')[1].trim()));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return TrustStore;
})();

exports['default'] = Certificate;
exports.Certificate = Certificate;
exports.TrustStore = TrustStore;

// Return false if record with this subject is not found

// If record is found, check fingerprints to verify that they didn't change

// Convert 'pem' file to 'der'

// Convert 'pem' file to 'der'

// If the sim doesn't have a keychains directory, create one
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDOzs7Ozs7O0tBRWpEOzs7U0E5RUcsVUFBVTs7O3FCQWlGRCxXQUFXO1FBQ2pCLFdBQVcsR0FBWCxXQUFXO1FBQUUsVUFBVSxHQUFWLFVBQVUiLCJmaWxlIjoibGliL2NlcnRpZmljYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcywgbWtkaXJwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlY1NRTGl0ZVF1ZXJ5IH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IG9wZW5zc2wgPSBCLnByb21pc2lmeShyZXF1aXJlKCdvcGVuc3NsLXdyYXBwZXInKS5leGVjKTtcblxuY29uc3QgdHNldCA9IGA8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz5cXG5cbiAgICA8IURPQ1RZUEUgcGxpc3QgUFVCTElDIFwiLS8vQXBwbGUvL0RURCBQTElTVCAxLjAvL0VOXCIgXCJodHRwOi8vd3d3LmFwcGxlLmNvbS9EVERzL1Byb3BlcnR5TGlzdC0xLjAuZHRkXCI+XG4gICAgPHBsaXN0IHZlcnNpb249XCIxLjBcIj5cbiAgICA8YXJyYXkvPlxuPC9wbGlzdD5gO1xuXG4vKipcbiAqIExpYnJhcnkgZm9yIHByb2dyYW1hdGljYWxseSBhZGRpbmcgY2VydGlmaWNhdGVzXG4gKi9cbmNsYXNzIENlcnRpZmljYXRlIHtcblxuICBjb25zdHJ1Y3RvciAocGVtRmlsZW5hbWUpIHtcbiAgICB0aGlzLnBlbUZpbGVuYW1lID0gcGVtRmlsZW5hbWU7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgY2VydGlmaWNhdGUgdG8gdGhlIFRydXN0U3RvcmVcbiAgICovXG4gIGFzeW5jIGFkZCAoZGlyKSB7XG4gICAgbGV0IGRhdGEgPSAoYXdhaXQgdGhpcy5nZXREZXJEYXRhKHRoaXMucGVtRmlsZW5hbWUpKS50b1N0cmluZygnaGV4Jyk7XG4gICAgbGV0IHN1YmplY3QgPSAoYXdhaXQgdGhpcy5nZXRTdWJqZWN0KHRoaXMucGVtRmlsZW5hbWUpKTtcbiAgICBsZXQgc2hhMSA9IChhd2FpdCB0aGlzLmdldEZpbmdlclByaW50KHRoaXMuZGF0YSkpLnRvU3RyaW5nKCdoZXgnKTtcblxuICAgIGxldCB0cnVzdFN0b3JlID0gbmV3IFRydXN0U3RvcmUoZGlyKTtcbiAgICByZXR1cm4gdHJ1c3RTdG9yZS5hZGRSZWNvcmQoc2hhMSwgdHNldCwgc3ViamVjdCwgZGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGtleWNoYWluIGF0IGdpdmVuIGRpcmVjdG9yeSBoYXMgdGhpcyBjZXJ0aWZpY2F0ZVxuICAgKi9cbiAgYXN5bmMgaGFzIChkaXIpIHtcbiAgICBsZXQgc3ViamVjdCA9IGF3YWl0IHRoaXMuZ2V0U3ViamVjdCh0aGlzLnBlbUZpbGVuYW1lKTtcbiAgICBsZXQgdHJ1c3RTdG9yZSA9IG5ldyBUcnVzdFN0b3JlKGRpcik7XG5cbiAgICAvLyBSZXR1cm4gZmFsc2UgaWYgcmVjb3JkIHdpdGggdGhpcyBzdWJqZWN0IGlzIG5vdCBmb3VuZFxuICAgIGlmICghYXdhaXQgdHJ1c3RTdG9yZS5oYXNSZWNvcmRzKHN1YmplY3QpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gSWYgcmVjb3JkIGlzIGZvdW5kLCBjaGVjayBmaW5nZXJwcmludHMgdG8gdmVyaWZ5IHRoYXQgdGhleSBkaWRuJ3QgY2hhbmdlXG4gICAgbGV0IHByZXZpb3VzRmluZ2VycHJpbnQgPSBhd2FpdCB0cnVzdFN0b3JlLmdldEZpbmdlclByaW50RnJvbVJlY29yZChzdWJqZWN0KTtcbiAgICBsZXQgY3VycmVudEZpbmdlcnByaW50ID0gYXdhaXQgdGhpcy5nZXRGaW5nZXJQcmludCgpO1xuICAgIHJldHVybiBwcmV2aW91c0ZpbmdlcnByaW50LnRvU3RyaW5nKCkgPT09IGN1cnJlbnRGaW5nZXJwcmludC50b1N0cmluZygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBjZXJ0aWZpY2F0ZSBmcm9tIHRoZSBUcnVzdFN0b3JlXG4gICAqL1xuICBhc3luYyByZW1vdmUgKGRpcikge1xuICAgIGxldCBzdWJqZWN0ID0gYXdhaXQgdGhpcy5nZXRTdWJqZWN0KHRoaXMucGVtRmlsZW5hbWUpO1xuICAgIGxldCB0cnVzdFN0b3JlID0gbmV3IFRydXN0U3RvcmUoZGlyKTtcbiAgICByZXR1cm4gdHJ1c3RTdG9yZS5yZW1vdmVSZWNvcmQoc3ViamVjdCk7XG4gIH1cblxuICAvKipcbiAgICogVHJhbnNsYXRlIFBFTSBmaWxlIHRvIERFUiBidWZmZXJcbiAgICovXG4gIGFzeW5jIGdldERlckRhdGEgKCkge1xuICAgIGlmICh0aGlzLmRhdGEpIHtcbiAgICAgIHJldHVybiB0aGlzLmRhdGE7XG4gICAgfVxuXG4gICAgLy8gQ29udmVydCAncGVtJyBmaWxlIHRvICdkZXInXG4gICAgdGhpcy5kYXRhID0gYXdhaXQgb3BlbnNzbCgneDUwOScsIHtcbiAgICAgIG91dGZvcm06ICdkZXInLFxuICAgICAgaW46IHRoaXMucGVtRmlsZW5hbWVcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmRhdGE7XG4gIH1cblxuICAvKipcbiAgICogR2V0IFNIQTEgZmluZ2VycHJpbnQgZnJvbSBkZXIgZGF0YSBiZWZvcmVcbiAgICovXG4gIGFzeW5jIGdldEZpbmdlclByaW50ICgpIHtcbiAgICBpZiAodGhpcy5maW5nZXJwcmludCkge1xuICAgICAgcmV0dXJuIHRoaXMuZmluZ2VycHJpbnQ7XG4gICAgfVxuXG4gICAgbGV0IGRhdGEgPSBhd2FpdCB0aGlzLmdldERlckRhdGEoKTtcbiAgICBsZXQgc2hhc3VtID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTEnKTtcbiAgICBzaGFzdW0udXBkYXRlKGRhdGEpO1xuICAgIHRoaXMuZmluZ2VycHJpbnQgPSBzaGFzdW0uZGlnZXN0KCk7XG4gICAgcmV0dXJuIHRoaXMuZmluZ2VycHJpbnQ7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgdGhlIHN1YmplY3QgZnJvbSB0aGUgZGVyIGRhdGFcbiAgICovXG4gIGFzeW5jIGdldFN1YmplY3QgKCkge1xuICAgIGlmICh0aGlzLnN1YmplY3QpIHtcbiAgICAgIHJldHVybiB0aGlzLnN1YmplY3Q7XG4gICAgfVxuXG4gICAgLy8gQ29udmVydCAncGVtJyBmaWxlIHRvICdkZXInXG4gICAgbGV0IHN1YmplY3QgPSBhd2FpdCBvcGVuc3NsKCd4NTA5Jywge1xuICAgICAgbm9vdXQ6IHRydWUsXG4gICAgICBzdWJqZWN0OiB0cnVlLFxuICAgICAgaW46IHRoaXMucGVtRmlsZW5hbWVcbiAgICB9KTtcbiAgICBsZXQgc3ViUmVnZXggPSAvXnN1YmplY3RbXFx3XFxXXSpcXC9DTj0oW1xcd1xcV10qKShcXG4pPy87XG4gICAgdGhpcy5zdWJqZWN0ID0gc3ViamVjdC50b1N0cmluZygpLm1hdGNoKHN1YlJlZ2V4KVsxXTtcbiAgICByZXR1cm4gdGhpcy5zdWJqZWN0O1xuICB9XG5cbn1cblxuLyoqXG4gKiBJbnRlcmZhY2UgZm9yIGFkZGluZyBhbmQgcmVtb3ZpbmcgcmVjb3JkcyB0byBUcnVzdFN0b3JlLnNxbGl0ZTMgZGF0YWJhc2VzIHRoYXQgS2V5Y2hhaW5zIHVzZVxuICovXG5jbGFzcyBUcnVzdFN0b3JlIHtcbiAgY29uc3RydWN0b3IgKHNoYXJlZFJlc291cmNlRGlyKSB7XG4gICAgdGhpcy5zaGFyZWRSZXNvdXJjZURpciA9IHNoYXJlZFJlc291cmNlRGlyO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBUcnVzdFN0b3JlIGRhdGFiYXNlIGFzc29jaWF0ZWQgd2l0aCB0aGlzIHNpbXVsYXRvclxuICAgKi9cbiAgYXN5bmMgZ2V0REIgKCkge1xuICAgIGlmICh0aGlzLmRiKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYjtcbiAgICB9XG5cbiAgICAvLyBJZiB0aGUgc2ltIGRvZXNuJ3QgaGF2ZSBhIGtleWNoYWlucyBkaXJlY3RvcnksIGNyZWF0ZSBvbmVcbiAgICBsZXQga2V5Y2hhaW5zUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnNoYXJlZFJlc291cmNlRGlyLCAnTGlicmFyeScsICdLZXljaGFpbnMnKTtcbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHMoa2V5Y2hhaW5zUGF0aCkpKSB7XG4gICAgICBhd2FpdCBta2RpcnAoa2V5Y2hhaW5zUGF0aCk7XG4gICAgfVxuXG4gICAgLy8gT3BlbiBzcWxpdGUgZGF0YWJhc2VcbiAgICB0aGlzLmRiID0gcGF0aC5yZXNvbHZlKGtleWNoYWluc1BhdGgsICdUcnVzdFN0b3JlLnNxbGl0ZTMnKTtcblxuICAgIC8vIElmIGl0IGRvZXNuJ3QgaGF2ZSBhIHRzZXR0aW5ncyB0YWJsZSwgY3JlYXRlIG9uZVxuICAgIGF3YWl0IGV4ZWNTUUxpdGVRdWVyeSh0aGlzLmRiLCBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgdHNldHRpbmdzIChzaGExIEJMT0IgTk9UIE5VTEwgREVGQVVMVCAnJywgc3ViaiBCTE9CIE5PVCBOVUxMIERFRkFVTFQgJycsIHRzZXQgQkxPQiwgZGF0YSBCTE9CLCBQUklNQVJZIEtFWShzaGExKSk7YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWNTUUxpdGVRdWVyeSh0aGlzLmRiLCAnQ1JFQVRFIElOREVYIGlzdWJqIE9OIHRzZXR0aW5ncyhzdWJqKTsnKTtcbiAgICB9IGNhdGNoIChlKSB7IH1cblxuXG4gICAgcmV0dXJuIHRoaXMuZGI7XG4gIH1cblxuICAvKipcbiAgICogQWRkIHJlY29yZCB0byB0c2V0dGluZ3NcbiAgICovXG4gIGFzeW5jIGFkZFJlY29yZCAoc2hhMSwgdHNldCwgc3ViaiwgZGF0YSkge1xuICAgIGxldCBkYiA9IGF3YWl0IHRoaXMuZ2V0REIoKTtcbiAgICBpZiAoYXdhaXQgdGhpcy5oYXNSZWNvcmRzKHN1YmopKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KGRiLCBgVVBEQVRFIHRzZXR0aW5ncyBTRVQgc2hhMT14Jz8nLCB0c2V0PSc/JywgZGF0YT14Jz8nIFdIRVJFIHN1Ymo9Jz8nYCwgc2hhMSwgdHNldCwgZGF0YSwgc3Viaik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCBleGVjU1FMaXRlUXVlcnkoZGIsIGBJTlNFUlQgSU5UTyB0c2V0dGluZ3MgKHNoYTEsIHN1YmosIHRzZXQsIGRhdGEpIFZBTFVFUyAoeCc/JywgJz8nLCAnPycsIHgnPycpYCwgc2hhMSwgc3ViaiwgdHNldCwgZGF0YSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSByZWNvcmQgZnJvbSB0c2V0dGluZ3MgdGhhdCBtYXRjaGVzIHRoZSBzdWJqZWN0XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdWJqXG4gICAqL1xuICBhc3luYyByZW1vdmVSZWNvcmQgKHN1YmopIHtcbiAgICByZXR1cm4gYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KGF3YWl0IHRoaXMuZ2V0REIoKSwgYERFTEVURSBGUk9NIHRzZXR0aW5ncyBXSEVSRSBzdWJqID0gJz8nYCwgc3Viaik7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgcmVjb3JkIGZyb20gdHNldHRpbmdzIHRoYXQgbWF0Y2hlcyB0aGUgc3VialxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3VialxuICAgKi9cbiAgYXN5bmMgaGFzUmVjb3JkcyAoc3Viaikge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRSZWNvcmRDb3VudChzdWJqKSkgPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjb3VudCBvZiBob3cgbWFueSByZWNvcmRzIGhhdmUgdGhpcyBzdWJqZWN0XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdWJqXG4gICAqL1xuICBhc3luYyBnZXRSZWNvcmRDb3VudCAoc3Viaikge1xuICAgIGxldCByZXN1bHQgPSAgKGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShhd2FpdCB0aGlzLmdldERCKCksIGBTRUxFQ1QgY291bnQoKikgRlJPTSB0c2V0dGluZ3MgV0hFUkUgc3ViaiA9ICc/J2AsIHN1YmopKS5zdGRvdXQ7XG4gICAgcmV0dXJuIHBhcnNlSW50KHJlc3VsdC5zcGxpdCgnPScpWzFdLCAxMCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBTSEExIGZpbmdlcnByaW50IGZvciB0aGUgcmVjb3JkIHRoYXQgaGFzIHRoaXMgc3ViamVjdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3VialxuICAgKi9cbiAgYXN5bmMgZ2V0RmluZ2VyUHJpbnRGcm9tUmVjb3JkIChzdWJqKSB7XG4gICAgbGV0IHJlc3VsdCA9IChhd2FpdCBleGVjU1FMaXRlUXVlcnkoYXdhaXQgdGhpcy5nZXREQigpLCBgU0VMRUNUIHNoYTEgRlJPTSB0c2V0dGluZ3MgV0hFUkUgc3Viaj0nPydgLCBzdWJqKSkuc3Rkb3V0O1xuICAgIGlmIChyZXN1bHQpIHtcbiAgICAgIHJldHVybiBuZXcgQnVmZmVyKHJlc3VsdC5zcGxpdCgnPScpWzFdLnRyaW0oKSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENlcnRpZmljYXRlO1xuZXhwb3J0IHsgQ2VydGlmaWNhdGUsIFRydXN0U3RvcmUgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
