'use strict';

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumIosDriver = require('appium-ios-driver');

var _asyncbox = require('asyncbox');

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var IPHONE_EXTRA_WEB_COORD_SCROLL_OFFSET = -15;
var IPHONE_EXTRA_WEB_COORD_NON_SCROLL_OFFSET = 10;
var IPHONE_WEB_COORD_OFFSET = -10;
var IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET = 84;
var IPAD_EXTRA_WEB_COORD_SCROLL_OFFSET = -10;
var IPAD_EXTRA_WEB_COORD_NON_SCROLL_OFFSET = 0;
var IPAD_WEB_COORD_OFFSET = 10;
var IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET = 95;

var extensions = {};

_Object$assign(extensions, _appiumIosDriver.iosCommands.web);

var getSafariIsIphone = _lodash2['default'].memoize(function getSafariIsIphone(sessionId, driver) {
  var isIphone, useragent;
  return _regeneratorRuntime.async(function getSafariIsIphone$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        isIphone = true;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(driver.execute('return navigator.userAgent'));

      case 4:
        useragent = context$1$0.sent;

        isIphone = useragent.toLowerCase().includes('iphone');
        context$1$0.next = 12;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Unable to find device type from useragent. Assuming iPhone');
        _logger2['default'].debug('Error: ' + context$1$0.t0.message);

      case 12:
        return context$1$0.abrupt('return', isIphone);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 8]]);
});

extensions.getElementHeightMemoized = _lodash2['default'].memoize(function callee$0$0(key, el) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = _appiumSupport.util.unwrapElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.getNativeRect(el));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent.height);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
});

extensions.getExtraTranslateWebCoordsOffset = function callee$0$0() {
  var offset, implicitWaitMs, el;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        offset = 0;
        implicitWaitMs = this.implicitWaitMs;
        context$1$0.prev = 2;

        this.setImplicitWait(0);

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('accessibility id', 'ReloadButton', false));

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(getSafariIsIphone(this.opts.sessionId, this));

      case 8:
        if (!context$1$0.sent) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.t0 = IPHONE_EXTRA_WEB_COORD_NON_SCROLL_OFFSET;
        context$1$0.next = 13;
        break;

      case 12:
        context$1$0.t0 = IPAD_EXTRA_WEB_COORD_NON_SCROLL_OFFSET;

      case 13:
        offset += context$1$0.t0;
        context$1$0.next = 37;
        break;

      case 16:
        context$1$0.prev = 16;
        context$1$0.t1 = context$1$0['catch'](2);
        context$1$0.prev = 18;
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('accessibility id', 'URL', false));

      case 21:
        el = context$1$0.sent;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.getElementHeightMemoized('URLBar', el));

      case 24:
        offset -= context$1$0.sent;
        context$1$0.next = 29;
        break;

      case 27:
        context$1$0.prev = 27;
        context$1$0.t2 = context$1$0['catch'](18);

      case 29:
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap(getSafariIsIphone(this.opts.sessionId, this));

      case 31:
        if (!context$1$0.sent) {
          context$1$0.next = 35;
          break;
        }

        context$1$0.t3 = IPHONE_EXTRA_WEB_COORD_SCROLL_OFFSET;
        context$1$0.next = 36;
        break;

      case 35:
        context$1$0.t3 = IPAD_EXTRA_WEB_COORD_SCROLL_OFFSET;

      case 36:
        offset += context$1$0.t3;

      case 37:
        context$1$0.prev = 37;

        // return implicit wait to what it was
        this.setImplicitWait(implicitWaitMs);
        return context$1$0.finish(37);

      case 40:
        context$1$0.next = 42;
        return _regeneratorRuntime.awrap(getSafariIsIphone(this.opts.sessionId, this));

      case 42:
        if (!context$1$0.sent) {
          context$1$0.next = 46;
          break;
        }

        context$1$0.t4 = IPHONE_WEB_COORD_OFFSET;
        context$1$0.next = 47;
        break;

      case 46:
        context$1$0.t4 = IPAD_WEB_COORD_OFFSET;

      case 47:
        offset += context$1$0.t4;

        _logger2['default'].debug('Extra translated web coordinates offset: ' + offset);
        return context$1$0.abrupt('return', offset);

      case 50:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 16, 37, 40], [18, 27]]);
};

extensions.getExtraNativeWebTapOffset = function callee$0$0() {
  var offset, implicitWaitMs, el;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        offset = 0;
        implicitWaitMs = this.implicitWaitMs;
        context$1$0.prev = 2;

        this.setImplicitWait(0);

        // first try to get tab offset
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('-ios predicate string', 'name LIKE \'*, Tab\' AND visible = 1', false));

      case 7:
        el = context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.getElementHeightMemoized('TabBar', el));

      case 10:
        offset += context$1$0.sent;
        context$1$0.next = 15;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](4);

      case 15:
        context$1$0.prev = 15;
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('accessibility id', 'Close app download offer', false));

      case 18:
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(getSafariIsIphone(this.opts.sessionId, this));

      case 20:
        if (!context$1$0.sent) {
          context$1$0.next = 24;
          break;
        }

        context$1$0.t1 = IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET;
        context$1$0.next = 25;
        break;

      case 24:
        context$1$0.t1 = IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET;

      case 25:
        offset += context$1$0.t1;
        context$1$0.next = 30;
        break;

      case 28:
        context$1$0.prev = 28;
        context$1$0.t2 = context$1$0['catch'](15);

      case 30:
        context$1$0.prev = 30;

        // return implicit wait to what it was
        this.setImplicitWait(implicitWaitMs);
        return context$1$0.finish(30);

      case 33:

        _logger2['default'].debug('Additional native web tap offset computed: ' + offset);
        return context$1$0.abrupt('return', offset);

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2,, 30, 33], [4, 13], [15, 28]]);
};

extensions.nativeWebTap = function callee$0$0(el) {
  var atomsElement, _ref, width, height, _ref2, x, y;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 7:
        _ref = context$1$0.sent;
        width = _ref.width;
        height = _ref.height;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 12:
        _ref2 = context$1$0.sent;
        x = _ref2.x;
        y = _ref2.y;

        x += width / 2;
        y += height / 2;

        this.curWebCoords = { x: x, y: y };
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.clickWebCoords());

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.clickCoords = function callee$0$0(coords) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.performTouch([{
          action: 'tap',
          options: coords
        }]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.translateWebCoords = function callee$0$0(coords) {
  var yOffset, implicitWaitMs, webview, rect, wvPos, realDims, cmd, wvDims, urlBarHeight, realDimensionHeight, xRatio, yRatio, newCoords;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Translating coordinates (' + JSON.stringify(coords) + ') to web coordinates');

        // add static offset for safari in landscape mode
        yOffset = this.opts.curOrientation === 'LANDSCAPE' ? this.landscapeWebCoordsOffset : 0;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getExtraNativeWebTapOffset());

      case 4:
        yOffset += context$1$0.sent;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.getExtraTranslateWebCoordsOffset());

      case 7:
        coords.y += context$1$0.sent;
        implicitWaitMs = this.implicitWaitMs;
        webview = undefined;
        context$1$0.prev = 10;

        this.setImplicitWait(0);
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(5, 100, function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.findNativeElementOrElements('-ios predicate string', 'type = \'XCUIElementTypeWebView\' AND visible = 1', false));

              case 2:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }));

      case 14:
        webview = context$1$0.sent;

      case 15:
        context$1$0.prev = 15;

        this.setImplicitWait(implicitWaitMs);
        return context$1$0.finish(15);

      case 18:

        webview = _appiumSupport.util.unwrapElement(webview);
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.proxyCommand('/element/' + webview + '/rect', 'GET'));

      case 21:
        rect = context$1$0.sent;
        wvPos = { x: rect.x, y: rect.y };
        realDims = { w: rect.width, h: rect.height };
        cmd = '(function () { return {w: document.documentElement.clientWidth, h: document.documentElement.clientHeight}; })()';
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 27:
        wvDims = context$1$0.sent;
        urlBarHeight = 64;

        wvPos.y += urlBarHeight;

        realDimensionHeight = 108;

        realDims.h -= realDimensionHeight;

        if (!(wvDims && realDims && wvPos)) {
          context$1$0.next = 46;
          break;
        }

        xRatio = realDims.w / wvDims.w;
        yRatio = realDims.h / wvDims.h;
        newCoords = {
          x: wvPos.x + Math.round(xRatio * coords.x),
          y: wvPos.y + yOffset + Math.round(yRatio * coords.y)
        };

        // additional logging for coordinates, since it is sometimes broken
        //   see https://github.com/appium/appium/issues/9159
        _logger2['default'].debug('Converted coordinates: ' + JSON.stringify(newCoords));
        _logger2['default'].debug('    rect: ' + JSON.stringify(rect));
        _logger2['default'].debug('    wvPos: ' + JSON.stringify(wvPos));
        _logger2['default'].debug('    realDims: ' + JSON.stringify(realDims));
        _logger2['default'].debug('    wvDims: ' + JSON.stringify(wvDims));
        _logger2['default'].debug('    xRatio: ' + JSON.stringify(xRatio));
        _logger2['default'].debug('    yRatio: ' + JSON.stringify(yRatio));
        _logger2['default'].debug('    yOffset: ' + JSON.stringify(yOffset));

        _logger2['default'].debug('Converted web coords ' + JSON.stringify(coords) + ' ' + ('into real coords ' + JSON.stringify(newCoords)));
        return context$1$0.abrupt('return', newCoords);

      case 46:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10,, 15, 18]]);
};

extensions.checkForAlert = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        return context$1$0.abrupt('return', false);

      case 1:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.waitForAtom = function callee$0$0(promise) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.t0 = this;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(promise);

      case 3:
        context$1$0.t1 = context$1$0.sent;
        return context$1$0.abrupt('return', context$1$0.t0.parseExecuteResponse.call(context$1$0.t0, context$1$0.t1));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

exports['default'] = extensions;
module.exports = exports['default'];

// sessionId parameter is for memoizing per session

// keep track of implicit wait, and set locally to 0

// try to see if there has been scrolling

// reload button found, which means scrolling has not happened

// no reload button, which indicates scrolling has happened

// no URL elements found, so continue

// when scrolling has happened, there is a tick more offset needed

// extra offset necessary (where do these come from? they just work)

// keep track of implicit wait, and set locally to 0

// no element found, so no tabs and no need to deal with offset

// next try to see if there is an Smart App Banner

// no smart app banner found, so continue

// `get_top_left_coordinates` returns the wrong value sometimes,
// unless we pre-call both of these functions before the actual calls

// add extra offset for possible extra things in the top of the page

// absolutize web coords

// TODO: investigate where these come from. They appear to be constants in my tests

// TODO: Add check for alert and accept/dismiss it as per autoAcceptAlert capability
//# sourceMappingURL=data:application/json;charset=utf8;base64,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OzRDQUNwRCxTQUFTOzs7Ozs7O0NBRW5CLENBQUM7O0FBRUYsVUFBVSxDQUFDLGFBQWEsR0FBRzs7Ozs0Q0FDbEIsS0FBSzs7Ozs7OztDQUNiLENBQUM7O0FBRUYsVUFBVSxDQUFDLFdBQVcsR0FBRyxvQkFBZ0IsT0FBTzs7Ozt5QkFFdkMsSUFBSTs7eUNBQTRCLE9BQU87Ozs7MkRBQWxDLG9CQUFvQjs7Ozs7OztDQUNqQyxDQUFDOztxQkFFYSxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy93ZWIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBJUEhPTkVfRVhUUkFfV0VCX0NPT1JEX1NDUk9MTF9PRkZTRVQgPSAtMTU7XG5jb25zdCBJUEhPTkVfRVhUUkFfV0VCX0NPT1JEX05PTl9TQ1JPTExfT0ZGU0VUID0gMTA7XG5jb25zdCBJUEhPTkVfV0VCX0NPT1JEX09GRlNFVCA9IC0xMDtcbmNvbnN0IElQSE9ORV9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQgPSA4NDtcbmNvbnN0IElQQURfRVhUUkFfV0VCX0NPT1JEX1NDUk9MTF9PRkZTRVQgPSAtMTA7XG5jb25zdCBJUEFEX0VYVFJBX1dFQl9DT09SRF9OT05fU0NST0xMX09GRlNFVCA9IDA7XG5jb25zdCBJUEFEX1dFQl9DT09SRF9PRkZTRVQgPSAxMDtcbmNvbnN0IElQQURfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUID0gOTU7XG5cbmxldCBleHRlbnNpb25zID0ge307XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgaW9zQ29tbWFuZHMud2ViKTtcblxuY29uc3QgZ2V0U2FmYXJpSXNJcGhvbmUgPSBfLm1lbW9pemUoYXN5bmMgZnVuY3Rpb24gZ2V0U2FmYXJpSXNJcGhvbmUgKHNlc3Npb25JZCwgZHJpdmVyKSB7XG4gIC8vIHNlc3Npb25JZCBwYXJhbWV0ZXIgaXMgZm9yIG1lbW9pemluZyBwZXIgc2Vzc2lvblxuICBsZXQgaXNJcGhvbmUgPSB0cnVlO1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJhZ2VudCA9IGF3YWl0IGRyaXZlci5leGVjdXRlKCdyZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudCcpO1xuICAgIGlzSXBob25lID0gdXNlcmFnZW50LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2lwaG9uZScpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgVW5hYmxlIHRvIGZpbmQgZGV2aWNlIHR5cGUgZnJvbSB1c2VyYWdlbnQuIEFzc3VtaW5nIGlQaG9uZWApO1xuICAgIGxvZy5kZWJ1ZyhgRXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbiAgcmV0dXJuIGlzSXBob25lO1xufSk7XG5cbmV4dGVuc2lvbnMuZ2V0RWxlbWVudEhlaWdodE1lbW9pemVkID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIChrZXksIGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgcmV0dXJuIChhd2FpdCB0aGlzLmdldE5hdGl2ZVJlY3QoZWwpKS5oZWlnaHQ7XG59KTtcblxuZXh0ZW5zaW9ucy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IG9mZnNldCA9IDA7XG5cbiAgLy8ga2VlcCB0cmFjayBvZiBpbXBsaWNpdCB3YWl0LCBhbmQgc2V0IGxvY2FsbHkgdG8gMFxuICBjb25zdCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG5cbiAgLy8gdHJ5IHRvIHNlZSBpZiB0aGVyZSBoYXMgYmVlbiBzY3JvbGxpbmdcbiAgdHJ5IHtcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdCgwKTtcblxuICAgIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywgJ1JlbG9hZEJ1dHRvbicsIGZhbHNlKTtcbiAgICAvLyByZWxvYWQgYnV0dG9uIGZvdW5kLCB3aGljaCBtZWFucyBzY3JvbGxpbmcgaGFzIG5vdCBoYXBwZW5lZFxuICAgIG9mZnNldCArPSBhd2FpdCBnZXRTYWZhcmlJc0lwaG9uZSh0aGlzLm9wdHMuc2Vzc2lvbklkLCB0aGlzKSA/XG4gICAgICBJUEhPTkVfRVhUUkFfV0VCX0NPT1JEX05PTl9TQ1JPTExfT0ZGU0VUOlxuICAgICAgSVBBRF9FWFRSQV9XRUJfQ09PUkRfTk9OX1NDUk9MTF9PRkZTRVQ7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIG5vIHJlbG9hZCBidXR0b24sIHdoaWNoIGluZGljYXRlcyBzY3JvbGxpbmcgaGFzIGhhcHBlbmVkXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGVsID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnVVJMJywgZmFsc2UpO1xuICAgICAgb2Zmc2V0IC09IGF3YWl0IHRoaXMuZ2V0RWxlbWVudEhlaWdodE1lbW9pemVkKCdVUkxCYXInLCBlbCk7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBubyBVUkwgZWxlbWVudHMgZm91bmQsIHNvIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgLy8gd2hlbiBzY3JvbGxpbmcgaGFzIGhhcHBlbmVkLCB0aGVyZSBpcyBhIHRpY2sgbW9yZSBvZmZzZXQgbmVlZGVkXG4gICAgb2Zmc2V0ICs9IGF3YWl0IGdldFNhZmFyaUlzSXBob25lKHRoaXMub3B0cy5zZXNzaW9uSWQsIHRoaXMpID9cbiAgICAgIElQSE9ORV9FWFRSQV9XRUJfQ09PUkRfU0NST0xMX09GRlNFVCA6XG4gICAgICBJUEFEX0VYVFJBX1dFQl9DT09SRF9TQ1JPTExfT0ZGU0VUO1xuICB9IGZpbmFsbHkge1xuICAgIC8vIHJldHVybiBpbXBsaWNpdCB3YWl0IHRvIHdoYXQgaXQgd2FzXG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG5cbiAgLy8gZXh0cmEgb2Zmc2V0IG5lY2Vzc2FyeSAod2hlcmUgZG8gdGhlc2UgY29tZSBmcm9tPyB0aGV5IGp1c3Qgd29yaylcbiAgb2Zmc2V0ICs9IGF3YWl0IGdldFNhZmFyaUlzSXBob25lKHRoaXMub3B0cy5zZXNzaW9uSWQsIHRoaXMpID9cbiAgICBJUEhPTkVfV0VCX0NPT1JEX09GRlNFVCA6XG4gICAgSVBBRF9XRUJfQ09PUkRfT0ZGU0VUO1xuXG4gIGxvZy5kZWJ1ZyhgRXh0cmEgdHJhbnNsYXRlZCB3ZWIgY29vcmRpbmF0ZXMgb2Zmc2V0OiAke29mZnNldH1gKTtcbiAgcmV0dXJuIG9mZnNldDtcbn07XG5cbmV4dGVuc2lvbnMuZ2V0RXh0cmFOYXRpdmVXZWJUYXBPZmZzZXQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBvZmZzZXQgPSAwO1xuXG4gIC8vIGtlZXAgdHJhY2sgb2YgaW1wbGljaXQgd2FpdCwgYW5kIHNldCBsb2NhbGx5IHRvIDBcbiAgY29uc3QgaW1wbGljaXRXYWl0TXMgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICB0cnkge1xuICAgIHRoaXMuc2V0SW1wbGljaXRXYWl0KDApO1xuXG4gICAgLy8gZmlyc3QgdHJ5IHRvIGdldCB0YWIgb2Zmc2V0XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGVsID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJy1pb3MgcHJlZGljYXRlIHN0cmluZycsIGBuYW1lIExJS0UgJyosIFRhYicgQU5EIHZpc2libGUgPSAxYCwgZmFsc2UpO1xuICAgICAgb2Zmc2V0ICs9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudEhlaWdodE1lbW9pemVkKCdUYWJCYXInLCBlbCk7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBubyBlbGVtZW50IGZvdW5kLCBzbyBubyB0YWJzIGFuZCBubyBuZWVkIHRvIGRlYWwgd2l0aCBvZmZzZXRcbiAgICB9XG5cbiAgICAvLyBuZXh0IHRyeSB0byBzZWUgaWYgdGhlcmUgaXMgYW4gU21hcnQgQXBwIEJhbm5lclxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsICdDbG9zZSBhcHAgZG93bmxvYWQgb2ZmZXInLCBmYWxzZSk7XG4gICAgICBvZmZzZXQgKz0gYXdhaXQgZ2V0U2FmYXJpSXNJcGhvbmUodGhpcy5vcHRzLnNlc3Npb25JZCwgdGhpcykgP1xuICAgICAgICBJUEhPTkVfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUIDpcbiAgICAgICAgSVBBRF9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQ7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBubyBzbWFydCBhcHAgYmFubmVyIGZvdW5kLCBzbyBjb250aW51ZVxuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICAvLyByZXR1cm4gaW1wbGljaXQgd2FpdCB0byB3aGF0IGl0IHdhc1xuICAgIHRoaXMuc2V0SW1wbGljaXRXYWl0KGltcGxpY2l0V2FpdE1zKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgQWRkaXRpb25hbCBuYXRpdmUgd2ViIHRhcCBvZmZzZXQgY29tcHV0ZWQ6ICR7b2Zmc2V0fWApO1xuICByZXR1cm4gb2Zmc2V0O1xufTtcblxuZXh0ZW5zaW9ucy5uYXRpdmVXZWJUYXAgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgY29uc3QgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuXG4gIC8vIGBnZXRfdG9wX2xlZnRfY29vcmRpbmF0ZXNgIHJldHVybnMgdGhlIHdyb25nIHZhbHVlIHNvbWV0aW1lcyxcbiAgLy8gdW5sZXNzIHdlIHByZS1jYWxsIGJvdGggb2YgdGhlc2UgZnVuY3Rpb25zIGJlZm9yZSB0aGUgYWN0dWFsIGNhbGxzXG4gIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9zaXplJywgW2F0b21zRWxlbWVudF0pO1xuICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfdG9wX2xlZnRfY29vcmRpbmF0ZXMnLCBbYXRvbXNFbGVtZW50XSk7XG5cbiAgY29uc3Qge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG4gIGxldCB7eCwgeX0gPSBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfdG9wX2xlZnRfY29vcmRpbmF0ZXMnLCBbYXRvbXNFbGVtZW50XSk7XG4gIHggKz0gd2lkdGggLyAyO1xuICB5ICs9IGhlaWdodCAvIDI7XG5cbiAgdGhpcy5jdXJXZWJDb29yZHMgPSB7eCwgeX07XG4gIGF3YWl0IHRoaXMuY2xpY2tXZWJDb29yZHMoKTtcbn07XG5cbmV4dGVuc2lvbnMuY2xpY2tDb29yZHMgPSBhc3luYyBmdW5jdGlvbiAoY29vcmRzKSB7XG4gIGF3YWl0IHRoaXMucGVyZm9ybVRvdWNoKFtcbiAgICB7XG4gICAgICBhY3Rpb246ICd0YXAnLFxuICAgICAgb3B0aW9uczogY29vcmRzLFxuICAgIH0sXG4gIF0pO1xufTtcblxuZXh0ZW5zaW9ucy50cmFuc2xhdGVXZWJDb29yZHMgPSBhc3luYyBmdW5jdGlvbiAoY29vcmRzKSB7XG4gIGxvZy5kZWJ1ZyhgVHJhbnNsYXRpbmcgY29vcmRpbmF0ZXMgKCR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0pIHRvIHdlYiBjb29yZGluYXRlc2ApO1xuXG4gIC8vIGFkZCBzdGF0aWMgb2Zmc2V0IGZvciBzYWZhcmkgaW4gbGFuZHNjYXBlIG1vZGVcbiAgbGV0IHlPZmZzZXQgPSB0aGlzLm9wdHMuY3VyT3JpZW50YXRpb24gPT09ICdMQU5EU0NBUEUnID8gdGhpcy5sYW5kc2NhcGVXZWJDb29yZHNPZmZzZXQgOiAwO1xuXG4gIC8vIGFkZCBleHRyYSBvZmZzZXQgZm9yIHBvc3NpYmxlIGV4dHJhIHRoaW5ncyBpbiB0aGUgdG9wIG9mIHRoZSBwYWdlXG4gIHlPZmZzZXQgKz0gYXdhaXQgdGhpcy5nZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCgpO1xuICBjb29yZHMueSArPSBhd2FpdCB0aGlzLmdldEV4dHJhVHJhbnNsYXRlV2ViQ29vcmRzT2Zmc2V0KCk7XG5cbiAgLy8gYWJzb2x1dGl6ZSB3ZWIgY29vcmRzXG4gIGNvbnN0IGltcGxpY2l0V2FpdE1zID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgbGV0IHdlYnZpZXc7XG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG4gICAgd2VidmlldyA9IGF3YWl0IHJldHJ5SW50ZXJ2YWwoNSwgMTAwLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJy1pb3MgcHJlZGljYXRlIHN0cmluZycsIGB0eXBlID0gJ1hDVUlFbGVtZW50VHlwZVdlYlZpZXcnIEFORCB2aXNpYmxlID0gMWAsIGZhbHNlKTtcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdChpbXBsaWNpdFdhaXRNcyk7XG4gIH1cblxuICB3ZWJ2aWV3ID0gdXRpbC51bndyYXBFbGVtZW50KHdlYnZpZXcpO1xuICBjb25zdCByZWN0ID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7d2Vidmlld30vcmVjdGAsICdHRVQnKTtcbiAgY29uc3Qgd3ZQb3MgPSB7eDogcmVjdC54LCB5OiByZWN0Lnl9O1xuICBjb25zdCByZWFsRGltcyA9IHt3OiByZWN0LndpZHRoLCBoOiByZWN0LmhlaWdodH07XG5cbiAgY29uc3QgY21kID0gJyhmdW5jdGlvbiAoKSB7IHJldHVybiB7dzogZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoLCBoOiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0fTsgfSkoKSc7XG4gIGNvbnN0IHd2RGltcyA9IGF3YWl0IHRoaXMucmVtb3RlLmV4ZWN1dGUoY21kKTtcblxuICAvLyBUT0RPOiBpbnZlc3RpZ2F0ZSB3aGVyZSB0aGVzZSBjb21lIGZyb20uIFRoZXkgYXBwZWFyIHRvIGJlIGNvbnN0YW50cyBpbiBteSB0ZXN0c1xuICBjb25zdCB1cmxCYXJIZWlnaHQgPSA2NDtcbiAgd3ZQb3MueSArPSB1cmxCYXJIZWlnaHQ7XG5cbiAgY29uc3QgcmVhbERpbWVuc2lvbkhlaWdodCA9IDEwODtcbiAgcmVhbERpbXMuaCAtPSByZWFsRGltZW5zaW9uSGVpZ2h0O1xuXG4gIGlmICh3dkRpbXMgJiYgcmVhbERpbXMgJiYgd3ZQb3MpIHtcbiAgICBsZXQgeFJhdGlvID0gcmVhbERpbXMudyAvIHd2RGltcy53O1xuICAgIGxldCB5UmF0aW8gPSByZWFsRGltcy5oIC8gd3ZEaW1zLmg7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IHtcbiAgICAgIHg6IHd2UG9zLnggKyBNYXRoLnJvdW5kKHhSYXRpbyAqIGNvb3Jkcy54KSxcbiAgICAgIHk6IHd2UG9zLnkgKyB5T2Zmc2V0ICsgTWF0aC5yb3VuZCh5UmF0aW8gKiBjb29yZHMueSksXG4gICAgfTtcblxuICAgIC8vIGFkZGl0aW9uYWwgbG9nZ2luZyBmb3IgY29vcmRpbmF0ZXMsIHNpbmNlIGl0IGlzIHNvbWV0aW1lcyBicm9rZW5cbiAgICAvLyAgIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvOTE1OVxuICAgIGxvZy5kZWJ1ZyhgQ29udmVydGVkIGNvb3JkaW5hdGVzOiAke0pTT04uc3RyaW5naWZ5KG5ld0Nvb3Jkcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgcmVjdDogJHtKU09OLnN0cmluZ2lmeShyZWN0KX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICB3dlBvczogJHtKU09OLnN0cmluZ2lmeSh3dlBvcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgcmVhbERpbXM6ICR7SlNPTi5zdHJpbmdpZnkocmVhbERpbXMpfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHd2RGltczogJHtKU09OLnN0cmluZ2lmeSh3dkRpbXMpfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHhSYXRpbzogJHtKU09OLnN0cmluZ2lmeSh4UmF0aW8pfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHlSYXRpbzogJHtKU09OLnN0cmluZ2lmeSh5UmF0aW8pfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHlPZmZzZXQ6ICR7SlNPTi5zdHJpbmdpZnkoeU9mZnNldCl9YCk7XG5cbiAgICBsb2cuZGVidWcoYENvbnZlcnRlZCB3ZWIgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0gYCArXG4gICAgICAgICAgICAgIGBpbnRvIHJlYWwgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICByZXR1cm4gbmV3Q29vcmRzO1xuICB9XG59O1xuXG5leHRlbnNpb25zLmNoZWNrRm9yQWxlcnQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmV4dGVuc2lvbnMud2FpdEZvckF0b20gPSBhc3luYyBmdW5jdGlvbiAocHJvbWlzZSkge1xuICAvLyBUT0RPOiBBZGQgY2hlY2sgZm9yIGFsZXJ0IGFuZCBhY2NlcHQvZGlzbWlzcyBpdCBhcyBwZXIgYXV0b0FjY2VwdEFsZXJ0IGNhcGFiaWxpdHlcbiAgcmV0dXJuIHRoaXMucGFyc2VFeGVjdXRlUmVzcG9uc2UoYXdhaXQgcHJvbWlzZSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
