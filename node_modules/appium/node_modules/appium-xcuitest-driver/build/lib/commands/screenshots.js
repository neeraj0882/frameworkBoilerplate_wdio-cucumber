'use strict';

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _asyncbox = require('asyncbox');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _nodeSimctl = require('node-simctl');

var _teen_process = require('teen_process');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var commands = {};

function getScreenshotWithIdevicelib(udid, isLandscape) {
  var pathToScreenshotTiff, pathToResultPng, sipsArgs;
  return _regeneratorRuntime.async(function getScreenshotWithIdevicelib$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path({ prefix: 'screenshot-' + udid, suffix: '.tiff' }));

      case 2:
        pathToScreenshotTiff = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(pathToScreenshotTiff));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path({ prefix: 'screenshot-' + udid, suffix: '.png' }));

      case 7:
        pathToResultPng = context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(pathToResultPng));

      case 10:
        context$1$0.prev = 10;
        context$1$0.prev = 11;
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('idevicescreenshot', ['-u', udid, pathToScreenshotTiff]));

      case 14:
        context$1$0.next = 19;
        break;

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](11);
        throw new Error('Cannot take a screenshot from the device \'' + udid + '\' using ' + ('idevicescreenshot. Original error: ' + context$1$0.t0.message));

      case 19:
        sipsArgs = ['-s', 'format', 'png', pathToScreenshotTiff, '--out', pathToResultPng];

        if (isLandscape) {
          sipsArgs = ['-r', '-90'].concat(_toConsumableArray(sipsArgs));
        }
        context$1$0.prev = 21;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('sips', sipsArgs));

      case 24:
        context$1$0.next = 29;
        break;

      case 26:
        context$1$0.prev = 26;
        context$1$0.t1 = context$1$0['catch'](21);
        throw new Error('Cannot convert a screenshot from TIFF to PNG using sips tool. ' + ('Original error: ' + context$1$0.t1.message));

      case 29:
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(pathToResultPng));

      case 31:
        if (context$1$0.sent) {
          context$1$0.next = 33;
          break;
        }

        throw new Error('Cannot convert a screenshot from TIFF to PNG. The conversion ' + ('result does not exist at \'' + pathToResultPng + '\''));

      case 33:
        context$1$0.next = 35;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(pathToResultPng));

      case 35:
        return context$1$0.abrupt('return', context$1$0.sent.toString('base64'));

      case 36:
        context$1$0.prev = 36;
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(pathToScreenshotTiff));

      case 39:
        context$1$0.next = 41;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(pathToResultPng));

      case 41:
        return context$1$0.finish(36);

      case 42:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10,, 36, 42], [11, 16], [21, 26]]);
}

function isIdevicescreenshotAvailable() {
  return _regeneratorRuntime.async(function isIdevicescreenshotAvailable$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevicescreenshot'));

      case 2:
        return context$1$0.abrupt('return', !!context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

commands.getScreenshot = function callee$0$0() {
  var getScreenshotFromWDA, orientation;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        getScreenshotFromWDA = function getScreenshotFromWDA() {
          var data;
          return _regeneratorRuntime.async(function getScreenshotFromWDA$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.proxyCommand('/screenshot', 'GET'));

              case 2:
                data = context$2$0.sent;

                if (_lodash2['default'].isString(data)) {
                  context$2$0.next = 5;
                  break;
                }

                throw new Error('Unable to take screenshot. WDA returned \'' + JSON.stringify(data) + '\'');

              case 5:
                return context$2$0.abrupt('return', data);

              case 6:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 1;

        _logger2['default'].debug('Taking screenshot with WDA');
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(getScreenshotFromWDA());

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Error getting screenshot: ' + context$1$0.t0.message);

        if (!this.isSimulator()) {
          context$1$0.next = 17;
          break;
        }

        if (this.xcodeVersion.versionFloat < 8.1) {
          _logger2['default'].errorAndThrow('No command line screenshot ability with Xcode ' + (this.xcodeVersion.versionFloat + '. Please upgrade to ') + 'at least Xcode 8.1');
        }
        _logger2['default'].info('Falling back to \'simctl io screenshot\' API');
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.getScreenshot)(this.opts.udid));

      case 16:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 17:
        context$1$0.prev = 17;
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(isIdevicescreenshotAvailable());

      case 20:
        if (!context$1$0.sent) {
          context$1$0.next = 28;
          break;
        }

        _logger2['default'].debug('Taking screenshot with \'idevicescreenshot\'');
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.proxyCommand('/orientation', 'GET'));

      case 24:
        orientation = context$1$0.sent;
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(getScreenshotWithIdevicelib(this.opts.udid, orientation === 'LANDSCAPE'));

      case 27:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 28:
        _logger2['default'].info('No \'idevicescreenshot\' program found. To use, install ' + 'using \'brew install --HEAD libimobiledevice\'');
        context$1$0.next = 34;
        break;

      case 31:
        context$1$0.prev = 31;
        context$1$0.t1 = context$1$0['catch'](17);

        _logger2['default'].warn('Error getting screenshot through \'idevicescreenshot\': ' + context$1$0.t1.message);

      case 34:

        // Retry for real devices only. Fail fast on Simulator if simctl does not work as expected
        _logger2['default'].debug('Retrying screenshot through WDA');
        context$1$0.next = 37;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(2, 1000, getScreenshotFromWDA));

      case 37:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 38:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 8], [17, 31]]);
};

commands.getElementScreenshot = function callee$0$0(el) {
  var atomsElement, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = _appiumSupport.util.unwrapElement(el);

        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('getElementScreenshot', [atomsElement]));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:

        if (this.xcodeVersion.major < 9) {
          _logger2['default'].errorAndThrow('Element screenshots are only available since Xcode 9. ' + ('The current Xcode version is ' + this.xcodeVersion.major + '.' + this.xcodeVersion.minor));
        }
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.proxyCommand('/element/' + el + '/screenshot', 'GET'));

      case 9:
        data = context$1$0.sent;

        if (!_lodash2['default'].isString(data)) {
          _logger2['default'].errorAndThrow('Unable to take a screenshot of the element ' + el + '. WDA returned \'' + JSON.stringify(data) + '\'');
        }
        return context$1$0.abrupt('return', data);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getViewportScreenshot = function callee$0$0() {
  var statusBarHeight, screenshot, scale, windowSize, rect, newScreenshot;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getStatusBarHeight());

      case 2:
        statusBarHeight = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getScreenshot());

      case 5:
        screenshot = context$1$0.sent;

        if (!(statusBarHeight === 0)) {
          context$1$0.next = 8;
          break;
        }

        return context$1$0.abrupt('return', screenshot);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.getDevicePixelRatio());

      case 10:
        scale = context$1$0.sent;

        // status bar height comes in unscaled, so scale it
        statusBarHeight = Math.round(statusBarHeight * scale);
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.getWindowSize());

      case 14:
        windowSize = context$1$0.sent;
        rect = {
          left: 0,
          top: statusBarHeight,
          width: windowSize.width * scale,
          height: windowSize.height * scale - statusBarHeight
        };
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(_appiumSupport.imageUtil.cropBase64Image(screenshot, rect));

      case 18:
        newScreenshot = context$1$0.sent;
        return context$1$0.abrupt('return', newScreenshot);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

exports['default'] = commands;
module.exports = exports['default'];

// The sips tool is only present on Mac OS

// all simulator scenarios are finished
// real device, so try idevicescreenshot if possible

// if we don't have a status bar, there's nothing to crop, so we can avoid
// extra calls and return straightaway
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90cy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7d0JBQThCLFVBQVU7O3NCQUMxQixRQUFROzs7OzBCQUNRLGFBQWE7OzRCQUN0QixjQUFjOztzQkFDbkIsV0FBVzs7Ozs2QkFDa0IsZ0JBQWdCOztBQUU3RCxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7O0FBRWxCLFNBQWUsMkJBQTJCLENBQUUsSUFBSSxFQUFFLFdBQVc7TUFDckQsb0JBQW9CLEVBRXBCLGVBQWUsRUFTZixRQUFROzs7Ozt5Q0FYcUIsdUJBQVEsSUFBSSxDQUFDLEVBQUMsTUFBTSxrQkFBZ0IsSUFBSSxBQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBQyxDQUFDOzs7QUFBMUYsNEJBQW9COzt5Q0FDcEIsa0JBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDOzs7O3lDQUNQLHVCQUFRLElBQUksQ0FBQyxFQUFDLE1BQU0sa0JBQWdCLElBQUksQUFBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUMsQ0FBQzs7O0FBQXBGLHVCQUFlOzt5Q0FDZixrQkFBRyxNQUFNLENBQUMsZUFBZSxDQUFDOzs7Ozs7eUNBR3RCLHdCQUFLLG1CQUFtQixFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxvQkFBb0IsQ0FBQyxDQUFDOzs7Ozs7Ozs7Y0FFN0QsSUFBSSxLQUFLLENBQUMsZ0RBQTZDLElBQUksMERBQ3pCLGVBQUUsT0FBTyxDQUFFLENBQUM7OztBQUVsRCxnQkFBUSxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsT0FBTyxFQUFFLGVBQWUsQ0FBQzs7QUFDdEYsWUFBSSxXQUFXLEVBQUU7QUFDZixrQkFBUSxJQUFJLElBQUksRUFBRSxLQUFLLDRCQUFLLFFBQVEsRUFBQyxDQUFDO1NBQ3ZDOzs7eUNBR08sd0JBQUssTUFBTSxFQUFFLFFBQVEsQ0FBQzs7Ozs7Ozs7O2NBRXRCLElBQUks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QUUsa0JBQWUsS0FBSyxDQUFDOzs7QUFBbEUsWUFBSTs7QUFDVixZQUFJLENBQUMsb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO0FBQ3JCLDhCQUFJLGFBQWEsaURBQStDLEVBQUUseUJBQW1CLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQUksQ0FBQztTQUMvRzs0Q0FDTSxJQUFJOzs7Ozs7O0NBQ1osQ0FBQzs7QUFFRixRQUFRLENBQUMscUJBQXFCLEdBQUc7TUFDM0IsZUFBZSxFQUNiLFVBQVUsRUFRVixLQUFLLEVBR0wsVUFBVSxFQUNaLElBQUksRUFNSixhQUFhOzs7Ozt5Q0FuQlcsSUFBSSxDQUFDLGtCQUFrQixFQUFFOzs7QUFBakQsdUJBQWU7O3lDQUNNLElBQUksQ0FBQyxhQUFhLEVBQUU7OztBQUF2QyxrQkFBVTs7Y0FJWixlQUFlLEtBQUssQ0FBQyxDQUFBOzs7Ozs0Q0FDaEIsVUFBVTs7Ozt5Q0FHQyxJQUFJLENBQUMsbUJBQW1CLEVBQUU7OztBQUF4QyxhQUFLOzs7QUFFWCx1QkFBZSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQyxDQUFDOzt5Q0FDN0IsSUFBSSxDQUFDLGFBQWEsRUFBRTs7O0FBQXZDLGtCQUFVO0FBQ1osWUFBSSxHQUFHO0FBQ1QsY0FBSSxFQUFFLENBQUM7QUFDUCxhQUFHLEVBQUUsZUFBZTtBQUNwQixlQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUssR0FBRyxLQUFLO0FBQy9CLGdCQUFNLEVBQUcsQUFBQyxVQUFVLENBQUMsTUFBTSxHQUFHLEtBQUssR0FBSSxlQUFlLEFBQUM7U0FDeEQ7O3lDQUN5Qix5QkFBVSxlQUFlLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQzs7O0FBQWpFLHFCQUFhOzRDQUNWLGFBQWE7Ozs7Ozs7Q0FDckIsQ0FBQzs7cUJBRWEsUUFBUSIsImZpbGUiOiJsaWIvY29tbWFuZHMvc2NyZWVuc2hvdHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldFNjcmVlbnNob3QgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsLCBpbWFnZVV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90V2l0aElkZXZpY2VsaWIgKHVkaWQsIGlzTGFuZHNjYXBlKSB7XG4gIGNvbnN0IHBhdGhUb1NjcmVlbnNob3RUaWZmID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6IGBzY3JlZW5zaG90LSR7dWRpZH1gLCBzdWZmaXg6ICcudGlmZid9KTtcbiAgYXdhaXQgZnMucmltcmFmKHBhdGhUb1NjcmVlbnNob3RUaWZmKTtcbiAgY29uc3QgcGF0aFRvUmVzdWx0UG5nID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6IGBzY3JlZW5zaG90LSR7dWRpZH1gLCBzdWZmaXg6ICcucG5nJ30pO1xuICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgdHJ5IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYygnaWRldmljZXNjcmVlbnNob3QnLCBbJy11JywgdWRpZCwgcGF0aFRvU2NyZWVuc2hvdFRpZmZdKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCB0YWtlIGEgc2NyZWVuc2hvdCBmcm9tIHRoZSBkZXZpY2UgJyR7dWRpZH0nIHVzaW5nIGAgK1xuICAgICAgICBgaWRldmljZXNjcmVlbnNob3QuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gICAgbGV0IHNpcHNBcmdzID0gWyctcycsICdmb3JtYXQnLCAncG5nJywgcGF0aFRvU2NyZWVuc2hvdFRpZmYsICctLW91dCcsIHBhdGhUb1Jlc3VsdFBuZ107XG4gICAgaWYgKGlzTGFuZHNjYXBlKSB7XG4gICAgICBzaXBzQXJncyA9IFsnLXInLCAnLTkwJywgLi4uc2lwc0FyZ3NdO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgLy8gVGhlIHNpcHMgdG9vbCBpcyBvbmx5IHByZXNlbnQgb24gTWFjIE9TXG4gICAgICBhd2FpdCBleGVjKCdzaXBzJywgc2lwc0FyZ3MpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNvbnZlcnQgYSBzY3JlZW5zaG90IGZyb20gVElGRiB0byBQTkcgdXNpbmcgc2lwcyB0b29sLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aFRvUmVzdWx0UG5nKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29udmVydCBhIHNjcmVlbnNob3QgZnJvbSBUSUZGIHRvIFBORy4gVGhlIGNvbnZlcnNpb24gYCArXG4gICAgICAgIGByZXN1bHQgZG9lcyBub3QgZXhpc3QgYXQgJyR7cGF0aFRvUmVzdWx0UG5nfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIChhd2FpdCBmcy5yZWFkRmlsZShwYXRoVG9SZXN1bHRQbmcpKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHBhdGhUb1NjcmVlbnNob3RUaWZmKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpc0lkZXZpY2VzY3JlZW5zaG90QXZhaWxhYmxlICgpIHtcbiAgcmV0dXJuICEhKGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlc2NyZWVuc2hvdCcpKTtcbn1cblxuY29tbWFuZHMuZ2V0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgZ2V0U2NyZWVuc2hvdEZyb21XREEgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvc2NyZWVuc2hvdCcsICdHRVQnKTtcbiAgICBpZiAoIV8uaXNTdHJpbmcoZGF0YSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHRha2Ugc2NyZWVuc2hvdC4gV0RBIHJldHVybmVkICcke0pTT04uc3RyaW5naWZ5KGRhdGEpfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYFRha2luZyBzY3JlZW5zaG90IHdpdGggV0RBYCk7XG4gICAgcmV0dXJuIGF3YWl0IGdldFNjcmVlbnNob3RGcm9tV0RBKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBFcnJvciBnZXR0aW5nIHNjcmVlbnNob3Q6ICR7ZXJyLm1lc3NhZ2V9YCk7XG5cbiAgICBpZiAodGhpcy5pc1NpbXVsYXRvcigpKSB7XG4gICAgICBpZiAodGhpcy54Y29kZVZlcnNpb24udmVyc2lvbkZsb2F0IDwgOC4xKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBObyBjb21tYW5kIGxpbmUgc2NyZWVuc2hvdCBhYmlsaXR5IHdpdGggWGNvZGUgYCArXG4gICAgICAgICAgICAgICAgIGAke3RoaXMueGNvZGVWZXJzaW9uLnZlcnNpb25GbG9hdH0uIFBsZWFzZSB1cGdyYWRlIHRvIGAgK1xuICAgICAgICAgICAgICAgICBgYXQgbGVhc3QgWGNvZGUgOC4xYCk7XG4gICAgICB9XG4gICAgICBsb2cuaW5mbyhgRmFsbGluZyBiYWNrIHRvICdzaW1jdGwgaW8gc2NyZWVuc2hvdCcgQVBJYCk7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdCh0aGlzLm9wdHMudWRpZCk7XG4gICAgfVxuICB9XG5cbiAgLy8gYWxsIHNpbXVsYXRvciBzY2VuYXJpb3MgYXJlIGZpbmlzaGVkXG4gIC8vIHJlYWwgZGV2aWNlLCBzbyB0cnkgaWRldmljZXNjcmVlbnNob3QgaWYgcG9zc2libGVcbiAgdHJ5IHtcbiAgICBpZiAoYXdhaXQgaXNJZGV2aWNlc2NyZWVuc2hvdEF2YWlsYWJsZSgpKSB7XG4gICAgICBsb2cuZGVidWcoYFRha2luZyBzY3JlZW5zaG90IHdpdGggJ2lkZXZpY2VzY3JlZW5zaG90J2ApO1xuICAgICAgY29uc3Qgb3JpZW50YXRpb24gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL29yaWVudGF0aW9uJywgJ0dFVCcpO1xuICAgICAgcmV0dXJuIGF3YWl0IGdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYih0aGlzLm9wdHMudWRpZCwgb3JpZW50YXRpb24gPT09ICdMQU5EU0NBUEUnKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYE5vICdpZGV2aWNlc2NyZWVuc2hvdCcgcHJvZ3JhbSBmb3VuZC4gVG8gdXNlLCBpbnN0YWxsIGAgK1xuICAgICAgICAgICAgIGB1c2luZyAnYnJldyBpbnN0YWxsIC0tSEVBRCBsaWJpbW9iaWxlZGV2aWNlJ2ApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgRXJyb3IgZ2V0dGluZyBzY3JlZW5zaG90IHRocm91Z2ggJ2lkZXZpY2VzY3JlZW5zaG90JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIFJldHJ5IGZvciByZWFsIGRldmljZXMgb25seS4gRmFpbCBmYXN0IG9uIFNpbXVsYXRvciBpZiBzaW1jdGwgZG9lcyBub3Qgd29yayBhcyBleHBlY3RlZFxuICBsb2cuZGVidWcoJ1JldHJ5aW5nIHNjcmVlbnNob3QgdGhyb3VnaCBXREEnKTtcbiAgcmV0dXJuIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMiwgMTAwMCwgZ2V0U2NyZWVuc2hvdEZyb21XREEpO1xufTtcblxuY29tbWFuZHMuZ2V0RWxlbWVudFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGNvbnN0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0RWxlbWVudFNjcmVlbnNob3QnLCBbYXRvbXNFbGVtZW50XSk7XG4gIH1cblxuICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPCA5KSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEVsZW1lbnQgc2NyZWVuc2hvdHMgYXJlIG9ubHkgYXZhaWxhYmxlIHNpbmNlIFhjb2RlIDkuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBUaGUgY3VycmVudCBYY29kZSB2ZXJzaW9uIGlzICR7dGhpcy54Y29kZVZlcnNpb24ubWFqb3J9LiR7dGhpcy54Y29kZVZlcnNpb24ubWlub3J9YCk7XG4gIH1cbiAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS9zY3JlZW5zaG90YCwgJ0dFVCcpO1xuICBpZiAoIV8uaXNTdHJpbmcoZGF0YSkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVW5hYmxlIHRvIHRha2UgYSBzY3JlZW5zaG90IG9mIHRoZSBlbGVtZW50ICR7ZWx9LiBXREEgcmV0dXJuZWQgJyR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9J2ApO1xuICB9XG4gIHJldHVybiBkYXRhO1xufTtcblxuY29tbWFuZHMuZ2V0Vmlld3BvcnRTY3JlZW5zaG90ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgc3RhdHVzQmFySGVpZ2h0ID0gYXdhaXQgdGhpcy5nZXRTdGF0dXNCYXJIZWlnaHQoKTtcbiAgY29uc3Qgc2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuXG4gIC8vIGlmIHdlIGRvbid0IGhhdmUgYSBzdGF0dXMgYmFyLCB0aGVyZSdzIG5vdGhpbmcgdG8gY3JvcCwgc28gd2UgY2FuIGF2b2lkXG4gIC8vIGV4dHJhIGNhbGxzIGFuZCByZXR1cm4gc3RyYWlnaHRhd2F5XG4gIGlmIChzdGF0dXNCYXJIZWlnaHQgPT09IDApIHtcbiAgICByZXR1cm4gc2NyZWVuc2hvdDtcbiAgfVxuXG4gIGNvbnN0IHNjYWxlID0gYXdhaXQgdGhpcy5nZXREZXZpY2VQaXhlbFJhdGlvKCk7XG4gIC8vIHN0YXR1cyBiYXIgaGVpZ2h0IGNvbWVzIGluIHVuc2NhbGVkLCBzbyBzY2FsZSBpdFxuICBzdGF0dXNCYXJIZWlnaHQgPSBNYXRoLnJvdW5kKHN0YXR1c0JhckhlaWdodCAqIHNjYWxlKTtcbiAgY29uc3Qgd2luZG93U2l6ZSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuICBsZXQgcmVjdCA9IHtcbiAgICBsZWZ0OiAwLFxuICAgIHRvcDogc3RhdHVzQmFySGVpZ2h0LFxuICAgIHdpZHRoOiB3aW5kb3dTaXplLndpZHRoICogc2NhbGUsXG4gICAgaGVpZ2h0OiAoKHdpbmRvd1NpemUuaGVpZ2h0ICogc2NhbGUpIC0gc3RhdHVzQmFySGVpZ2h0KVxuICB9O1xuICBsZXQgbmV3U2NyZWVuc2hvdCA9IGF3YWl0IGltYWdlVXRpbC5jcm9wQmFzZTY0SW1hZ2Uoc2NyZWVuc2hvdCwgcmVjdCk7XG4gIHJldHVybiBuZXdTY3JlZW5zaG90O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
