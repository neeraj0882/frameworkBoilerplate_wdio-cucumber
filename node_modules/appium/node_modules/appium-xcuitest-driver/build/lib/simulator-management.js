'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumIosSimulator = require('appium-ios-simulator');

var _nodeSimctl = require('node-simctl');

var _utils = require('./utils');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

// returns sim for desired caps
function createSim(caps, sessionId) {
  var name, udid;
  return _regeneratorRuntime.async(function createSim$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        name = 'appiumTest-' + sessionId;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.createDevice)(name, caps.deviceName, caps.platformVersion));

      case 3:
        udid = context$1$0.sent;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.getSimulator)(udid));

      case 6:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getExistingSim(opts) {
  var devices, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, device;

  return _regeneratorRuntime.async(function getExistingSim$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.getDevices)(opts.platformVersion));

      case 2:
        devices = context$1$0.sent;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 6;
        _iterator = _getIterator(_lodash2['default'].values(devices));

      case 8:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 17;
          break;
        }

        device = _step.value;

        if (!(device.name === opts.deviceName)) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.getSimulator)(device.udid));

      case 13:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 14:
        _iteratorNormalCompletion = true;
        context$1$0.next = 8;
        break;

      case 17:
        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](6);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        return context$1$0.abrupt('return', null);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 19, 23, 31], [24,, 26, 30]]);
}

function shutdownSimulator(device) {
  return _regeneratorRuntime.async(function shutdownSimulator$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _utils.resetXCTestProcesses)(device.udid, true));

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(device.shutdown());

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function runSimulatorReset(device, opts) {
  var isKeychainsBackupSuccessful, isSafari;
  return _regeneratorRuntime.async(function runSimulatorReset$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(opts.noReset && !opts.fullReset)) {
          context$1$0.next = 3;
          break;
        }

        // noReset === true && fullReset === false
        _logger2['default'].debug('Reset: noReset is on. Leaving simulator as is');
        return context$1$0.abrupt('return');

      case 3:
        if (device) {
          context$1$0.next = 6;
          break;
        }

        _logger2['default'].debug('Reset: no device available. Skipping');
        return context$1$0.abrupt('return');

      case 6:
        if (!opts.fullReset) {
          context$1$0.next = 26;
          break;
        }

        _logger2['default'].debug('Reset: fullReset is on. Cleaning simulator');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(shutdownSimulator(device));

      case 10:
        isKeychainsBackupSuccessful = false;

        if (!(opts.keychainsExcludePatterns || opts.keepKeyChains)) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(device.backupKeychains());

      case 14:
        isKeychainsBackupSuccessful = context$1$0.sent;

      case 15:
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(device.clean());

      case 17:
        if (!isKeychainsBackupSuccessful) {
          context$1$0.next = 23;
          break;
        }

        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(device.restoreKeychains(opts.keychainsExcludePatterns || []));

      case 20:
        _logger2['default'].info('Successfully restored keychains after full reset');
        context$1$0.next = 24;
        break;

      case 23:
        if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
          _logger2['default'].warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
        }

      case 24:
        context$1$0.next = 61;
        break;

      case 26:
        if (!opts.bundleId) {
          context$1$0.next = 61;
          break;
        }

        context$1$0.next = 29;
        return _regeneratorRuntime.awrap(device.isRunning());

      case 29:
        if (!context$1$0.sent) {
          context$1$0.next = 43;
          break;
        }

        if (!(device.xcodeVersion.major >= 8)) {
          context$1$0.next = 41;
          break;
        }

        context$1$0.prev = 31;
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.terminate)(device.udid, opts.bundleId));

      case 34:
        context$1$0.next = 39;
        break;

      case 36:
        context$1$0.prev = 36;
        context$1$0.t0 = context$1$0['catch'](31);

        _logger2['default'].warn('Reset: failed to terminate Simulator application with id "' + opts.bundleId + '"');

      case 39:
        context$1$0.next = 43;
        break;

      case 41:
        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(shutdownSimulator(device));

      case 43:
        if (!opts.app) {
          context$1$0.next = 46;
          break;
        }

        _logger2['default'].info('Not scrubbing third party app in anticipation of uninstall');
        return context$1$0.abrupt('return');

      case 46:
        isSafari = (opts.browserName || '').toLowerCase() === 'safari';
        context$1$0.prev = 47;

        if (!isSafari) {
          context$1$0.next = 53;
          break;
        }

        context$1$0.next = 51;
        return _regeneratorRuntime.awrap(device.cleanSafari());

      case 51:
        context$1$0.next = 55;
        break;

      case 53:
        context$1$0.next = 55;
        return _regeneratorRuntime.awrap(device.scrubCustomApp(_path2['default'].basename(opts.app), opts.bundleId));

      case 55:
        context$1$0.next = 61;
        break;

      case 57:
        context$1$0.prev = 57;
        context$1$0.t1 = context$1$0['catch'](47);

        _logger2['default'].warn(context$1$0.t1.message);
        _logger2['default'].warn('Reset: could not scrub ' + (isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"') + '. Leaving as is.');

      case 61:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[31, 36], [47, 57]]);
}

function installToSimulator(device, app, bundleId) {
  var noReset = arguments.length <= 3 || arguments[3] === undefined ? true : arguments[3];
  return _regeneratorRuntime.async(function installToSimulator$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (app) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].debug('No app path is given. Nothing to install.');
        return context$1$0.abrupt('return');

      case 3:
        if (!bundleId) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(device.isAppInstalled(bundleId));

      case 6:
        if (!context$1$0.sent) {
          context$1$0.next = 13;
          break;
        }

        if (!noReset) {
          context$1$0.next = 10;
          break;
        }

        _logger2['default'].debug('App \'' + bundleId + '\' is already installed. No need to reinstall.');
        return context$1$0.abrupt('return');

      case 10:
        _logger2['default'].debug('Reset requested. Removing app with id \'' + bundleId + '\' from the device');
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(device.removeApp(bundleId));

      case 13:
        _logger2['default'].debug('Installing \'' + app + '\' on Simulator with UUID \'' + device.udid + '\'...');
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(device.installApp(app));

      case 16:
        _logger2['default'].debug('The app has been installed successfully.');

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function shutdownOtherSimulators(currentDevice) {
  var allDevices, otherBootedDevices, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, udid;

  return _regeneratorRuntime.async(function shutdownOtherSimulators$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.t0 = _lodash2['default'];
        context$1$0.t1 = _lodash2['default'];
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.getDevices)());

      case 4:
        context$1$0.t2 = context$1$0.sent;
        context$1$0.t3 = context$1$0.t1.values.call(context$1$0.t1, context$1$0.t2);
        allDevices = context$1$0.t0.flatMap.call(context$1$0.t0, context$1$0.t3);
        otherBootedDevices = allDevices.filter(function (device) {
          return device.udid !== currentDevice.udid && device.state === 'Booted';
        });

        if (!_lodash2['default'].isEmpty(otherBootedDevices)) {
          context$1$0.next = 11;
          break;
        }

        _logger2['default'].info('No other running simulators have been detected');
        return context$1$0.abrupt('return');

      case 11:
        _logger2['default'].info('Detected ' + otherBootedDevices.length + ' other running Simulator' + (otherBootedDevices.length === 1 ? '' : 's') + '.' + ('Shutting ' + (otherBootedDevices.length === 1 ? 'it' : 'them') + ' down...'));
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 15;
        _iterator2 = _getIterator(otherBootedDevices);

      case 17:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 26;
          break;
        }

        udid = _step2.value.udid;
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap((0, _utils.resetXCTestProcesses)(udid, true));

      case 21:
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.shutdown)(udid));

      case 23:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 17;
        break;

      case 26:
        context$1$0.next = 32;
        break;

      case 28:
        context$1$0.prev = 28;
        context$1$0.t4 = context$1$0['catch'](15);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t4;

      case 32:
        context$1$0.prev = 32;
        context$1$0.prev = 33;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 35:
        context$1$0.prev = 35;

        if (!_didIteratorError2) {
          context$1$0.next = 38;
          break;
        }

        throw _iteratorError2;

      case 38:
        return context$1$0.finish(35);

      case 39:
        return context$1$0.finish(32);

      case 40:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[15, 28, 32, 40], [33,, 35, 39]]);
}

exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.runSimulatorReset = runSimulatorReset;
exports.installToSimulator = installToSimulator;
exports.shutdownSimulator = shutdownSimulator;
exports.shutdownOtherSimulators = shutdownOtherSimulators;

// stop XCTest processes if running to avoid unexpected side effects

// Terminate the app under test if it is still running on Simulator
// Termination is not needed if Simulator is not running

// It is necessary to stop the corresponding xcodebuild process before killing
// the simulator, otherwise it will be automatically restarted
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7b0JBQWlCLE1BQU07Ozs7a0NBQ00sc0JBQXNCOzswQkFDVyxhQUFhOztxQkFDdEMsU0FBUzs7c0JBQ2hDLFFBQVE7Ozs7c0JBQ04sVUFBVTs7Ozs7QUFHMUIsU0FBZSxTQUFTLENBQUUsSUFBSSxFQUFFLFNBQVM7TUFDbkMsSUFBSSxFQUNKLElBQUk7Ozs7QUFESixZQUFJLG1CQUFpQixTQUFTOzt5Q0FDakIsOEJBQWEsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQzs7O0FBQXRFLFlBQUk7O3lDQUNLLHNDQUFhLElBQUksQ0FBQzs7Ozs7Ozs7OztDQUNoQzs7QUFFRCxTQUFlLGNBQWMsQ0FBRSxJQUFJO01BQzdCLE9BQU8sa0ZBQ0YsTUFBTTs7Ozs7O3lDQURLLDRCQUFXLElBQUksQ0FBQyxlQUFlLENBQUM7OztBQUFoRCxlQUFPOzs7OztpQ0FDUSxvQkFBRSxNQUFNLENBQUMsT0FBTyxDQUFDOzs7Ozs7OztBQUEzQixjQUFNOztjQUNULE1BQU0sQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLFVBQVUsQ0FBQTs7Ozs7O3lDQUNwQixzQ0FBYSxNQUFNLENBQUMsSUFBSSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7NENBR25DLElBQUk7Ozs7Ozs7Q0FDWjs7QUFFRCxTQUFlLGlCQUFpQixDQUFFLE1BQU07Ozs7O3lDQUVoQyxpQ0FBcUIsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7Ozs7eUNBQ3ZDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7Ozs7Ozs7Q0FDeEI7O0FBRUQsU0FBZSxpQkFBaUIsQ0FBRSxNQUFNLEVBQUUsSUFBSTtNQWV0QywyQkFBMkIsRUE4QnpCLFFBQVE7Ozs7Y0E1Q1osSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxT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QzdDLFVBQVUsRUFDVixrQkFBa0IsdUZBT1osSUFBSTs7Ozs7Ozs7eUNBUjRCLDZCQUFZOzs7O3dDQUF6QixNQUFNO0FBQS9CLGtCQUFVLGtCQUFLLE9BQU87QUFDdEIsMEJBQWtCLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFDLE1BQU07aUJBQUssTUFBTSxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxLQUFLLEtBQUssUUFBUTtTQUFBLENBQUM7O2FBQ3JILG9CQUFFLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQzs7Ozs7QUFDL0IsNEJBQUksSUFBSSxDQUFDLGdEQUFnRCxDQUFDLENBQUM7Ozs7QUFHN0QsNEJBQUksSUFBSSxDQUFDLGNBQVksa0JBQWtCLENBQUMsTUFBTSxpQ0FBMkIsa0JBQWtCLENBQUMsTUFBTSxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsR0FBRyxDQUFBLHlCQUM5RixrQkFBa0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxHQUFHLElBQUksR0FBRyxNQUFNLENBQUEsY0FBVSxDQUFDLENBQUM7Ozs7O2tDQUMzRCxrQkFBa0I7Ozs7Ozs7O0FBQTNCLFlBQUksZ0JBQUosSUFBSTs7eUNBR1IsaUNBQXFCLElBQUksRUFBRSxJQUFJLENBQUM7Ozs7eUNBQ2hDLDBCQUFTLElBQUksQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztDQUV2Qjs7UUFFUSxTQUFTLEdBQVQsU0FBUztRQUFFLGNBQWMsR0FBZCxjQUFjO1FBQUUsaUJBQWlCLEdBQWpCLGlCQUFpQjtRQUFFLGtCQUFrQixHQUFsQixrQkFBa0I7UUFDaEUsaUJBQWlCLEdBQWpCLGlCQUFpQjtRQUFFLHVCQUF1QixHQUF2Qix1QkFBdUIiLCJmaWxlIjoibGliL3NpbXVsYXRvci1tYW5hZ2VtZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBnZXRTaW11bGF0b3IgfSBmcm9tICdhcHBpdW0taW9zLXNpbXVsYXRvcic7XG5pbXBvcnQgeyBjcmVhdGVEZXZpY2UsIGdldERldmljZXMsIHRlcm1pbmF0ZSwgc2h1dGRvd24gfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyByZXNldFhDVGVzdFByb2Nlc3NlcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG4vLyByZXR1cm5zIHNpbSBmb3IgZGVzaXJlZCBjYXBzXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTaW0gKGNhcHMsIHNlc3Npb25JZCkge1xuICBsZXQgbmFtZSA9IGBhcHBpdW1UZXN0LSR7c2Vzc2lvbklkfWA7XG4gIGxldCB1ZGlkID0gYXdhaXQgY3JlYXRlRGV2aWNlKG5hbWUsIGNhcHMuZGV2aWNlTmFtZSwgY2Fwcy5wbGF0Zm9ybVZlcnNpb24pO1xuICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRFeGlzdGluZ1NpbSAob3B0cykge1xuICBsZXQgZGV2aWNlcyA9IGF3YWl0IGdldERldmljZXMob3B0cy5wbGF0Zm9ybVZlcnNpb24pO1xuICBmb3IgKGxldCBkZXZpY2Ugb2YgXy52YWx1ZXMoZGV2aWNlcykpIHtcbiAgICBpZiAoZGV2aWNlLm5hbWUgPT09IG9wdHMuZGV2aWNlTmFtZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGdldFNpbXVsYXRvcihkZXZpY2UudWRpZCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93blNpbXVsYXRvciAoZGV2aWNlKSB7XG4gIC8vIHN0b3AgWENUZXN0IHByb2Nlc3NlcyBpZiBydW5uaW5nIHRvIGF2b2lkIHVuZXhwZWN0ZWQgc2lkZSBlZmZlY3RzXG4gIGF3YWl0IHJlc2V0WENUZXN0UHJvY2Vzc2VzKGRldmljZS51ZGlkLCB0cnVlKTtcbiAgYXdhaXQgZGV2aWNlLnNodXRkb3duKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blNpbXVsYXRvclJlc2V0IChkZXZpY2UsIG9wdHMpIHtcbiAgaWYgKG9wdHMubm9SZXNldCAmJiAhb3B0cy5mdWxsUmVzZXQpIHtcbiAgICAvLyBub1Jlc2V0ID09PSB0cnVlICYmIGZ1bGxSZXNldCA9PT0gZmFsc2VcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBub1Jlc2V0IGlzIG9uLiBMZWF2aW5nIHNpbXVsYXRvciBhcyBpcycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghZGV2aWNlKSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldDogbm8gZGV2aWNlIGF2YWlsYWJsZS4gU2tpcHBpbmcnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAob3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBmdWxsUmVzZXQgaXMgb24uIENsZWFuaW5nIHNpbXVsYXRvcicpO1xuICAgIGF3YWl0IHNodXRkb3duU2ltdWxhdG9yKGRldmljZSk7XG4gICAgbGV0IGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCA9IGZhbHNlO1xuICAgIGlmIChvcHRzLmtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyB8fCBvcHRzLmtlZXBLZXlDaGFpbnMpIHtcbiAgICAgIGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCA9IGF3YWl0IGRldmljZS5iYWNrdXBLZXljaGFpbnMoKTtcbiAgICB9XG4gICAgYXdhaXQgZGV2aWNlLmNsZWFuKCk7XG4gICAgaWYgKGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCkge1xuICAgICAgYXdhaXQgZGV2aWNlLnJlc3RvcmVLZXljaGFpbnMob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgW10pO1xuICAgICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSByZXN0b3JlZCBrZXljaGFpbnMgYWZ0ZXIgZnVsbCByZXNldGApO1xuICAgIH0gZWxzZSBpZiAob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgb3B0cy5rZWVwS2V5Q2hhaW5zKSB7XG4gICAgICBsb2cud2FybignQ2Fubm90IHJlc3RvcmUga2V5Y2hhaW5zIGFmdGVyIGZ1bGwgcmVzZXQsIGJlY2F1c2UgJyArXG4gICAgICAgICAgICAgICAndGhlIGJhY2t1cCBvcGVyYXRpb24gZGlkIG5vdCBzdWNjZWVkJyk7XG4gICAgfVxuICB9IGVsc2UgaWYgKG9wdHMuYnVuZGxlSWQpIHtcbiAgICAvLyBUZXJtaW5hdGUgdGhlIGFwcCB1bmRlciB0ZXN0IGlmIGl0IGlzIHN0aWxsIHJ1bm5pbmcgb24gU2ltdWxhdG9yXG4gICAgLy8gVGVybWluYXRpb24gaXMgbm90IG5lZWRlZCBpZiBTaW11bGF0b3IgaXMgbm90IHJ1bm5pbmdcbiAgICBpZiAoYXdhaXQgZGV2aWNlLmlzUnVubmluZygpKSB7XG4gICAgICBpZiAoZGV2aWNlLnhjb2RlVmVyc2lvbi5tYWpvciA+PSA4KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGVybWluYXRlKGRldmljZS51ZGlkLCBvcHRzLmJ1bmRsZUlkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYFJlc2V0OiBmYWlsZWQgdG8gdGVybWluYXRlIFNpbXVsYXRvciBhcHBsaWNhdGlvbiB3aXRoIGlkIFwiJHtvcHRzLmJ1bmRsZUlkfVwiYCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IHNodXRkb3duU2ltdWxhdG9yKGRldmljZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChvcHRzLmFwcCkge1xuICAgICAgbG9nLmluZm8oJ05vdCBzY3J1YmJpbmcgdGhpcmQgcGFydHkgYXBwIGluIGFudGljaXBhdGlvbiBvZiB1bmluc3RhbGwnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaXNTYWZhcmkgPSAob3B0cy5icm93c2VyTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gJ3NhZmFyaSc7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChpc1NhZmFyaSkge1xuICAgICAgICBhd2FpdCBkZXZpY2UuY2xlYW5TYWZhcmkoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IGRldmljZS5zY3J1YkN1c3RvbUFwcChwYXRoLmJhc2VuYW1lKG9wdHMuYXBwKSwgb3B0cy5idW5kbGVJZCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihlcnIubWVzc2FnZSk7XG4gICAgICBsb2cud2FybihgUmVzZXQ6IGNvdWxkIG5vdCBzY3J1YiAke2lzU2FmYXJpID8gJ1NhZmFyaSBicm93c2VyJyA6ICdhcHBsaWNhdGlvbiB3aXRoIGlkIFwiJyArIG9wdHMuYnVuZGxlSWQgKyAnXCInfS4gTGVhdmluZyBhcyBpcy5gKTtcbiAgICB9XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbFRvU2ltdWxhdG9yIChkZXZpY2UsIGFwcCwgYnVuZGxlSWQsIG5vUmVzZXQgPSB0cnVlKSB7XG4gIGlmICghYXBwKSB7XG4gICAgbG9nLmRlYnVnKCdObyBhcHAgcGF0aCBpcyBnaXZlbi4gTm90aGluZyB0byBpbnN0YWxsLicpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChidW5kbGVJZCkge1xuICAgIGlmIChhd2FpdCBkZXZpY2UuaXNBcHBJbnN0YWxsZWQoYnVuZGxlSWQpKSB7XG4gICAgICBpZiAobm9SZXNldCkge1xuICAgICAgICBsb2cuZGVidWcoYEFwcCAnJHtidW5kbGVJZH0nIGlzIGFscmVhZHkgaW5zdGFsbGVkLiBObyBuZWVkIHRvIHJlaW5zdGFsbC5gKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBSZXNldCByZXF1ZXN0ZWQuIFJlbW92aW5nIGFwcCB3aXRoIGlkICcke2J1bmRsZUlkfScgZnJvbSB0aGUgZGV2aWNlYCk7XG4gICAgICBhd2FpdCBkZXZpY2UucmVtb3ZlQXBwKGJ1bmRsZUlkKTtcbiAgICB9XG4gIH1cbiAgbG9nLmRlYnVnKGBJbnN0YWxsaW5nICcke2FwcH0nIG9uIFNpbXVsYXRvciB3aXRoIFVVSUQgJyR7ZGV2aWNlLnVkaWR9Jy4uLmApO1xuICBhd2FpdCBkZXZpY2UuaW5zdGFsbEFwcChhcHApO1xuICBsb2cuZGVidWcoJ1RoZSBhcHAgaGFzIGJlZW4gaW5zdGFsbGVkIHN1Y2Nlc3NmdWxseS4nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2h1dGRvd25PdGhlclNpbXVsYXRvcnMgKGN1cnJlbnREZXZpY2UpIHtcbiAgY29uc3QgYWxsRGV2aWNlcyA9IF8uZmxhdE1hcChfLnZhbHVlcyhhd2FpdCBnZXREZXZpY2VzKCkpKTtcbiAgY29uc3Qgb3RoZXJCb290ZWREZXZpY2VzID0gYWxsRGV2aWNlcy5maWx0ZXIoKGRldmljZSkgPT4gZGV2aWNlLnVkaWQgIT09IGN1cnJlbnREZXZpY2UudWRpZCAmJiBkZXZpY2Uuc3RhdGUgPT09ICdCb290ZWQnKTtcbiAgaWYgKF8uaXNFbXB0eShvdGhlckJvb3RlZERldmljZXMpKSB7XG4gICAgbG9nLmluZm8oJ05vIG90aGVyIHJ1bm5pbmcgc2ltdWxhdG9ycyBoYXZlIGJlZW4gZGV0ZWN0ZWQnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgbG9nLmluZm8oYERldGVjdGVkICR7b3RoZXJCb290ZWREZXZpY2VzLmxlbmd0aH0gb3RoZXIgcnVubmluZyBTaW11bGF0b3Ike290aGVyQm9vdGVkRGV2aWNlcy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ30uYCArXG4gICAgICAgICAgIGBTaHV0dGluZyAke290aGVyQm9vdGVkRGV2aWNlcy5sZW5ndGggPT09IDEgPyAnaXQnIDogJ3RoZW0nfSBkb3duLi4uYCk7XG4gIGZvciAoY29uc3Qge3VkaWR9IG9mIG90aGVyQm9vdGVkRGV2aWNlcykge1xuICAgIC8vIEl0IGlzIG5lY2Vzc2FyeSB0byBzdG9wIHRoZSBjb3JyZXNwb25kaW5nIHhjb2RlYnVpbGQgcHJvY2VzcyBiZWZvcmUga2lsbGluZ1xuICAgIC8vIHRoZSBzaW11bGF0b3IsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgcmVzdGFydGVkXG4gICAgYXdhaXQgcmVzZXRYQ1Rlc3RQcm9jZXNzZXModWRpZCwgdHJ1ZSk7XG4gICAgYXdhaXQgc2h1dGRvd24odWRpZCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgY3JlYXRlU2ltLCBnZXRFeGlzdGluZ1NpbSwgcnVuU2ltdWxhdG9yUmVzZXQsIGluc3RhbGxUb1NpbXVsYXRvcixcbiAgICAgICAgIHNodXRkb3duU2ltdWxhdG9yLCBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
