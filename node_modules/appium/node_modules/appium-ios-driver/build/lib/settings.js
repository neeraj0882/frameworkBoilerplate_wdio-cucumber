'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
var SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

function launchAndQuitSimulator(sim, safari) {
  return _regeneratorRuntime.async(function launchAndQuitSimulator$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('No simulator directories found.');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(sim.launchAndQuit(safari));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function checkPreferences(settings) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(settings), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var setting = _step.value;

      if (_lodash2['default'].has(opts, setting)) {
        return true;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return false;
}

function setLocaleAndPreferences(sim, opts) {
  var safari = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
  var shutdownFn = arguments.length <= 3 || arguments[3] === undefined ? _lodash2['default'].noop : arguments[3];
  var localConfig, prefsUpdated;
  return _regeneratorRuntime.async(function setLocaleAndPreferences$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(setLocale(sim, opts, {}, safari));

      case 2:
        localConfig = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(setPreferences(sim, opts, safari));

      case 5:
        prefsUpdated = context$1$0.sent;

        if (!(localConfig._updated || prefsUpdated)) {
          context$1$0.next = 10;
          break;
        }

        _logger2['default'].debug("Updated settings. Rebooting the simulator if it's already open");
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(shutdownFn(sim));

      case 10:
        delete localConfig._updated;
        return context$1$0.abrupt('return', localConfig);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

// pass in the simulator so that other systems that use the function can supply
// whatever they have
function setLocale(sim, opts) {
  var localeConfig = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];
  var safari = arguments.length <= 3 || arguments[3] === undefined ? false : arguments[3];
  var updated;
  return _regeneratorRuntime.async(function setLocale$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!opts.language && !opts.locale && !opts.calendarFormat)) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].debug("No reason to set locale");
        return context$1$0.abrupt('return', {
          _updated: false
        });

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(sim.isFresh());

      case 5:
        if (!context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(launchAndQuitSimulator(sim, safari));

      case 8:

        _logger2['default'].debug('Setting locale information');
        localeConfig = {
          language: opts.language || localeConfig.language,
          locale: opts.locale || localeConfig.locale,
          calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
          _updated: false
        };

        context$1$0.prev = 10;
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(sim.updateLocale(opts.language, opts.locale, opts.calendarFormat));

      case 13:
        updated = context$1$0.sent;

        if (updated) {
          localeConfig._updated = true;
        }
        context$1$0.next = 20;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t0 = context$1$0['catch'](10);

        _logger2['default'].errorAndThrow('Appium was unable to set locale info: ' + context$1$0.t0);

      case 20:
        return context$1$0.abrupt('return', localeConfig);

      case 21:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10, 17]]);
}

function setPreferences(sim, opts) {
  var safari = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
  var needToSetPrefs, needToSetSafariPrefs;
  return _regeneratorRuntime.async(function setPreferences$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
        needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

        if (!(!needToSetPrefs && !needToSetSafariPrefs)) {
          context$1$0.next = 5;
          break;
        }

        _logger2['default'].debug("No iOS / app preferences to set");
        return context$1$0.abrupt('return', false);

      case 5:

        _logger2['default'].debug("Setting iOS and app preferences");

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(sim.isFresh());

      case 8:
        if (!context$1$0.sent) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(launchAndQuitSimulator(sim, safari));

      case 11:
        context$1$0.prev = 11;

        if (!needToSetPrefs) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(setLocServicesPrefs(sim, opts));

      case 15:
        context$1$0.next = 21;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t0 = context$1$0['catch'](11);

        _logger2['default'].error("Error setting location services preferences, prefs will not work");
        _logger2['default'].error(context$1$0.t0);

      case 21:
        context$1$0.prev = 21;

        if (!needToSetSafariPrefs) {
          context$1$0.next = 25;
          break;
        }

        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(setSafariPrefs(sim, opts));

      case 25:
        context$1$0.next = 31;
        break;

      case 27:
        context$1$0.prev = 27;
        context$1$0.t1 = context$1$0['catch'](21);

        _logger2['default'].error("Error setting safari preferences, prefs will not work");
        _logger2['default'].error(context$1$0.t1);

      case 31:
        return context$1$0.abrupt('return', true);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[11, 17], [21, 27]]);
}

function setLocServicesPrefs(sim) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var locServ, msg, locAuth;
  return _regeneratorRuntime.async(function setLocServicesPrefs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        locServ = _lodash2['default'].find([opts.locationServicesEnabled, opts.locationServicesAuthorized], function (c) {
          return !_lodash2['default'].isUndefined(c);
        });

        if (_lodash2['default'].isUndefined(locServ)) {
          context$1$0.next = 6;
          break;
        }

        locServ = locServ ? 1 : 0;
        _logger2['default'].debug('Setting location services to ' + locServ);
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(sim.updateSettings('locationServices', {
          LocationServicesEnabled: locServ,
          'LocationServicesEnabledIn7.0': locServ,
          'LocationServicesEnabledIn8.0': locServ
        }));

      case 6:
        if (_lodash2['default'].isUndefined(opts.locationServicesAuthorized)) {
          context$1$0.next = 12;
          break;
        }

        if (!opts.bundleId) {
          msg = "Can't set location services for app without bundle ID";

          _logger2['default'].errorAndThrow(msg);
        }
        locAuth = !!opts.locationServicesAuthorized;

        if (locAuth) {
          _logger2['default'].debug("Authorizing location services for app");
        } else {
          _logger2['default'].debug("De-authorizing location services for app");
        }
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(sim.updateLocationSettings(opts.bundleId, locAuth));

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function setSafariPrefs(sim) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var safariSettings, val;
  return _regeneratorRuntime.async(function setSafariPrefs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        safariSettings = {};

        if (_lodash2['default'].has(opts, 'safariAllowPopups')) {
          val = !!opts.safariAllowPopups;

          _logger2['default'].debug('Setting javascript window opening to \'' + val + '\'');
          safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
          safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
        }
        if (_lodash2['default'].has(opts, 'safariIgnoreFraudWarning')) {
          val = !opts.safariIgnoreFraudWarning;

          _logger2['default'].debug('Setting fraudulent website warning to \'' + val + '\'');
          safariSettings.WarnAboutFraudulentWebsites = val;
        }
        if (_lodash2['default'].has(opts, 'safariOpenLinksInBackground')) {
          val = opts.safariOpenLinksInBackground ? 1 : 0;

          _logger2['default'].debug('Setting opening links in background to \'' + !!val + '\'');
          safariSettings.OpenLinksInBackground = val;
        }

        if (!(_lodash2['default'].size(safariSettings) > 0)) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(sim.updateSafariSettings(safariSettings));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.setLocale = setLocale;
exports.setPreferences = setPreferences;
exports.setLocaleAndPreferences = setLocaleAndPreferences;

// we need the simulator to have its directories in place
//# sourceMappingURL=data:application/json;charset=utf8;base64,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RyxHQUFHLENBQUM7QUFDakUsd0JBQWMsQ0FBQyxxQ0FBcUMsR0FBRyxHQUFHLENBQUM7U0FDNUQ7QUFDRCxZQUFJLG9CQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsMEJBQTBCLENBQUMsRUFBRTtBQUN2QyxhQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCOztBQUN4Qyw4QkFBTyxLQUFLLDhDQUEyQyxHQUFHLFFBQUksQ0FBQztBQUMvRCx3QkFBYyxDQUFDLDJCQUEyQixHQUFHLEdBQUcsQ0FBQztTQUNsRDtBQUNELFlBQUksb0JBQUUsR0FBRyxDQUFDLElBQUksRUFBRSw2QkFBNkIsQ0FBQyxFQUFFO0FBQzFDLGFBQUcsR0FBRyxJQUFJLENBQUMsMkJBQTJCLEdBQUcsQ0FBQyxHQUFHLENBQUM7O0FBQ2xELDhCQUFPLEtBQUssK0NBQTRDLENBQUMsQ0FBQyxHQUFHLFFBQUksQ0FBQztBQUNsRSx3QkFBYyxDQUFDLHFCQUFxQixHQUFHLEdBQUcsQ0FBQztTQUM1Qzs7Y0FDRyxvQkFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFBOzs7Ozs7eUNBQ3RCLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxjQUFjLENBQUM7Ozs7Ozs7Q0FFakQ7O1FBRVEsU0FBUyxHQUFULFNBQVM7UUFBRSxjQUFjLEdBQWQsY0FBYztRQUFFLHVCQUF1QixHQUF2Qix1QkFBdUIiLCJmaWxlIjoibGliL3NldHRpbmdzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IFNFVFRJTkdTX0NBUFMgPSBbXG4gICdsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCcsXG4gICdsb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCcsXG5dO1xuY29uc3QgU0FGQVJJX1NFVFRJTkdTX0NBUFMgPSBbXG4gICdzYWZhcmlBbGxvd1BvcHVwcycsXG4gICdzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmcnLFxuICAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJyxcbl07XG5cbmFzeW5jIGZ1bmN0aW9uIGxhdW5jaEFuZFF1aXRTaW11bGF0b3IgKHNpbSwgc2FmYXJpKSB7XG4gIGxvZ2dlci5kZWJ1ZygnTm8gc2ltdWxhdG9yIGRpcmVjdG9yaWVzIGZvdW5kLicpO1xuICByZXR1cm4gYXdhaXQgc2ltLmxhdW5jaEFuZFF1aXQoc2FmYXJpKTtcbn1cblxuZnVuY3Rpb24gY2hlY2tQcmVmZXJlbmNlcyAoc2V0dGluZ3MsIG9wdHMgPSB7fSkge1xuICBmb3IgKGxldCBzZXR0aW5nIG9mIHNldHRpbmdzKSB7XG4gICAgaWYgKF8uaGFzKG9wdHMsIHNldHRpbmcpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NhbGVBbmRQcmVmZXJlbmNlcyAoc2ltLCBvcHRzLCBzYWZhcmkgPSBmYWxzZSwgc2h1dGRvd25GbiA9IF8ubm9vcCkge1xuICBjb25zdCBsb2NhbENvbmZpZyA9IGF3YWl0IHNldExvY2FsZShzaW0sIG9wdHMsIHt9LCBzYWZhcmkpO1xuICBjb25zdCBwcmVmc1VwZGF0ZWQgPSBhd2FpdCBzZXRQcmVmZXJlbmNlcyhzaW0sIG9wdHMsIHNhZmFyaSk7XG4gIGlmIChsb2NhbENvbmZpZy5fdXBkYXRlZCB8fCBwcmVmc1VwZGF0ZWQpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJVcGRhdGVkIHNldHRpbmdzLiBSZWJvb3RpbmcgdGhlIHNpbXVsYXRvciBpZiBpdCdzIGFscmVhZHkgb3BlblwiKTtcbiAgICBhd2FpdCBzaHV0ZG93bkZuKHNpbSk7XG4gIH1cbiAgZGVsZXRlIGxvY2FsQ29uZmlnLl91cGRhdGVkO1xuICByZXR1cm4gbG9jYWxDb25maWc7XG59XG5cbi8vIHBhc3MgaW4gdGhlIHNpbXVsYXRvciBzbyB0aGF0IG90aGVyIHN5c3RlbXMgdGhhdCB1c2UgdGhlIGZ1bmN0aW9uIGNhbiBzdXBwbHlcbi8vIHdoYXRldmVyIHRoZXkgaGF2ZVxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jYWxlIChzaW0sIG9wdHMsIGxvY2FsZUNvbmZpZyA9IHt9LCBzYWZhcmkgPSBmYWxzZSkge1xuICBpZiAoIW9wdHMubGFuZ3VhZ2UgJiYgIW9wdHMubG9jYWxlICYmICFvcHRzLmNhbGVuZGFyRm9ybWF0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiTm8gcmVhc29uIHRvIHNldCBsb2NhbGVcIik7XG4gICAgcmV0dXJuIHtcbiAgICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgICB9O1xuICB9XG5cbiAgLy8gd2UgbmVlZCB0aGUgc2ltdWxhdG9yIHRvIGhhdmUgaXRzIGRpcmVjdG9yaWVzIGluIHBsYWNlXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHNhZmFyaSk7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ1NldHRpbmcgbG9jYWxlIGluZm9ybWF0aW9uJyk7XG4gIGxvY2FsZUNvbmZpZyA9IHtcbiAgICBsYW5ndWFnZTogb3B0cy5sYW5ndWFnZSB8fCBsb2NhbGVDb25maWcubGFuZ3VhZ2UsXG4gICAgbG9jYWxlOiBvcHRzLmxvY2FsZSB8fCBsb2NhbGVDb25maWcubG9jYWxlLFxuICAgIGNhbGVuZGFyRm9ybWF0OiBvcHRzLmNhbGVuZGFyRm9ybWF0IHx8IGxvY2FsZUNvbmZpZy5jYWxlbmRhckZvcm1hdCxcbiAgICBfdXBkYXRlZDogZmFsc2UsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBsZXQgdXBkYXRlZCA9IGF3YWl0IHNpbS51cGRhdGVMb2NhbGUob3B0cy5sYW5ndWFnZSwgb3B0cy5sb2NhbGUsIG9wdHMuY2FsZW5kYXJGb3JtYXQpO1xuICAgIGlmICh1cGRhdGVkKSB7XG4gICAgICBsb2NhbGVDb25maWcuX3VwZGF0ZWQgPSB0cnVlO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBBcHBpdW0gd2FzIHVuYWJsZSB0byBzZXQgbG9jYWxlIGluZm86ICR7ZX1gKTtcbiAgfVxuXG4gIHJldHVybiBsb2NhbGVDb25maWc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGxldCBuZWVkVG9TZXRQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGxldCBuZWVkVG9TZXRTYWZhcmlQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0FGQVJJX1NFVFRJTkdTX0NBUFMsIG9wdHMpO1xuICBpZiAoIW5lZWRUb1NldFByZWZzICYmICFuZWVkVG9TZXRTYWZhcmlQcmVmcykge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIk5vIGlPUyAvIGFwcCBwcmVmZXJlbmNlcyB0byBzZXRcIik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKFwiU2V0dGluZyBpT1MgYW5kIGFwcCBwcmVmZXJlbmNlc1wiKTtcblxuICBpZiAoYXdhaXQgc2ltLmlzRnJlc2goKSkge1xuICAgIGF3YWl0IGxhdW5jaEFuZFF1aXRTaW11bGF0b3Ioc2ltLCBzYWZhcmkpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBpZiAobmVlZFRvU2V0UHJlZnMpIHtcbiAgICAgIGF3YWl0IHNldExvY1NlcnZpY2VzUHJlZnMoc2ltLCBvcHRzKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBzZXR0aW5nIGxvY2F0aW9uIHNlcnZpY2VzIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrXCIpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgICBhd2FpdCBzZXRTYWZhcmlQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIHNldHRpbmcgc2FmYXJpIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrXCIpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NTZXJ2aWNlc1ByZWZzIChzaW0sIG9wdHMgPSB7fSkge1xuICBsZXQgbG9jU2VydiA9IF8uZmluZChbb3B0cy5sb2NhdGlvblNlcnZpY2VzRW5hYmxlZCwgb3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZF0sIChjKSA9PiB7XG4gICAgcmV0dXJuICFfLmlzVW5kZWZpbmVkKGMpO1xuICB9KTtcbiAgaWYgKCFfLmlzVW5kZWZpbmVkKGxvY1NlcnYpKSB7XG4gICAgbG9jU2VydiA9IGxvY1NlcnYgPyAxIDogMDtcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgbG9jYXRpb24gc2VydmljZXMgdG8gJHtsb2NTZXJ2fWApO1xuICAgIGF3YWl0IHNpbS51cGRhdGVTZXR0aW5ncygnbG9jYXRpb25TZXJ2aWNlcycsIHtcbiAgICAgIExvY2F0aW9uU2VydmljZXNFbmFibGVkOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW43LjAnOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW44LjAnOiBsb2NTZXJ2XG4gICAgfSk7XG4gIH1cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQpKSB7XG4gICAgaWYgKCFvcHRzLmJ1bmRsZUlkKSB7XG4gICAgICBsZXQgbXNnID0gXCJDYW4ndCBzZXQgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCB3aXRob3V0IGJ1bmRsZSBJRFwiO1xuICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICB9XG4gICAgbGV0IGxvY0F1dGggPSAhIW9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQ7XG4gICAgaWYgKGxvY0F1dGgpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIkF1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHBcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIkRlLWF1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHBcIik7XG4gICAgfVxuICAgIGF3YWl0IHNpbS51cGRhdGVMb2NhdGlvblNldHRpbmdzKG9wdHMuYnVuZGxlSWQsIGxvY0F1dGgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFNhZmFyaVByZWZzIChzaW0sIG9wdHMgPSB7fSkge1xuICBsZXQgc2FmYXJpU2V0dGluZ3MgPSB7fTtcblxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaUFsbG93UG9wdXBzJykpIHtcbiAgICBsZXQgdmFsID0gISFvcHRzLnNhZmFyaUFsbG93UG9wdXBzO1xuICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBqYXZhc2NyaXB0IHdpbmRvdyBvcGVuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgICBzYWZhcmlTZXR0aW5ncy5KYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nJykpIHtcbiAgICBsZXQgdmFsID0gIW9wdHMuc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nO1xuICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBmcmF1ZHVsZW50IHdlYnNpdGUgd2FybmluZyB0byAnJHt2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLldhcm5BYm91dEZyYXVkdWxlbnRXZWJzaXRlcyA9IHZhbDtcbiAgfVxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCcpKSB7XG4gICAgbGV0IHZhbCA9IG9wdHMuc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID8gMSA6IDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIG9wZW5pbmcgbGlua3MgaW4gYmFja2dyb3VuZCB0byAnJHshIXZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID0gdmFsO1xuICB9XG4gIGlmIChfLnNpemUoc2FmYXJpU2V0dGluZ3MpID4gMCkge1xuICAgIGF3YWl0IHNpbS51cGRhdGVTYWZhcmlTZXR0aW5ncyhzYWZhcmlTZXR0aW5ncyk7XG4gIH1cbn1cblxuZXhwb3J0IHsgc2V0TG9jYWxlLCBzZXRQcmVmZXJlbmNlcywgc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
