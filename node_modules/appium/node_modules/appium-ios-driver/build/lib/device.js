'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumIosSimulator = require('appium-ios-simulator');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

function checkSimulatorAvailable(opts, sdkVersion, availableDevices) {
  var dString, noDevicesError, sim;
  return _regeneratorRuntime.async(function checkSimulatorAvailable$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(sdkVersion < 7.1)) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].debug('Instruments v < 7.1, not checking device string support');
        return context$1$0.abrupt('return');

      case 3:

        _logger2['default'].debug('Checking whether our device string is supported');

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(getAdjustedDeviceName(opts));

      case 6:
        dString = context$1$0.sent;

        noDevicesError = function noDevicesError() {
          var msg = 'Could not find a device to launch. You requested ' + ('\'' + dString + '\', but the available devices were: ') + JSON.stringify(availableDevices);
          _logger2['default'].errorAndThrow(msg);
        };

        if (!(sdkVersion >= 8)) {
          context$1$0.next = 15;
          break;
        }

        sim = _utils2['default'].getSimForDeviceString(dString, availableDevices);

        if (sim[0] === null || sim[1] === null) {
          noDevicesError();
        }
        _logger2['default'].debug('iOS sim UDID is ' + sim[1]);
        return context$1$0.abrupt('return', sim[1]);

      case 15:
        if (!_lodash2['default'].includes(availableDevices, dString)) {
          noDevicesError();
        }

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getAdjustedDeviceName(opts) {
  return _regeneratorRuntime.async(function getAdjustedDeviceName$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.t0 = opts._adjustedDeviceName;

        if (context$1$0.t0) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.getDeviceString)(opts));

      case 4:
        context$1$0.t0 = context$1$0.sent;

      case 5:
        opts._adjustedDeviceName = context$1$0.t0;
        return context$1$0.abrupt('return', opts._adjustedDeviceName);

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

// TODO: what to do with this?
function moveBuiltInApp() {
  return _regeneratorRuntime.async(function moveBuiltInApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/*sim*/
// call sim function once it is in place
function runSimulatorReset(sim, opts, keepApp) {
  return _regeneratorRuntime.async(function runSimulatorReset$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!opts.reset && !opts.fullReset)) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].debug('Reset not set, not ending sim');
        return context$1$0.abrupt('return');

      case 3:

        _logger2['default'].debug('Running ios sim reset flow');

        // The simulator process must be ended before we delete applications.
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(endSimulator(sim));

      case 6:
        if (!opts.fullReset) {
          context$1$0.next = 12;
          break;
        }

        _logger2['default'].debug('Full reset is on, so erasing simulator');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(fullResetSimulator(sim));

      case 10:
        context$1$0.next = 15;
        break;

      case 12:
        if (!opts.reset) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(resetSimulator(sim, opts, keepApp));

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fullResetSimulator(sim) {
  return _regeneratorRuntime.async(function fullResetSimulator$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Cleaning the simulator');

        if (!sim) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(sim.clean());

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function resetSimulator(sim, opts, keepApp) {
  return _regeneratorRuntime.async(function resetSimulator$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (sim) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return');

      case 2:
        // eslint-disable-line curly

        _logger2['default'].debug('Cleaning sim state.');
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(clearAppData(sim, opts, keepApp));

      case 6:
        context$1$0.next = 12;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](3);

        _logger2['default'].warn(context$1$0.t0);
        _logger2['default'].warn("Could not reset simulator. Leaving as is.");

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 8]]);
}

function endSimulator(sim) {
  return _regeneratorRuntime.async(function endSimulator$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (sim) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return');

      case 2:
        // eslint-disable-line curly

        _logger2['default'].debug('Killing the simulator');
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(sim.shutdown());

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function isolateSimulatorDevice(sim, opts, sdkVersion) {
  return _regeneratorRuntime.async(function isolateSimulatorDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(opts.isolateSimDevice && sdkVersion >= 8)) {
          context$1$0.next = 3;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(sim.isolateSim());

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function clearAppData(sim, opts, keepApp) {
  return _regeneratorRuntime.async(function clearAppData$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!keepApp && opts.app && opts.bundleId)) {
          context$1$0.next = 3;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(sim.cleanCustomApp(_path2['default'].basename(opts.app), opts.bundleId));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function resetRealDevice(device, opts) {
  var bundleId;
  return _regeneratorRuntime.async(function resetRealDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(opts.bundleId && opts.fullReset)) {
          context$1$0.next = 18;
          break;
        }

        bundleId = opts.bundleId;

        _logger2['default'].debug('Full reset requested. Will try to uninstall the app \'' + bundleId + '\'.');
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(device.isInstalled(bundleId));

      case 5:
        if (context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].debug('App not installed. No need to uninstall');
        return context$1$0.abrupt('return');

      case 8:
        context$1$0.prev = 8;
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(device.remove(bundleId));

      case 11:
        context$1$0.next = 17;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](8);

        _logger2['default'].error('Could not remove \'' + bundleId + '\' from device');
        throw context$1$0.t0;

      case 17:
        _logger2['default'].debug('Removed ' + bundleId);

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 13]]);
}

function runRealDeviceReset(device, opts) {
  return _regeneratorRuntime.async(function runRealDeviceReset$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(opts.reset || opts.fullReset)) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].debug("Running ios real device reset flow");

        if (!opts.reset) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(resetRealDevice(device, opts));

      case 5:
        context$1$0.next = 8;
        break;

      case 7:
        _logger2['default'].debug("Reset not set, continuing");

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.runSimulatorReset = runSimulatorReset;
exports.isolateSimulatorDevice = isolateSimulatorDevice;
exports.checkSimulatorAvailable = checkSimulatorAvailable;
exports.moveBuiltInApp = moveBuiltInApp;
exports.getAdjustedDeviceName = getAdjustedDeviceName;
exports.endSimulator = endSimulator;
exports.runRealDeviceReset = runRealDeviceReset;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUM7Ozs7QUFHN0QsNEJBQU8sS0FBSyxjQUFZLFFBQVEsQ0FBRyxDQUFDOzs7Ozs7O0NBRXZDOztBQUVELFNBQWUsa0JBQWtCLENBQUUsTUFBTSxFQUFFLElBQUk7Ozs7Y0FDekMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFBOzs7OztBQUM5Qiw0QkFBTyxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQzs7YUFDL0MsSUFBSSxDQUFDLEtBQUs7Ozs7Ozt5Q0FDTixlQUFlLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQzs7Ozs7OztBQUdyQyw0QkFBTyxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQzs7Ozs7OztDQUU3Qzs7UUFHUSxpQkFBaUIsR0FBakIsaUJBQWlCO1FBQUUsc0JBQXNCLEdBQXRCLHNCQUFzQjtRQUFFLHVCQUF1QixHQUF2Qix1QkFBdUI7UUFDbEUsY0FBYyxHQUFkLGNBQWM7UUFBRSxxQkFBcUIsR0FBckIscUJBQXFCO1FBQUUsWUFBWSxHQUFaLFlBQVk7UUFBRSxrQkFBa0IsR0FBbEIsa0JBQWtCIiwiZmlsZSI6ImxpYi9kZXZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZ2V0RGV2aWNlU3RyaW5nIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdXRpbHMgZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcblxuXG5hc3luYyBmdW5jdGlvbiBjaGVja1NpbXVsYXRvckF2YWlsYWJsZSAob3B0cywgc2RrVmVyc2lvbiwgYXZhaWxhYmxlRGV2aWNlcykge1xuICBpZiAoc2RrVmVyc2lvbiA8IDcuMSkge1xuICAgIGxvZ2dlci5kZWJ1ZygnSW5zdHJ1bWVudHMgdiA8IDcuMSwgbm90IGNoZWNraW5nIGRldmljZSBzdHJpbmcgc3VwcG9ydCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnQ2hlY2tpbmcgd2hldGhlciBvdXIgZGV2aWNlIHN0cmluZyBpcyBzdXBwb3J0ZWQnKTtcblxuICBsZXQgZFN0cmluZyA9IGF3YWl0IGdldEFkanVzdGVkRGV2aWNlTmFtZShvcHRzKTtcbiAgbGV0IG5vRGV2aWNlc0Vycm9yID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBtc2cgPSBgQ291bGQgbm90IGZpbmQgYSBkZXZpY2UgdG8gbGF1bmNoLiBZb3UgcmVxdWVzdGVkIGAgK1xuICAgICAgICAgICAgICBgJyR7ZFN0cmluZ30nLCBidXQgdGhlIGF2YWlsYWJsZSBkZXZpY2VzIHdlcmU6IGAgK1xuICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShhdmFpbGFibGVEZXZpY2VzKTtcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICB9O1xuICBpZiAoc2RrVmVyc2lvbiA+PSA4KSB7XG4gICAgbGV0IHNpbSA9IHV0aWxzLmdldFNpbUZvckRldmljZVN0cmluZyhkU3RyaW5nLCBhdmFpbGFibGVEZXZpY2VzKTtcbiAgICBpZiAoc2ltWzBdID09PSBudWxsIHx8IHNpbVsxXSA9PT0gbnVsbCkge1xuICAgICAgbm9EZXZpY2VzRXJyb3IoKTtcbiAgICB9XG4gICAgbG9nZ2VyLmRlYnVnKGBpT1Mgc2ltIFVESUQgaXMgJHtzaW1bMV19YCk7XG4gICAgcmV0dXJuIHNpbVsxXTtcbiAgfSBlbHNlIGlmICghXy5pbmNsdWRlcyhhdmFpbGFibGVEZXZpY2VzLCBkU3RyaW5nKSkge1xuICAgIG5vRGV2aWNlc0Vycm9yKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QWRqdXN0ZWREZXZpY2VOYW1lIChvcHRzKSB7XG4gIG9wdHMuX2FkanVzdGVkRGV2aWNlTmFtZSA9IG9wdHMuX2FkanVzdGVkRGV2aWNlTmFtZSB8fCBhd2FpdCBnZXREZXZpY2VTdHJpbmcob3B0cyk7XG4gIHJldHVybiBvcHRzLl9hZGp1c3RlZERldmljZU5hbWU7XG59XG5cbi8vIFRPRE86IHdoYXQgdG8gZG8gd2l0aCB0aGlzP1xuYXN5bmMgZnVuY3Rpb24gbW92ZUJ1aWx0SW5BcHAgKC8qc2ltKi8pIHtcbiAgLy8gY2FsbCBzaW0gZnVuY3Rpb24gb25jZSBpdCBpcyBpbiBwbGFjZVxufVxuXG5hc3luYyBmdW5jdGlvbiBydW5TaW11bGF0b3JSZXNldCAoc2ltLCBvcHRzLCBrZWVwQXBwKSB7XG4gIGlmICghb3B0cy5yZXNldCAmJiAhb3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1Jlc2V0IG5vdCBzZXQsIG5vdCBlbmRpbmcgc2ltJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKCdSdW5uaW5nIGlvcyBzaW0gcmVzZXQgZmxvdycpO1xuXG4gIC8vIFRoZSBzaW11bGF0b3IgcHJvY2VzcyBtdXN0IGJlIGVuZGVkIGJlZm9yZSB3ZSBkZWxldGUgYXBwbGljYXRpb25zLlxuICBhd2FpdCBlbmRTaW11bGF0b3Ioc2ltKTtcblxuICBpZiAob3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0Z1bGwgcmVzZXQgaXMgb24sIHNvIGVyYXNpbmcgc2ltdWxhdG9yJyk7XG4gICAgYXdhaXQgZnVsbFJlc2V0U2ltdWxhdG9yKHNpbSk7XG4gIH0gZWxzZSBpZiAob3B0cy5yZXNldCkge1xuICAgIGF3YWl0IHJlc2V0U2ltdWxhdG9yKHNpbSwgb3B0cywga2VlcEFwcCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZnVsbFJlc2V0U2ltdWxhdG9yIChzaW0pIHtcbiAgbG9nZ2VyLmRlYnVnKCdDbGVhbmluZyB0aGUgc2ltdWxhdG9yJyk7XG4gIGlmIChzaW0pIHtcbiAgICBhd2FpdCBzaW0uY2xlYW4oKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiByZXNldFNpbXVsYXRvciAoc2ltLCBvcHRzLCBrZWVwQXBwKSB7XG4gIGlmICghc2ltKSByZXR1cm47IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICBsb2dnZXIuZGVidWcoJ0NsZWFuaW5nIHNpbSBzdGF0ZS4nKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBjbGVhckFwcERhdGEoc2ltLCBvcHRzLCBrZWVwQXBwKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLndhcm4oZXJyKTtcbiAgICBsb2dnZXIud2FybihcIkNvdWxkIG5vdCByZXNldCBzaW11bGF0b3IuIExlYXZpbmcgYXMgaXMuXCIpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGVuZFNpbXVsYXRvciAoc2ltKSB7XG4gIGlmICghc2ltKSByZXR1cm47IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICBsb2dnZXIuZGVidWcoJ0tpbGxpbmcgdGhlIHNpbXVsYXRvcicpO1xuICBhd2FpdCBzaW0uc2h1dGRvd24oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaXNvbGF0ZVNpbXVsYXRvckRldmljZSAoc2ltLCBvcHRzLCBzZGtWZXJzaW9uKSB7XG4gIGlmIChvcHRzLmlzb2xhdGVTaW1EZXZpY2UgJiYgc2RrVmVyc2lvbiA+PSA4KSB7XG4gICAgYXdhaXQgc2ltLmlzb2xhdGVTaW0oKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjbGVhckFwcERhdGEgIChzaW0sIG9wdHMsIGtlZXBBcHApIHtcbiAgaWYgKCFrZWVwQXBwICYmIG9wdHMuYXBwICYmIG9wdHMuYnVuZGxlSWQpIHtcbiAgICBhd2FpdCBzaW0uY2xlYW5DdXN0b21BcHAocGF0aC5iYXNlbmFtZShvcHRzLmFwcCksIG9wdHMuYnVuZGxlSWQpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlc2V0UmVhbERldmljZSAoZGV2aWNlLCBvcHRzKSB7XG4gIGlmIChvcHRzLmJ1bmRsZUlkICYmIG9wdHMuZnVsbFJlc2V0KSB7XG4gICAgbGV0IGJ1bmRsZUlkID0gb3B0cy5idW5kbGVJZDtcbiAgICBsb2dnZXIuZGVidWcoYEZ1bGwgcmVzZXQgcmVxdWVzdGVkLiBXaWxsIHRyeSB0byB1bmluc3RhbGwgdGhlIGFwcCAnJHtidW5kbGVJZH0nLmApO1xuICAgIGlmICghYXdhaXQgZGV2aWNlLmlzSW5zdGFsbGVkKGJ1bmRsZUlkKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdBcHAgbm90IGluc3RhbGxlZC4gTm8gbmVlZCB0byB1bmluc3RhbGwnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGRldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBDb3VsZCBub3QgcmVtb3ZlICcke2J1bmRsZUlkfScgZnJvbSBkZXZpY2VgKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gICAgbG9nZ2VyLmRlYnVnKGBSZW1vdmVkICR7YnVuZGxlSWR9YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuUmVhbERldmljZVJlc2V0IChkZXZpY2UsIG9wdHMpIHtcbiAgaWYgKG9wdHMucmVzZXQgfHwgb3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJSdW5uaW5nIGlvcyByZWFsIGRldmljZSByZXNldCBmbG93XCIpO1xuICAgIGlmIChvcHRzLnJlc2V0KSB7XG4gICAgICBhd2FpdCByZXNldFJlYWxEZXZpY2UoZGV2aWNlLCBvcHRzKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiUmVzZXQgbm90IHNldCwgY29udGludWluZ1wiKTtcbiAgfVxufVxuXG5cbmV4cG9ydCB7IHJ1blNpbXVsYXRvclJlc2V0LCBpc29sYXRlU2ltdWxhdG9yRGV2aWNlLCBjaGVja1NpbXVsYXRvckF2YWlsYWJsZSxcbiAgICAgICAgIG1vdmVCdWlsdEluQXBwLCBnZXRBZGp1c3RlZERldmljZU5hbWUsIGVuZFNpbXVsYXRvciwgcnVuUmVhbERldmljZVJlc2V0IH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
