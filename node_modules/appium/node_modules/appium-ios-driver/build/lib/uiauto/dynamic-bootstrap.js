// Generate a bootstrap for the UIAuto Instruments script containing
// the environment variables we need.

'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _appiumSupport = require('appium-support');

var _buildScript = require('./build-script');

var _buildScript2 = _interopRequireDefault(_buildScript);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _uiautoClient = require('./uiauto-client');

var BOOTSTRAP_JS_PATH = _path2['default'].resolve(__dirname, '..', '..', '..', 'uiauto', 'bootstrap.js');
var COMMAND_PROXY_CLIENT_PATH = _path2['default'].resolve(__dirname, 'bin', 'command-proxy-client.js');
if (!__dirname.match(/build\/lib\/uiauto$/)) {
  BOOTSTRAP_JS_PATH = _path2['default'].resolve(__dirname, '..', 'uiauto', 'bootstrap.js');
  COMMAND_PROXY_CLIENT_PATH = _path2['default'].resolve(__dirname, 'bin', 'command-proxy-client.js');
}

function getEnv() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  // build an object with the required properties for bootstrap
  return {
    nodePath: process.execPath,
    commandProxyClientPath: COMMAND_PROXY_CLIENT_PATH,
    instrumentsSock: opts.sock || _uiautoClient.DEFAULT_INSTRUMENTS_SOCKET,
    interKeyDelay: opts.interKeyDelay || null,
    justLoopInfinitely: opts.justLoopInfinitely,
    autoAcceptAlerts: opts.autoAcceptAlerts,
    autoDismissAlerts: opts.autoDismissAlerts,
    sendKeyStrategy: opts.sendKeyStrategy,
    initialLocation: opts.initialLocation
  };
}

function buildCode(opts) {
  var env, bootstrapJs, imports, bootstrapCode, lines, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, key, value, quote;

  return _regeneratorRuntime.async(function buildCode$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!opts.code) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return', opts.code);

      case 2:
        env = getEnv(opts);

        _logger2['default'].debug('Dynamic env: ' + JSON.stringify(env));

        bootstrapJs = BOOTSTRAP_JS_PATH;
        imports = opts.imports && opts.imports.pre ? opts.imports.pre : [];
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap((0, _buildScript2['default'])(bootstrapJs, imports));

      case 8:
        bootstrapCode = context$1$0.sent;
        lines = [];

        lines.push('// This file is automatically generated. Do not manually modify!');
        lines.push('');
        lines.push(bootstrapCode);
        lines.push('');
        lines.push('bootstrap({');
        // add each defined variable to the environment
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 18;
        for (_iterator = _getIterator(_lodash2['default'].toPairs(env)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          key = _step$value[0];
          value = _step$value[1];

          if (!_lodash2['default'].isUndefined(value)) {
            quote = _lodash2['default'].isString(value) ? '\"' : '';

            lines.push('  "' + key + '": ' + quote + value + quote + ',');
          }
        }
        // get rid of the last comma that was added
        context$1$0.next = 26;
        break;

      case 22:
        context$1$0.prev = 22;
        context$1$0.t0 = context$1$0['catch'](18);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 26:
        context$1$0.prev = 26;
        context$1$0.prev = 27;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 29:
        context$1$0.prev = 29;

        if (!_didIteratorError) {
          context$1$0.next = 32;
          break;
        }

        throw _iteratorError;

      case 32:
        return context$1$0.finish(29);

      case 33:
        return context$1$0.finish(26);

      case 34:
        lines[lines.length - 1] = lines[lines.length - 1].replace(/,$/, '');
        lines.push('});');
        return context$1$0.abrupt('return', lines.join('\r\n'));

      case 37:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[18, 22, 26, 34], [27,, 29, 33]]);
}

function computeHash(code) {
  return _crypto2['default'].createHash('md5').update(code).digest('hex').substring(0, 16);
}

function getDynamicBootstrapDir() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  // figuring out where to store dynamic bootstrap
  var dynamicBootstrapDir = undefined;
  if (process.env.APPIUM_BOOTSTRAP_DIR) {
    // mainly for test
    dynamicBootstrapDir = process.env.APPIUM_BOOTSTRAP_DIR;
  } else if (process.env.HOME) {
    dynamicBootstrapDir = _path2['default'].resolve(process.env.HOME, 'Library/Application Support/appium/bootstrap');
  } else {
    // no user dir, using tmp
    dynamicBootstrapDir = _path2['default'].resolve(opts.tmpDir || '/tmp', 'appium/bootstrap');
  }
  return dynamicBootstrapDir;
}

function writeDynamicBootstrapIfNecessary(dynamicBootstrapDir, dynamicBootstrapPath, code, hash) {
  var codeIsGood, existingCode;
  return _regeneratorRuntime.async(function writeDynamicBootstrapIfNecessary$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(dynamicBootstrapDir));

      case 2:
        codeIsGood = true;
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(dynamicBootstrapPath));

      case 6:
        existingCode = context$1$0.sent;

        codeIsGood = computeHash(existingCode) === hash;
        context$1$0.next = 13;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](3);

        codeIsGood = false;

      case 13:
        if (!codeIsGood) {
          context$1$0.next = 17;
          break;
        }

        _logger2['default'].debug('Reusing dynamic bootstrap: ' + dynamicBootstrapPath);
        context$1$0.next = 20;
        break;

      case 17:
        _logger2['default'].debug('Creating or overwriting dynamic bootstrap: ' + dynamicBootstrapPath);
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(dynamicBootstrapPath, code, { flag: 'w+' }));

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 10]]);
}

function prepareBootstrap() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var dynamicBootstrapDir, code, hash, dynamicBootstrapPath;
  return _regeneratorRuntime.async(function prepareBootstrap$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Preparing bootstrap code');

        dynamicBootstrapDir = getDynamicBootstrapDir(opts);

        _logger2['default'].debug('Dynamic bootstrap dir: ' + dynamicBootstrapDir);

        // building code and hash
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(buildCode(opts));

      case 5:
        code = context$1$0.sent;
        hash = computeHash(code);
        dynamicBootstrapPath = _path2['default'].resolve(dynamicBootstrapDir, 'bootstrap-' + hash + '.js');

        _logger2['default'].debug('Dynamic bootstrap code: ' + code.split('\n')[0] + '...');
        _logger2['default'].debug('Dynamic bootstrap path: ' + dynamicBootstrapPath);
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(writeDynamicBootstrapIfNecessary(dynamicBootstrapDir, dynamicBootstrapPath, code, hash));

      case 12:
        return context$1$0.abrupt('return', dynamicBootstrapPath);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.prepareBootstrap = prepareBootstrap;
exports.getEnv = getEnv;

// only build the code if it hasn't been done before

// if special imports were sent in, make use of them

// generate the dynamic part of the bootstrap code
// with the environment set up properly

// check if there is existing code and it has the same hash

// write file if the old code is not the same
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG8vZHluYW1pYy1ib290c3RyYXAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBR2lCLE1BQU07Ozs7c0JBQ1QsUUFBUTs7OztzQkFDSCxRQUFROzs7OzZCQUNBLGdCQUFnQjs7MkJBQ25CLGdCQUFnQjs7OztzQkFDckIsVUFBVTs7Ozs0QkFDYyxpQkFBaUI7O0FBRzVELElBQUksaUJBQWlCLEdBQUcsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7QUFDNUYsSUFBSSx5QkFBeUIsR0FBRyxrQkFBSyxPQUFPLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO0FBQzFGLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLEVBQUU7QUFDM0MsbUJBQWlCLEdBQUcsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQzVFLDJCQUF5QixHQUFHLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLHlCQUF5QixDQUFDLENBQUM7Q0FDdkY7O0FBRUQsU0FBUyxNQUFNLEdBQWE7TUFBWCxJQUFJLHlEQUFHLEVBQUU7OztBQUV4QixTQUFPO0FBQ0wsWUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRO0FBQzFCLDBCQUFzQixFQUFFLHlCQUF5QjtBQUNqRCxtQkFBZSxFQUFFLElBQUksQ0FBQyxJQUFJLDRDQUE4QjtBQUN4RCxpQkFBYSxFQUFFLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSTtBQUN6QyxzQkFBa0IsRUFBRSxJQUFJLENBQUMsa0JBQWtCO0FBQzNDLG9CQUFnQixFQUFFLElBQUksQ0FBQyxnQkFBZ0I7QUFDdkMscUJBQWlCLEVBQUUsSUFBSSxDQUFDLGlCQUFpQjtBQUN6QyxtQkFBZSxF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QyxDQUFDLENBQUMsQ0FBQyxTQUFNLENBQUM7QUFDbEUsNEJBQU8sS0FBSyw4QkFBNEIsb0JBQW9CLENBQUcsQ0FBQzs7eUNBQzFELGdDQUFnQyxDQUFDLG1CQUFtQixFQUN4RCxvQkFBb0IsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDOzs7NENBRTVCLG9CQUFvQjs7Ozs7OztDQUM1Qjs7UUFFUSxnQkFBZ0IsR0FBaEIsZ0JBQWdCO1FBQUUsTUFBTSxHQUFOLE1BQU0iLCJmaWxlIjoibGliL3VpYXV0by9keW5hbWljLWJvb3RzdHJhcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEdlbmVyYXRlIGEgYm9vdHN0cmFwIGZvciB0aGUgVUlBdXRvIEluc3RydW1lbnRzIHNjcmlwdCBjb250YWluaW5nXG4vLyB0aGUgZW52aXJvbm1lbnQgdmFyaWFibGVzIHdlIG5lZWQuXG5cbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCB7IGZzLCBta2RpcnAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgYnVpbGRTY3JpcHQgZnJvbSAnLi9idWlsZC1zY3JpcHQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBERUZBVUxUX0lOU1RSVU1FTlRTX1NPQ0tFVCB9IGZyb20gJy4vdWlhdXRvLWNsaWVudCc7XG5cblxubGV0IEJPT1RTVFJBUF9KU19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ3VpYXV0bycsICdib290c3RyYXAuanMnKTtcbmxldCBDT01NQU5EX1BST1hZX0NMSUVOVF9QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2JpbicsICdjb21tYW5kLXByb3h5LWNsaWVudC5qcycpO1xuaWYgKCFfX2Rpcm5hbWUubWF0Y2goL2J1aWxkXFwvbGliXFwvdWlhdXRvJC8pKSB7XG4gIEJPT1RTVFJBUF9KU19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ3VpYXV0bycsICdib290c3RyYXAuanMnKTtcbiAgQ09NTUFORF9QUk9YWV9DTElFTlRfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdiaW4nLCAnY29tbWFuZC1wcm94eS1jbGllbnQuanMnKTtcbn1cblxuZnVuY3Rpb24gZ2V0RW52IChvcHRzID0ge30pIHtcbiAgLy8gYnVpbGQgYW4gb2JqZWN0IHdpdGggdGhlIHJlcXVpcmVkIHByb3BlcnRpZXMgZm9yIGJvb3RzdHJhcFxuICByZXR1cm4ge1xuICAgIG5vZGVQYXRoOiBwcm9jZXNzLmV4ZWNQYXRoLFxuICAgIGNvbW1hbmRQcm94eUNsaWVudFBhdGg6IENPTU1BTkRfUFJPWFlfQ0xJRU5UX1BBVEgsXG4gICAgaW5zdHJ1bWVudHNTb2NrOiBvcHRzLnNvY2sgfHwgREVGQVVMVF9JTlNUUlVNRU5UU19TT0NLRVQsXG4gICAgaW50ZXJLZXlEZWxheTogb3B0cy5pbnRlcktleURlbGF5IHx8IG51bGwsXG4gICAganVzdExvb3BJbmZpbml0ZWx5OiBvcHRzLmp1c3RMb29wSW5maW5pdGVseSxcbiAgICBhdXRvQWNjZXB0QWxlcnRzOiBvcHRzLmF1dG9BY2NlcHRBbGVydHMsXG4gICAgYXV0b0Rpc21pc3NBbGVydHM6IG9wdHMuYXV0b0Rpc21pc3NBbGVydHMsXG4gICAgc2VuZEtleVN0cmF0ZWd5OiBvcHRzLnNlbmRLZXlTdHJhdGVneSxcbiAgICBpbml0aWFsTG9jYXRpb246IG9wdHMuaW5pdGlhbExvY2F0aW9uLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBidWlsZENvZGUgKG9wdHMpIHtcbiAgLy8gb25seSBidWlsZCB0aGUgY29kZSBpZiBpdCBoYXNuJ3QgYmVlbiBkb25lIGJlZm9yZVxuICBpZiAob3B0cy5jb2RlKSByZXR1cm4gb3B0cy5jb2RlO1xuXG4gIGxldCBlbnYgPSBnZXRFbnYob3B0cyk7XG4gIGxvZ2dlci5kZWJ1ZyhgRHluYW1pYyBlbnY6ICR7SlNPTi5zdHJpbmdpZnkoZW52KX1gKTtcblxuICBsZXQgYm9vdHN0cmFwSnMgPSBCT09UU1RSQVBfSlNfUEFUSDtcbiAgLy8gaWYgc3BlY2lhbCBpbXBvcnRzIHdlcmUgc2VudCBpbiwgbWFrZSB1c2Ugb2YgdGhlbVxuICBsZXQgaW1wb3J0cyA9IChvcHRzLmltcG9ydHMgJiYgb3B0cy5pbXBvcnRzLnByZSkgPyBvcHRzLmltcG9ydHMucHJlIDogW107XG4gIGxldCBib290c3RyYXBDb2RlID0gYXdhaXQgYnVpbGRTY3JpcHQoYm9vdHN0cmFwSnMsIGltcG9ydHMpO1xuXG4gIC8vIGdlbmVyYXRlIHRoZSBkeW5hbWljIHBhcnQgb2YgdGhlIGJvb3RzdHJhcCBjb2RlXG4gIC8vIHdpdGggdGhlIGVudmlyb25tZW50IHNldCB1cCBwcm9wZXJseVxuICBsZXQgbGluZXMgPSBbXTtcbiAgbGluZXMucHVzaCgnLy8gVGhpcyBmaWxlIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkLiBEbyBub3QgbWFudWFsbHkgbW9kaWZ5IScpO1xuICBsaW5lcy5wdXNoKCcnKTtcbiAgbGluZXMucHVzaChib290c3RyYXBDb2RlKTtcbiAgbGluZXMucHVzaCgnJyk7XG4gIGxpbmVzLnB1c2goJ2Jvb3RzdHJhcCh7Jyk7XG4gIC8vIGFkZCBlYWNoIGRlZmluZWQgdmFyaWFibGUgdG8gdGhlIGVudmlyb25tZW50XG4gIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoZW52KSkge1xuICAgIGlmICghXy5pc1VuZGVmaW5lZCh2YWx1ZSkpIHtcbiAgICAgIGxldCBxdW90ZSA9IF8uaXNTdHJpbmcodmFsdWUpID8gJ1xcXCInIDogJyc7XG4gICAgICBsaW5lcy5wdXNoKGAgIFwiJHtrZXl9XCI6ICR7cXVvdGV9JHt2YWx1ZX0ke3F1b3RlfSxgKTtcbiAgICB9XG4gIH1cbiAgLy8gZ2V0IHJpZCBvZiB0aGUgbGFzdCBjb21tYSB0aGF0IHdhcyBhZGRlZFxuICBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXSA9IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLnJlcGxhY2UoLywkLywgJycpO1xuICBsaW5lcy5wdXNoKCd9KTsnKTtcbiAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcclxcbicpO1xufVxuXG5mdW5jdGlvbiBjb21wdXRlSGFzaCAoY29kZSkge1xuICByZXR1cm4gY3J5cHRvXG4gICAgLmNyZWF0ZUhhc2goJ21kNScpXG4gICAgLnVwZGF0ZShjb2RlKVxuICAgIC5kaWdlc3QoJ2hleCcpXG4gICAgLnN1YnN0cmluZygwLCAxNik7XG59XG5cbmZ1bmN0aW9uIGdldER5bmFtaWNCb290c3RyYXBEaXIgKG9wdHMgPSB7fSkge1xuICAvLyBmaWd1cmluZyBvdXQgd2hlcmUgdG8gc3RvcmUgZHluYW1pYyBib290c3RyYXBcbiAgbGV0IGR5bmFtaWNCb290c3RyYXBEaXI7XG4gIGlmIChwcm9jZXNzLmVudi5BUFBJVU1fQk9PVFNUUkFQX0RJUikge1xuICAgIC8vIG1haW5seSBmb3IgdGVzdFxuICAgIGR5bmFtaWNCb290c3RyYXBEaXIgPSBwcm9jZXNzLmVudi5BUFBJVU1fQk9PVFNUUkFQX0RJUjtcbiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5IT01FKSB7XG4gICAgZHluYW1pY0Jvb3RzdHJhcERpciA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmVudi5IT01FLFxuICAgICAgJ0xpYnJhcnkvQXBwbGljYXRpb24gU3VwcG9ydC9hcHBpdW0vYm9vdHN0cmFwJyk7XG4gIH0gZWxzZSB7XG4gICAgLy8gbm8gdXNlciBkaXIsIHVzaW5nIHRtcFxuICAgIGR5bmFtaWNCb290c3RyYXBEaXIgPSBwYXRoLnJlc29sdmUob3B0cy50bXBEaXIgfHwgJy90bXAnLCAnYXBwaXVtL2Jvb3RzdHJhcCcpO1xuICB9XG4gIHJldHVybiBkeW5hbWljQm9vdHN0cmFwRGlyO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3cml0ZUR5bmFtaWNCb290c3RyYXBJZk5lY2Vzc2FyeSAoZHluYW1pY0Jvb3RzdHJhcERpciwgZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIGhhc2gpIHtcbiAgYXdhaXQgbWtkaXJwKGR5bmFtaWNCb290c3RyYXBEaXIpO1xuXG4gIC8vIGNoZWNrIGlmIHRoZXJlIGlzIGV4aXN0aW5nIGNvZGUgYW5kIGl0IGhhcyB0aGUgc2FtZSBoYXNoXG4gIGxldCBjb2RlSXNHb29kID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBsZXQgZXhpc3RpbmdDb2RlID0gYXdhaXQgZnMucmVhZEZpbGUoZHluYW1pY0Jvb3RzdHJhcFBhdGgpO1xuICAgIGNvZGVJc0dvb2QgPSBjb21wdXRlSGFzaChleGlzdGluZ0NvZGUpID09PSBoYXNoO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb2RlSXNHb29kID0gZmFsc2U7XG4gIH1cblxuICAvLyB3cml0ZSBmaWxlIGlmIHRoZSBvbGQgY29kZSBpcyBub3QgdGhlIHNhbWVcbiAgaWYgKGNvZGVJc0dvb2QpIHtcbiAgICBsb2dnZXIuZGVidWcoYFJldXNpbmcgZHluYW1pYyBib290c3RyYXA6ICR7ZHluYW1pY0Jvb3RzdHJhcFBhdGh9YCk7XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBDcmVhdGluZyBvciBvdmVyd3JpdGluZyBkeW5hbWljIGJvb3RzdHJhcDogJHtkeW5hbWljQm9vdHN0cmFwUGF0aH1gKTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIHtmbGFnOiAndysnfSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUJvb3RzdHJhcCAob3B0cyA9IHt9KSB7XG4gIGxvZ2dlci5kZWJ1ZygnUHJlcGFyaW5nIGJvb3RzdHJhcCBjb2RlJyk7XG5cbiAgbGV0IGR5bmFtaWNCb290c3RyYXBEaXIgPSBnZXREeW5hbWljQm9vdHN0cmFwRGlyKG9wdHMpO1xuICBsb2dnZXIuZGVidWcoYER5bmFtaWMgYm9vdHN0cmFwIGRpcjogJHtkeW5hbWljQm9vdHN0cmFwRGlyfWApO1xuXG4gIC8vIGJ1aWxkaW5nIGNvZGUgYW5kIGhhc2hcbiAgbGV0IGNvZGUgPSBhd2FpdCBidWlsZENvZGUob3B0cyk7XG4gIGxldCBoYXNoID0gY29tcHV0ZUhhc2goY29kZSk7XG4gIGxldCBkeW5hbWljQm9vdHN0cmFwUGF0aCA9IHBhdGgucmVzb2x2ZShkeW5hbWljQm9vdHN0cmFwRGlyLCBgYm9vdHN0cmFwLSR7aGFzaH0uanNgKTtcbiAgbG9nZ2VyLmRlYnVnKGBEeW5hbWljIGJvb3RzdHJhcCBjb2RlOiAke2NvZGUuc3BsaXQoJ1xcbicpWzBdfS4uLmApO1xuICBsb2dnZXIuZGVidWcoYER5bmFtaWMgYm9vdHN0cmFwIHBhdGg6ICR7ZHluYW1pY0Jvb3RzdHJhcFBhdGh9YCk7XG4gIGF3YWl0IHdyaXRlRHluYW1pY0Jvb3RzdHJhcElmTmVjZXNzYXJ5KGR5bmFtaWNCb290c3RyYXBEaXIsXG4gICAgZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIGhhc2gpO1xuXG4gIHJldHVybiBkeW5hbWljQm9vdHN0cmFwUGF0aDtcbn1cblxuZXhwb3J0IHsgcHJlcGFyZUJvb3RzdHJhcCwgZ2V0RW52IH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
