// The Command Proxy relays UIAuto message to and from Appium. It is also the
// UIAuto facade for Appium.
//
// The message route is the following:
// Appium <--> Command Proxy <--> Instruments
// The medium between Instruments and Command Proxy is the command-proxy-client
// script.
//
// Command Proxy --> Instruments message format: {cmd:"<CMD>"}
//
// Instruments --> Command Proxy message format:
// <one char message type>,<stringified json data>
// <stringified json data> format:
// {status:<status>, value:<result>}

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _uiautoResponse = require('./uiauto-response');

var _uiautoResponse2 = _interopRequireDefault(_uiautoResponse);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _through = require('through');

var _through2 = _interopRequireDefault(_through);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var MORE_COMMAND = '#more';
var DEFAULT_INSTRUMENTS_SOCKET = '/tmp/instruments_sock';

var UIAutoClient = (function () {
  function UIAutoClient() {
    var sock = arguments.length <= 0 || arguments[0] === undefined ? '/tmp/instruments_sock' : arguments[0];

    _classCallCheck(this, UIAutoClient);

    this.curCommand = null;
    this.onReceiveCommand = null;
    this.commandQueue = [];
    this.sock = sock;
    this.socketServer = null;
    this.hasConnected = false;
    this.currentSocket = null;
  }

  _createClass(UIAutoClient, [{
    key: 'sendCommand',
    value: function sendCommand(cmd) {
      var cmdPromise;
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmdPromise = new _bluebird2['default'](function (resolve, reject) {
              var cb = function cb(result) {
                // get back a JSONWP object, so decode and
                // just return the value
                if (result.status === 0) {
                  resolve(result.value);
                } else if (result.status) {
                  var jsonwpError = (0, _appiumBaseDriver.errorFromCode)(result.status, result.value);
                  reject(jsonwpError);
                } else {
                  reject(new Error(result.value));
                }
              };
              _this.commandQueue.push({ cmd: cmd, cb: cb });
              if (_lodash2['default'].isFunction(_this.onReceiveCommand)) {
                _this.onReceiveCommand();
              }
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(cmdPromise);

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * Returns true if the resulting connecting is the first
     * socket connection for this proxy session
     */
  }, {
    key: 'start',
    value: function start() {
      var connectedPromise;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            connectedPromise = new _bluebird2['default'](function (resolve) {
              var response = new _uiautoResponse2['default']();
              _this2.socketServer = _net2['default'].createServer({ allowHalfOpen: true }, function (conn) {
                if (!_this2.hasConnected) {
                  _this2.hasConnected = true;
                  _logger2['default'].info('Instruments is ready to receive commands');
                  resolve(true);
                }
                // up with strings! down with buffers!
                conn.setEncoding('utf8');

                // keep track of this so that we can destroy the socket
                // when shutting down
                _this2.currentSocket = conn;

                conn.on('close', function () {
                  _this2.currentSocket = null;
                });

                // all data goes into buffer
                conn.pipe((0, _through2['default'])(function (data) {
                  _logger2['default'].debug('Socket data received (' + data.length + ' bytes)');
                  response.addData(data);
                }));

                // when all data is in, deal with it
                conn.on('end', function () {
                  // if we are midway through handling a command
                  // we want to try out the data, getting more if necessary
                  if (_this2.curCommand) {
                    var result = response.getResult();
                    if (result && !result.needsMoreData) {
                      // if we're done altogether, call the callback associated with the command
                      _this2.curCommand.cb(result);
                      _this2.curCommand = null;
                    } else {
                      if (result) {
                        _logger2['default'].debug('Not the last chunk, trying to get more');
                      } else {
                        _logger2['default'].debug('No result received. Continuing to try to get more');
                      }
                      // add a command to the queue, to request more data
                      _this2.commandQueue.unshift({ cmd: MORE_COMMAND, cb: _this2.curCommand.cb });
                    }
                  } else {
                    _logger2['default'].debug('Got a result when we were not expecting one! Ignoring it');
                    response.resetBuffer();
                  }

                  // set up a callback to handle the next command
                  var onReceiveCommand = function onReceiveCommand() {
                    _this2.onReceiveCommand = null;
                    _this2.curCommand = _this2.commandQueue.shift();
                    _logger2['default'].debug('Sending command to instruments: ' + _this2.curCommand.cmd);
                    conn.write(JSON.stringify({ cmd: _this2.curCommand.cmd }));
                    conn.end();
                  };
                  if (_this2.commandQueue.length) {
                    onReceiveCommand();
                  } else {
                    _this2.onReceiveCommand = onReceiveCommand;
                  }
                });
              });

              _this2.socketServer.on('close', function () {
                _logger2['default'].debug('Instruments socket server was closed');
              });
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(this.sock));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(this.sock)));

          case 5:

            this.socketServer.listen(this.sock);
            _logger2['default'].debug('Instruments socket server started at ' + this.sock);

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(connectedPromise);

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // make sure clear out command cbs so we can't have any lingering cbs
            // if a socket request makes it through after exit somehow
            this.curCommand = null;
            this.onReceiveCommand = null;

            if (this.currentSocket) {
              _logger2['default'].debug('Destroying instruments client socket.');
              this.currentSocket.end();
              this.currentSocket.destroy();
              this.currentSocket = null;
            }

            if (!this.socketServer) {
              context$2$0.next = 8;
              break;
            }

            _logger2['default'].debug('Closing socket server.');
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_bluebird2['default'].promisify(this.socketServer.close, this.socketServer)());

          case 7:
            this.socketServer = null;

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'safeShutdown',
    value: function safeShutdown() {
      return _regeneratorRuntime.async(function safeShutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Shutting down command proxy and ignoring any errors');
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.shutdown());

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('Ignoring error: ' + context$2$0.t0);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return UIAutoClient;
})();

exports.UIAutoClient = UIAutoClient;
exports.DEFAULT_INSTRUMENTS_SOCKET = DEFAULT_INSTRUMENTS_SOCKET;
exports['default'] = UIAutoClient;

// only resolve the promise when the server that is created actually connects

// remove socket file if it currently exists

// create the new socket file
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG8vdWlhdXRvLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs4QkFlMkIsbUJBQW1COzs7O3NCQUMzQixVQUFVOzs7O3VCQUNULFNBQVM7Ozs7bUJBQ2IsS0FBSzs7Ozs2QkFDTSxnQkFBZ0I7O29CQUMxQixNQUFNOzs7O3dCQUNULFVBQVU7Ozs7c0JBQ1YsUUFBUTs7OztnQ0FDUSxvQkFBb0I7O0FBR2xELElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQztBQUM3QixJQUFNLDBCQUEwQixHQUFHLHVCQUF1QixDQUFDOztJQUVyRCxZQUFZO0FBQ0osV0FEUixZQUFZLEdBQzZCO1FBQWhDLElBQUkseURBQUcsdUJBQXVCOzswQkFEdkMsWUFBWTs7QUFFZCxRQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztBQUN2QixRQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBQzdCLFFBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLFFBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0FBQ3pCLFFBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO0FBQzFCLFFBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0dBQzNCOztlQVRHLFlBQVk7O1dBV0UscUJBQUMsR0FBRztVQUNoQixVQUFVOzs7Ozs7QUFBVixzQkFBVSxHQUFHLDBCQUFNLFVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBSztBQUMxQyxrQkFBSSxFQUFFLEdBQUcsU0FBTCxFQUFFLENBQUksTUFBTSxFQUFLOzs7QUFHbkIsb0JBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDdkIseUJBQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ3ZCLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO0FBQ3hCLHNCQUFJLFdBQVcsR0FBRyxxQ0FBYyxNQUFNLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUM3RCx3QkFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2lCQUNyQixNQUFNO0FBQ0wsd0JBQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztpQkFDakM7ZUFDRixDQUFDO0FBQ0Ysb0JBQUssWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFDLEdBQUcsRUFBSCxHQUFHLEVBQUUsRUFBRSxFQUFGLEVBQUUsRUFBQyxDQUFDLENBQUM7QUFDbEMsa0JBQUksb0JBQUUsVUFBVSxDQUFDLE1BQUssZ0JBQWdCLENBQUMsRUFBRTtBQUN2QyxzQkFBSyxnQkFBZ0IsRUFBRSxDQUFDO2VBQ3pCO2FBQ0YsQ0FBQzs7NkNBQ1csVUFBVTs7Ozs7Ozs7OztLQUN4Qjs7Ozs7Ozs7V0FNVztVQUVOLGdCQUFnQjs7Ozs7O0FBQWhCLDRCQUFnQixHQUFHLDBCQUFNLFVBQUMsT0FBTyxFQUFLO0FBQ3hDLGtCQUFJLFFBQVEsR0FBRyxpQ0FBb0IsQ0FBQztBQUNwQyxxQkFBSyxZQUFZLEdBQUcsaUJBQUksWUFBWSxDQUFDLEVBQUMsYUFBYSxFQUFFLElBQUksRUFBQyxFQUFFLFVBQUMsSUFBSSxFQUFLO0FBQ3BFLG9CQUFJLENBQUMsT0FBSyxZQUFZLEVBQUU7QUFDdEIseUJBQUssWUFBWSxHQUFHLElBQUksQ0FBQztBQUN6QixzQ0FBTyxJQUFJLENBQUMsMENBQTBDLENBQUMsQ0FBQztBQUN4RCx5QkFBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNmOztBQUVELG9CQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDOzs7O0FBSXpCLHVCQUFLLGFBQWEsR0FBRyxJQUFJLENBQUM7O0FBRTFCLG9CQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxZQUFNO0FBQ3JCLHlCQUFLLGFBQWEsR0FBRyxJQUFJLENBQUM7aUJBQzNCLENBQUMsQ0FBQzs7O0FBR0gsb0JBQUksQ0FBQyxJQUFJLENBQUMsMEJBQVEsVUFBQyxJQUFJLEVBQUs7QUFDMUIsc0NBQU8sS0FBSyw0QkFBMEIsSUFBSSxDQUFDLE1BQU0sYUFBVSxDQUFDO0FBQzVELDBCQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUN4QixDQUFDLENBQUMsQ0FBQzs7O0FBR0osb0JBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLFlBQU07OztBQUduQixzQkFBSSxPQUFLLFVBQVUsRUFBRTtBQUNuQix3QkFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ2xDLHdCQUFJLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUU7O0FBRW5DLDZCQUFLLFVBQVUsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsNkJBQUssVUFBVSxHQUFHLElBQUksQ0FBQztxQkFDeEIsTUFBTTtBQUNMLDBCQUFJLE1BQU0sRUFBRTtBQUNWLDRDQUFPLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO3VCQUN4RCxNQUFNO0FBQ0wsNENBQU8sS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7dUJBQ25FOztBQUVELDZCQUFLLFlBQVksQ0FBQyxPQUFPLENBQUMsRUFBQyxHQUFHLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxPQUFLLFVBQVUsQ0FBQyxFQUFFLEVBQUMsQ0FBQyxDQUFDO3FCQUN4RTttQkFDRixNQUFNO0FBQ0wsd0NBQU8sS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7QUFDekUsNEJBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQzttQkFDeEI7OztBQUdELHNCQUFJLGdCQUFnQixHQUFHLFNBQW5CLGdCQUFnQixHQUFTO0FBQzNCLDJCQUFLLGdCQUFnQixHQUFHLElBQUksQ0FBQztBQUM3QiwyQkFBSyxVQUFVLEdBQUcsT0FBSyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDNUMsd0NBQU8sS0FBSyxzQ0FBb0MsT0FBSyxVQUFVLENBQUMsR0FBRyxDQUFHLENBQUM7QUFDdkUsd0JBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFDLEdBQUcsRUFBRSxPQUFLLFVBQVUsQ0FBQyxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkQsd0JBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQzttQkFDWixDQUFDO0FBQ0Ysc0JBQUksT0FBSyxZQUFZLENBQUMsTUFBTSxFQUFFO0FBQzVCLG9DQUFnQixFQUFFLENBQUM7bUJBQ3BCLE1BQU07QUFDTCwyQkFBSyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQzttQkFDMUM7aUJBQ0YsQ0FBQyxDQUFDO2VBQ0osQ0FBQyxDQUFDOztBQUVILHFCQUFLLFlBQVksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFlBQVk7QUFDeEMsb0NBQU8sS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7ZUFDdEQsQ0FBQyxDQUFDO2FBQ0osQ0FBQzs7NkNBR0ksa0JBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7Ozs7NkNBR3BCLDJCQUFPLGtCQUFLLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7QUFFckMsZ0JBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNwQyxnQ0FBTyxLQUFLLDJDQUF5QyxJQUFJLENBQUMsSUFBSSxDQUFHLENBQUM7Ozs2Q0FFckQsZ0JBQWdCOzs7Ozs7Ozs7O0tBQzlCOzs7V0FFYzs7Ozs7O0FBR2IsZ0JBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLGdCQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDOztBQUU3QixnQkFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO0FBQ3RCLGtDQUFPLEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO0FBQ3RELGtCQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLGtCQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzdCLGtCQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQzthQUMzQjs7aUJBQ0csSUFBSSxDQUFDLFlBQVk7Ozs7O0FBQ25CLGdDQUFPLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDOzs2Q0FDakMsQUFBQyxzQkFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFHOzs7QUFDakUsZ0JBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDOzs7Ozs7O0tBRTVCOzs7V0FFa0I7Ozs7QUFDakIsZ0NBQU8sS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7Ozs2Q0FFNUQsSUFBSSxDQUFDLFFBQVEsRUFBRTs7Ozs7Ozs7OztBQUVyQixnQ0FBTyxLQUFLLHFDQUEwQixDQUFDOzs7Ozs7O0tBRTFDOzs7U0FuSkcsWUFBWTs7O1FBc0pULFlBQVksR0FBWixZQUFZO1FBQUUsMEJBQTBCLEdBQTFCLDBCQUEwQjtxQkFDbEMsWUFBWSIsImZpbGUiOiJsaWIvdWlhdXRvL3VpYXV0by1jbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUaGUgQ29tbWFuZCBQcm94eSByZWxheXMgVUlBdXRvIG1lc3NhZ2UgdG8gYW5kIGZyb20gQXBwaXVtLiBJdCBpcyBhbHNvIHRoZVxuLy8gVUlBdXRvIGZhY2FkZSBmb3IgQXBwaXVtLlxuLy9cbi8vIFRoZSBtZXNzYWdlIHJvdXRlIGlzIHRoZSBmb2xsb3dpbmc6XG4vLyBBcHBpdW0gPC0tPiBDb21tYW5kIFByb3h5IDwtLT4gSW5zdHJ1bWVudHNcbi8vIFRoZSBtZWRpdW0gYmV0d2VlbiBJbnN0cnVtZW50cyBhbmQgQ29tbWFuZCBQcm94eSBpcyB0aGUgY29tbWFuZC1wcm94eS1jbGllbnRcbi8vIHNjcmlwdC5cbi8vXG4vLyBDb21tYW5kIFByb3h5IC0tPiBJbnN0cnVtZW50cyBtZXNzYWdlIGZvcm1hdDoge2NtZDpcIjxDTUQ+XCJ9XG4vL1xuLy8gSW5zdHJ1bWVudHMgLS0+IENvbW1hbmQgUHJveHkgbWVzc2FnZSBmb3JtYXQ6XG4vLyA8b25lIGNoYXIgbWVzc2FnZSB0eXBlPiw8c3RyaW5naWZpZWQganNvbiBkYXRhPlxuLy8gPHN0cmluZ2lmaWVkIGpzb24gZGF0YT4gZm9ybWF0OlxuLy8ge3N0YXR1czo8c3RhdHVzPiwgdmFsdWU6PHJlc3VsdD59XG5cbmltcG9ydCBVSUF1dG9SZXNwb25zZSBmcm9tICcuL3VpYXV0by1yZXNwb25zZSc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB0aHJvdWdoIGZyb20gJ3Rocm91Z2gnO1xuaW1wb3J0IG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IHsgbWtkaXJwLCBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9yRnJvbUNvZGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuXG5cbmNvbnN0IE1PUkVfQ09NTUFORCA9ICcjbW9yZSc7XG5jb25zdCBERUZBVUxUX0lOU1RSVU1FTlRTX1NPQ0tFVCA9ICcvdG1wL2luc3RydW1lbnRzX3NvY2snO1xuXG5jbGFzcyBVSUF1dG9DbGllbnQge1xuICBjb25zdHJ1Y3RvciAoc29jayA9ICcvdG1wL2luc3RydW1lbnRzX3NvY2snKSB7XG4gICAgdGhpcy5jdXJDb21tYW5kID0gbnVsbDtcbiAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQgPSBudWxsO1xuICAgIHRoaXMuY29tbWFuZFF1ZXVlID0gW107XG4gICAgdGhpcy5zb2NrID0gc29jaztcbiAgICB0aGlzLnNvY2tldFNlcnZlciA9IG51bGw7XG4gICAgdGhpcy5oYXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLmN1cnJlbnRTb2NrZXQgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKGNtZCkge1xuICAgIGxldCBjbWRQcm9taXNlID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IGNiID0gKHJlc3VsdCkgPT4ge1xuICAgICAgICAvLyBnZXQgYmFjayBhIEpTT05XUCBvYmplY3QsIHNvIGRlY29kZSBhbmRcbiAgICAgICAgLy8ganVzdCByZXR1cm4gdGhlIHZhbHVlXG4gICAgICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSAwKSB7XG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQudmFsdWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5zdGF0dXMpIHtcbiAgICAgICAgICBsZXQganNvbndwRXJyb3IgPSBlcnJvckZyb21Db2RlKHJlc3VsdC5zdGF0dXMsIHJlc3VsdC52YWx1ZSk7XG4gICAgICAgICAgcmVqZWN0KGpzb253cEVycm9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKHJlc3VsdC52YWx1ZSkpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy5jb21tYW5kUXVldWUucHVzaCh7Y21kLCBjYn0pO1xuICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLm9uUmVjZWl2ZUNvbW1hbmQpKSB7XG4gICAgICAgIHRoaXMub25SZWNlaXZlQ29tbWFuZCgpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCBjbWRQcm9taXNlO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSByZXN1bHRpbmcgY29ubmVjdGluZyBpcyB0aGUgZmlyc3RcbiAgICogc29ja2V0IGNvbm5lY3Rpb24gZm9yIHRoaXMgcHJveHkgc2Vzc2lvblxuICAgKi9cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIC8vIG9ubHkgcmVzb2x2ZSB0aGUgcHJvbWlzZSB3aGVuIHRoZSBzZXJ2ZXIgdGhhdCBpcyBjcmVhdGVkIGFjdHVhbGx5IGNvbm5lY3RzXG4gICAgbGV0IGNvbm5lY3RlZFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgbGV0IHJlc3BvbnNlID0gbmV3IFVJQXV0b1Jlc3BvbnNlKCk7XG4gICAgICB0aGlzLnNvY2tldFNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoe2FsbG93SGFsZk9wZW46IHRydWV9LCAoY29ubikgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuaGFzQ29ubmVjdGVkKSB7XG4gICAgICAgICAgdGhpcy5oYXNDb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgIGxvZ2dlci5pbmZvKCdJbnN0cnVtZW50cyBpcyByZWFkeSB0byByZWNlaXZlIGNvbW1hbmRzJyk7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICAvLyB1cCB3aXRoIHN0cmluZ3MhIGRvd24gd2l0aCBidWZmZXJzIVxuICAgICAgICBjb25uLnNldEVuY29kaW5nKCd1dGY4Jyk7XG5cbiAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB0aGlzIHNvIHRoYXQgd2UgY2FuIGRlc3Ryb3kgdGhlIHNvY2tldFxuICAgICAgICAvLyB3aGVuIHNodXR0aW5nIGRvd25cbiAgICAgICAgdGhpcy5jdXJyZW50U29ja2V0ID0gY29ubjtcblxuICAgICAgICBjb25uLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRTb2NrZXQgPSBudWxsO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBhbGwgZGF0YSBnb2VzIGludG8gYnVmZmVyXG4gICAgICAgIGNvbm4ucGlwZSh0aHJvdWdoKChkYXRhKSA9PiB7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKGBTb2NrZXQgZGF0YSByZWNlaXZlZCAoJHtkYXRhLmxlbmd0aH0gYnl0ZXMpYCk7XG4gICAgICAgICAgcmVzcG9uc2UuYWRkRGF0YShkYXRhKTtcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIC8vIHdoZW4gYWxsIGRhdGEgaXMgaW4sIGRlYWwgd2l0aCBpdFxuICAgICAgICBjb25uLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgLy8gaWYgd2UgYXJlIG1pZHdheSB0aHJvdWdoIGhhbmRsaW5nIGEgY29tbWFuZFxuICAgICAgICAgIC8vIHdlIHdhbnQgdG8gdHJ5IG91dCB0aGUgZGF0YSwgZ2V0dGluZyBtb3JlIGlmIG5lY2Vzc2FyeVxuICAgICAgICAgIGlmICh0aGlzLmN1ckNvbW1hbmQpIHtcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSByZXNwb25zZS5nZXRSZXN1bHQoKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgIXJlc3VsdC5uZWVkc01vcmVEYXRhKSB7XG4gICAgICAgICAgICAgIC8vIGlmIHdlJ3JlIGRvbmUgYWx0b2dldGhlciwgY2FsbCB0aGUgY2FsbGJhY2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBjb21tYW5kXG4gICAgICAgICAgICAgIHRoaXMuY3VyQ29tbWFuZC5jYihyZXN1bHQpO1xuICAgICAgICAgICAgICB0aGlzLmN1ckNvbW1hbmQgPSBudWxsO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnTm90IHRoZSBsYXN0IGNodW5rLCB0cnlpbmcgdG8gZ2V0IG1vcmUnKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoJ05vIHJlc3VsdCByZWNlaXZlZC4gQ29udGludWluZyB0byB0cnkgdG8gZ2V0IG1vcmUnKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAvLyBhZGQgYSBjb21tYW5kIHRvIHRoZSBxdWV1ZSwgdG8gcmVxdWVzdCBtb3JlIGRhdGFcbiAgICAgICAgICAgICAgdGhpcy5jb21tYW5kUXVldWUudW5zaGlmdCh7Y21kOiBNT1JFX0NPTU1BTkQsIGNiOiB0aGlzLmN1ckNvbW1hbmQuY2J9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdHb3QgYSByZXN1bHQgd2hlbiB3ZSB3ZXJlIG5vdCBleHBlY3Rpbmcgb25lISBJZ25vcmluZyBpdCcpO1xuICAgICAgICAgICAgcmVzcG9uc2UucmVzZXRCdWZmZXIoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBzZXQgdXAgYSBjYWxsYmFjayB0byBoYW5kbGUgdGhlIG5leHQgY29tbWFuZFxuICAgICAgICAgIGxldCBvblJlY2VpdmVDb21tYW5kID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vblJlY2VpdmVDb21tYW5kID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuY3VyQ29tbWFuZCA9IHRoaXMuY29tbWFuZFF1ZXVlLnNoaWZ0KCk7XG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoYFNlbmRpbmcgY29tbWFuZCB0byBpbnN0cnVtZW50czogJHt0aGlzLmN1ckNvbW1hbmQuY21kfWApO1xuICAgICAgICAgICAgY29ubi53cml0ZShKU09OLnN0cmluZ2lmeSh7Y21kOiB0aGlzLmN1ckNvbW1hbmQuY21kfSkpO1xuICAgICAgICAgICAgY29ubi5lbmQoKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGlmICh0aGlzLmNvbW1hbmRRdWV1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIG9uUmVjZWl2ZUNvbW1hbmQoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5vblJlY2VpdmVDb21tYW5kID0gb25SZWNlaXZlQ29tbWFuZDtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuc29ja2V0U2VydmVyLm9uKCdjbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdJbnN0cnVtZW50cyBzb2NrZXQgc2VydmVyIHdhcyBjbG9zZWQnKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gcmVtb3ZlIHNvY2tldCBmaWxlIGlmIGl0IGN1cnJlbnRseSBleGlzdHNcbiAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy5zb2NrKTtcblxuICAgIC8vIGNyZWF0ZSB0aGUgbmV3IHNvY2tldCBmaWxlXG4gICAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZSh0aGlzLnNvY2spKTtcblxuICAgIHRoaXMuc29ja2V0U2VydmVyLmxpc3Rlbih0aGlzLnNvY2spO1xuICAgIGxvZ2dlci5kZWJ1ZyhgSW5zdHJ1bWVudHMgc29ja2V0IHNlcnZlciBzdGFydGVkIGF0ICR7dGhpcy5zb2NrfWApO1xuXG4gICAgcmV0dXJuIGF3YWl0IGNvbm5lY3RlZFByb21pc2U7XG4gIH1cblxuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgLy8gbWFrZSBzdXJlIGNsZWFyIG91dCBjb21tYW5kIGNicyBzbyB3ZSBjYW4ndCBoYXZlIGFueSBsaW5nZXJpbmcgY2JzXG4gICAgLy8gaWYgYSBzb2NrZXQgcmVxdWVzdCBtYWtlcyBpdCB0aHJvdWdoIGFmdGVyIGV4aXQgc29tZWhvd1xuICAgIHRoaXMuY3VyQ29tbWFuZCA9IG51bGw7XG4gICAgdGhpcy5vblJlY2VpdmVDb21tYW5kID0gbnVsbDtcblxuICAgIGlmICh0aGlzLmN1cnJlbnRTb2NrZXQpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnRGVzdHJveWluZyBpbnN0cnVtZW50cyBjbGllbnQgc29ja2V0LicpO1xuICAgICAgdGhpcy5jdXJyZW50U29ja2V0LmVuZCgpO1xuICAgICAgdGhpcy5jdXJyZW50U29ja2V0LmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuY3VycmVudFNvY2tldCA9IG51bGw7XG4gICAgfVxuICAgIGlmICh0aGlzLnNvY2tldFNlcnZlcikge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDbG9zaW5nIHNvY2tldCBzZXJ2ZXIuJyk7XG4gICAgICBhd2FpdCAoQi5wcm9taXNpZnkodGhpcy5zb2NrZXRTZXJ2ZXIuY2xvc2UsIHRoaXMuc29ja2V0U2VydmVyKSkoKTtcbiAgICAgIHRoaXMuc29ja2V0U2VydmVyID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzYWZlU2h1dGRvd24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnU2h1dHRpbmcgZG93biBjb21tYW5kIHByb3h5IGFuZCBpZ25vcmluZyBhbnkgZXJyb3JzJyk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuc2h1dGRvd24oKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgSWdub3JpbmcgZXJyb3I6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBVSUF1dG9DbGllbnQsIERFRkFVTFRfSU5TVFJVTUVOVFNfU09DS0VUIH07XG5leHBvcnQgZGVmYXVsdCBVSUF1dG9DbGllbnQ7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
