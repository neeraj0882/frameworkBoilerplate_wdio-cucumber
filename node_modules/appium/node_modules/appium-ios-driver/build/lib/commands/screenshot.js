'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _uuidJs = require('uuid-js');

var _uuidJs2 = _interopRequireDefault(_uuidJs);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _asyncbox = require('asyncbox');

var _appiumSupport = require('appium-support');

var _uiautoUtils = require('../uiauto/utils');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumBaseDriver = require('appium-base-driver');

var commands = {},
    helpers = {},
    extensions = {};

commands.getScreenshot = function callee$0$0() {
  var guid, shotFile, shotFolder, shotPath, takeScreenShot, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        guid = _uuidJs2['default'].create();
        shotFile = 'screenshot' + guid;
        shotFolder = _path2['default'].resolve(this.opts.tmpDir, 'appium-instruments/Run 1/');
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(shotFolder));

      case 5:
        if (context$1$0.sent) {
          context$1$0.next = 9;
          break;
        }

        _logger2['default'].debug('Creating folder \'' + shotFolder + '\'');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(shotFolder));

      case 9:
        shotPath = _path2['default'].resolve(shotFolder, shotFile + '.png');

        _logger2['default'].debug('Taking screenshot: \'' + shotPath + '\'');

        takeScreenShot = function takeScreenShot() {
          var screenshotWaitTimeout, startMs, success;
          return _regeneratorRuntime.async(function takeScreenShot$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.capture(\'' + shotFile + '\')'));

              case 2:
                screenshotWaitTimeout = (this.opts.screenshotWaitTimeout || 10) * 1000;

                _logger2['default'].debug('Waiting ' + screenshotWaitTimeout + ' ms for screenshot to be generated.');
                startMs = Date.now();
                success = false;

              case 6:
                if (!(Date.now() - startMs < screenshotWaitTimeout)) {
                  context$2$0.next = 16;
                  break;
                }

                context$2$0.next = 9;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(shotPath));

              case 9:
                if (!context$2$0.sent) {
                  context$2$0.next = 12;
                  break;
                }

                success = true;
                return context$2$0.abrupt('break', 16);

              case 12:
                context$2$0.next = 14;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(300));

              case 14:
                context$2$0.next = 6;
                break;

              case 16:
                if (success) {
                  context$2$0.next = 18;
                  break;
                }

                throw new _appiumBaseDriver.errors.UnknownError('Timed out waiting for screenshot file');

              case 18:
                context$2$0.next = 20;
                return _regeneratorRuntime.awrap(this.getOrientation());

              case 20:
                context$2$0.t0 = context$2$0.sent;

                if (!(context$2$0.t0 === 'LANDSCAPE')) {
                  context$2$0.next = 25;
                  break;
                }

                _logger2['default'].debug('Rotating landscape screenshot');
                context$2$0.next = 25;
                return _regeneratorRuntime.awrap((0, _uiautoUtils.rotateImage)(shotPath, -90));

              case 25:
                context$2$0.next = 27;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(shotPath));

              case 27:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 28:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap((0, _asyncbox.retry)(3, takeScreenShot));

      case 14:
        data = context$1$0.sent;
        return context$1$0.abrupt('return', new Buffer(data).toString('base64'));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getViewportScreenshot = function callee$0$0() {
  var windowSize, scale, statusBarHeight, screenshot, rect, newScreenshot;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getWindowSize());

      case 2:
        windowSize = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getDevicePixelRatio());

      case 5:
        scale = context$1$0.sent;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.getStatusBarHeight());

      case 8:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.t1 = scale;
        statusBarHeight = context$1$0.t0 * context$1$0.t1;
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.getScreenshot());

      case 13:
        screenshot = context$1$0.sent;
        rect = {
          left: 0,
          top: statusBarHeight,
          width: windowSize.width * scale,
          height: windowSize.height * scale - statusBarHeight
        };
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(_appiumSupport.imageUtil.cropBase64Image(screenshot, rect));

      case 17:
        newScreenshot = context$1$0.sent;
        return context$1$0.abrupt('return', newScreenshot);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// check the rotation, and rotate if necessary

// Retrying the whole screenshot process for three times.

// status bar height comes in unscaled, so scale it
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQkFBaUIsU0FBUzs7Ozt3QkFDWixVQUFVOzs7O29CQUNQLE1BQU07Ozs7d0JBQ0QsVUFBVTs7NkJBQ00sZ0JBQWdCOzsyQkFDMUIsaUJBQWlCOztzQkFDMUIsV0FBVzs7OztnQ0FDUCxvQkFBb0I7O0FBRzNDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxhQUFhLEdBQUc7TUFDbkIsSUFBSSxFQUNKLFFBQVEsRUFFUixVQUFVLEVBTVYsUUFBUSxFQUdSLGNBQWMsRUE0QmQsSUFBSTs7Ozs7O0FBeENKLFlBQUksR0FBRyxvQkFBSyxNQUFNLEVBQUU7QUFDcEIsZ0JBQVEsa0JBQWdCLElBQUk7QUFFNUIsa0JBQVUsR0FBRyxrQkFBSyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsMkJBQTJCLENBQUM7O3lDQUNoRSxrQkFBRyxNQUFNLENBQUMsVUFBVSxDQUFDOzs7Ozs7OztBQUMvQiw0QkFBTyxLQUFLLHdCQUFxQixVQUFVLFFBQUksQ0FBQzs7eUNBQzFDLDJCQUFPLFVBQVUsQ0FBQzs7O0FBR3RCLGdCQUFRLEdBQUcsa0JBQUssT0FBTyxDQUFDLFVBQVUsRUFBSyxRQUFRLFVBQU87O0FBQzFELDRCQUFPLEtBQUssMkJBQXdCLFFBQVEsUUFBSSxDQUFDOztBQUU3QyxzQkFBYyxHQUFHLFNBQWpCLGNBQWM7Y0FHWixxQkFBcUIsRUFFckIsT0FBTyxFQUVQLE9BQU87Ozs7O2lEQU5MLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxtQkFBZ0IsUUFBUSxTQUFLOzs7QUFFNUQscUNBQXFCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixJQUFJLEVBQUUsQ0FBQSxHQUFJLElBQUk7O0FBQzFFLG9DQUFPLEtBQUssY0FBWSxxQkFBcUIseUNBQXNDLENBQUM7QUFDaEYsdUJBQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFO0FBRXBCLHVCQUFPLEdBQUcsS0FBSzs7O3NCQUNaLEFBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLE9BQU8sR0FBSSxxQkFBcUIsQ0FBQTs7Ozs7O2lEQUN6QyxrQkFBRyxTQUFTLENBQUMsUUFBUSxDQUFDOzs7Ozs7OztBQUM5Qix1QkFBTyxHQUFHLElBQUksQ0FBQzs7Ozs7aURBR1gsc0JBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQzs7Ozs7OztvQkFFZixPQUFPOzs7OztzQkFDSixJQUFJLHlCQUFPLFlBQVksQ0FBQyx1Q0FBdUMsQ0FBQzs7OztpREFJOUQsSUFBSSxDQUFDLGNBQWMsRUFBRTs7Ozs7eUNBQUssV0FBVzs7Ozs7QUFDN0Msb0NBQU8sS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7O2lEQUN4Qyw4QkFBWSxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUM7Ozs7aURBRXJCLGtCQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUM7Ozs7Ozs7Ozs7U0FDbkM7Ozt5Q0FHZ0IscUJBQU0sQ0FBQyxFQUFFLGNBQWMsQ0FBQzs7O0FBQXJDLFlBQUk7NENBQ0QsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQzs7Ozs7OztDQUMzQyxDQUFDOztBQUVGLFFBQVEsQ0FBQyxxQkFBcUIsR0FBRztNQUN6QixVQUFVLEVBQ1YsS0FBSyxFQUVMLGVBQWUsRUFDZixVQUFVLEVBQ1osSUFBSSxFQU1KLGFBQWE7Ozs7O3lDQVhRLElBQUksQ0FBQyxhQUFhLEVBQUU7OztBQUF2QyxrQkFBVTs7eUNBQ0ksSUFBSSxDQUFDLG1CQUFtQixFQUFFOzs7QUFBeEMsYUFBSzs7eUNBRW1CLElBQUksQ0FBQyxrQkFBa0IsRUFBRTs7Ozt5QkFBRyxLQUFLO0FBQXpELHVCQUFlOzt5Q0FDSSxJQUFJLENBQUMsYUFBYSxFQUFFOzs7QUFBdkMsa0JBQVU7QUFDWixZQUFJLEdBQUc7QUFDVCxjQUFJLEVBQUUsQ0FBQztBQUNQLGFBQUcsRUFBRSxlQUFlO0FBQ3BCLGVBQUssRUFBRSxVQUFVLENBQUMsS0FBSyxHQUFHLEtBQUs7QUFDL0IsZ0JBQU0sRUFBRSxVQUFVLENBQUMsTUFBTSxHQUFHLEtBQUssR0FBRyxlQUFlO1NBQ3BEOzt5Q0FDeUIseUJBQVUsZUFBZSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUM7OztBQUFqRSxxQkFBYTs0Q0FDVixhQUFhOzs7Ozs7O0NBQ3JCLENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1YsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvc2NyZWVuc2hvdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1dWlkIGZyb20gJ3V1aWQtanMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyByZXRyeSB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGZzLCBta2RpcnAsIGltYWdlVXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHJvdGF0ZUltYWdlIH0gZnJvbSAnLi4vdWlhdXRvL3V0aWxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5nZXRTY3JlZW5zaG90ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgZ3VpZCA9IHV1aWQuY3JlYXRlKCk7XG4gIGxldCBzaG90RmlsZSA9IGBzY3JlZW5zaG90JHtndWlkfWA7XG5cbiAgbGV0IHNob3RGb2xkZXIgPSBwYXRoLnJlc29sdmUodGhpcy5vcHRzLnRtcERpciwgJ2FwcGl1bS1pbnN0cnVtZW50cy9SdW4gMS8nKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHNob3RGb2xkZXIpKSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ3JlYXRpbmcgZm9sZGVyICcke3Nob3RGb2xkZXJ9J2ApO1xuICAgIGF3YWl0IG1rZGlycChzaG90Rm9sZGVyKTtcbiAgfVxuXG4gIGxldCBzaG90UGF0aCA9IHBhdGgucmVzb2x2ZShzaG90Rm9sZGVyLCBgJHtzaG90RmlsZX0ucG5nYCk7XG4gIGxvZ2dlci5kZWJ1ZyhgVGFraW5nIHNjcmVlbnNob3Q6ICcke3Nob3RQYXRofSdgKTtcblxuICBsZXQgdGFrZVNjcmVlblNob3QgPSBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmNhcHR1cmUoJyR7c2hvdEZpbGV9JylgKTtcblxuICAgIGxldCBzY3JlZW5zaG90V2FpdFRpbWVvdXQgPSAodGhpcy5vcHRzLnNjcmVlbnNob3RXYWl0VGltZW91dCB8fCAxMCkgKiAxMDAwO1xuICAgIGxvZ2dlci5kZWJ1ZyhgV2FpdGluZyAke3NjcmVlbnNob3RXYWl0VGltZW91dH0gbXMgZm9yIHNjcmVlbnNob3QgdG8gYmUgZ2VuZXJhdGVkLmApO1xuICAgIGxldCBzdGFydE1zID0gRGF0ZS5ub3coKTtcblxuICAgIGxldCBzdWNjZXNzID0gZmFsc2U7XG4gICAgd2hpbGUgKChEYXRlLm5vdygpIC0gc3RhcnRNcykgPCBzY3JlZW5zaG90V2FpdFRpbWVvdXQpIHtcbiAgICAgIGlmIChhd2FpdCBmcy5oYXNBY2Nlc3Moc2hvdFBhdGgpKSB7XG4gICAgICAgIHN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGF3YWl0IEIuZGVsYXkoMzAwKTtcbiAgICB9XG4gICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcignVGltZWQgb3V0IHdhaXRpbmcgZm9yIHNjcmVlbnNob3QgZmlsZScpO1xuICAgIH1cblxuICAgIC8vIGNoZWNrIHRoZSByb3RhdGlvbiwgYW5kIHJvdGF0ZSBpZiBuZWNlc3NhcnlcbiAgICBpZiAoYXdhaXQgdGhpcy5nZXRPcmllbnRhdGlvbigpID09PSAnTEFORFNDQVBFJykge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdSb3RhdGluZyBsYW5kc2NhcGUgc2NyZWVuc2hvdCcpO1xuICAgICAgYXdhaXQgcm90YXRlSW1hZ2Uoc2hvdFBhdGgsIC05MCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBmcy5yZWFkRmlsZShzaG90UGF0aCk7XG4gIH07XG5cbiAgLy8gUmV0cnlpbmcgdGhlIHdob2xlIHNjcmVlbnNob3QgcHJvY2VzcyBmb3IgdGhyZWUgdGltZXMuXG4gIGxldCBkYXRhID0gYXdhaXQgcmV0cnkoMywgdGFrZVNjcmVlblNob3QpO1xuICByZXR1cm4gbmV3IEJ1ZmZlcihkYXRhKS50b1N0cmluZygnYmFzZTY0Jyk7XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHdpbmRvd1NpemUgPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgY29uc3Qgc2NhbGUgPSBhd2FpdCB0aGlzLmdldERldmljZVBpeGVsUmF0aW8oKTtcbiAgLy8gc3RhdHVzIGJhciBoZWlnaHQgY29tZXMgaW4gdW5zY2FsZWQsIHNvIHNjYWxlIGl0XG4gIGNvbnN0IHN0YXR1c0JhckhlaWdodCA9IGF3YWl0IHRoaXMuZ2V0U3RhdHVzQmFySGVpZ2h0KCkgKiBzY2FsZTtcbiAgY29uc3Qgc2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuICBsZXQgcmVjdCA9IHtcbiAgICBsZWZ0OiAwLFxuICAgIHRvcDogc3RhdHVzQmFySGVpZ2h0LFxuICAgIHdpZHRoOiB3aW5kb3dTaXplLndpZHRoICogc2NhbGUsXG4gICAgaGVpZ2h0OiB3aW5kb3dTaXplLmhlaWdodCAqIHNjYWxlIC0gc3RhdHVzQmFySGVpZ2h0XG4gIH07XG4gIGxldCBuZXdTY3JlZW5zaG90ID0gYXdhaXQgaW1hZ2VVdGlsLmNyb3BCYXNlNjRJbWFnZShzY3JlZW5zaG90LCByZWN0KTtcbiAgcmV0dXJuIG5ld1NjcmVlbnNob3Q7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7Y29tbWFuZHMsIGhlbHBlcnN9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
