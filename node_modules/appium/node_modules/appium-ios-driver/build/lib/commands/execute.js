'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumIosSimulator = require('appium-ios-simulator');

var _server = require('../server');

var commands = {},
    helpers = {},
    extensions = {};

commands.execute = function callee$0$0(script, args) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!script.match(/^mobile\:/)) {
          context$1$0.next = 7;
          break;
        }

        script = script.replace(/^mobile\:/, '').trim();
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeMobile(script, _lodash2['default'].isArray(args) ? args[0] : args));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        if (!this.isWebContext()) {
          context$1$0.next = 14;
          break;
        }

        args = this.convertElementsForAtoms(args);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, args]));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 16:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeAsync = function callee$0$0(script, args, sessionId) {
  var address, port, protocol, currentUrl, responseUrl, defaultHost, urlObject;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;

        sessionId = sessionId || this.sessionId;

        // https sites need to reply to an https endpoint, in Safari
        protocol = 'http:';
        context$1$0.prev = 8;
        context$1$0.t0 = _url2['default'];
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.getUrl());

      case 12:
        context$1$0.t1 = context$1$0.sent;
        currentUrl = context$1$0.t0.parse.call(context$1$0.t0, context$1$0.t1);

        if (currentUrl.protocol === 'https:' && this.opts.httpsCallbackPort && this.opts.httpsCallbackAddress) {
          protocol = currentUrl.protocol;
          port = this.opts.httpsCallbackPort;
          address = this.opts.httpsCallbackAddress;
        }
        context$1$0.next = 19;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t2 = context$1$0['catch'](8);

      case 19:
        responseUrl = protocol + '//' + address + ':' + port + '/wd/hub/session/' + sessionId + '/receive_async_response';

        if (this.isRealDevice()) {
          defaultHost = this.opts.address;
          urlObject = _url2['default'].parse(responseUrl);

          if (urlObject.hostname === defaultHost) {
            _logger2['default'].debug('Real device safari test and no custom callback address ' + 'set, changing callback address to local ip.');
            urlObject.hostname = _appiumSupport.util.localIp();
            urlObject.host = null; // set to null, otherwise hostname is ignored
            responseUrl = _url2['default'].format(urlObject);
          } else {
            _logger2['default'].debug('Custom callback address set, leaving as is.');
          }
        }

        _logger2['default'].debug('Response url for executeAsync: ' + responseUrl);
        args = this.convertElementsForAtoms(args);
        this.asyncWaitMs = this.asyncWaitMs || 0;
        context$1$0.next = 26;
        return _regeneratorRuntime.awrap(this.executeAtomAsync('execute_async_script', [script, args, this.asyncWaitMs], responseUrl));

      case 26:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 27:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 17]]);
};

commands.receiveAsyncResponse = function callee$0$0(status, value) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Received async response: ' + JSON.stringify(value));
        if (!_lodash2['default'].isNull(this.asyncPromise) && !_lodash2['default'].isUndefined(this.asyncPromise)) {
          if (status !== 0) {
            this.asyncPromise.reject((0, _appiumBaseDriver.errorFromCode)(status, value.message));
          } else {
            this.asyncPromise.resolve(value);
          }
        } else {
          _logger2['default'].warn('Received async response when we were not expecting one! ' + ('Response was: ' + JSON.stringify(value)));
        }

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.startHttpsAsyncServer = function callee$0$0() {
  var address, port, _ref, sslServer, pemCertificate, httpsPort, udid;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Starting https server for async responses');
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _server.startHttpsServer)(port, address));

      case 5:
        _ref = context$1$0.sent;
        sslServer = _ref.sslServer;
        pemCertificate = _ref.pemCertificate;
        httpsPort = _ref.httpsPort;

        this.opts.sslServer = sslServer;
        this.opts.httpsServerCertificate = pemCertificate;
        this.opts.httpsCallbackPort = httpsPort;
        this.opts.httpsCallbackAddress = 'localhost';
        udid = undefined;

        if (this.sim) {
          // ios driver
          udid = this.sim.udid;
        } else {
          // xcuitest driver
          udid = this.opts.udid;
        }
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.installSSLCert)(this.opts.httpsServerCertificate, udid));

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopHttpsAsyncServer = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Stopping https server for async responses');

        if (!this.opts.sslServer) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.opts.sslServer.close());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.uninstallSSLCert)(this.opts.httpsServerCertificate, this.opts.udid));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeMobile = function callee$0$0(mobileCommand) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(mobileCommand === 'scroll')) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.mobileScroll(opts));

      case 3:
        context$1$0.next = 12;
        break;

      case 5:
        if (!(mobileCommand === 'viewportScreenshot')) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.getViewportScreenshot());

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
        throw new _appiumBaseDriver.errors.UnknownCommandError('Unknown command, all the mobile commands except scroll have been removed.');

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// we only support mobile: scroll
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9leGVjdXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBc0Msb0JBQW9COztzQkFDNUMsUUFBUTs7OzttQkFDTixLQUFLOzs7OzZCQUNBLGdCQUFnQjs7c0JBQ2xCLFdBQVc7Ozs7a0NBQ21CLHNCQUFzQjs7c0JBQ3RDLFdBQVc7O0FBRzVDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxPQUFPLEdBQUcsb0JBQWdCLE1BQU0sRUFBRSxJQUFJOzs7O2FBQ3pDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDOzs7OztBQUMzQixjQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7O3lDQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQzs7Ozs7O2FBRXJFLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7O0FBQ3JCLFlBQUksR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7O3lDQUM3QixJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDOzs7Ozs7O3lDQUVsRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7Ozs7Q0FHdkQsQ0FBQzs7QUFFRixRQUFRLENBQUMsWUFBWSxHQUFHLG9CQUFnQixNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVM7TUFLekQsT0FBTyxFQUNQLElBQUksRUFJSixRQUFRLEVBRU4sVUFBVSxFQU9aLFdBQVcsRUFHVCxXQUFXLEVBQ1gsU0FBUzs7OztZQXRCVixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1QsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDOzs7Ozs7QUFHaEQsZUFBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTztBQUN4RCxZQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJOztBQUNuRCxpQkFBUyxHQUFHLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDOzs7QUFHcEMsZ0JBQVEsR0FBRyxPQUFPOzs7O3lDQUVhLElBQUksQ0FBQyxNQUFNLEVBQUU7Ozs7QUFBMUMsa0JBQVUsa0JBQU8sS0FBSzs7QUFDMUIsWUFBSSxVQUFVLENBQUMsUUFBUSxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUU7QUFDckcsa0JBQVEsR0FBRyxVQUFVLENBQUMsUUFBUSxDQUFDO0FBQy9CLGNBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDO0FBQ25DLGlCQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztTQUMxQzs7Ozs7Ozs7O0FBRUMsbUJBQVcsR0FBTSxRQUFRLFVBQUssT0FBTyxTQUFJLElBQUksd0JBQW1CLFNBQVM7O0FBRTdFLFlBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFFO0FBQ25CLHFCQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPO0FBQy9CLG1CQUFTLEdBQUcsaUJBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQzs7QUFDdEMsY0FBSSxTQUFTLENBQUMsUUFBUSxLQUFLLFdBQVcsRUFBRTtBQUN0QyxnQ0FBTyxLQUFLLENBQUMseURBQXlELEdBQ3pELDZDQUE2QyxDQUFDLENBQUM7QUFDNUQscUJBQVMsQ0FBQyxRQUFRLEdBQUcsb0JBQUssT0FBTyxFQUFFLENBQUM7QUFDcEMscUJBQVMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ3RCLHVCQUFXLEdBQUcsaUJBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1dBQ3JDLE1BQU07QUFDTCxnQ0FBTyxLQUFLLENBQUMsNkNBQTZDLENBQUMsQ0FBQztXQUM3RDtTQUNGOztBQUVELDRCQUFPLEtBQUsscUNBQW1DLFdBQVcsQ0FBRyxDQUFDO0FBQzlELFlBQUksR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDMUMsWUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsQ0FBQzs7eUNBQzVCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFdBQVcsQ0FBQzs7Ozs7Ozs7OztDQUMxRyxDQUFDOztBQUVGLFFBQVEsQ0FBQyxvQkFBb0IsR0FBRyxvQkFBZ0IsTUFBTSxFQUFFLEtBQUs7Ozs7QUFDM0QsNEJBQU8sS0FBSywrQkFBNkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBRyxDQUFDO0FBQ2xFLFlBQUksQ0FBQyxvQkFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsb0JBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRTtBQUNyRSxjQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDaEIsZ0JBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLHFDQUFjLE1BQU0sRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztXQUNoRSxNQUFNO0FBQ0wsZ0JBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1dBQ2xDO1NBQ0YsTUFBTTtBQUNMLDhCQUFPLElBQUksQ0FBQyxpRkFDaUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBRSxDQUFDLENBQUM7U0FDdkQ7Ozs7Ozs7Q0FDRixDQUFDOztBQUVGLE9BQU8sQ0FBQyxxQkFBcUIsR0FBRztNQUUxQixPQUFPLEVBQ1AsSUFBSSxRQUNILFNBQVMsRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUtyQyxJQUFJOzs7OztBQVJSLDRCQUFPLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO0FBQ3RELGVBQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU87QUFDeEQsWUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTs7eUNBQ0EsOEJBQWlCLElBQUksRUFBRSxPQUFPLENBQUM7Ozs7QUFBN0UsaUJBQVMsUUFBVCxTQUFTO0FBQUUsc0JBQWMsUUFBZCxjQUFjO0FBQUUsaUJBQVMsUUFBVCxTQUFTOztBQUN6QyxZQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFDaEMsWUFBSSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxjQUFjLENBQUM7QUFDbEQsWUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxTQUFTLENBQUM7QUFDeEMsWUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxXQUFXLENBQUM7QUFDekMsWUFBSTs7QUFDUixZQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7O0FBRVosY0FBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1NBQ3RCLE1BQU07O0FBRUwsY0FBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3ZCOzt5Q0FDSyx3Q0FBZSxJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQzs7Ozs7OztDQUM3RCxDQUFDOztBQUVGLE9BQU8sQ0FBQyxvQkFBb0IsR0FBRzs7OztBQUM3Qiw0QkFBTyxLQUFLLENBQUMsMkNBQTJDLENBQUMsQ0FBQzs7YUFDdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTOzs7Ozs7eUNBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFOzs7O3lDQUU3QiwwQ0FBaUIsSUFBSSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzs7Ozs7OztDQUN6RSxDQUFDOztBQUVGLFFBQVEsQ0FBQyxhQUFhLEdBQUcsb0JBQWdCLGFBQWE7TUFBRSxJQUFJLHlEQUFDLEVBQUU7Ozs7Y0FFekQsYUFBYSxLQUFLLFFBQVEsQ0FBQTs7Ozs7O3lDQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQzs7Ozs7OztjQUNwQixhQUFhLEtBQUssb0JBQW9CLENBQUE7Ozs7Ozt5Q0FDbEMsSUFBSSxDQUFDLHFCQUFxQixFQUFFOzs7Ozs7Y0FFbkMsSUFBSSx5QkFBTyxtQkFBbUIsQ0FBQywyRUFBMkUsQ0FBQzs7Ozs7OztDQUVwSCxDQUFDOztBQUVGLGVBQWMsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO3FCQUNYLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2V4ZWN1dGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMsIGVycm9yRnJvbUNvZGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBpbnN0YWxsU1NMQ2VydCwgdW5pbnN0YWxsU1NMQ2VydCB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCB7IHN0YXJ0SHR0cHNTZXJ2ZXIgfSBmcm9tICcuLi9zZXJ2ZXInO1xuXG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMuZXhlY3V0ZSA9IGFzeW5jIGZ1bmN0aW9uIChzY3JpcHQsIGFyZ3MpIHtcbiAgaWYgKHNjcmlwdC5tYXRjaCgvXm1vYmlsZVxcOi8pKSB7XG4gICAgc2NyaXB0ID0gc2NyaXB0LnJlcGxhY2UoL15tb2JpbGVcXDovLCAnJykudHJpbSgpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVNb2JpbGUoc2NyaXB0LCBfLmlzQXJyYXkoYXJncykgPyBhcmdzWzBdIDogYXJncyk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgIGFyZ3MgPSB0aGlzLmNvbnZlcnRFbGVtZW50c0ZvckF0b21zKGFyZ3MpO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2V4ZWN1dGVfc2NyaXB0JywgW3NjcmlwdCwgYXJnc10pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoc2NyaXB0KTtcbiAgICB9XG4gIH1cbn07XG5cbmNvbW1hbmRzLmV4ZWN1dGVBc3luYyA9IGFzeW5jIGZ1bmN0aW9uIChzY3JpcHQsIGFyZ3MsIHNlc3Npb25JZCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoc2NyaXB0KTtcbiAgfVxuXG4gIGxldCBhZGRyZXNzID0gdGhpcy5vcHRzLmNhbGxiYWNrQWRkcmVzcyB8fCB0aGlzLm9wdHMuYWRkcmVzcztcbiAgbGV0IHBvcnQgPSB0aGlzLm9wdHMuY2FsbGJhY2tQb3J0IHx8IHRoaXMub3B0cy5wb3J0O1xuICBzZXNzaW9uSWQgPSBzZXNzaW9uSWQgfHwgdGhpcy5zZXNzaW9uSWQ7XG5cbiAgLy8gaHR0cHMgc2l0ZXMgbmVlZCB0byByZXBseSB0byBhbiBodHRwcyBlbmRwb2ludCwgaW4gU2FmYXJpXG4gIGxldCBwcm90b2NvbCA9ICdodHRwOic7XG4gIHRyeSB7XG4gICAgbGV0IGN1cnJlbnRVcmwgPSB1cmwucGFyc2UoYXdhaXQgdGhpcy5nZXRVcmwoKSk7XG4gICAgaWYgKGN1cnJlbnRVcmwucHJvdG9jb2wgPT09ICdodHRwczonICYmIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrUG9ydCAmJiB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja0FkZHJlc3MpIHtcbiAgICAgIHByb3RvY29sID0gY3VycmVudFVybC5wcm90b2NvbDtcbiAgICAgIHBvcnQgPSB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja1BvcnQ7XG4gICAgICBhZGRyZXNzID0gdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tBZGRyZXNzO1xuICAgIH1cbiAgfSBjYXRjaCAoaWduKSB7fVxuICBsZXQgcmVzcG9uc2VVcmwgPSBgJHtwcm90b2NvbH0vLyR7YWRkcmVzc306JHtwb3J0fS93ZC9odWIvc2Vzc2lvbi8ke3Nlc3Npb25JZH0vcmVjZWl2ZV9hc3luY19yZXNwb25zZWA7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsZXQgZGVmYXVsdEhvc3QgPSB0aGlzLm9wdHMuYWRkcmVzcztcbiAgICBsZXQgdXJsT2JqZWN0ID0gdXJsLnBhcnNlKHJlc3BvbnNlVXJsKTtcbiAgICBpZiAodXJsT2JqZWN0Lmhvc3RuYW1lID09PSBkZWZhdWx0SG9zdCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdSZWFsIGRldmljZSBzYWZhcmkgdGVzdCBhbmQgbm8gY3VzdG9tIGNhbGxiYWNrIGFkZHJlc3MgJyArXG4gICAgICAgICAgICAgICAgICAgJ3NldCwgY2hhbmdpbmcgY2FsbGJhY2sgYWRkcmVzcyB0byBsb2NhbCBpcC4nKTtcbiAgICAgIHVybE9iamVjdC5ob3N0bmFtZSA9IHV0aWwubG9jYWxJcCgpO1xuICAgICAgdXJsT2JqZWN0Lmhvc3QgPSBudWxsOyAvLyBzZXQgdG8gbnVsbCwgb3RoZXJ3aXNlIGhvc3RuYW1lIGlzIGlnbm9yZWRcbiAgICAgIHJlc3BvbnNlVXJsID0gdXJsLmZvcm1hdCh1cmxPYmplY3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0N1c3RvbSBjYWxsYmFjayBhZGRyZXNzIHNldCwgbGVhdmluZyBhcyBpcy4nKTtcbiAgICB9XG4gIH1cblxuICBsb2dnZXIuZGVidWcoYFJlc3BvbnNlIHVybCBmb3IgZXhlY3V0ZUFzeW5jOiAke3Jlc3BvbnNlVXJsfWApO1xuICBhcmdzID0gdGhpcy5jb252ZXJ0RWxlbWVudHNGb3JBdG9tcyhhcmdzKTtcbiAgdGhpcy5hc3luY1dhaXRNcyA9IHRoaXMuYXN5bmNXYWl0TXMgfHwgMDtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b21Bc3luYygnZXhlY3V0ZV9hc3luY19zY3JpcHQnLCBbc2NyaXB0LCBhcmdzLCB0aGlzLmFzeW5jV2FpdE1zXSwgcmVzcG9uc2VVcmwpO1xufTtcblxuY29tbWFuZHMucmVjZWl2ZUFzeW5jUmVzcG9uc2UgPSBhc3luYyBmdW5jdGlvbiAoc3RhdHVzLCB2YWx1ZSkge1xuICBsb2dnZXIuZGVidWcoYFJlY2VpdmVkIGFzeW5jIHJlc3BvbnNlOiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gKTtcbiAgaWYgKCFfLmlzTnVsbCh0aGlzLmFzeW5jUHJvbWlzZSkgJiYgIV8uaXNVbmRlZmluZWQodGhpcy5hc3luY1Byb21pc2UpKSB7XG4gICAgaWYgKHN0YXR1cyAhPT0gMCkge1xuICAgICAgdGhpcy5hc3luY1Byb21pc2UucmVqZWN0KGVycm9yRnJvbUNvZGUoc3RhdHVzLCB2YWx1ZS5tZXNzYWdlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYXN5bmNQcm9taXNlLnJlc29sdmUodmFsdWUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIud2FybihgUmVjZWl2ZWQgYXN5bmMgcmVzcG9uc2Ugd2hlbiB3ZSB3ZXJlIG5vdCBleHBlY3Rpbmcgb25lISBgICtcbiAgICAgICAgICAgICAgICBgUmVzcG9uc2Ugd2FzOiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gKTtcbiAgfVxufTtcblxuaGVscGVycy5zdGFydEh0dHBzQXN5bmNTZXJ2ZXIgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnU3RhcnRpbmcgaHR0cHMgc2VydmVyIGZvciBhc3luYyByZXNwb25zZXMnKTtcbiAgbGV0IGFkZHJlc3MgPSB0aGlzLm9wdHMuY2FsbGJhY2tBZGRyZXNzIHx8IHRoaXMub3B0cy5hZGRyZXNzO1xuICBsZXQgcG9ydCA9IHRoaXMub3B0cy5jYWxsYmFja1BvcnQgfHwgdGhpcy5vcHRzLnBvcnQ7XG4gIGxldCB7c3NsU2VydmVyLCBwZW1DZXJ0aWZpY2F0ZSwgaHR0cHNQb3J0fSA9IGF3YWl0IHN0YXJ0SHR0cHNTZXJ2ZXIocG9ydCwgYWRkcmVzcyk7XG4gIHRoaXMub3B0cy5zc2xTZXJ2ZXIgPSBzc2xTZXJ2ZXI7XG4gIHRoaXMub3B0cy5odHRwc1NlcnZlckNlcnRpZmljYXRlID0gcGVtQ2VydGlmaWNhdGU7XG4gIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrUG9ydCA9IGh0dHBzUG9ydDtcbiAgdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tBZGRyZXNzID0gJ2xvY2FsaG9zdCc7XG4gIGxldCB1ZGlkO1xuICBpZiAodGhpcy5zaW0pIHtcbiAgICAvLyBpb3MgZHJpdmVyXG4gICAgdWRpZCA9IHRoaXMuc2ltLnVkaWQ7XG4gIH0gZWxzZSB7XG4gICAgLy8geGN1aXRlc3QgZHJpdmVyXG4gICAgdWRpZCA9IHRoaXMub3B0cy51ZGlkO1xuICB9XG4gIGF3YWl0IGluc3RhbGxTU0xDZXJ0KHRoaXMub3B0cy5odHRwc1NlcnZlckNlcnRpZmljYXRlLCB1ZGlkKTtcbn07XG5cbmhlbHBlcnMuc3RvcEh0dHBzQXN5bmNTZXJ2ZXIgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnU3RvcHBpbmcgaHR0cHMgc2VydmVyIGZvciBhc3luYyByZXNwb25zZXMnKTtcbiAgaWYgKHRoaXMub3B0cy5zc2xTZXJ2ZXIpIHtcbiAgICBhd2FpdCB0aGlzLm9wdHMuc3NsU2VydmVyLmNsb3NlKCk7XG4gIH1cbiAgYXdhaXQgdW5pbnN0YWxsU1NMQ2VydCh0aGlzLm9wdHMuaHR0cHNTZXJ2ZXJDZXJ0aWZpY2F0ZSwgdGhpcy5vcHRzLnVkaWQpO1xufTtcblxuY29tbWFuZHMuZXhlY3V0ZU1vYmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChtb2JpbGVDb21tYW5kLCBvcHRzPXt9KSB7XG4gIC8vIHdlIG9ubHkgc3VwcG9ydCBtb2JpbGU6IHNjcm9sbFxuICBpZiAobW9iaWxlQ29tbWFuZCA9PT0gJ3Njcm9sbCcpIHtcbiAgICBhd2FpdCB0aGlzLm1vYmlsZVNjcm9sbChvcHRzKTtcbiAgfSBlbHNlIGlmIChtb2JpbGVDb21tYW5kID09PSAndmlld3BvcnRTY3JlZW5zaG90Jykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFZpZXdwb3J0U2NyZWVuc2hvdCgpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkNvbW1hbmRFcnJvcignVW5rbm93biBjb21tYW5kLCBhbGwgdGhlIG1vYmlsZSBjb21tYW5kcyBleGNlcHQgc2Nyb2xsIGhhdmUgYmVlbiByZW1vdmVkLicpO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
