'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require("js2xmlparser2");

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

var _nodeSimctl = require('node-simctl');

var commands = {},
    helpers = {},
    extensions = {};

commands.active = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('active_element', []));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getActiveElement()"));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getDeviceTime = function callee$0$0() {
  var idevicedate, _ref, stdout, date, dateStr;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Attempting to capture iOS device date and time');

        if (!this.isRealDevice()) {
          context$1$0.next = 31;
          break;
        }

        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevicedate'));

      case 5:
        idevicedate = context$1$0.sent;

        _logger2['default'].info('Found idevicedate: \'' + idevicedate + '\'');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(idevicedate, ['-u', this.opts.udid]));

      case 9:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        stdout = stdout.trim();
        context$1$0.prev = 12;
        date = new Date(stdout);
        dateStr = date.toString();

        if (!(dateStr === 'Invalid Date')) {
          context$1$0.next = 17;
          break;
        }

        throw new Error('Unable to parse idevicedate output');

      case 17:
        return context$1$0.abrupt('return', dateStr);

      case 20:
        context$1$0.prev = 20;
        context$1$0.t0 = context$1$0['catch'](12);

        // sometimes `idevicedate` returns an un-parsable format
        // in which case, we just want to return the output and
        // let the client deal with it
        _logger2['default'].debug('Unable to parse date \'' + stdout + '\'. Returning as is');
        return context$1$0.abrupt('return', stdout);

      case 24:
        context$1$0.next = 29;
        break;

      case 26:
        context$1$0.prev = 26;
        context$1$0.t1 = context$1$0['catch'](2);

        _logger2['default'].errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');

      case 29:
        context$1$0.next = 33;
        break;

      case 31:
        _logger2['default'].warn('On simulator. Assuming device time is the same as host time');
        return context$1$0.abrupt('return', new Date().toString());

      case 33:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 26], [12, 20]]);
};

commands.hideKeyboard = function callee$0$0(strategy) {
  for (var _len = arguments.length, possibleKeys = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    possibleKeys[_key - 1] = arguments[_key];
  }

  var cmd, key;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        possibleKeys.pop(); // last parameter is the session id
        cmd = undefined;
        key = _lodash2['default'].find(possibleKeys, function (k) {
          return k;
        });

        if (key) {
          strategy = strategy || 'pressKey';
          cmd = 'au.hideKeyboard(\'' + strategy + '\', \'' + key + '\')';
        } else {
          strategy = strategy || 'default';
          cmd = 'au.hideKeyboard(\'' + strategy + '\')';
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(cmd));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getPageSource = function callee$0$0() {
  var script;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        script = 'return document.documentElement.outerHTML';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getNativePageSource());

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getNativePageSource = function callee$0$0() {
  var jsonSource, xmlSource;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML());

      case 2:
        jsonSource = context$1$0.sent;

        if (typeof jsonSource === "string") {
          jsonSource = JSON.parse(jsonSource);
        }
        xmlSource = (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
          wrapArray: { enabled: false, elementName: "element" },
          declaration: { include: true },
          prettyPrinting: { indentString: "    " }
        });
        return context$1$0.abrupt('return', xmlSource);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.background = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.background(' + secs + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.lock = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!secs) {
          _logger2['default'].debug('No seconds parameter. Using 0 seconds');
          secs = 0;
        }
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.lock(' + secs + ')'));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.closeApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.stop());

      case 4:
        _logger2['default'].info('Successfully closed the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while closing the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.launchApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.start());

      case 4:
        _logger2['default'].info('Successfully launched the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while launching the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.removeApp = function callee$0$0(bundleId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isRealDevice()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.realDevice.remove(bundleId));

      case 3:
        context$1$0.next = 7;
        break;

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.sim.removeApp(bundleId));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.keys = function callee$0$0(keys) {
  var el, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.active());

      case 3:
        el = context$1$0.sent;

        if (!_lodash2['default'].isUndefined(el.ELEMENT)) {
          context$1$0.next = 6;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.setValue(keys, el.ELEMENT));

      case 8:
        context$1$0.next = 16;
        break;

      case 10:
        if (_lodash2['default'].isArray(keys)) {
          keys = keys.join('');
        }
        if (!_lodash2['default'].isString(keys)) {
          keys = keys.toString();
        }
        keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
        command = 'au.sendKeysToActiveElement(\'' + keys + '\')';
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setGeoLocation = function callee$0$0(location) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('target.setLocation(' + JSON.stringify(location) + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

//}
commands.getWindowSize = function callee$0$0() {
  var windowHandle = arguments.length <= 0 || arguments[0] === undefined ? "current" : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(windowHandle !== "current")) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError("Currently only getting current window size is supported.");

      case 2:
        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_window_size', []));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getWindowSize()"));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// For W3C
commands.getWindowRect = function callee$0$0() {
  var _ref2, width, height;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getWindowSize());

      case 2:
        _ref2 = context$1$0.sent;
        width = _ref2.width;
        height = _ref2.height;
        return context$1$0.abrupt('return', {
          width: width,
          height: height,
          x: 0,
          y: 0
        });

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getStrings = function callee$0$0(language) {
  var stringFile = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var strings;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Gettings strings for language \'' + language + '\' and string file \'' + stringFile + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(_lodash2['default'].defaults({ language: language, stringFile: stringFile }, this.opts)));

      case 3:
        strings = context$1$0.sent;

        if (strings && strings.length >= 1) {
          strings = strings[0];
        }
        return context$1$0.abrupt('return', strings);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setUrl = function callee$0$0(url) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Attempting to set url \'' + url + '\'');

        if (this.isWebContext()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, url));

      case 4:
        return context$1$0.abrupt('return');

      case 5:
        this.setCurrentUrl(url);
        // make sure to clear out any leftover web frames
        this.curWebFrames = [];
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.remote.navToUrl(url));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// TODO: check the hasOptions bit, the method signature should be location, option

//let hasOptions = altitude !== null || horizontalAccuracy !== null || verticalAccuracy !== null || course !== null || speed !== null;
//if (hasOptions) {
//let options = {};
//if (altitude !== null) {
//options.altitude = altitude;
//}
//if (horizontalAccuracy !== null) {
//options.horizontalAccuracy = horizontalAccuracy;
//}
//if (verticalAccuracy !== null) {
//options.verticalAccuracy = verticalAccuracy;
//}
//if (course !== null) {
//options.course = course;
//}
//if (speed !== null) {
//options.speed = speed;
//}
//await this.uiAutoClient.sendCommand(
//`target.setLocationWithOptions(${JSON.stringify(coordinates)}, ${JSON.stringify(options)})`);
//} else {
// use xcrun to open deeplink
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COztzQkFDN0IsUUFBUTs7Ozs2QkFDSCxlQUFlOzs7O3NCQUNsQixXQUFXOzs7OzZCQUNGLGdCQUFnQjs7NEJBQ3BCLGNBQWM7O3FCQUNqQixVQUFVOzs7OzBCQUNKLGFBQWE7O0FBRXJDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxNQUFNLEdBQUc7Ozs7YUFDWixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7Ozs7Ozs7eUNBRXRDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDOzs7Ozs7Ozs7O0NBRXRFLENBQUM7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRztNQUlmLFdBQVcsUUFFVixNQUFNLEVBR0wsSUFBSSxFQUNKLE9BQU87Ozs7O0FBVGpCLDRCQUFJLElBQUksQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDOzthQUN2RCxJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7O3lDQUVLLGtCQUFHLEtBQUssQ0FBQyxhQUFhLENBQUM7OztBQUEzQyxtQkFBVzs7QUFDZiw0QkFBSSxJQUFJLDJCQUF3QixXQUFXLFFBQUksQ0FBQzs7eUNBQzNCLHdCQUFLLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOzs7O0FBQXpELGNBQU0sUUFBTixNQUFNOztBQUNYLGNBQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7O0FBRWpCLFlBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDdkIsZUFBTyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUU7O2NB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aW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQganMyeG1sIGZyb20gXCJqczJ4bWxwYXJzZXIyXCI7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHV0aWxzIGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IG9wZW5VcmwgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMuYWN0aXZlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdhY3RpdmVfZWxlbWVudCcsIFtdKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoXCJhdS5nZXRBY3RpdmVFbGVtZW50KClcIik7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZy5pbmZvKCdBdHRlbXB0aW5nIHRvIGNhcHR1cmUgaU9TIGRldmljZSBkYXRlIGFuZCB0aW1lJyk7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBpZGV2aWNlZGF0ZSA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlZGF0ZScpO1xuICAgICAgbG9nLmluZm8oYEZvdW5kIGlkZXZpY2VkYXRlOiAnJHtpZGV2aWNlZGF0ZX0nYCk7XG4gICAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGlkZXZpY2VkYXRlLCBbJy11JywgdGhpcy5vcHRzLnVkaWRdKTtcbiAgICAgIHN0ZG91dCA9IHN0ZG91dC50cmltKCk7XG4gICAgICB0cnkge1xuICAgICAgICBsZXQgZGF0ZSA9IG5ldyBEYXRlKHN0ZG91dCk7XG4gICAgICAgIGxldCBkYXRlU3RyID0gZGF0ZS50b1N0cmluZygpO1xuICAgICAgICBpZiAoZGF0ZVN0ciA9PT0gJ0ludmFsaWQgRGF0ZScpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBwYXJzZSBpZGV2aWNlZGF0ZSBvdXRwdXQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGF0ZVN0cjtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBzb21ldGltZXMgYGlkZXZpY2VkYXRlYCByZXR1cm5zIGFuIHVuLXBhcnNhYmxlIGZvcm1hdFxuICAgICAgICAvLyBpbiB3aGljaCBjYXNlLCB3ZSBqdXN0IHdhbnQgdG8gcmV0dXJuIHRoZSBvdXRwdXQgYW5kXG4gICAgICAgIC8vIGxldCB0aGUgY2xpZW50IGRlYWwgd2l0aCBpdFxuICAgICAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBwYXJzZSBkYXRlICcke3N0ZG91dH0nLiBSZXR1cm5pbmcgYXMgaXNgKTtcbiAgICAgICAgcmV0dXJuIHN0ZG91dDtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgY2FwdHVyZSBkZXZpY2UgZGF0ZSBhbmQgdGltZSB1c2luZyBsaWJpbW9iaWxlZGV2aWNlIGlkZXZpY2VkYXRlLiAnICtcbiAgICAgICAgICAgICAgICAgICAgICdMaWJpbW9iaWxlZGV2aWNlIGlzIHByb2JhYmx5IG5vdCBpbnN0YWxsZWQnKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLndhcm4oJ09uIHNpbXVsYXRvci4gQXNzdW1pbmcgZGV2aWNlIHRpbWUgaXMgdGhlIHNhbWUgYXMgaG9zdCB0aW1lJyk7XG4gICAgcmV0dXJuIG5ldyBEYXRlKCkudG9TdHJpbmcoKTtcbiAgfVxufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBsZXQgY21kO1xuICBsZXQga2V5ID0gXy5maW5kKHBvc3NpYmxlS2V5cywgKGspID0+IHtyZXR1cm4gazt9KTtcbiAgaWYgKGtleSkge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ3ByZXNzS2V5JztcbiAgICBjbWQgPSBgYXUuaGlkZUtleWJvYXJkKCcke3N0cmF0ZWd5fScsICcke2tleX0nKWA7XG4gIH0gZWxzZSB7XG4gICAgc3RyYXRlZ3kgPSBzdHJhdGVneSB8fCAnZGVmYXVsdCc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nKWA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY21kKTtcbn07XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgY29uc3Qgc2NyaXB0ID0gJ3JldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub3V0ZXJIVE1MJztcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbXV0pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldE5hdGl2ZVBhZ2VTb3VyY2UoKTtcbiAgfVxufTtcblxuaGVscGVycy5nZXROYXRpdmVQYWdlU291cmNlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQganNvblNvdXJjZSA9IGF3YWl0IHRoaXMuZ2V0U291cmNlRm9yRWxlbWVudEZvclhNTCgpO1xuICBpZiAodHlwZW9mIGpzb25Tb3VyY2UgPT09IFwic3RyaW5nXCIpIHtcbiAgICBqc29uU291cmNlID0gSlNPTi5wYXJzZShqc29uU291cmNlKTtcbiAgfVxuICBsZXQgeG1sU291cmNlID0ganMyeG1sKFwiQXBwaXVtQVVUXCIsIGpzb25Tb3VyY2UsIHtcbiAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6IFwiZWxlbWVudFwifSxcbiAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgIHByZXR0eVByaW50aW5nOiB7aW5kZW50U3RyaW5nOiBcIiAgICBcIn1cbiAgfSk7XG4gIHJldHVybiB4bWxTb3VyY2U7XG59O1xuXG5jb21tYW5kcy5iYWNrZ3JvdW5kID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmJhY2tncm91bmQoJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmxvY2sgPSBhc3luYyBmdW5jdGlvbiAoc2Vjcykge1xuICBpZiAoIXNlY3MpIHtcbiAgICBsb2cuZGVidWcoJ05vIHNlY29uZHMgcGFyYW1ldGVyLiBVc2luZyAwIHNlY29uZHMnKTtcbiAgICBzZWNzID0gMDtcbiAgfVxuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgYXUubG9jaygke3NlY3N9KWApO1xufTtcblxuY29tbWFuZHMuY2xvc2VBcHAgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBhcHBOYW1lID0gdGhpcy5vcHRzLmFwcCB8fCB0aGlzLm9wdHMuYnVuZGxlSWQ7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBjbG9zZWQgdGhlICcke2FwcE5hbWV9JyBhcHAuYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBjbG9zaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RhcnQoKTtcbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IGxhdW5jaGVkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgbGF1bmNoaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMucmVtb3ZlQXBwID0gYXN5bmMgZnVuY3Rpb24gKGJ1bmRsZUlkKSB7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgYXdhaXQgdGhpcy5yZWFsRGV2aWNlLnJlbW92ZShidW5kbGVJZCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5zaW0ucmVtb3ZlQXBwKGJ1bmRsZUlkKTtcbiAgfVxufTtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIChrZXlzKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGVsID0gYXdhaXQgdGhpcy5hY3RpdmUoKTtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChlbC5FTEVNRU5UKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5zZXRWYWx1ZShrZXlzLCBlbC5FTEVNRU5UKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoXy5pc0FycmF5KGtleXMpKSB7XG4gICAgICBrZXlzID0ga2V5cy5qb2luKCcnKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzU3RyaW5nKGtleXMpKSB7XG4gICAgICBrZXlzID0ga2V5cy50b1N0cmluZygpO1xuICAgIH1cbiAgICBrZXlzID0gdXRpbC5lc2NhcGVTcGVjaWFsQ2hhcnMoa2V5cywgXCInXCIpO1xuICAgIGxldCBjb21tYW5kID0gYGF1LnNlbmRLZXlzVG9BY3RpdmVFbGVtZW50KCcke2tleXN9JylgO1xuICAgIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5zZXRHZW9Mb2NhdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIChsb2NhdGlvbikge1xuICAvLyBUT0RPOiBjaGVjayB0aGUgaGFzT3B0aW9ucyBiaXQsIHRoZSBtZXRob2Qgc2lnbmF0dXJlIHNob3VsZCBiZSBsb2NhdGlvbiwgb3B0aW9uXG5cbiAgLy9sZXQgaGFzT3B0aW9ucyA9IGFsdGl0dWRlICE9PSBudWxsIHx8IGhvcml6b250YWxBY2N1cmFjeSAhPT0gbnVsbCB8fCB2ZXJ0aWNhbEFjY3VyYWN5ICE9PSBudWxsIHx8IGNvdXJzZSAhPT0gbnVsbCB8fCBzcGVlZCAhPT0gbnVsbDtcbiAgLy9pZiAoaGFzT3B0aW9ucykge1xuICAgIC8vbGV0IG9wdGlvbnMgPSB7fTtcbiAgICAvL2lmIChhbHRpdHVkZSAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLmFsdGl0dWRlID0gYWx0aXR1ZGU7XG4gICAgLy99XG4gICAgLy9pZiAoaG9yaXpvbnRhbEFjY3VyYWN5ICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuaG9yaXpvbnRhbEFjY3VyYWN5ID0gaG9yaXpvbnRhbEFjY3VyYWN5O1xuICAgIC8vfVxuICAgIC8vaWYgKHZlcnRpY2FsQWNjdXJhY3kgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy52ZXJ0aWNhbEFjY3VyYWN5ID0gdmVydGljYWxBY2N1cmFjeTtcbiAgICAvL31cbiAgICAvL2lmIChjb3Vyc2UgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy5jb3Vyc2UgPSBjb3Vyc2U7XG4gICAgLy99XG4gICAgLy9pZiAoc3BlZWQgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy5zcGVlZCA9IHNwZWVkO1xuICAgIC8vfVxuICAgIC8vYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoXG4gICAgICAvL2B0YXJnZXQuc2V0TG9jYXRpb25XaXRoT3B0aW9ucygke0pTT04uc3RyaW5naWZ5KGNvb3JkaW5hdGVzKX0sICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucyl9KWApO1xuICAvL30gZWxzZSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGB0YXJnZXQuc2V0TG9jYXRpb24oJHtKU09OLnN0cmluZ2lmeShsb2NhdGlvbil9KWApO1xuICAvL31cbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd1NpemUgPSBhc3luYyBmdW5jdGlvbiAod2luZG93SGFuZGxlPVwiY3VycmVudFwiKSB7XG4gIGlmICh3aW5kb3dIYW5kbGUgIT09IFwiY3VycmVudFwiKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKFwiQ3VycmVudGx5IG9ubHkgZ2V0dGluZyBjdXJyZW50IHdpbmRvdyBzaXplIGlzIHN1cHBvcnRlZC5cIik7XG4gIH1cblxuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfd2luZG93X3NpemUnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFwiYXUuZ2V0V2luZG93U2l6ZSgpXCIpO1xuICB9XG59O1xuXG4vLyBGb3IgVzNDXG5jb21tYW5kcy5nZXRXaW5kb3dSZWN0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgeDogMCxcbiAgICB5OiAwXG4gIH07XG59O1xuXG5jb21tYW5kcy5nZXRTdHJpbmdzID0gYXN5bmMgZnVuY3Rpb24gKGxhbmd1YWdlLCBzdHJpbmdGaWxlID0gbnVsbCkge1xuICBsb2cuZGVidWcoYEdldHRpbmdzIHN0cmluZ3MgZm9yIGxhbmd1YWdlICcke2xhbmd1YWdlfScgYW5kIHN0cmluZyBmaWxlICcke3N0cmluZ0ZpbGV9J2ApO1xuICBsZXQgc3RyaW5ncyA9IGF3YWl0IHV0aWxzLnBhcnNlTG9jYWxpemFibGVTdHJpbmdzKF8uZGVmYXVsdHMoe2xhbmd1YWdlLCBzdHJpbmdGaWxlfSwgdGhpcy5vcHRzKSk7XG4gIGlmIChzdHJpbmdzICYmIHN0cmluZ3MubGVuZ3RoID49IDEpIHtcbiAgICBzdHJpbmdzID0gc3RyaW5nc1swXTtcbiAgfVxuICByZXR1cm4gc3RyaW5ncztcbn07XG5cbmNvbW1hbmRzLnNldFVybCA9IGFzeW5jIGZ1bmN0aW9uICh1cmwpIHtcbiAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHNldCB1cmwgJyR7dXJsfSdgKTtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgLy8gdXNlIHhjcnVuIHRvIG9wZW4gZGVlcGxpbmtcbiAgICBhd2FpdCBvcGVuVXJsKHRoaXMub3B0cy51ZGlkIHx8IHRoaXMuc2ltLnVkaWQsIHVybCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIHRoaXMuc2V0Q3VycmVudFVybCh1cmwpO1xuICAvLyBtYWtlIHN1cmUgdG8gY2xlYXIgb3V0IGFueSBsZWZ0b3ZlciB3ZWIgZnJhbWVzXG4gIHRoaXMuY3VyV2ViRnJhbWVzID0gW107XG4gIGF3YWl0IHRoaXMucmVtb3RlLm5hdlRvVXJsKHVybCk7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
