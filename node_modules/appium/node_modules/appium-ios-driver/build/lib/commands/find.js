'use strict';

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require('js2xmlparser2');

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _xmldom = require('xmldom');

var _xmldom2 = _interopRequireDefault(_xmldom);

var _xpath = require('xpath');

var _xpath2 = _interopRequireDefault(_xpath);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _utils = require('../utils');

// we override the xpath search for this first-visible-child selector, which
// looks like /*[@firstVisible="true"]
var MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible ?= ?('|")true\1\]/;

// we likewise override xpath search to provide a shortcut for finding all
// scrollable elements
var MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable ?= ?('|")true\1\]/;

var commands = {},
    helpers = {},
    extensions = {};

helpers.findElOrEls = function callee$0$0(strategy, selector, mult, context) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context = (0, _utils.unwrapEl)(context);

        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.findWebElementOrElements(strategy, selector, mult, context));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.findUIElementOrElements(strategy, selector, mult, context));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.findUIElementOrElements = function callee$0$0(strategy, selector, mult, context) {
  var createGetElementCommand, getLocalizedStringForSelector, res, doFind;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (strategy !== "xpath") {
          selector = _appiumSupport.util.escapeSpecialChars(selector, "'");
        }

        if (typeof context === "undefined" || !context) {
          context = '';
        } else if (typeof context === "string") {
          context = _appiumSupport.util.escapeSpecialChars(context, "'");
        }

        if (!(strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector))) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.findScrollableElOrEls(mult, context));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        if (!(strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector))) {
          context$1$0.next = 12;
          break;
        }

        if (!mult) {
          context$1$0.next = 9;
          break;
        }

        throw new Error("Cannot get multiple first children");

      case 9:
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.getFirstVisibleChild(context));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 12:
        if (!(strategy === 'class name' && selector.indexOf('UIA') !== 0)) {
          context$1$0.next = 14;
          break;
        }

        throw new _appiumBaseDriver.errors.InvalidSelectorError('The class name selector must use full UIA class names. Try \'UIA' + selector + '\' instead.');

      case 14:

        if (!selector) new _appiumBaseDriver.errors.InvalidSelectorError('Missing selector'); // eslint-disable-line curly

        createGetElementCommand = function createGetElementCommand(strategy, selector, mult, context) {
          var ext = mult ? 's' : '';
          var command = "";
          context = !context ? context : ', \'' + context + '\'';
          switch (strategy) {
            case "name":
              command = 'au.getElement' + ext + 'ByName(\'' + selector + '\'' + context + ')';
              break;
            case "accessibility id":
              command = 'au.getElement' + ext + 'ByAccessibilityId(\'' + selector + '\'' + context + ')';
              break;
            case "id":
              command = 'au.getElement' + ext + 'ById(\'' + selector + '\')';
              break;
            case "-ios uiautomation":
              command = 'au.getElement' + ext + 'ByUIAutomation(\'' + selector + '\'' + context + ')';
              break;
            default:
              command = 'au.getElement' + ext + 'ByType(\'' + selector + '\'' + context + ')';
          }

          return command;
        };

        getLocalizedStringForSelector = function getLocalizedStringForSelector(selector, strings) {
          var newSelector = selector;
          if (strings) {
            var localizedSelector = strings[selector];
            if (localizedSelector) {
              newSelector = localizedSelector;
            } else {
              _logger2['default'].debug('Id selector, \'' + selector + '\', not found in Localizable.strings.');
            }
          }

          return newSelector;
        };

        res = undefined;

        doFind = function doFind() {
          var findByAxIdCmd, findByIdCmd, command;
          return _regeneratorRuntime.async(function doFind$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                if (!(strategy === "xpath")) {
                  context$2$0.next = 6;
                  break;
                }

                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(this.findUIElementsByXpath(selector, mult, context));

              case 3:
                res = context$2$0.sent;
                context$2$0.next = 22;
                break;

              case 6:
                if (!(strategy === "id")) {
                  context$2$0.next = 18;
                  break;
                }

                findByAxIdCmd = createGetElementCommand("accessibility id", selector, mult, context);
                context$2$0.next = 10;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(findByAxIdCmd));

              case 10:
                res = context$2$0.sent;

                if (res && _lodash2['default'].size(res) > 0) {
                  context$2$0.next = 16;
                  break;
                }

                findByIdCmd = createGetElementCommand("id", getLocalizedStringForSelector(selector, this.opts.localizableStrings), mult, context);
                context$2$0.next = 15;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(findByIdCmd));

              case 15:
                res = context$2$0.sent;

              case 16:
                context$2$0.next = 22;
                break;

              case 18:
                command = createGetElementCommand(strategy, selector, mult, context);
                context$2$0.next = 21;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

              case 21:
                res = context$2$0.sent;

              case 22:
                return context$2$0.abrupt('return', _lodash2['default'].size(res) > 0);

              case 23:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 19;
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.implicitWaitForCondition(doFind));

      case 22:
        context$1$0.next = 31;
        break;

      case 24:
        context$1$0.prev = 24;
        context$1$0.t0 = context$1$0['catch'](19);

        if (!(context$1$0.t0.message && context$1$0.t0.message.match(/Condition unmet/))) {
          context$1$0.next = 30;
          break;
        }

        // condition was not met setting res to empty array
        res = [];
        context$1$0.next = 31;
        break;

      case 30:
        throw context$1$0.t0;

      case 31:
        if (!mult) {
          context$1$0.next = 35;
          break;
        }

        return context$1$0.abrupt('return', res);

      case 35:
        if (!(!res || _lodash2['default'].size(res) === 0)) {
          context$1$0.next = 37;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 37:
        return context$1$0.abrupt('return', res);

      case 38:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[19, 24]]);
};

var _pathFromDomNode = function _pathFromDomNode(node) {
  var path = null;
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].values(node.attributes)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var attrObj = _step.value;

      if (attrObj.name === "path") {
        path = attrObj.value;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return path;
};

var _xmlSourceFromJson = function _xmlSourceFromJson(jsonSource) {
  if (typeof jsonSource === "string") {
    jsonSource = JSON.parse(jsonSource);
  }
  return (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
    wrapArray: { enabled: false, elementName: "element" },
    declaration: { include: true },
    prettyPrinting: { indentString: "    " }
  });
};

var _performXpathQueryOnJson = function _performXpathQueryOnJson(selector, jsonSource) {
  var xmlSource = _xmlSourceFromJson(jsonSource);
  var dom = new _xmldom2['default'].DOMParser().parseFromString(xmlSource);
  return _xpath2['default'].select(selector, dom);
};

commands.findUIElementsByXpath = function callee$0$0(selector, mult) {
  var context = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
  var curRetry = arguments.length <= 3 || arguments[3] === undefined ? 1 : arguments[3];

  var sourceXml, selectedNodes, indexPaths, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, node, ip, methodName, methodArgs, proxyCmd, res;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        sourceXml = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML(context));

      case 4:
        sourceXml = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn("Error getting source, can't continue finding element by XPath");
        throw context$1$0.t0;

      case 11:
        selectedNodes = _performXpathQueryOnJson(selector, sourceXml);

        if (!mult) {
          selectedNodes = selectedNodes.slice(0, 1);
        }
        indexPaths = [];
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 17;

        // filter out elements without 'path' attribute
        for (_iterator2 = _getIterator(selectedNodes); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          node = _step2.value;
          ip = _pathFromDomNode(node);

          if (ip !== null) {
            indexPaths.push(ip);
          }
        }

        context$1$0.next = 25;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t1 = context$1$0['catch'](17);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t1;

      case 25:
        context$1$0.prev = 25;
        context$1$0.prev = 26;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 28:
        context$1$0.prev = 28;

        if (!_didIteratorError2) {
          context$1$0.next = 31;
          break;
        }

        throw _iteratorError2;

      case 31:
        return context$1$0.finish(28);

      case 32:
        return context$1$0.finish(25);

      case 33:
        if (!(indexPaths.length < 1)) {
          context$1$0.next = 35;
          break;
        }

        return context$1$0.abrupt('return', []);

      case 35:
        methodName = undefined;
        methodArgs = [];

        if (!mult) {
          methodName = "getElementByIndexPath";
          methodArgs[0] = '\'' + indexPaths[0] + '\'';
        } else {
          methodName = "getElementsByIndexPaths";
          methodArgs[0] = JSON.stringify(indexPaths);
        }

        if (context) {
          methodArgs[1] = 'au.getElement(\'' + context + '\')';
        }

        proxyCmd = 'au.' + methodName + '(' + methodArgs.join(", ") + ')';
        res = undefined;
        context$1$0.prev = 41;
        context$1$0.next = 44;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(proxyCmd));

      case 44:
        res = context$1$0.sent;
        context$1$0.next = 57;
        break;

      case 47:
        context$1$0.prev = 47;
        context$1$0.t2 = context$1$0['catch'](41);

        if (!(curRetry < 3)) {
          context$1$0.next = 56;
          break;
        }

        _logger2['default'].debug("Got a warning from uiauto that some index paths " + "could not be resolved, trying again");
        context$1$0.next = 53;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(300));

      case 53:
        context$1$0.next = 55;
        return _regeneratorRuntime.awrap(this.findUIElementsByXpath(selector, mult, context, curRetry + 1));

      case 55:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 56:
        throw context$1$0.t2;

      case 57:
        return context$1$0.abrupt('return', res);

      case 58:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7], [17, 21, 25, 33], [26,, 28, 32], [41, 47]]);
};

helpers.findScrollableElOrEls = function callee$0$0(mult, context) {
  var scrollTypes, res, ext, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, scrollType, command, elements, element;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        scrollTypes = ['UIAScrollView', 'UIATableView', 'UIACollectionView', 'UIAWebView'];
        res = [];
        ext = mult ? 's' : '';
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 6;
        _iterator3 = _getIterator(scrollTypes);

      case 8:
        if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
          context$1$0.next = 26;
          break;
        }

        scrollType = _step3.value;
        command = 'au.getElement' + ext + 'ByType(\'' + scrollType + '\'' + context + ')';

        if (!mult) {
          context$1$0.next = 18;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 14:
        elements = context$1$0.sent;

        if (!_lodash2['default'].isEmpty(elements)) {
          res.push.apply(res, _toConsumableArray(elements));
        }
        context$1$0.next = 23;
        break;

      case 18:
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 20:
        element = context$1$0.sent;

        if (!element) {
          context$1$0.next = 23;
          break;
        }

        return context$1$0.abrupt('return', element);

      case 23:
        _iteratorNormalCompletion3 = true;
        context$1$0.next = 8;
        break;

      case 26:
        context$1$0.next = 32;
        break;

      case 28:
        context$1$0.prev = 28;
        context$1$0.t0 = context$1$0['catch'](6);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 32:
        context$1$0.prev = 32;
        context$1$0.prev = 33;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 35:
        context$1$0.prev = 35;

        if (!_didIteratorError3) {
          context$1$0.next = 38;
          break;
        }

        throw _iteratorError3;

      case 38:
        return context$1$0.finish(35);

      case 39:
        return context$1$0.finish(32);

      case 40:
        if (!mult) {
          context$1$0.next = 42;
          break;
        }

        return context$1$0.abrupt('return', res);

      case 42:
        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 43:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 28, 32, 40], [33,, 35, 39]]);
};

helpers.getFirstVisibleChild = function callee$0$0(elementId) {
  var visibleEls;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.findElementsFromElement('-ios uiautomation', '.elements().withPredicate("isVisible == 1");', elementId));

      case 2:
        visibleEls = context$1$0.sent;
        return context$1$0.abrupt('return', _lodash2['default'].first(visibleEls));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// previously getSelectorForStrategy

// For the ID strategy, we first want to handle the selector as an
// accessibility id. If no element is found by that strategy, we fall
// back to searching for the string.

// Since no element was found using the accessibility id, we fall
// back to search by string.

// and if we don't have any matching nodes, return the empty array

// otherwise look up the actual element by its index path

// having index paths means we think elements should be there. Sometimes
// uiauto lags in enabling us to get elements, so we retry a few times if
// it can't find elements we know should be there. see uiauto code
// for more logic

// we get a StaleElementReference if uiauto can't find an element
// by the path we mentioned
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxvQkFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7QUFDeEIsYUFBRyxDQUFDLElBQUksTUFBQSxDQUFSLEdBQUcscUJBQVMsUUFBUSxFQUFDLENBQUM7U0FDdkI7Ozs7Ozt5Q0FFbUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDOzs7QUFBdEQsZUFBTzs7YUFDUCxPQUFPOzs7Ozs0Q0FDRixPQUFPOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7YUFLaEIsSUFBSTs7Ozs7NENBQ0MsR0FBRzs7O2NBR04sSUFBSSx5QkFBTyxrQkFBa0IsRUFBRTs7Ozs7OztDQUN0QyxDQUFDOztBQUVGLE9BQU8sQ0FBQyxvQkFBb0IsR0FBRyxvQkFBZ0IsU0FBUztNQUNsRCxVQUFVOzs7Ozt5Q0FBUyxJQUFJLENBQUMsdUJBQXVCLENBQUMsbUJBQW1CLEVBQUUsOENBQThDLEVBQUUsU0FBUyxDQUFDOzs7QUFBL0gsa0JBQVU7NENBQ1Asb0JBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQzs7Ozs7OztDQUMzQixDQUFDOztBQUVGLGVBQWMsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO3FCQUNYLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbmQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQganMyeG1sIGZyb20gJ2pzMnhtbHBhcnNlcjInO1xuaW1wb3J0IFhNTERvbSBmcm9tICd4bWxkb20nO1xuaW1wb3J0IHhwYXRoIGZyb20gJ3hwYXRoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHVud3JhcEVsIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG4vLyB3ZSBvdmVycmlkZSB0aGUgeHBhdGggc2VhcmNoIGZvciB0aGlzIGZpcnN0LXZpc2libGUtY2hpbGQgc2VsZWN0b3IsIHdoaWNoXG4vLyBsb29rcyBsaWtlIC8qW0BmaXJzdFZpc2libGU9XCJ0cnVlXCJdXG5jb25zdCBNQUdJQ19GSVJTVF9WSVNfQ0hJTERfU0VMID0gL1xcL1xcKlxcW0BmaXJzdFZpc2libGUgPz0gPygnfFwiKXRydWVcXDFcXF0vO1xuXG4vLyB3ZSBsaWtld2lzZSBvdmVycmlkZSB4cGF0aCBzZWFyY2ggdG8gcHJvdmlkZSBhIHNob3J0Y3V0IGZvciBmaW5kaW5nIGFsbFxuLy8gc2Nyb2xsYWJsZSBlbGVtZW50c1xuY29uc3QgTUFHSUNfU0NST0xMQUJMRV9TRUwgPSAvXFwvXFwvXFwqXFxbQHNjcm9sbGFibGUgPz0gPygnfFwiKXRydWVcXDFcXF0vO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmhlbHBlcnMuZmluZEVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGNvbnRleHQgPSB1bndyYXBFbChjb250ZXh0KTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kV2ViRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kVUlFbGVtZW50T3JFbGVtZW50cyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9XG59O1xuXG5oZWxwZXJzLmZpbmRVSUVsZW1lbnRPckVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBpZiAoc3RyYXRlZ3kgIT09IFwieHBhdGhcIikge1xuICAgIHNlbGVjdG9yID0gdXRpbC5lc2NhcGVTcGVjaWFsQ2hhcnMoc2VsZWN0b3IsIFwiJ1wiKTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgY29udGV4dCA9PT0gXCJ1bmRlZmluZWRcIiB8fCAhY29udGV4dCkge1xuICAgIGNvbnRleHQgPSAnJztcbiAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PT0gXCJzdHJpbmdcIikge1xuICAgIGNvbnRleHQgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhjb250ZXh0LCBcIidcIik7XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICd4cGF0aCcgJiYgTUFHSUNfU0NST0xMQUJMRV9TRUwudGVzdChzZWxlY3RvcikpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kU2Nyb2xsYWJsZUVsT3JFbHMobXVsdCwgY29udGV4dCk7XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICd4cGF0aCcgJiYgTUFHSUNfRklSU1RfVklTX0NISUxEX1NFTC50ZXN0KHNlbGVjdG9yKSkge1xuICAgIGlmIChtdWx0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZ2V0IG11bHRpcGxlIGZpcnN0IGNoaWxkcmVuXCIpO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRGaXJzdFZpc2libGVDaGlsZChjb250ZXh0KTtcbiAgfVxuXG4gIC8vIHByZXZpb3VzbHkgZ2V0U2VsZWN0b3JGb3JTdHJhdGVneVxuICBpZiAoc3RyYXRlZ3kgPT09ICdjbGFzcyBuYW1lJyAmJiBzZWxlY3Rvci5pbmRleE9mKCdVSUEnKSAhPT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZFNlbGVjdG9yRXJyb3IoXG4gICAgICBgVGhlIGNsYXNzIG5hbWUgc2VsZWN0b3IgbXVzdCB1c2UgZnVsbCBVSUEgY2xhc3MgbmFtZXMuIFRyeSAnVUlBJHtzZWxlY3Rvcn0nIGluc3RlYWQuYCk7XG4gIH1cblxuICBpZiAoIXNlbGVjdG9yKSBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKCdNaXNzaW5nIHNlbGVjdG9yJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICBsZXQgY3JlYXRlR2V0RWxlbWVudENvbW1hbmQgPSBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gICAgbGV0IGV4dCA9IG11bHQgPyAncycgOiAnJztcbiAgICBsZXQgY29tbWFuZCA9IFwiXCI7XG4gICAgY29udGV4dCA9ICFjb250ZXh0ID8gY29udGV4dCA6IGAsICcke2NvbnRleHR9J2AgO1xuICAgIHN3aXRjaCAoc3RyYXRlZ3kpIHtcbiAgICAgIGNhc2UgXCJuYW1lXCI6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5TmFtZSgnJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJhY2Nlc3NpYmlsaXR5IGlkXCI6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5QWNjZXNzaWJpbGl0eUlkKCcke3NlbGVjdG9yfScke2NvbnRleHR9KWA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImlkXCI6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5SWQoJyR7c2VsZWN0b3J9JylgO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCItaW9zIHVpYXV0b21hdGlvblwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeVVJQXV0b21hdGlvbignJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5VHlwZSgnJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgIH1cblxuICAgIHJldHVybiBjb21tYW5kO1xuICB9O1xuXG4gIGxldCBnZXRMb2NhbGl6ZWRTdHJpbmdGb3JTZWxlY3RvciA9IGZ1bmN0aW9uIChzZWxlY3Rvciwgc3RyaW5ncykge1xuICAgIGxldCBuZXdTZWxlY3RvciA9IHNlbGVjdG9yO1xuICAgIGlmIChzdHJpbmdzKSB7XG4gICAgICBsZXQgbG9jYWxpemVkU2VsZWN0b3IgPSBzdHJpbmdzW3NlbGVjdG9yXTtcbiAgICAgIGlmIChsb2NhbGl6ZWRTZWxlY3Rvcikge1xuICAgICAgICBuZXdTZWxlY3RvciA9IGxvY2FsaXplZFNlbGVjdG9yO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBJZCBzZWxlY3RvciwgJyR7c2VsZWN0b3J9Jywgbm90IGZvdW5kIGluIExvY2FsaXphYmxlLnN0cmluZ3MuYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1NlbGVjdG9yO1xuICB9O1xuXG4gIGxldCByZXM7XG4gIGxldCBkb0ZpbmQgPSBhc3luYyAoKSA9PiB7XG4gICAgaWYgKHN0cmF0ZWd5ID09PSBcInhwYXRoXCIpIHtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudHNCeVhwYXRoKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSBcImlkXCIpIHtcbiAgICAgIC8vIEZvciB0aGUgSUQgc3RyYXRlZ3ksIHdlIGZpcnN0IHdhbnQgdG8gaGFuZGxlIHRoZSBzZWxlY3RvciBhcyBhblxuICAgICAgLy8gYWNjZXNzaWJpbGl0eSBpZC4gSWYgbm8gZWxlbWVudCBpcyBmb3VuZCBieSB0aGF0IHN0cmF0ZWd5LCB3ZSBmYWxsXG4gICAgICAvLyBiYWNrIHRvIHNlYXJjaGluZyBmb3IgdGhlIHN0cmluZy5cbiAgICAgIGxldCBmaW5kQnlBeElkQ21kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoXCJhY2Nlc3NpYmlsaXR5IGlkXCIsIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGZpbmRCeUF4SWRDbWQpO1xuICAgICAgaWYgKCEocmVzICYmIF8uc2l6ZShyZXMpID4gMCkpIHtcbiAgICAgICAgLy8gU2luY2Ugbm8gZWxlbWVudCB3YXMgZm91bmQgdXNpbmcgdGhlIGFjY2Vzc2liaWxpdHkgaWQsIHdlIGZhbGxcbiAgICAgICAgLy8gYmFjayB0byBzZWFyY2ggYnkgc3RyaW5nLlxuICAgICAgICBsZXQgZmluZEJ5SWRDbWQgPSBjcmVhdGVHZXRFbGVtZW50Q29tbWFuZChcImlkXCIsIGdldExvY2FsaXplZFN0cmluZ0ZvclNlbGVjdG9yKHNlbGVjdG9yLFxuICAgICAgICAgIHRoaXMub3B0cy5sb2NhbGl6YWJsZVN0cmluZ3MpLCBtdWx0LCBjb250ZXh0KTtcbiAgICAgICAgcmVzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoZmluZEJ5SWRDbWQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgY29tbWFuZCA9IGNyZWF0ZUdldEVsZW1lbnRDb21tYW5kKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgICB9XG4gICAgcmV0dXJuIF8uc2l6ZShyZXMpID4gMDtcbiAgfTtcblxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGRvRmluZCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIC8vIGNvbmRpdGlvbiB3YXMgbm90IG1ldCBzZXR0aW5nIHJlcyB0byBlbXB0eSBhcnJheVxuICAgICAgcmVzID0gW107XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cbiAgaWYgKG11bHQpIHtcbiAgICByZXR1cm4gcmVzO1xuICB9IGVsc2Uge1xuICAgIGlmICghcmVzIHx8IF8uc2l6ZShyZXMpID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG59O1xuXG5sZXQgX3BhdGhGcm9tRG9tTm9kZSA9IGZ1bmN0aW9uIChub2RlKSB7XG4gIGxldCBwYXRoID0gbnVsbDtcbiAgZm9yIChsZXQgYXR0ck9iaiBvZiBfLnZhbHVlcyhub2RlLmF0dHJpYnV0ZXMpKSB7XG4gICAgaWYgKGF0dHJPYmoubmFtZSA9PT0gXCJwYXRoXCIpIHtcbiAgICAgIHBhdGggPSBhdHRyT2JqLnZhbHVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcGF0aDtcbn07XG5cbmxldCBfeG1sU291cmNlRnJvbUpzb24gPSBmdW5jdGlvbiAoanNvblNvdXJjZSkge1xuICBpZiAodHlwZW9mIGpzb25Tb3VyY2UgPT09IFwic3RyaW5nXCIpIHtcbiAgICBqc29uU291cmNlID0gSlNPTi5wYXJzZShqc29uU291cmNlKTtcbiAgfVxuICByZXR1cm4ganMyeG1sKFwiQXBwaXVtQVVUXCIsIGpzb25Tb3VyY2UsIHtcbiAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6IFwiZWxlbWVudFwifSxcbiAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgIHByZXR0eVByaW50aW5nOiB7aW5kZW50U3RyaW5nOiBcIiAgICBcIn1cbiAgfSk7XG59O1xuXG5sZXQgX3BlcmZvcm1YcGF0aFF1ZXJ5T25Kc29uID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBqc29uU291cmNlKSB7XG4gIGxldCB4bWxTb3VyY2UgPSBfeG1sU291cmNlRnJvbUpzb24oanNvblNvdXJjZSk7XG4gIGxldCBkb20gPSBuZXcgWE1MRG9tLkRPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyh4bWxTb3VyY2UpO1xuICByZXR1cm4geHBhdGguc2VsZWN0KHNlbGVjdG9yLCBkb20pO1xufTtcblxuY29tbWFuZHMuZmluZFVJRWxlbWVudHNCeVhwYXRoID0gYXN5bmMgZnVuY3Rpb24gKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0PW51bGwsIGN1clJldHJ5PTEpIHtcbiAgbGV0IHNvdXJjZVhtbDtcbiAgdHJ5IHtcbiAgICBzb3VyY2VYbWwgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoY29udGV4dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci53YXJuKFwiRXJyb3IgZ2V0dGluZyBzb3VyY2UsIGNhbid0IGNvbnRpbnVlIGZpbmRpbmcgZWxlbWVudCBieSBYUGF0aFwiKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbiAgbGV0IHNlbGVjdGVkTm9kZXMgPSBfcGVyZm9ybVhwYXRoUXVlcnlPbkpzb24oc2VsZWN0b3IsIHNvdXJjZVhtbCk7XG5cbiAgaWYgKCFtdWx0KSB7XG4gICAgc2VsZWN0ZWROb2RlcyA9IHNlbGVjdGVkTm9kZXMuc2xpY2UoMCwgMSk7XG4gIH1cbiAgbGV0IGluZGV4UGF0aHMgPSBbXTtcbiAgLy8gZmlsdGVyIG91dCBlbGVtZW50cyB3aXRob3V0ICdwYXRoJyBhdHRyaWJ1dGVcbiAgZm9yIChsZXQgbm9kZSBvZiBzZWxlY3RlZE5vZGVzKSB7XG4gICAgbGV0IGlwID0gX3BhdGhGcm9tRG9tTm9kZShub2RlKTtcbiAgICBpZiAoaXAgIT09IG51bGwpIHtcbiAgICAgIGluZGV4UGF0aHMucHVzaChpcCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGluZGV4UGF0aHMubGVuZ3RoIDwgMSkge1xuICAgIC8vIGFuZCBpZiB3ZSBkb24ndCBoYXZlIGFueSBtYXRjaGluZyBub2RlcywgcmV0dXJuIHRoZSBlbXB0eSBhcnJheVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSBsb29rIHVwIHRoZSBhY3R1YWwgZWxlbWVudCBieSBpdHMgaW5kZXggcGF0aFxuICBsZXQgbWV0aG9kTmFtZTtcbiAgbGV0IG1ldGhvZEFyZ3MgPSBbXTtcblxuICBpZiAoIW11bHQpIHtcbiAgICBtZXRob2ROYW1lID0gXCJnZXRFbGVtZW50QnlJbmRleFBhdGhcIjtcbiAgICBtZXRob2RBcmdzWzBdID0gYCcke2luZGV4UGF0aHNbMF19J2A7XG4gIH0gZWxzZSB7XG4gICAgbWV0aG9kTmFtZSA9IFwiZ2V0RWxlbWVudHNCeUluZGV4UGF0aHNcIjtcbiAgICBtZXRob2RBcmdzWzBdID0gSlNPTi5zdHJpbmdpZnkoaW5kZXhQYXRocyk7XG4gIH1cblxuICBpZiAoY29udGV4dCkge1xuICAgIG1ldGhvZEFyZ3NbMV0gPSBgYXUuZ2V0RWxlbWVudCgnJHtjb250ZXh0fScpYDtcbiAgfVxuXG4gIGxldCBwcm94eUNtZCA9IGBhdS4ke21ldGhvZE5hbWV9KCR7bWV0aG9kQXJncy5qb2luKFwiLCBcIil9KWA7XG5cbiAgLy8gaGF2aW5nIGluZGV4IHBhdGhzIG1lYW5zIHdlIHRoaW5rIGVsZW1lbnRzIHNob3VsZCBiZSB0aGVyZS4gU29tZXRpbWVzXG4gIC8vIHVpYXV0byBsYWdzIGluIGVuYWJsaW5nIHVzIHRvIGdldCBlbGVtZW50cywgc28gd2UgcmV0cnkgYSBmZXcgdGltZXMgaWZcbiAgLy8gaXQgY2FuJ3QgZmluZCBlbGVtZW50cyB3ZSBrbm93IHNob3VsZCBiZSB0aGVyZS4gc2VlIHVpYXV0byBjb2RlXG4gIC8vIGZvciBtb3JlIGxvZ2ljXG4gIGxldCByZXM7XG4gIHRyeSB7XG4gICAgcmVzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQocHJveHlDbWQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyB3ZSBnZXQgYSBTdGFsZUVsZW1lbnRSZWZlcmVuY2UgaWYgdWlhdXRvIGNhbid0IGZpbmQgYW4gZWxlbWVudFxuICAgIC8vIGJ5IHRoZSBwYXRoIHdlIG1lbnRpb25lZFxuICAgIGlmIChjdXJSZXRyeSA8IDMpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIkdvdCBhIHdhcm5pbmcgZnJvbSB1aWF1dG8gdGhhdCBzb21lIGluZGV4IHBhdGhzIFwiICtcbiAgICAgICAgICAgICAgICAgICBcImNvdWxkIG5vdCBiZSByZXNvbHZlZCwgdHJ5aW5nIGFnYWluXCIpO1xuICAgICAgYXdhaXQgQi5kZWxheSgzMDApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudHNCeVhwYXRoKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0LCBjdXJSZXRyeSArIDEpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbiAgcmV0dXJuIHJlcztcbn07XG5cbmhlbHBlcnMuZmluZFNjcm9sbGFibGVFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gKG11bHQsIGNvbnRleHQpIHtcbiAgY29uc3Qgc2Nyb2xsVHlwZXMgPSBbJ1VJQVNjcm9sbFZpZXcnLCAnVUlBVGFibGVWaWV3JywgJ1VJQUNvbGxlY3Rpb25WaWV3JywgJ1VJQVdlYlZpZXcnXTtcbiAgbGV0IHJlcyA9IFtdO1xuICBjb25zdCBleHQgPSBtdWx0ID8gJ3MnIDogJyc7XG4gIGZvciAoY29uc3Qgc2Nyb2xsVHlwZSBvZiBzY3JvbGxUeXBlcykge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5VHlwZSgnJHtzY3JvbGxUeXBlfScke2NvbnRleHR9KWA7XG5cbiAgICBpZiAobXVsdCkge1xuICAgICAgbGV0IGVsZW1lbnRzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gICAgICBpZiAoIV8uaXNFbXB0eShlbGVtZW50cykpIHtcbiAgICAgICAgcmVzLnB1c2goLi4uZWxlbWVudHMpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgZWxlbWVudCA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKG11bHQpIHtcbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbn07XG5cbmhlbHBlcnMuZ2V0Rmlyc3RWaXNpYmxlQ2hpbGQgPSBhc3luYyBmdW5jdGlvbiAoZWxlbWVudElkKSB7XG4gIGxldCB2aXNpYmxlRWxzID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudHNGcm9tRWxlbWVudCgnLWlvcyB1aWF1dG9tYXRpb24nLCAnLmVsZW1lbnRzKCkud2l0aFByZWRpY2F0ZShcImlzVmlzaWJsZSA9PSAxXCIpOycsIGVsZW1lbnRJZCk7XG4gIHJldHVybiBfLmZpcnN0KHZpc2libGVFbHMpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
