'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var commands = {},
    helpers = {},
    extensions = {};

// TODO: more explicit error message for all the file-movement commands

/*
 *  Get the full path to an iOS simulator file.
 *  Calls cb(err, fullFilePath)
 *  /Some/Path                           fetches a file relative to the root of the device's filesystem.
 *  /Applications/AppName.app/Some/Path  fetches a file relative to the root of that Application's .app directory, adding in the GUID.
 *  So it looks something like: /Applications/GUID-GUID-GUID-GUID/Some/Path
 */
helpers.getSimFileFullPath = function callee$0$0(remotePath) {
  var basePath, appName, appNameRegex, appNameMatches, findPath, _ref, stdout, appRoot, subPath;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        basePath = this.sim.getDir();
        appName = null;

        if (this.opts.app) {
          appNameRegex = new RegExp('\\' + _path2['default'].sep + '([\\w-]+\\.app)');
          appNameMatches = appNameRegex.exec(this.opts.app);

          if (appNameMatches) {
            appName = appNameMatches[1];
          }
        }
        // de-absolutize the path
        if (_appiumSupport.system.isWindows()) {
          if (remotePath.indexof("://") === 1) {
            remotePath = remotePath.slice(4);
          }
        } else {
          if (remotePath.indexOf("/") === 0) {
            remotePath = remotePath.slice(1);
          }
        }

        if (!(remotePath.indexOf(appName) === 0)) {
          context$1$0.next = 18;
          break;
        }

        _logger2['default'].debug("We want an app-relative file");

        findPath = basePath;

        if (this.opts.platformVersion >= 8) {
          // the .app file appears in /Containers/Data and /Containers/Bundle both. We only want /Bundle
          findPath = _path2['default'].resolve(basePath, "Containers", "Bundle");
        }
        findPath = findPath.replace(/\s/g, '\\ ');

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('find', [findPath, '-name', appName]));

      case 11:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        appRoot = stdout.replace(/\n$/, '');
        subPath = remotePath.substring(appName.length + 1);
        return context$1$0.abrupt('return', _path2['default'].resolve(appRoot, subPath));

      case 18:
        _logger2['default'].debug("We want a sim-relative file");
        return context$1$0.abrupt('return', _path2['default'].resolve(basePath, remotePath));

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pushFile = function callee$0$0(remotePath, base64Data) {
  var fullPath, content;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pushing ' + remotePath + ' to iOS simulator');

        if (!this.isRealDevice()) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug("Unsupported: cannot write files to physical device");
        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 6:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to write ' + fullPath + '...');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(fullPath));

      case 10:
        if (!context$1$0.sent) {
          context$1$0.next = 14;
          break;
        }

        _logger2['default'].debug(fullPath + ' already exists, deleting...');
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(fullPath));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(fullPath)));

      case 16:
        content = new Buffer(base64Data, 'base64');
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(fullPath, content));

      case 19:
        _logger2['default'].debug('Wrote ' + content.length + ' bytes to ' + fullPath);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFile = function callee$0$0(remotePath) {
  var fullPath, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling ' + remotePath + ' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to read ' + fullPath);
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(fullPath, { encoding: 'base64' }));

      case 9:
        data = context$1$0.sent;
        return context$1$0.abrupt('return', data);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFolder = function callee$0$0(remotePath) {
  var fullPath, buffer, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling \'' + remotePath + '\' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Adding ' + fullPath + ' to an in-memory zip archive');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.toInMemoryZip(fullPath));

      case 9:
        buffer = context$1$0.sent;

        _logger2['default'].debug("Converting in-memory zip file to base64 encoded string");
        data = buffer.toString('base64');

        _logger2['default'].debug("Returning in-memory zip file as base54 encoded string");
        return context$1$0.abrupt('return', data);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COzs2QkFDSCxnQkFBZ0I7O3NCQUNyQyxXQUFXOzs7O29CQUNiLE1BQU07Ozs7NEJBQ0YsY0FBYzs7QUFFbkMsSUFBSSxRQUFRLEdBQUcsRUFBRTtJQUFFLE9BQU8sR0FBRyxFQUFFO0lBQUUsVUFBVSxHQUFHLEVBQUUsQ0FBQzs7Ozs7Ozs7Ozs7QUFXakQsT0FBTyxDQUFDLGtCQUFrQixHQUFHLG9CQUFnQixVQUFVO01BQ2pELFFBQVEsRUFDUixPQUFPLEVBR0wsWUFBWSxFQUNaLGNBQWMsRUFtQmQsUUFBUSxRQU9OLE1BQU0sRUFDUixPQUFPLEVBQ1AsT0FBTzs7Ozs7QUFqQ1QsZ0JBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRTtBQUM1QixlQUFPLEdBQUcsSUFBSTs7QUFFbEIsWUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtBQUNiLHNCQUFZLEdBQUcsSUFBSSxNQUFNLFFBQU0sa0JBQUssR0FBRyxxQkFBa0I7QUFDekQsd0JBQWMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDOztBQUNyRCxjQUFJLGNBQWMsRUFBRTtBQUNsQixtQkFBTyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztXQUM3QjtTQUNGOztBQUVELFlBQUksc0JBQU8sU0FBUyxFQUFFLEVBQUU7QUFDdEIsY0FBSSxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNuQyxzQkFBVSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7V0FDbEM7U0FDRixNQUFNO0FBQ0wsY0FBSSxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNqQyxzQkFBVSxHQUFHLFVB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QWEsQ0FBQzs7YUFFN0MsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7Y0FDZixJQUFJLHlCQUFPLHNCQUFzQixFQUFFOzs7O3lDQUd0QixJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDOzs7QUFBcEQsZ0JBQVE7O0FBRVosNEJBQU8sS0FBSyxhQUFXLFFBQVEsa0NBQStCLENBQUM7O3lDQUM1QyxtQkFBSSxhQUFhLENBQUMsUUFBUSxDQUFDOzs7QUFBMUMsY0FBTTs7QUFFViw0QkFBTyxLQUFLLENBQUMsd0RBQXdELENBQUMsQ0FBQztBQUNuRSxZQUFJLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7O0FBQ3BDLDRCQUFPLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDOzRDQUMvRCxJQUFJOzs7Ozs7O0NBQ1osQ0FBQzs7QUFFRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztxQkFDWCxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGZzLCBzeXN0ZW0sIG1rZGlycCwgemlwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG4vLyBUT0RPOiBtb3JlIGV4cGxpY2l0IGVycm9yIG1lc3NhZ2UgZm9yIGFsbCB0aGUgZmlsZS1tb3ZlbWVudCBjb21tYW5kc1xuXG4vKlxuICogIEdldCB0aGUgZnVsbCBwYXRoIHRvIGFuIGlPUyBzaW11bGF0b3IgZmlsZS5cbiAqICBDYWxscyBjYihlcnIsIGZ1bGxGaWxlUGF0aClcbiAqICAvU29tZS9QYXRoICAgICAgICAgICAgICAgICAgICAgICAgICAgZmV0Y2hlcyBhIGZpbGUgcmVsYXRpdmUgdG8gdGhlIHJvb3Qgb2YgdGhlIGRldmljZSdzIGZpbGVzeXN0ZW0uXG4gKiAgL0FwcGxpY2F0aW9ucy9BcHBOYW1lLmFwcC9Tb21lL1BhdGggIGZldGNoZXMgYSBmaWxlIHJlbGF0aXZlIHRvIHRoZSByb290IG9mIHRoYXQgQXBwbGljYXRpb24ncyAuYXBwIGRpcmVjdG9yeSwgYWRkaW5nIGluIHRoZSBHVUlELlxuICogIFNvIGl0IGxvb2tzIHNvbWV0aGluZyBsaWtlOiAvQXBwbGljYXRpb25zL0dVSUQtR1VJRC1HVUlELUdVSUQvU29tZS9QYXRoXG4gKi9cbmhlbHBlcnMuZ2V0U2ltRmlsZUZ1bGxQYXRoID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgpIHtcbiAgbGV0IGJhc2VQYXRoID0gdGhpcy5zaW0uZ2V0RGlyKCk7XG4gIGxldCBhcHBOYW1lID0gbnVsbDtcblxuICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgIGxldCBhcHBOYW1lUmVnZXggPSBuZXcgUmVnRXhwKGBcXFxcJHtwYXRoLnNlcH0oW1xcXFx3LV0rXFxcXC5hcHApYCk7XG4gICAgbGV0IGFwcE5hbWVNYXRjaGVzID0gYXBwTmFtZVJlZ2V4LmV4ZWModGhpcy5vcHRzLmFwcCk7XG4gICAgaWYgKGFwcE5hbWVNYXRjaGVzKSB7XG4gICAgICBhcHBOYW1lID0gYXBwTmFtZU1hdGNoZXNbMV07XG4gICAgfVxuICB9XG4gIC8vIGRlLWFic29sdXRpemUgdGhlIHBhdGhcbiAgaWYgKHN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgIGlmIChyZW1vdGVQYXRoLmluZGV4b2YoXCI6Ly9cIikgPT09IDEpIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAocmVtb3RlUGF0aC5pbmRleE9mKFwiL1wiKSA9PT0gMCkge1xuICAgICAgcmVtb3RlUGF0aCA9IHJlbW90ZVBhdGguc2xpY2UoMSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHJlbW90ZVBhdGguaW5kZXhPZihhcHBOYW1lKSA9PT0gMCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIldlIHdhbnQgYW4gYXBwLXJlbGF0aXZlIGZpbGVcIik7XG5cbiAgICBsZXQgZmluZFBhdGggPSBiYXNlUGF0aDtcbiAgICBpZiAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA+PSA4KSB7XG4gICAgICAvLyB0aGUgLmFwcCBmaWxlIGFwcGVhcnMgaW4gL0NvbnRhaW5lcnMvRGF0YSBhbmQgL0NvbnRhaW5lcnMvQnVuZGxlIGJvdGguIFdlIG9ubHkgd2FudCAvQnVuZGxlXG4gICAgICBmaW5kUGF0aCA9IHBhdGgucmVzb2x2ZShiYXNlUGF0aCwgXCJDb250YWluZXJzXCIsIFwiQnVuZGxlXCIpO1xuICAgIH1cbiAgICBmaW5kUGF0aCA9ICBmaW5kUGF0aC5yZXBsYWNlKC9cXHMvZywgJ1xcXFwgJyk7XG5cbiAgICBsZXQgeyBzdGRvdXQgfSA9IGF3YWl0IGV4ZWMoJ2ZpbmQnLCBbZmluZFBhdGgsICctbmFtZScsIGFwcE5hbWVdKTtcbiAgICBsZXQgYXBwUm9vdCA9IHN0ZG91dC5yZXBsYWNlKC9cXG4kLywgJycpO1xuICAgIGxldCBzdWJQYXRoID0gcmVtb3RlUGF0aC5zdWJzdHJpbmcoYXBwTmFtZS5sZW5ndGggKyAxKTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGFwcFJvb3QsIHN1YlBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIldlIHdhbnQgYSBzaW0tcmVsYXRpdmUgZmlsZVwiKTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGJhc2VQYXRoLCByZW1vdGVQYXRoKTtcbiAgfVxufTtcblxuY29tbWFuZHMucHVzaEZpbGUgPSBhc3luYyBmdW5jdGlvbiAocmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBsb2dnZXIuZGVidWcoYFB1c2hpbmcgJHtyZW1vdGVQYXRofSB0byBpT1Mgc2ltdWxhdG9yYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJVbnN1cHBvcnRlZDogY2Fubm90IHdyaXRlIGZpbGVzIHRvIHBoeXNpY2FsIGRldmljZVwiKTtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBmdWxsUGF0aCA9IGF3YWl0IHRoaXMuZ2V0U2ltRmlsZUZ1bGxQYXRoKHJlbW90ZVBhdGgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgQXR0ZW1wdGluZyB0byB3cml0ZSAke2Z1bGxQYXRofS4uLmApO1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGZ1bGxQYXRoKSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgJHtmdWxsUGF0aH0gYWxyZWFkeSBleGlzdHMsIGRlbGV0aW5nLi4uYCk7XG4gICAgYXdhaXQgZnMudW5saW5rKGZ1bGxQYXRoKTtcbiAgfVxuICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGZ1bGxQYXRoKSk7XG4gIGxldCBjb250ZW50ID0gbmV3IEJ1ZmZlcihiYXNlNjREYXRhLCAnYmFzZTY0Jyk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShmdWxsUGF0aCwgY29udGVudCk7XG4gIGxvZ2dlci5kZWJ1ZyhgV3JvdGUgJHtjb250ZW50Lmxlbmd0aH0gYnl0ZXMgdG8gJHtmdWxsUGF0aH1gKTtcbn07XG5cbmNvbW1hbmRzLnB1bGxGaWxlID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgpIHtcbiAgbG9nZ2VyLmRlYnVnKGBQdWxsaW5nICR7cmVtb3RlUGF0aH0gZnJvbSBzaW1gKTtcblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG4gIGxldCBmdWxsUGF0aCA9IGF3YWl0IHRoaXMuZ2V0U2ltRmlsZUZ1bGxQYXRoKHJlbW90ZVBhdGgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgQXR0ZW1wdGluZyB0byByZWFkICR7ZnVsbFBhdGh9YCk7XG4gIGxldCBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGUoZnVsbFBhdGgsIHtlbmNvZGluZzogJ2Jhc2U2NCd9KTtcbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5jb21tYW5kcy5wdWxsRm9sZGVyID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgpIHtcbiAgbG9nZ2VyLmRlYnVnKGBQdWxsaW5nICcke3JlbW90ZVBhdGh9JyBmcm9tIHNpbWApO1xuXG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEFkZGluZyAke2Z1bGxQYXRofSB0byBhbiBpbi1tZW1vcnkgemlwIGFyY2hpdmVgKTtcbiAgbGV0IGJ1ZmZlciA9IGF3YWl0IHppcC50b0luTWVtb3J5WmlwKGZ1bGxQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoXCJDb252ZXJ0aW5nIGluLW1lbW9yeSB6aXAgZmlsZSB0byBiYXNlNjQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIGxldCBkYXRhID0gYnVmZmVyLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgbG9nZ2VyLmRlYnVnKFwiUmV0dXJuaW5nIGluLW1lbW9yeSB6aXAgZmlsZSBhcyBiYXNlNTQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIHJldHVybiBkYXRhO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
