'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _utils = require('../utils');

var commands = {},
    helpers = {},
    extensions = {};

commands.getAttribute = function callee$0$0(attribute, el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 12;
          break;
        }

        atomsElement = this.getAtomsElement(el);

        if (!_lodash2['default'].isNull(atomsElement)) {
          context$1$0.next = 7;
          break;
        }

        throw new _appiumBaseDriver.errors.UnknownError('Error converting element ID for using in WD atoms: \'' + el + '\'');

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.executeAtom('get_attribute_value', [atomsElement, attribute]));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
        context$1$0.next = 24;
        break;

      case 12:
        if (!(attribute === 'contentSize')) {
          context$1$0.next = 16;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.getElementContentSize(el));

      case 15:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 16:
        if (!_lodash2['default'].includes(['label', 'name', 'value', 'values', 'hint'], attribute)) {
          context$1$0.next = 23;
          break;
        }

        command = 'au.getElement(\'' + el + '\').' + attribute + '()';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 20:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 23:
        throw new _appiumBaseDriver.errors.UnknownCommandError('UIAElements don\'t have the attribute \'' + attribute + '\'');

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.clear = function callee$0$0(el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('clear', [atomsElement]));

      case 5:
        context$1$0.next = 10;
        break;

      case 7:
        command = 'au.getElement(\'' + el + '\').setValue(\'\')';
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setValueImmediate = function callee$0$0(value, el) {
  var command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);
        value = _appiumSupport.util.escapeSpecialChars(value, "'");
        command = 'au.getElement(\'' + el + '\').setValue(\'' + value + '\')';
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setValue = function callee$0$0(value, el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 9;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('click', [atomsElement]));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.executeAtom('type', [atomsElement, value]));

      case 7:
        context$1$0.next = 20;
        break;

      case 9:
        if (value instanceof Array) {
          value = value.join("");
        }
        if (typeof value !== 'string') {
          value = value.toString();
        }
        value = _appiumSupport.util.escapeSpecialChars(value, "'");
        // de-escape \n so it can be used specially
        value = value.replace(/\\\\n/g, "\\n");

        if (!this.opts.useRobot) {
          context$1$0.next = 17;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 17:
        command = 'au.getElement(\'' + el + '\').setValueByType(\'' + value + '\')';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getText = function callee$0$0(el) {
  var atomsElement, command, res;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_text', [atomsElement]));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        command = 'au.getElement(\'' + el + '\').text()';
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 11:
        res = context$1$0.sent;

        // in some cases instruments returns in integer. we only want a string
        res = res ? res.toString() : '';
        return context$1$0.abrupt('return', res);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.elementDisplayed = function callee$0$0(el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('is_displayed', [atomsElement]));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        command = 'au.getElement(\'' + el + '\').isDisplayed()';
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.elementEnabled = function callee$0$0(el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('is_enabled', [atomsElement]));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        command = 'au.getElement(\'' + el + '\').isEnabled() === 1';
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.elementSelected = function callee$0$0(el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('is_selected', [atomsElement]));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        command = 'au.getElement(\'' + el + '\').isSelected()';
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getName = function callee$0$0(el) {
  var atomsElement, script, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 9;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        script = 'return arguments[0].tagName.toLowerCase()';
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, [atomsElement]]));

      case 6:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
        command = 'au.getElement(\'' + el + '\').type()';
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 12:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getLocation = function callee$0$0(el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.useAtomsElement(el));

      case 4:
        atomsElement = context$1$0.sent;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 7:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
        command = 'au.getElement(\'' + el + '\').getElementLocation()';
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 13:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getLocationInView = function callee$0$0(el) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getLocation(el));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getSize = function callee$0$0(el) {
  var atomsElement, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);

        if (!this.isWebContext()) {
          context$1$0.next = 12;
          break;
        }

        atomsElement = this.getAtomsElement(el);

        if (!(atomsElement === null)) {
          context$1$0.next = 7;
          break;
        }

        throw new _appiumBaseDriver.errors.UnknownError('Error converting element ID for using in WD atoms: \'' + el + '\'');

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
        context$1$0.next = 16;
        break;

      case 12:
        command = 'au.getElement(\'' + el + '\').getElementSize()';
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 15:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getElementContentSize = function callee$0$0(el) {
  var command, frames, type, contentHeight, firstElementFrame, lastElementFrame, elementsInRow, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, i, frame, spaceBetweenElements, numberOfRows, size, topLeftCoord;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = (0, _utils.unwrapEl)(el);
        command = 'au.getElement(\'' + el + '\').childElementsFrames()';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 4:
        frames = context$1$0.sent;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.getName(el));

      case 7:
        type = context$1$0.sent;
        contentHeight = 0;
        context$1$0.t0 = type;
        context$1$0.next = context$1$0.t0 === "UIATableView" ? 12 : context$1$0.t0 === "UIACollectionView" ? 16 : 51;
        break;

      case 12:
        firstElementFrame = _lodash2['default'].first(frames);
        lastElementFrame = _lodash2['default'].last(frames);

        contentHeight = lastElementFrame.origin.y + lastElementFrame.size.height - firstElementFrame.origin.y;
        return context$1$0.abrupt('break', 52);

      case 16:
        firstElementFrame = _lodash2['default'].first(frames);
        elementsInRow = 0;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 21;
        _iterator = _getIterator(frames.entries());

      case 23:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 33;
          break;
        }

        _step$value = _slicedToArray(_step.value, 2);
        i = _step$value[0];
        frame = _step$value[1];

        if (!(frame.origin.y !== firstElementFrame.origin.y)) {
          context$1$0.next = 30;
          break;
        }

        elementsInRow = i;
        return context$1$0.abrupt('break', 33);

      case 30:
        _iteratorNormalCompletion = true;
        context$1$0.next = 23;
        break;

      case 33:
        context$1$0.next = 39;
        break;

      case 35:
        context$1$0.prev = 35;
        context$1$0.t1 = context$1$0['catch'](21);
        _didIteratorError = true;
        _iteratorError = context$1$0.t1;

      case 39:
        context$1$0.prev = 39;
        context$1$0.prev = 40;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 42:
        context$1$0.prev = 42;

        if (!_didIteratorError) {
          context$1$0.next = 45;
          break;
        }

        throw _iteratorError;

      case 45:
        return context$1$0.finish(42);

      case 46:
        return context$1$0.finish(39);

      case 47:
        spaceBetweenElements = frames[elementsInRow].origin.y - frames[elementsInRow - 1].origin.y - frames[elementsInRow - 1].size.height;
        numberOfRows = Math.ceil(frames.length / elementsInRow);

        // Assume that all cells are of the same size
        contentHeight = numberOfRows * firstElementFrame.size.height + spaceBetweenElements * (numberOfRows - 1);
        return context$1$0.abrupt('break', 52);

      case 51:
        return context$1$0.abrupt('return', null);

      case 52:
        context$1$0.next = 54;
        return _regeneratorRuntime.awrap(this.getSize(el));

      case 54:
        size = context$1$0.sent;
        context$1$0.next = 57;
        return _regeneratorRuntime.awrap(this.getLocationInView(el));

      case 57:
        topLeftCoord = context$1$0.sent;
        return context$1$0.abrupt('return', JSON.stringify({
          width: size.width,
          height: size.height,
          top: topLeftCoord.y,
          left: topLeftCoord.x,
          scrollableOffset: contentHeight
        }));

      case 59:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[21, 35, 39, 47], [40,, 42, 46]]);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

/* TODO */

// Get number of elements in a row

// This method calculates content size only for UIATableView and UIACollectionView. UIAWebView is comming soon.
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9lbGVtZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Z0NBQXVCLG9CQUFvQjs7c0JBQzdCLFFBQVE7Ozs7NkJBQ0QsZ0JBQWdCOztxQkFDWixVQUFVOztBQUVuQyxJQUFJLFFBQVEsR0FBRyxFQUFFO0lBQUUsT0FBTyxHQUFHLEVBQUU7SUFBRSxVQUFVLEdBQUcsRUFBRSxDQUFDOztBQUVqRCxRQUFRLENBQUMsWUFBWSxHQUFHLG9CQUFnQixTQUFTLEVBQUUsRUFBRTtNQUc3QyxZQUFZLEVBV1YsT0FBTzs7OztBQWJmLFVBQUUsR0FBRyxxQkFBUyxFQUFFLENBQUMsQ0FBQzs7YUFDZCxJQUFJLENBQUMsWUFBWSxFQUFFOzs7OztBQUNqQixvQkFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDOzthQUN2QyxvQkFBRSxNQUFNLENBQUMsWUFBWSxDQUFDOzs7OztjQUNsQixJQUFJLHlCQUFPLFlBQVksMkRBQXdELEVBQUUsUUFBSTs7Ozt5Q0FFOUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLFlBQVksRUFBRSxTQUFTLENBQUMsQ0FBQzs7Ozs7Ozs7OztjQUc3RSxTQUFTLEtBQUssYUFBYSxDQUFBOzs7Ozs7eUNBQ2hCLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUM7Ozs7OzthQUV6QyxvQkFBRSxRQUFRLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLEVBQUUsU0FBUyxDQUFDOzs7OztBQUNqRSxlQUFPLHdCQUFxQixFQUFFLFlBQU0sU0FBUzs7eUNBQ3BDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQzs7Ozs7O2NBRTdDLElBQUkseUJBQU8sbUJBQW1CLDhDQUEwQyxTQUFTLFFBQUk7Ozs7Ozs7Q0FHaEcsQ0FBQzs7QUFFRixRQUFRLENBQUMsS0FBSyxHQUFH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LE1BQU07QUFDbkIsYUFBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ25CLGNBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNwQiwwQkFBZ0IsRUFBRSxhQUFhO1NBQ2hDLENBQUM7Ozs7Ozs7Q0FDSCxDQUFDOztBQUVGLGVBQWMsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO3FCQUNYLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2VsZW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyB1bndyYXBFbCB9IGZyb20gJy4uL3V0aWxzJztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5nZXRBdHRyaWJ1dGUgPSBhc3luYyBmdW5jdGlvbiAoYXR0cmlidXRlLCBlbCkge1xuICBlbCA9IHVud3JhcEVsKGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy5nZXRBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGlmIChfLmlzTnVsbChhdG9tc0VsZW1lbnQpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGZvciB1c2luZyBpbiBXRCBhdG9tczogJyR7ZWx9J2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X2F0dHJpYnV0ZV92YWx1ZScsIFthdG9tc0VsZW1lbnQsIGF0dHJpYnV0ZV0pO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoYXR0cmlidXRlID09PSAnY29udGVudFNpemUnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRFbGVtZW50Q29udGVudFNpemUoZWwpO1xuICAgIH1cbiAgICBpZiAoXy5pbmNsdWRlcyhbJ2xhYmVsJywgJ25hbWUnLCAndmFsdWUnLCAndmFsdWVzJywgJ2hpbnQnXSwgYXR0cmlidXRlKSkge1xuICAgICAgbGV0IGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCgnJHtlbH0nKS4ke2F0dHJpYnV0ZX0oKWA7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkNvbW1hbmRFcnJvcihgVUlBRWxlbWVudHMgZG9uJ3QgaGF2ZSB0aGUgYXR0cmlidXRlICcke2F0dHJpYnV0ZX0nYCk7XG4gICAgfVxuICB9XG59O1xuXG5jb21tYW5kcy5jbGVhciA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBlbCA9IHVud3JhcEVsKGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2NsZWFyJywgW2F0b21zRWxlbWVudF0pO1xuICB9IGVsc2Uge1xuICAgIGxldCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQoJyR7ZWx9Jykuc2V0VmFsdWUoJycpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0VmFsdWVJbW1lZGlhdGUgPSBhc3luYyBmdW5jdGlvbiAodmFsdWUsIGVsKSB7XG4gIGVsID0gdW53cmFwRWwoZWwpO1xuICB2YWx1ZSA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKHZhbHVlLCBcIidcIik7XG4gIGxldCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQoJyR7ZWx9Jykuc2V0VmFsdWUoJyR7dmFsdWV9JylgO1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbn07XG5cbmNvbW1hbmRzLnNldFZhbHVlID0gYXN5bmMgZnVuY3Rpb24gKHZhbHVlLCBlbCkge1xuICBlbCA9IHVud3JhcEVsKGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2NsaWNrJywgW2F0b21zRWxlbWVudF0pO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ3R5cGUnLCBbYXRvbXNFbGVtZW50LCB2YWx1ZV0pO1xuICB9IGVsc2Uge1xuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLmpvaW4oXCJcIik7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIHZhbHVlID0gdXRpbC5lc2NhcGVTcGVjaWFsQ2hhcnModmFsdWUsIFwiJ1wiKTtcbiAgICAvLyBkZS1lc2NhcGUgXFxuIHNvIGl0IGNhbiBiZSB1c2VkIHNwZWNpYWxseVxuICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvXFxcXFxcXFxuL2csIFwiXFxcXG5cIik7XG4gICAgaWYgKHRoaXMub3B0cy51c2VSb2JvdCkge1xuICAgICAgLyogVE9ETyAqL3Rocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50KCcke2VsfScpLnNldFZhbHVlQnlUeXBlKCcke3ZhbHVlfScpYDtcbiAgICAgIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgIH1cbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0VGV4dCA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBlbCA9IHVud3JhcEVsKGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfdGV4dCcsIFthdG9tc0VsZW1lbnRdKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50KCcke2VsfScpLnRleHQoKWA7XG4gICAgbGV0IHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgIC8vIGluIHNvbWUgY2FzZXMgaW5zdHJ1bWVudHMgcmV0dXJucyBpbiBpbnRlZ2VyLiB3ZSBvbmx5IHdhbnQgYSBzdHJpbmdcbiAgICByZXMgPSByZXMgPyByZXMudG9TdHJpbmcoKSA6ICcnO1xuICAgIHJldHVybiByZXM7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmVsZW1lbnREaXNwbGF5ZWQgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgZWwgPSB1bndyYXBFbChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnaXNfZGlzcGxheWVkJywgW2F0b21zRWxlbWVudF0pO1xuICB9IGVsc2Uge1xuICAgIGxldCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQoJyR7ZWx9JykuaXNEaXNwbGF5ZWQoKWA7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5lbGVtZW50RW5hYmxlZCA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBlbCA9IHVud3JhcEVsKGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdpc19lbmFibGVkJywgW2F0b21zRWxlbWVudF0pO1xuICB9IGVsc2Uge1xuICAgIGxldCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQoJyR7ZWx9JykuaXNFbmFibGVkKCkgPT09IDFgO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZWxlbWVudFNlbGVjdGVkID0gYXN5bmMgZnVuY3Rpb24gKGVsKSB7XG4gIGVsID0gdW53cmFwRWwoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2lzX3NlbGVjdGVkJywgW2F0b21zRWxlbWVudF0pO1xuICB9IGVsc2Uge1xuICAgIGxldCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQoJyR7ZWx9JykuaXNTZWxlY3RlZCgpYDtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldE5hbWUgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgZWwgPSB1bndyYXBFbChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgICBsZXQgc2NyaXB0ID0gJ3JldHVybiBhcmd1bWVudHNbMF0udGFnTmFtZS50b0xvd2VyQ2FzZSgpJztcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbYXRvbXNFbGVtZW50XV0pO1xuICB9IGVsc2Uge1xuICAgIGxldCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQoJyR7ZWx9JykudHlwZSgpYDtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldExvY2F0aW9uID0gYXN5bmMgZnVuY3Rpb24gKGVsKSB7XG4gIGVsID0gdW53cmFwRWwoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBhdG9tc0VsZW1lbnQgPSBhd2FpdCB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50KCcke2VsfScpLmdldEVsZW1lbnRMb2NhdGlvbigpYDtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldExvY2F0aW9uSW5WaWV3ID0gYXN5bmMgZnVuY3Rpb24gKGVsKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmdldExvY2F0aW9uKGVsKTtcbn07XG5cbmNvbW1hbmRzLmdldFNpemUgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgZWwgPSB1bndyYXBFbChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMuZ2V0QXRvbXNFbGVtZW50KGVsKTtcbiAgICBpZiAoYXRvbXNFbGVtZW50ID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGZvciB1c2luZyBpbiBXRCBhdG9tczogJyR7ZWx9J2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxldCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQoJyR7ZWx9JykuZ2V0RWxlbWVudFNpemUoKWA7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRFbGVtZW50Q29udGVudFNpemUgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgZWwgPSB1bndyYXBFbChlbCk7XG4gIGNvbnN0IGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCgnJHtlbH0nKS5jaGlsZEVsZW1lbnRzRnJhbWVzKClgO1xuICBjb25zdCBmcmFtZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgY29uc3QgdHlwZSA9IGF3YWl0IHRoaXMuZ2V0TmFtZShlbCk7XG5cbiAgbGV0IGNvbnRlbnRIZWlnaHQgPSAwO1xuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlIFwiVUlBVGFibGVWaWV3XCI6IHtcbiAgICAgIGNvbnN0IGZpcnN0RWxlbWVudEZyYW1lID0gXy5maXJzdChmcmFtZXMpO1xuICAgICAgY29uc3QgbGFzdEVsZW1lbnRGcmFtZSA9IF8ubGFzdChmcmFtZXMpO1xuICAgICAgY29udGVudEhlaWdodCA9IGxhc3RFbGVtZW50RnJhbWUub3JpZ2luLnkgKyBsYXN0RWxlbWVudEZyYW1lLnNpemUuaGVpZ2h0IC0gZmlyc3RFbGVtZW50RnJhbWUub3JpZ2luLnk7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY2FzZSBcIlVJQUNvbGxlY3Rpb25WaWV3XCI6IHtcbiAgICAgIGxldCBmaXJzdEVsZW1lbnRGcmFtZSA9IF8uZmlyc3QoZnJhbWVzKTtcbiAgICAgIGxldCBlbGVtZW50c0luUm93ID0gMDtcblxuICAgICAgLy8gR2V0IG51bWJlciBvZiBlbGVtZW50cyBpbiBhIHJvd1xuICAgICAgZm9yIChjb25zdCBbaSwgZnJhbWVdIG9mIGZyYW1lcy5lbnRyaWVzKCkpIHtcbiAgICAgICAgaWYgKGZyYW1lLm9yaWdpbi55ICE9PSBmaXJzdEVsZW1lbnRGcmFtZS5vcmlnaW4ueSkge1xuICAgICAgICAgIGVsZW1lbnRzSW5Sb3cgPSBpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNwYWNlQmV0d2VlbkVsZW1lbnRzID0gZnJhbWVzW2VsZW1lbnRzSW5Sb3ddLm9yaWdpbi55IC0gZnJhbWVzW2VsZW1lbnRzSW5Sb3cgLSAxXS5vcmlnaW4ueSAtIGZyYW1lc1tlbGVtZW50c0luUm93IC0gMV0uc2l6ZS5oZWlnaHQ7XG4gICAgICBjb25zdCBudW1iZXJPZlJvd3MgPSBNYXRoLmNlaWwoZnJhbWVzLmxlbmd0aCAvIGVsZW1lbnRzSW5Sb3cpO1xuXG4gICAgICAvLyBBc3N1bWUgdGhhdCBhbGwgY2VsbHMgYXJlIG9mIHRoZSBzYW1lIHNpemVcbiAgICAgIGNvbnRlbnRIZWlnaHQgPSBudW1iZXJPZlJvd3MgKiBmaXJzdEVsZW1lbnRGcmFtZS5zaXplLmhlaWdodCArIHNwYWNlQmV0d2VlbkVsZW1lbnRzICogKG51bWJlck9mUm93cyAtIDEpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGRlZmF1bHQ6IHtcbiAgICAgIC8vIFRoaXMgbWV0aG9kIGNhbGN1bGF0ZXMgY29udGVudCBzaXplIG9ubHkgZm9yIFVJQVRhYmxlVmlldyBhbmQgVUlBQ29sbGVjdGlvblZpZXcuIFVJQVdlYlZpZXcgaXMgY29tbWluZyBzb29uLlxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgY29uc3Qgc2l6ZSA9IGF3YWl0IHRoaXMuZ2V0U2l6ZShlbCk7XG4gIGNvbnN0IHRvcExlZnRDb29yZCA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcoZWwpO1xuXG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgd2lkdGg6IHNpemUud2lkdGgsXG4gICAgaGVpZ2h0OiBzaXplLmhlaWdodCxcbiAgICB0b3A6IHRvcExlZnRDb29yZC55LFxuICAgIGxlZnQ6IHRvcExlZnRDb29yZC54LFxuICAgIHNjcm9sbGFibGVPZmZzZXQ6IGNvbnRlbnRIZWlnaHRcbiAgfSk7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
