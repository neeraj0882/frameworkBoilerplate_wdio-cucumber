'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var MAX_EVENTS = 5000;

var IOSPerformanceLog = (function () {
  function IOSPerformanceLog(remoteDebugger) {
    var maxEvents = arguments.length <= 1 || arguments[1] === undefined ? MAX_EVENTS : arguments[1];

    _classCallCheck(this, IOSPerformanceLog);

    this.remoteDebugger = remoteDebugger;
    this.maxEvents = parseInt(maxEvents, 10);

    this.timelineEvents = [];
  }

  _createClass(IOSPerformanceLog, [{
    key: 'startCapture',
    value: function startCapture() {
      return _regeneratorRuntime.async(function startCapture$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Starting performance (Timeline) log capture');
            this.timelineEvents = [];
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.remoteDebugger.startTimeline(this.onTimelineEvent.bind(this)));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopCapture',
    value: function stopCapture() {
      return _regeneratorRuntime.async(function stopCapture$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Stopping performance (Timeline) log capture');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.remoteDebugger.stopTimeline());

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'onTimelineEvent',
    value: function onTimelineEvent(event) {
      _logger2['default'].debug('Received Timeline event: ' + _lodash2['default'].truncate(JSON.stringify(event)));
      this.timelineEvents.push(event);

      // if we have too many, get rid of the oldest log line
      if (this.timelineEvents.length > this.maxEvents) {
        var removedEvent = this.timelineEvents.shift();
        _logger2['default'].warn('Too many Timeline events, removing earliest: ' + _lodash2['default'].truncate(JSON.stringify(removedEvent)));
      }
    }
  }, {
    key: 'getLogs',
    value: function getLogs() {
      var events;
      return _regeneratorRuntime.async(function getLogs$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            events = this.timelineEvents;

            // flush events
            _logger2['default'].debug('Flushing Timeline events');
            this.timelineEvents = [];

            return context$2$0.abrupt('return', events);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getAllLogs',
    value: function getAllLogs() {
      return _regeneratorRuntime.async(function getAllLogs$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', this.getLogs());

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return IOSPerformanceLog;
})();

exports.IOSPerformanceLog = IOSPerformanceLog;
exports['default'] = IOSPerformanceLog;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1wZXJmb3JtYW5jZS1sb2cuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7c0JBQW1CLFVBQVU7Ozs7c0JBQ2YsUUFBUTs7OztBQUV0QixJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUM7O0lBRWxCLGlCQUFpQjtBQUNULFdBRFIsaUJBQWlCLENBQ1IsY0FBYyxFQUEwQjtRQUF4QixTQUFTLHlEQUFHLFVBQVU7OzBCQUQvQyxpQkFBaUI7O0FBRW5CLFFBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO0FBQ3JDLFFBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQzs7QUFFekMsUUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7R0FDMUI7O2VBTkcsaUJBQWlCOztXQVFGOzs7O0FBQ2pCLGdDQUFPLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBQzVELGdCQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQzs7NkNBQ1osSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7Ozs7Ozs7S0FDaEY7OztXQUVpQjs7OztBQUNoQixnQ0FBTyxLQUFLLENBQUMsNkNBQTZDLENBQUMsQ0FBQzs7NkNBQy9DLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFOzs7Ozs7Ozs7O0tBQ2hEOzs7V0FFZSx5QkFBQyxLQUFLLEVBQUU7QUFDdEIsMEJBQU8sS0FBSywrQkFBNkIsb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBRyxDQUFDO0FBQzlFLFVBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDOzs7QUFHaEMsVUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFO0FBQy9DLFlBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDL0MsNEJBQU8sSUFBSSxtREFBaUQsb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBRyxDQUFDO09BQ3pHO0tBQ0Y7OztXQUVhO1VBQ1IsTUFBTTs7OztBQUFOLGtCQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWM7OztBQUdoQyxnQ0FBTyxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUN6QyxnQkFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7O2dEQUVsQixNQUFNOzs7Ozs7O0tBQ2Q7OztXQUVnQjs7OztnREFDUixJQUFJLENBQUMsT0FBTyxFQUFFOzs7Ozs7O0tBQ3RCOzs7U0ExQ0csaUJBQWlCOzs7UUE4Q2QsaUJBQWlCLEdBQWpCLGlCQUFpQjtxQkFDWCxpQkFBaUIiLCJmaWxlIjoibGliL2RldmljZS1sb2cvaW9zLXBlcmZvcm1hbmNlLWxvZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgTUFYX0VWRU5UUyA9IDUwMDA7XG5cbmNsYXNzIElPU1BlcmZvcm1hbmNlTG9nIHtcbiAgY29uc3RydWN0b3IgKHJlbW90ZURlYnVnZ2VyLCBtYXhFdmVudHMgPSBNQVhfRVZFTlRTKSB7XG4gICAgdGhpcy5yZW1vdGVEZWJ1Z2dlciA9IHJlbW90ZURlYnVnZ2VyO1xuICAgIHRoaXMubWF4RXZlbnRzID0gcGFyc2VJbnQobWF4RXZlbnRzLCAxMCk7XG5cbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRzID0gW107XG4gIH1cblxuICBhc3luYyBzdGFydENhcHR1cmUgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnU3RhcnRpbmcgcGVyZm9ybWFuY2UgKFRpbWVsaW5lKSBsb2cgY2FwdHVyZScpO1xuICAgIHRoaXMudGltZWxpbmVFdmVudHMgPSBbXTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5yZW1vdGVEZWJ1Z2dlci5zdGFydFRpbWVsaW5lKHRoaXMub25UaW1lbGluZUV2ZW50LmJpbmQodGhpcykpO1xuICB9XG5cbiAgYXN5bmMgc3RvcENhcHR1cmUgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnU3RvcHBpbmcgcGVyZm9ybWFuY2UgKFRpbWVsaW5lKSBsb2cgY2FwdHVyZScpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnJlbW90ZURlYnVnZ2VyLnN0b3BUaW1lbGluZSgpO1xuICB9XG5cbiAgb25UaW1lbGluZUV2ZW50IChldmVudCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgUmVjZWl2ZWQgVGltZWxpbmUgZXZlbnQ6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShldmVudCkpfWApO1xuICAgIHRoaXMudGltZWxpbmVFdmVudHMucHVzaChldmVudCk7XG5cbiAgICAvLyBpZiB3ZSBoYXZlIHRvbyBtYW55LCBnZXQgcmlkIG9mIHRoZSBvbGRlc3QgbG9nIGxpbmVcbiAgICBpZiAodGhpcy50aW1lbGluZUV2ZW50cy5sZW5ndGggPiB0aGlzLm1heEV2ZW50cykge1xuICAgICAgbGV0IHJlbW92ZWRFdmVudCA9IHRoaXMudGltZWxpbmVFdmVudHMuc2hpZnQoKTtcbiAgICAgIGxvZ2dlci53YXJuKGBUb28gbWFueSBUaW1lbGluZSBldmVudHMsIHJlbW92aW5nIGVhcmxpZXN0OiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocmVtb3ZlZEV2ZW50KSl9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0TG9ncyAoKSB7XG4gICAgbGV0IGV2ZW50cyA9IHRoaXMudGltZWxpbmVFdmVudHM7XG5cbiAgICAvLyBmbHVzaCBldmVudHNcbiAgICBsb2dnZXIuZGVidWcoJ0ZsdXNoaW5nIFRpbWVsaW5lIGV2ZW50cycpO1xuICAgIHRoaXMudGltZWxpbmVFdmVudHMgPSBbXTtcblxuICAgIHJldHVybiBldmVudHM7XG4gIH1cblxuICBhc3luYyBnZXRBbGxMb2dzICgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRMb2dzKCk7XG4gIH1cbn1cblxuXG5leHBvcnQgeyBJT1NQZXJmb3JtYW5jZUxvZyB9O1xuZXhwb3J0IGRlZmF1bHQgSU9TUGVyZm9ybWFuY2VMb2c7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
