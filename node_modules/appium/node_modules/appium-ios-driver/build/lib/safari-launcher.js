'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var SAFARI_LAUNCHER_DIR = _path2['default'].resolve(__dirname, '..', '..', 'build', 'SafariLauncher');
var SAFARI_LAUNCHER_APP_FILE = _path2['default'].resolve(__dirname, '..', '..', 'build', 'SafariLauncher', 'SafariLauncher.app');
var SAFARI_LAUNCHER_REPO = _path2['default'].resolve(__dirname, '..', '..', 'node_modules', 'safari-launcher');
var SAFARI_LAUNCHER_CONFIG_FILE = _path2['default'].resolve(SAFARI_LAUNCHER_REPO, 'build.xcconfig');
var SAFARI_LAUNCHER_BUNDLE = 'com.bytearc.SafariLauncher';

var sdks = ['iphoneos'];

function cleanApp(appRoot, sdk) {
  return _regeneratorRuntime.async(function cleanApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Cleaning SafariLauncher for ' + sdk);
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcodebuild', ['-sdk', sdk, 'clean'], { cwd: appRoot }));

      case 4:
        context$1$0.next = 10;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].error(context$1$0.t0);
        throw context$1$0.t0;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function cleanAll() {
  var sdkVer, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, sdk, fullSdk;

  return _regeneratorRuntime.async(function cleanAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info("Cleaning SafariLauncher");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

      case 3:
        sdkVer = context$1$0.sent;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 7;
        _iterator = _getIterator(sdks);

      case 9:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 17;
          break;
        }

        sdk = _step.value;
        fullSdk = sdk + sdkVer;
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(cleanApp(SAFARI_LAUNCHER_REPO, fullSdk));

      case 14:
        _iteratorNormalCompletion = true;
        context$1$0.next = 9;
        break;

      case 17:
        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        context$1$0.next = 33;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(SAFARI_LAUNCHER_DIR));

      case 33:
        _logger2['default'].info("Finished cleaning SafariLauncher");

      case 34:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 19, 23, 31], [24,, 26, 30]]);
}

function buildApp(appRoot, sdk) {
  var args;
  return _regeneratorRuntime.async(function buildApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;

        _logger2['default'].debug('Building SafariLauncher for ' + sdk);
        args = ['-sdk', sdk, '-xcconfig', SAFARI_LAUNCHER_CONFIG_FILE];
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcodebuild', args, {
          cwd: appRoot
        }));

      case 5:
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].error(context$1$0.t0);
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 7]]);
}

function buildAll() {
  var sdkVer, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, sdk, fullSdk;

  return _regeneratorRuntime.async(function buildAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info("Building SafariLauncher");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

      case 3:
        sdkVer = context$1$0.sent;
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 7;
        _iterator2 = _getIterator(sdks);

      case 9:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 17;
          break;
        }

        sdk = _step2.value;
        fullSdk = sdk + sdkVer;
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(buildApp(SAFARI_LAUNCHER_REPO, fullSdk));

      case 14:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 9;
        break;

      case 17:
        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError2) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError2;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        _logger2['default'].info("Finished building SafariLauncher");

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 19, 23, 31], [24,, 26, 30]]);
}

function renameAll() {
  var file;
  return _regeneratorRuntime.async(function renameAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;

        _logger2['default'].info("Renaming SafariLauncher");
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SAFARI_LAUNCHER_DIR));

      case 4:
        if (context$1$0.sent) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SAFARI_LAUNCHER_DIR));

      case 7:
        file = _path2['default'].resolve(SAFARI_LAUNCHER_REPO, 'build', 'Release-iphoneos', 'SafariLauncher.app');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rename(file, SAFARI_LAUNCHER_APP_FILE));

      case 10:
        _logger2['default'].info("Finished renaming SafariLauncher");
        context$1$0.next = 17;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].warn("Could not rename SafariLauncher");
        _logger2['default'].errorAndThrow(context$1$0.t0);

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 13]]);
}

function updateConfig() {
  var config;
  return _regeneratorRuntime.async(function updateConfig$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Updating config for Safari Launcher');
        config = 'BUNDLE_ID = ' + SAFARI_LAUNCHER_BUNDLE + '\nIDENTITY_NAME = iPhone Developer\nIDENTITY_CODE =';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(SAFARI_LAUNCHER_CONFIG_FILE, config));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function install() {
  return _regeneratorRuntime.async(function install$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(cleanAll());

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(updateConfig());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(buildAll());

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(renameAll());

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function needsInstall() {
  var exists;
  return _regeneratorRuntime.async(function needsInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Checking for presence of SafariLauncher at \'' + SAFARI_LAUNCHER_APP_FILE + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SAFARI_LAUNCHER_APP_FILE));

      case 3:
        exists = context$1$0.sent;

        _logger2['default'].debug('SafariLauncher ' + (exists ? 'exists' : 'does not exist'));
        return context$1$0.abrupt('return', !exists);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.install = install;
exports.needsInstall = needsInstall;
exports.SAFARI_LAUNCHER_APP_FILE = SAFARI_LAUNCHER_APP_FILE;
exports.SAFARI_LAUNCHER_BUNDLE = SAFARI_LAUNCHER_BUNDLE;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUF4Qix3QkFBd0I7UUFBRSxzQkFBc0IsR0FBdEIsc0JBQXNCIiwiZmlsZSI6ImxpYi9zYWZhcmktbGF1bmNoZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5cbmNvbnN0IFNBRkFSSV9MQVVOQ0hFUl9ESVIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdidWlsZCcsICdTYWZhcmlMYXVuY2hlcicpO1xuY29uc3QgU0FGQVJJX0xBVU5DSEVSX0FQUF9GSUxFID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYnVpbGQnLCAnU2FmYXJpTGF1bmNoZXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTYWZhcmlMYXVuY2hlci5hcHAnKTtcbmNvbnN0IFNBRkFSSV9MQVVOQ0hFUl9SRVBPID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdub2RlX21vZHVsZXMnLCAnc2FmYXJpLWxhdW5jaGVyJyk7XG5jb25zdCBTQUZBUklfTEFVTkNIRVJfQ09ORklHX0ZJTEUgPSBwYXRoLnJlc29sdmUoU0FGQVJJX0xBVU5DSEVSX1JFUE8sICdidWlsZC54Y2NvbmZpZycpO1xuY29uc3QgU0FGQVJJX0xBVU5DSEVSX0JVTkRMRSA9ICdjb20uYnl0ZWFyYy5TYWZhcmlMYXVuY2hlcic7XG5cbmNvbnN0IHNka3MgPSBbJ2lwaG9uZW9zJ107XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFuQXBwIChhcHBSb290LCBzZGspIHtcbiAgbG9nZ2VyLmRlYnVnKGBDbGVhbmluZyBTYWZhcmlMYXVuY2hlciBmb3IgJHtzZGt9YCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygneGNvZGVidWlsZCcsIFsnLXNkaycsIHNkaywgJ2NsZWFuJ10sIHtjd2Q6IGFwcFJvb3R9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFuQWxsICgpIHtcbiAgbG9nZ2VyLmluZm8oXCJDbGVhbmluZyBTYWZhcmlMYXVuY2hlclwiKTtcbiAgbGV0IHNka1ZlciA9IGF3YWl0IHhjb2RlLmdldE1heElPU1NESygpO1xuICBmb3IgKGxldCBzZGsgb2Ygc2Rrcykge1xuICAgIGxldCBmdWxsU2RrID0gc2RrK3Nka1ZlcjtcbiAgICBhd2FpdCBjbGVhbkFwcChTQUZBUklfTEFVTkNIRVJfUkVQTywgZnVsbFNkayk7XG4gIH1cbiAgYXdhaXQgZnMucmltcmFmKFNBRkFSSV9MQVVOQ0hFUl9ESVIpO1xuICBsb2dnZXIuaW5mbyhcIkZpbmlzaGVkIGNsZWFuaW5nIFNhZmFyaUxhdW5jaGVyXCIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBidWlsZEFwcCAoYXBwUm9vdCwgc2RrKSB7XG4gIHRyeSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBCdWlsZGluZyBTYWZhcmlMYXVuY2hlciBmb3IgJHtzZGt9YCk7XG4gICAgbGV0IGFyZ3MgPSBbJy1zZGsnLCBzZGssICcteGNjb25maWcnLCBTQUZBUklfTEFVTkNIRVJfQ09ORklHX0ZJTEVdO1xuICAgIGF3YWl0IGV4ZWMoJ3hjb2RlYnVpbGQnLCBhcmdzLCB7XG4gICAgICBjd2Q6IGFwcFJvb3RcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGJ1aWxkQWxsICgpIHtcbiAgbG9nZ2VyLmluZm8oXCJCdWlsZGluZyBTYWZhcmlMYXVuY2hlclwiKTtcbiAgbGV0IHNka1ZlciA9IGF3YWl0IHhjb2RlLmdldE1heElPU1NESygpO1xuICBmb3IgKGxldCBzZGsgb2Ygc2Rrcykge1xuICAgIGxldCBmdWxsU2RrID0gc2RrICsgc2RrVmVyO1xuICAgIGF3YWl0IGJ1aWxkQXBwKFNBRkFSSV9MQVVOQ0hFUl9SRVBPLCBmdWxsU2RrKTtcbiAgfVxuICBsb2dnZXIuaW5mbyhcIkZpbmlzaGVkIGJ1aWxkaW5nIFNhZmFyaUxhdW5jaGVyXCIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZW5hbWVBbGwgKCkge1xuICB0cnkge1xuICAgIGxvZ2dlci5pbmZvKFwiUmVuYW1pbmcgU2FmYXJpTGF1bmNoZXJcIik7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoU0FGQVJJX0xBVU5DSEVSX0RJUikpIHtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKFNBRkFSSV9MQVVOQ0hFUl9ESVIpO1xuICAgIH1cblxuICAgIGxldCBmaWxlID0gcGF0aC5yZXNvbHZlKFNBRkFSSV9MQVVOQ0hFUl9SRVBPLCAnYnVpbGQnLCAnUmVsZWFzZS1pcGhvbmVvcycsICdTYWZhcmlMYXVuY2hlci5hcHAnKTtcbiAgICBhd2FpdCBmcy5yZW5hbWUoXG4gICAgICBmaWxlLFxuICAgICAgU0FGQVJJX0xBVU5DSEVSX0FQUF9GSUxFKTtcbiAgICBsb2dnZXIuaW5mbyhcIkZpbmlzaGVkIHJlbmFtaW5nIFNhZmFyaUxhdW5jaGVyXCIpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIud2FybihcIkNvdWxkIG5vdCByZW5hbWUgU2FmYXJpTGF1bmNoZXJcIik7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coZXJyKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVDb25maWcgKCkge1xuICBsb2dnZXIuaW5mbygnVXBkYXRpbmcgY29uZmlnIGZvciBTYWZhcmkgTGF1bmNoZXInKTtcbiAgbGV0IGNvbmZpZyA9IGBCVU5ETEVfSUQgPSAke1NBRkFSSV9MQVVOQ0hFUl9CVU5ETEV9XG5JREVOVElUWV9OQU1FID0gaVBob25lIERldmVsb3BlclxuSURFTlRJVFlfQ09ERSA9YDtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKFNBRkFSSV9MQVVOQ0hFUl9DT05GSUdfRklMRSwgY29uZmlnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbCAoKSB7XG4gIGF3YWl0IGNsZWFuQWxsKCk7XG4gIGF3YWl0IHVwZGF0ZUNvbmZpZygpO1xuICBhd2FpdCBidWlsZEFsbCgpO1xuICBhd2FpdCByZW5hbWVBbGwoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbmVlZHNJbnN0YWxsICgpIHtcbiAgbG9nZ2VyLmRlYnVnKGBDaGVja2luZyBmb3IgcHJlc2VuY2Ugb2YgU2FmYXJpTGF1bmNoZXIgYXQgJyR7U0FGQVJJX0xBVU5DSEVSX0FQUF9GSUxFfSdgKTtcbiAgbGV0IGV4aXN0cyA9IGF3YWl0IGZzLmV4aXN0cyhTQUZBUklfTEFVTkNIRVJfQVBQX0ZJTEUpO1xuICBsb2dnZXIuZGVidWcoYFNhZmFyaUxhdW5jaGVyICR7ZXhpc3RzID8gJ2V4aXN0cycgOiAnZG9lcyBub3QgZXhpc3QnfWApO1xuICByZXR1cm4gIWV4aXN0cztcbn1cblxuXG5leHBvcnQgeyBpbnN0YWxsLCBuZWVkc0luc3RhbGwsIFNBRkFSSV9MQVVOQ0hFUl9BUFBfRklMRSwgU0FGQVJJX0xBVU5DSEVSX0JVTkRMRSB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
