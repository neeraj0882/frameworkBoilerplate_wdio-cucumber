'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _utf7 = require('utf7');

var _utf72 = _interopRequireDefault(_utf7);

var _appiumAndroidDriver = require('appium-android-driver');

var _driver = require('./driver');

var imap = _utf72['default'].imap;

var extensions = {},
    commands = {},
    helpers = {};

commands.launchApp = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.startSelendroidSession());

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};
commands.reset = function callee$0$0() {
  var oldImpWait, oldCommandTimeoutMs, oldSessionId;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Running generic full reset");
        oldImpWait = this.implicitWaitMs;
        oldCommandTimeoutMs = this.commandTimeoutMs;
        oldSessionId = this.sessionId;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.deleteSession());

      case 6:
        _logger2['default'].debug("Restarting app");
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.startSelendroidSession());

      case 9:
        this.implicitWait(oldImpWait);
        this.timeouts('command', oldCommandTimeoutMs);
        this.sessionId = oldSessionId;

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.performMultiAction = function callee$0$0(elId, actions) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!elId) {
          context$1$0.next = 2;
          break;
        }

        throw new Error("Selendroid actions do not support element id");

      case 2:
        return context$1$0.abrupt('return', this.selendroid.jwproxy.command('/action', 'POST', { payload: actions }));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function encodeString(value, unicode) {
  for (var i = 0; i < value.length; i++) {
    var c = value.charCodeAt(i);
    // if we're using the unicode keyboard, and this is unicode, maybe encode
    if (unicode && (c > 127 || c === 38)) {
      // this is not simple ascii, or it is an ampersand (`&`)
      if (c >= parseInt("E000", 16) && c <= parseInt("E040", 16)) {
        // Selenium uses a Unicode PUA to cover certain special characters
        // see https://code.google.com/p/selenium/source/browse/java/client/src/org/openqa/selenium/Keys.java
      } else {
          // encode the text
          value = imap.encode(value);
          break;
        }
    }
  }
  return value;
}

// Need to override this for correct unicode support
commands.setValue = function callee$0$0(value, elementId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (value instanceof Array) {
          value = value.join("");
        }
        _logger2['default'].debug('Setting text on element \'' + elementId + '\': \'' + value + '\'');
        value = encodeString(value, this.opts.unicodeKeyboard);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/element/' + elementId + '/value', 'POST', { value: [value] }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// This is needed to satisfy updated WebElement interface in Selenium 3
commands.getElementRect = function callee$0$0(elementId) {
  var location, size;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/element/' + elementId + '/location', 'GET'));

      case 2:
        location = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/element/' + elementId + '/size', 'GET'));

      case 5:
        size = context$1$0.sent;
        return context$1$0.abrupt('return', _Object$assign(location, size));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Need to override this for correct unicode support
commands.keys = function callee$0$0(value) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (value instanceof Array) {
          value = value.join("");
        }
        _logger2['default'].debug('Setting text: \'' + value + '\'');
        value = encodeString(value, this.opts.unicodeKeyboard);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/keys', 'POST', { value: [value] }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Selendroid doesn't support metastate for keyevents
commands.keyevent = function callee$0$0(keycode, metastate) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Ignoring metastate ' + metastate);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.adb.keyevent(keycode));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Use ADB since we don't have UiAutomator
commands.back = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.adb.keyevent(4));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getContexts = function callee$0$0() {
  var chromiumViews, webviews, selendroidViews;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        chromiumViews = [];
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumAndroidDriver.webviewHelpers.getWebviews(this.adb, this.opts.androidDeviceSocket));

      case 3:
        webviews = context$1$0.sent;

        if (_lodash2['default'].includes(webviews, _appiumAndroidDriver.CHROMIUM_WIN)) {
          chromiumViews = [_appiumAndroidDriver.CHROMIUM_WIN];
        } else {
          chromiumViews = [];
        }

        _logger2['default'].info('Getting window handles from Selendroid');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/window_handles', 'GET', {}));

      case 8:
        selendroidViews = context$1$0.sent;

        this.contexts = _lodash2['default'].union(selendroidViews, chromiumViews);
        _logger2['default'].info('Available contexts: ' + JSON.stringify(this.contexts));
        return context$1$0.abrupt('return', this.contexts);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.switchContext = function callee$0$0(name) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/window', 'POST', { name: name }));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.isChromedriverContext = function (windowName) {
  return windowName === _appiumAndroidDriver.CHROMIUM_WIN;
};

// Need to override android-driver's version of this since we don't actually
// have a bootstrap; instead we just restart adb and re-forward the Selendroid
// port
helpers.wrapBootstrapDisconnect = function callee$0$0(wrapped) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(wrapped());

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.adb.restart());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.adb.forwardPort(this.opts.systemPort, _driver.DEVICE_PORT));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);

exports['default'] = extensions;
module.exports = exports['default'];

// called when setting context
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Ozs7eUNBQ2pELE9BQU8sRUFBRTs7Ozt5Q0FDVCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRTs7Ozt5Q0FDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLHNCQUFjOzs7Ozs7O0NBQzlELENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDOztxQkFFOUIsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgdXRmNyBmcm9tICd1dGY3JztcbmltcG9ydCB7IHdlYnZpZXdIZWxwZXJzLCBDSFJPTUlVTV9XSU4gfSBmcm9tICdhcHBpdW0tYW5kcm9pZC1kcml2ZXInO1xuaW1wb3J0IHsgREVWSUNFX1BPUlQgfSBmcm9tICcuL2RyaXZlcic7XG5cbmNvbnN0IHtpbWFwfSA9IHV0Zjc7XG5cbmxldCBleHRlbnNpb25zID0ge30sXG4gICAgY29tbWFuZHMgPSB7fSxcbiAgICBoZWxwZXJzID0ge307XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgYXdhaXQgdGhpcy5zdGFydFNlbGVuZHJvaWRTZXNzaW9uKCk7XG59O1xuY29tbWFuZHMucmVzZXQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZy5kZWJ1ZyhcIlJ1bm5pbmcgZ2VuZXJpYyBmdWxsIHJlc2V0XCIpO1xuICBsZXQgb2xkSW1wV2FpdCA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIGxldCBvbGRDb21tYW5kVGltZW91dE1zID0gdGhpcy5jb21tYW5kVGltZW91dE1zO1xuICBsZXQgb2xkU2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uSWQ7XG5cbiAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKCk7XG4gIGxvZy5kZWJ1ZyhcIlJlc3RhcnRpbmcgYXBwXCIpO1xuICBhd2FpdCB0aGlzLnN0YXJ0U2VsZW5kcm9pZFNlc3Npb24oKTtcbiAgdGhpcy5pbXBsaWNpdFdhaXQob2xkSW1wV2FpdCk7XG4gIHRoaXMudGltZW91dHMoJ2NvbW1hbmQnLCBvbGRDb21tYW5kVGltZW91dE1zKTtcbiAgdGhpcy5zZXNzaW9uSWQgPSBvbGRTZXNzaW9uSWQ7XG59O1xuXG5jb21tYW5kcy5wZXJmb3JtTXVsdGlBY3Rpb24gPSBhc3luYyBmdW5jdGlvbiAoZWxJZCwgYWN0aW9ucykge1xuICBpZiAoZWxJZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlNlbGVuZHJvaWQgYWN0aW9ucyBkbyBub3Qgc3VwcG9ydCBlbGVtZW50IGlkXCIpO1xuICB9XG4gIHJldHVybiB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKCcvYWN0aW9uJywgJ1BPU1QnLCB7cGF5bG9hZDogYWN0aW9uc30pO1xufTtcblxuZnVuY3Rpb24gZW5jb2RlU3RyaW5nICh2YWx1ZSwgdW5pY29kZSkge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IGMgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpO1xuICAgIC8vIGlmIHdlJ3JlIHVzaW5nIHRoZSB1bmljb2RlIGtleWJvYXJkLCBhbmQgdGhpcyBpcyB1bmljb2RlLCBtYXliZSBlbmNvZGVcbiAgICBpZiAodW5pY29kZSAmJiAoYyA+IDEyNyB8fCBjID09PSAzOCkpIHtcbiAgICAgIC8vIHRoaXMgaXMgbm90IHNpbXBsZSBhc2NpaSwgb3IgaXQgaXMgYW4gYW1wZXJzYW5kIChgJmApXG4gICAgICBpZiAoYyA+PSBwYXJzZUludChcIkUwMDBcIiwgMTYpICYmIGMgPD0gcGFyc2VJbnQoXCJFMDQwXCIsIDE2KSkge1xuICAgICAgICAvLyBTZWxlbml1bSB1c2VzIGEgVW5pY29kZSBQVUEgdG8gY292ZXIgY2VydGFpbiBzcGVjaWFsIGNoYXJhY3RlcnNcbiAgICAgICAgLy8gc2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3Avc2VsZW5pdW0vc291cmNlL2Jyb3dzZS9qYXZhL2NsaWVudC9zcmMvb3JnL29wZW5xYS9zZWxlbml1bS9LZXlzLmphdmFcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGVuY29kZSB0aGUgdGV4dFxuICAgICAgICB2YWx1ZSA9IGltYXAuZW5jb2RlKHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB2YWx1ZTtcbn1cblxuLy8gTmVlZCB0byBvdmVycmlkZSB0aGlzIGZvciBjb3JyZWN0IHVuaWNvZGUgc3VwcG9ydFxuY29tbWFuZHMuc2V0VmFsdWUgPSBhc3luYyBmdW5jdGlvbiAodmFsdWUsIGVsZW1lbnRJZCkge1xuICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIHZhbHVlID0gdmFsdWUuam9pbihcIlwiKTtcbiAgfVxuICBsb2cuZGVidWcoYFNldHRpbmcgdGV4dCBvbiBlbGVtZW50ICcke2VsZW1lbnRJZH0nOiAnJHt2YWx1ZX0nYCk7XG4gIHZhbHVlID0gZW5jb2RlU3RyaW5nKHZhbHVlLCB0aGlzLm9wdHMudW5pY29kZUtleWJvYXJkKTtcbiAgYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZChgL2VsZW1lbnQvJHtlbGVtZW50SWR9L3ZhbHVlYCwgJ1BPU1QnLCB7dmFsdWU6IFt2YWx1ZV19KTtcbn07XG5cbi8vIFRoaXMgaXMgbmVlZGVkIHRvIHNhdGlzZnkgdXBkYXRlZCBXZWJFbGVtZW50IGludGVyZmFjZSBpbiBTZWxlbml1bSAzXG5jb21tYW5kcy5nZXRFbGVtZW50UmVjdCA9IGFzeW5jIGZ1bmN0aW9uIChlbGVtZW50SWQpIHtcbiAgY29uc3QgbG9jYXRpb24gPSBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKGAvZWxlbWVudC8ke2VsZW1lbnRJZH0vbG9jYXRpb25gLCAnR0VUJyk7XG4gIGNvbnN0IHNpemUgPSBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKGAvZWxlbWVudC8ke2VsZW1lbnRJZH0vc2l6ZWAsICdHRVQnKTtcbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24obG9jYXRpb24sIHNpemUpO1xufTtcblxuLy8gTmVlZCB0byBvdmVycmlkZSB0aGlzIGZvciBjb3JyZWN0IHVuaWNvZGUgc3VwcG9ydFxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uICh2YWx1ZSkge1xuICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIHZhbHVlID0gdmFsdWUuam9pbihcIlwiKTtcbiAgfVxuICBsb2cuZGVidWcoYFNldHRpbmcgdGV4dDogJyR7dmFsdWV9J2ApO1xuICB2YWx1ZSA9IGVuY29kZVN0cmluZyh2YWx1ZSwgdGhpcy5vcHRzLnVuaWNvZGVLZXlib2FyZCk7XG4gIGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoJy9rZXlzJywgJ1BPU1QnLCB7dmFsdWU6IFt2YWx1ZV19KTtcbn07XG5cbi8vIFNlbGVuZHJvaWQgZG9lc24ndCBzdXBwb3J0IG1ldGFzdGF0ZSBmb3Iga2V5ZXZlbnRzXG5jb21tYW5kcy5rZXlldmVudCA9IGFzeW5jIGZ1bmN0aW9uIChrZXljb2RlLCBtZXRhc3RhdGUpIHtcbiAgbG9nLmRlYnVnKGBJZ25vcmluZyBtZXRhc3RhdGUgJHttZXRhc3RhdGV9YCk7XG4gIGF3YWl0IHRoaXMuYWRiLmtleWV2ZW50KGtleWNvZGUpO1xufTtcblxuLy8gVXNlIEFEQiBzaW5jZSB3ZSBkb24ndCBoYXZlIFVpQXV0b21hdG9yXG5jb21tYW5kcy5iYWNrID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBhd2FpdCB0aGlzLmFkYi5rZXlldmVudCg0KTtcbn07XG5cbmNvbW1hbmRzLmdldENvbnRleHRzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgY2hyb21pdW1WaWV3cyA9IFtdO1xuICBsZXQgd2Vidmlld3MgPSBhd2FpdCB3ZWJ2aWV3SGVscGVycy5nZXRXZWJ2aWV3cyh0aGlzLmFkYixcbiAgICAgIHRoaXMub3B0cy5hbmRyb2lkRGV2aWNlU29ja2V0KTtcbiAgaWYgKF8uaW5jbHVkZXMod2Vidmlld3MsIENIUk9NSVVNX1dJTikpIHtcbiAgICBjaHJvbWl1bVZpZXdzID0gW0NIUk9NSVVNX1dJTl07XG4gIH0gZWxzZSB7XG4gICAgY2hyb21pdW1WaWV3cyA9IFtdO1xuICB9XG5cbiAgbG9nLmluZm8oJ0dldHRpbmcgd2luZG93IGhhbmRsZXMgZnJvbSBTZWxlbmRyb2lkJyk7XG4gIGxldCBzZWxlbmRyb2lkVmlld3MgPSBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKCcvd2luZG93X2hhbmRsZXMnLCAnR0VUJywge30pO1xuICB0aGlzLmNvbnRleHRzID0gXy51bmlvbihzZWxlbmRyb2lkVmlld3MsIGNocm9taXVtVmlld3MpO1xuICBsb2cuaW5mbyhgQXZhaWxhYmxlIGNvbnRleHRzOiAke0pTT04uc3RyaW5naWZ5KHRoaXMuY29udGV4dHMpfWApO1xuICByZXR1cm4gdGhpcy5jb250ZXh0cztcbn07XG5cbmhlbHBlcnMuc3dpdGNoQ29udGV4dCA9IGFzeW5jIGZ1bmN0aW9uIChuYW1lKSB7XG4gIC8vIGNhbGxlZCB3aGVuIHNldHRpbmcgY29udGV4dFxuICBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKCcvd2luZG93JywgJ1BPU1QnLCB7bmFtZX0pO1xufTtcblxuaGVscGVycy5pc0Nocm9tZWRyaXZlckNvbnRleHQgPSBmdW5jdGlvbiAod2luZG93TmFtZSkge1xuICByZXR1cm4gd2luZG93TmFtZSA9PT0gQ0hST01JVU1fV0lOO1xufTtcblxuLy8gTmVlZCB0byBvdmVycmlkZSBhbmRyb2lkLWRyaXZlcidzIHZlcnNpb24gb2YgdGhpcyBzaW5jZSB3ZSBkb24ndCBhY3R1YWxseVxuLy8gaGF2ZSBhIGJvb3RzdHJhcDsgaW5zdGVhZCB3ZSBqdXN0IHJlc3RhcnQgYWRiIGFuZCByZS1mb3J3YXJkIHRoZSBTZWxlbmRyb2lkXG4vLyBwb3J0XG5oZWxwZXJzLndyYXBCb290c3RyYXBEaXNjb25uZWN0ID0gYXN5bmMgZnVuY3Rpb24gKHdyYXBwZWQpIHtcbiAgYXdhaXQgd3JhcHBlZCgpO1xuICBhd2FpdCB0aGlzLmFkYi5yZXN0YXJ0KCk7XG4gIGF3YWl0IHRoaXMuYWRiLmZvcndhcmRQb3J0KHRoaXMub3B0cy5zeXN0ZW1Qb3J0LCBERVZJQ0VfUE9SVCk7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
