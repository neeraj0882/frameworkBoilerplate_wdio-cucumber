'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var SE_VER = "0.17.0";
var SE_DOWNLOAD_CDNURL = process.env.npm_config_selendroid_driver_cdnurl || process.env.SELENDROID_DRIVER_CDNURL || "http://repo1.maven.org/maven2/io/selendroid/selendroid-standalone";
var SE_DOWNLOAD = SE_DOWNLOAD_CDNURL + '/' + SE_VER + '/selendroid-standalone-' + SE_VER + '-with-dependencies.jar';
var SE_DOWNLOAD_SHA256 = "7cf7163ac47f1c46eff95b62f78b58c1dabdec534acc6632da3784739f6e9d82";
var SE_DIR = _path2['default'].resolve(__dirname, "..", "..", "selendroid");
var SE_DOWNLOAD_DIR = _path2['default'].resolve(SE_DIR, "download");
// Use of temporary file means that SE_JAR_PATH can only exist if it has
// verified content.
var SE_JAR_PATH_TMP = _path2['default'].resolve(SE_DOWNLOAD_DIR, "selendroid-server.jar.tmp");
// Putting fingerprint in file name means download triggered if fingerprint changed.
var SE_JAR_PATH = _path2['default'].resolve(SE_DOWNLOAD_DIR, 'selendroid-server-' + SE_DOWNLOAD_SHA256 + '.jar');
var SE_APK_PATH = _path2['default'].resolve(SE_DIR, "selendroid-server.apk");
var SE_MANIFEST_PATH = _path2['default'].resolve(SE_DIR, "AndroidManifest.xml");

function setupSelendroid() {
  var manifestPath, serverPath, extractedManifestPath, extractedServerPath;
  return _regeneratorRuntime.async(function setupSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar'));

      case 3:
        context$1$0.next = 10;
        break;

      case 5:
        context$1$0.prev = 5;
        context$1$0.t0 = context$1$0['catch'](0);

        if (!(context$1$0.t0.message.indexOf("ENOENT") !== -1 || context$1$0.t0.message.indexOf("exited with code 2") !== -1 || context$1$0.t0.message.indexOf("Command 'jar' not found. Is it installed?") !== -1)) {
          context$1$0.next = 10;
          break;
        }

        _logger2['default'].error("Could not find Java's 'jar' executable on your PATH. Please " + "ensure it is present and try running install again");
        return context$1$0.abrupt('return');

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_JAR_PATH));

      case 12:
        if (!context$1$0.sent) {
          context$1$0.next = 16;
          break;
        }

        _logger2['default'].info("Standalone jar exists, skipping download: " + SE_JAR_PATH);
        context$1$0.next = 18;
        break;

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(downloadSelendroid());

      case 18:
        _logger2['default'].info('Determining AndroidManifest location');
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/AndroidManifest.*\.xml$/, SE_JAR_PATH));

      case 21:
        manifestPath = context$1$0.sent;

        _logger2['default'].info('Determining server apk location');
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/selendroid-server.*\.apk$/, SE_JAR_PATH));

      case 25:
        serverPath = context$1$0.sent;

        _logger2['default'].info('Extracting manifest and apk to ' + SE_DOWNLOAD_DIR);
        context$1$0.next = 29;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['xf', SE_JAR_PATH, manifestPath, serverPath], {
          cwd: SE_DOWNLOAD_DIR
        }));

      case 29:
        _logger2['default'].info('Copying manifest and apk to ' + SE_DIR);
        extractedManifestPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, manifestPath);
        extractedServerPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, serverPath);
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedManifestPath, SE_MANIFEST_PATH));

      case 34:
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedServerPath, SE_APK_PATH));

      case 36:
        _logger2['default'].info("Cleaning up temp files");
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedManifestPath));

      case 39:
        context$1$0.next = 41;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedServerPath));

      case 41:
        _logger2['default'].info('Fixing AndroidManifest icon bug');
        context$1$0.next = 44;
        return _regeneratorRuntime.awrap(fixManifestIcons(SE_MANIFEST_PATH));

      case 44:
        context$1$0.next = 46;
        return _regeneratorRuntime.awrap(serverExists());

      case 46:
        if (context$1$0.sent) {
          context$1$0.next = 48;
          break;
        }

        throw new Error("Something went wrong in setting up selendroid");

      case 48:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 5]]);
}

function downloadSelendroid() {
  var body, fingerprint;
  return _regeneratorRuntime.async(function downloadSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Ensuring ' + SE_DOWNLOAD_DIR + ' exists');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DIR));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DOWNLOAD_DIR));

      case 5:
        _logger2['default'].info('Downloading Selendroid standalone server version ' + SE_VER + ' from ' + (SE_DOWNLOAD + ' --> ' + SE_JAR_PATH));
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: SE_DOWNLOAD, encoding: null }));

      case 8:
        body = context$1$0.sent;

        if (!(!body instanceof Buffer)) {
          context$1$0.next = 11;
          break;
        }

        throw new Error(Object.prototype.toString.call(body));

      case 11:
        _logger2['default'].info('Writing binary content to ' + SE_JAR_PATH_TMP);
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(SE_JAR_PATH_TMP, body));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(SE_JAR_PATH_TMP, 420));

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(sha256(body));

      case 18:
        fingerprint = context$1$0.sent;

        if (!(fingerprint === SE_DOWNLOAD_SHA256)) {
          context$1$0.next = 25;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rename(SE_JAR_PATH_TMP, SE_JAR_PATH));

      case 22:
        _logger2['default'].info("Selendroid standalone server downloaded");
        context$1$0.next = 26;
        break;

      case 25:
        _logger2['default'].errorAndThrow("bad SHA256 fingerprint: " + fingerprint + " bytes: " + body.length);

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function sha256(buffer) {
  var hash;
  return _regeneratorRuntime.async(function sha256$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        hash = _crypto2['default'].createHash('sha256');
        return context$1$0.abrupt('return', hash.update(buffer).digest('hex'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getFilePathFromJar(fileRegex, jarPath) {
  var _ref, stdout, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, line;

  return _regeneratorRuntime.async(function getFilePathFromJar$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['tf', jarPath]));

      case 2:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 7;
        _iterator = _getIterator(stdout.split("\n"));

      case 9:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 16;
          break;
        }

        line = _step.value;

        if (!fileRegex.test(line.trim())) {
          context$1$0.next = 13;
          break;
        }

        return context$1$0.abrupt('return', line.trim());

      case 13:
        _iteratorNormalCompletion = true;
        context$1$0.next = 9;
        break;

      case 16:
        context$1$0.next = 22;
        break;

      case 18:
        context$1$0.prev = 18;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 22:
        context$1$0.prev = 22;
        context$1$0.prev = 23;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 25:
        context$1$0.prev = 25;

        if (!_didIteratorError) {
          context$1$0.next = 28;
          break;
        }

        throw _iteratorError;

      case 28:
        return context$1$0.finish(25);

      case 29:
        return context$1$0.finish(22);

      case 30:
        throw new Error('Could not find ' + fileRegex + ' in ' + jarPath);

      case 31:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
}

function serverExists() {
  return _regeneratorRuntime.async(function serverExists$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_APK_PATH));

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_MANIFEST_PATH));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
        context$1$0.prev = 11;
        context$1$0.t1 = context$1$0['catch'](0);

        if (!(context$1$0.t1.code.indexOf("ENOENT") !== -1)) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 15:
        throw context$1$0.t1;

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 11]]);
}

function fixManifestIcons(manifest) {
  var curData, iconRe, newData;
  return _regeneratorRuntime.async(function fixManifestIcons$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(manifest));

      case 2:
        curData = context$1$0.sent.toString('utf8');
        iconRe = /application[\s\S]+android:icon="[^"]+"/;
        newData = curData.replace(iconRe, "application");
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(manifest, newData));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.setupSelendroid = setupSelendroid;
exports.serverExists = serverExists;
exports.SE_APK_PATH = SE_APK_PATH;
exports.SE_MANIFEST_PATH = SE_MANIFEST_PATH;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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akI7O0FBRUQsU0FBZSxnQkFBZ0IsQ0FBRSxRQUFRO01BQ25DLE9BQU8sRUFDUCxNQUFNLEVBQ04sT0FBTzs7Ozs7eUNBRlUsa0JBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQzs7O0FBQXRDLGVBQU8sb0JBQWlDLFFBQVEsQ0FBQyxNQUFNO0FBQ3ZELGNBQU0sR0FBRyx3Q0FBd0M7QUFDakQsZUFBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQzs7eUNBQzlDLGtCQUFHLFNBQVMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDOzs7Ozs7O0NBQ3RDOztRQUVRLGVBQWUsR0FBZixlQUFlO1FBQUUsWUFBWSxHQUFaLFlBQVk7UUFBRSxXQUFXLEdBQVgsV0FBVztRQUFFLGdCQUFnQixHQUFoQixnQkFBZ0IiLCJmaWxlIjoibGliL2luc3RhbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcblxuY29uc3QgU0VfVkVSID0gXCIwLjE3LjBcIjtcbmNvbnN0IFNFX0RPV05MT0FEX0NETlVSTCA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfc2VsZW5kcm9pZF9kcml2ZXJfY2RudXJsIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmVudi5TRUxFTkRST0lEX0RSSVZFUl9DRE5VUkwgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiaHR0cDovL3JlcG8xLm1hdmVuLm9yZy9tYXZlbjIvaW8vc2VsZW5kcm9pZC9zZWxlbmRyb2lkLXN0YW5kYWxvbmVcIjtcbmNvbnN0IFNFX0RPV05MT0FEID0gYCR7U0VfRE9XTkxPQURfQ0ROVVJMfS8ke1NFX1ZFUn0vc2VsZW5kcm9pZC1zdGFuZGFsb25lLSR7U0VfVkVSfS13aXRoLWRlcGVuZGVuY2llcy5qYXJgO1xuY29uc3QgU0VfRE9XTkxPQURfU0hBMjU2ID0gXCI3Y2Y3MTYzYWM0N2YxYzQ2ZWZmOTViNjJmNzhiNThjMWRhYmRlYzUzNGFjYzY2MzJkYTM3ODQ3MzlmNmU5ZDgyXCI7XG5jb25zdCBTRV9ESVIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBcIi4uXCIsIFwiLi5cIiwgXCJzZWxlbmRyb2lkXCIpO1xuY29uc3QgU0VfRE9XTkxPQURfRElSID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJkb3dubG9hZFwiKTtcbi8vIFVzZSBvZiB0ZW1wb3JhcnkgZmlsZSBtZWFucyB0aGF0IFNFX0pBUl9QQVRIIGNhbiBvbmx5IGV4aXN0IGlmIGl0IGhhc1xuLy8gdmVyaWZpZWQgY29udGVudC5cbmNvbnN0IFNFX0pBUl9QQVRIX1RNUCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIFwic2VsZW5kcm9pZC1zZXJ2ZXIuamFyLnRtcFwiKTtcbi8vIFB1dHRpbmcgZmluZ2VycHJpbnQgaW4gZmlsZSBuYW1lIG1lYW5zIGRvd25sb2FkIHRyaWdnZXJlZCBpZiBmaW5nZXJwcmludCBjaGFuZ2VkLlxuY29uc3QgU0VfSkFSX1BBVEggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBgc2VsZW5kcm9pZC1zZXJ2ZXItJHtTRV9ET1dOTE9BRF9TSEEyNTZ9LmphcmApO1xuY29uc3QgU0VfQVBLX1BBVEggPSBwYXRoLnJlc29sdmUoU0VfRElSLCBcInNlbGVuZHJvaWQtc2VydmVyLmFwa1wiKTtcbmNvbnN0IFNFX01BTklGRVNUX1BBVEggPSBwYXRoLnJlc29sdmUoU0VfRElSLCBcIkFuZHJvaWRNYW5pZmVzdC54bWxcIik7XG5cbmFzeW5jIGZ1bmN0aW9uIHNldHVwU2VsZW5kcm9pZCAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygnamFyJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKFwiRU5PRU5UXCIpICE9PSAtMSB8fFxuICAgICAgICBlcnIubWVzc2FnZS5pbmRleE9mKFwiZXhpdGVkIHdpdGggY29kZSAyXCIpICE9PSAtMSB8fFxuICAgICAgICBlcnIubWVzc2FnZS5pbmRleE9mKFwiQ29tbWFuZCAnamFyJyBub3QgZm91bmQuIElzIGl0IGluc3RhbGxlZD9cIikgIT09IC0xKSB7XG4gICAgICBsb2cuZXJyb3IoXCJDb3VsZCBub3QgZmluZCBKYXZhJ3MgJ2phcicgZXhlY3V0YWJsZSBvbiB5b3VyIFBBVEguIFBsZWFzZSBcIiArXG4gICAgICAgICAgICAgICAgXCJlbnN1cmUgaXQgaXMgcHJlc2VudCBhbmQgdHJ5IHJ1bm5pbmcgaW5zdGFsbCBhZ2FpblwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhTRV9KQVJfUEFUSCkpIHtcbiAgICBsb2cuaW5mbyhcIlN0YW5kYWxvbmUgamFyIGV4aXN0cywgc2tpcHBpbmcgZG93bmxvYWQ6IFwiICsgU0VfSkFSX1BBVEgpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IGRvd25sb2FkU2VsZW5kcm9pZCgpO1xuICB9XG4gIGxvZy5pbmZvKGBEZXRlcm1pbmluZyBBbmRyb2lkTWFuaWZlc3QgbG9jYXRpb25gKTtcbiAgbGV0IG1hbmlmZXN0UGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvQW5kcm9pZE1hbmlmZXN0LipcXC54bWwkLyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZy5pbmZvKGBEZXRlcm1pbmluZyBzZXJ2ZXIgYXBrIGxvY2F0aW9uYCk7XG4gIGxldCBzZXJ2ZXJQYXRoID0gYXdhaXQgZ2V0RmlsZVBhdGhGcm9tSmFyKC9zZWxlbmRyb2lkLXNlcnZlci4qXFwuYXBrJC8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNFX0pBUl9QQVRIKTtcbiAgbG9nLmluZm8oYEV4dHJhY3RpbmcgbWFuaWZlc3QgYW5kIGFwayB0byAke1NFX0RPV05MT0FEX0RJUn1gKTtcbiAgYXdhaXQgZXhlYygnamFyJywgWyd4ZicsIFNFX0pBUl9QQVRILCBtYW5pZmVzdFBhdGgsIHNlcnZlclBhdGhdLCB7XG4gICAgY3dkOiBTRV9ET1dOTE9BRF9ESVJcbiAgfSk7XG4gIGxvZy5pbmZvKGBDb3B5aW5nIG1hbmlmZXN0IGFuZCBhcGsgdG8gJHtTRV9ESVJ9YCk7XG4gIGxldCBleHRyYWN0ZWRNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBtYW5pZmVzdFBhdGgpO1xuICBsZXQgZXh0cmFjdGVkU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIHNlcnZlclBhdGgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRNYW5pZmVzdFBhdGgsIFNFX01BTklGRVNUX1BBVEgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRTZXJ2ZXJQYXRoLCBTRV9BUEtfUEFUSCk7XG4gIGxvZy5pbmZvKFwiQ2xlYW5pbmcgdXAgdGVtcCBmaWxlc1wiKTtcbiAgYXdhaXQgZnMucmltcmFmKGV4dHJhY3RlZE1hbmlmZXN0UGF0aCk7XG4gIGF3YWl0IGZzLnJpbXJhZihleHRyYWN0ZWRTZXJ2ZXJQYXRoKTtcbiAgbG9nLmluZm8oYEZpeGluZyBBbmRyb2lkTWFuaWZlc3QgaWNvbiBidWdgKTtcbiAgYXdhaXQgZml4TWFuaWZlc3RJY29ucyhTRV9NQU5JRkVTVF9QQVRIKTtcbiAgaWYgKCEoYXdhaXQgc2VydmVyRXhpc3RzKCkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiU29tZXRoaW5nIHdlbnQgd3JvbmcgaW4gc2V0dGluZyB1cCBzZWxlbmRyb2lkXCIpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkU2VsZW5kcm9pZCAoKSB7XG4gIGxvZy5pbmZvKGBFbnN1cmluZyAke1NFX0RPV05MT0FEX0RJUn0gZXhpc3RzYCk7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RJUik7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RPV05MT0FEX0RJUik7XG4gIGxvZy5pbmZvKGBEb3dubG9hZGluZyBTZWxlbmRyb2lkIHN0YW5kYWxvbmUgc2VydmVyIHZlcnNpb24gJHtTRV9WRVJ9IGZyb20gYCArXG4gICAgICAgICAgIGAke1NFX0RPV05MT0FEfSAtLT4gJHtTRV9KQVJfUEFUSH1gKTtcbiAgbGV0IGJvZHkgPSBhd2FpdCByZXF1ZXN0LmdldCh7dXJsOiBTRV9ET1dOTE9BRCwgZW5jb2Rpbmc6IG51bGx9KTtcbiAgaWYgKCFib2R5IGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChib2R5KSk7XG4gIH1cbiAgbG9nLmluZm8oYFdyaXRpbmcgYmluYXJ5IGNvbnRlbnQgdG8gJHtTRV9KQVJfUEFUSF9UTVB9YCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShTRV9KQVJfUEFUSF9UTVAsIGJvZHkpO1xuICBhd2FpdCBmcy5jaG1vZChTRV9KQVJfUEFUSF9UTVAsIDBvMDY0NCk7XG4gIGxldCBmaW5nZXJwcmludCA9IGF3YWl0IHNoYTI1Nihib2R5KTtcbiAgaWYgKGZpbmdlcnByaW50ID09PSBTRV9ET1dOTE9BRF9TSEEyNTYpIHtcbiAgICBhd2FpdCBmcy5yZW5hbWUoU0VfSkFSX1BBVEhfVE1QLCBTRV9KQVJfUEFUSCk7XG4gICAgbG9nLmluZm8oXCJTZWxlbmRyb2lkIHN0YW5kYWxvbmUgc2VydmVyIGRvd25sb2FkZWRcIik7XG4gIH0gZWxzZSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coXCJiYWQgU0hBMjU2IGZpbmdlcnByaW50OiBcIiArIGZpbmdlcnByaW50ICsgXCIgYnl0ZXM6IFwiICsgYm9keS5sZW5ndGgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNoYTI1NiAoYnVmZmVyKSB7XG4gIGNvbnN0IGhhc2ggPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2Jyk7XG4gIHJldHVybiBoYXNoLnVwZGF0ZShidWZmZXIpLmRpZ2VzdCgnaGV4Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEZpbGVQYXRoRnJvbUphciAoZmlsZVJlZ2V4LCBqYXJQYXRoKSB7XG4gIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2phcicsIFsndGYnLCBqYXJQYXRoXSk7XG4gIGZvciAobGV0IGxpbmUgb2Ygc3Rkb3V0LnNwbGl0KFwiXFxuXCIpKSB7XG4gICAgaWYgKGZpbGVSZWdleC50ZXN0KGxpbmUudHJpbSgpKSkge1xuICAgICAgcmV0dXJuIGxpbmUudHJpbSgpO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kICR7ZmlsZVJlZ2V4fSBpbiAke2phclBhdGh9YCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlcnZlckV4aXN0cyAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIChhd2FpdCBmcy5leGlzdHMoU0VfQVBLX1BBVEgpICYmXG4gICAgICAgICAgICBhd2FpdCBmcy5leGlzdHMoU0VfTUFOSUZFU1RfUEFUSCkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUuY29kZS5pbmRleE9mKFwiRU5PRU5UXCIpICE9PSAtMSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeE1hbmlmZXN0SWNvbnMgKG1hbmlmZXN0KSB7XG4gIGxldCBjdXJEYXRhID0gKGF3YWl0IGZzLnJlYWRGaWxlKG1hbmlmZXN0KSkudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgbGV0IGljb25SZSA9IC9hcHBsaWNhdGlvbltcXHNcXFNdK2FuZHJvaWQ6aWNvbj1cIlteXCJdK1wiLztcbiAgbGV0IG5ld0RhdGEgPSBjdXJEYXRhLnJlcGxhY2UoaWNvblJlLCBcImFwcGxpY2F0aW9uXCIpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUobWFuaWZlc3QsIG5ld0RhdGEpO1xufVxuXG5leHBvcnQgeyBzZXR1cFNlbGVuZHJvaWQsIHNlcnZlckV4aXN0cywgU0VfQVBLX1BBVEgsIFNFX01BTklGRVNUX1BBVEggfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
