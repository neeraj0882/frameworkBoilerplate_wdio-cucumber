'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _packageJson = require('../../package.json');

// eslint-disable-line import/no-unresolved

var TEST_APK_PATH = _path2['default'].resolve(__dirname, '..', '..', 'espresso-server', 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');
var TEST_MANIFEST_PATH = _path2['default'].resolve(__dirname, '..', '..', 'espresso-server', 'AndroidManifest-test.xml');
var TEST_APK_PKG = "io.appium.espressoserver.test";
var REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];

var EspressoRunner = (function () {
  function EspressoRunner() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, EspressoRunner);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQUIRED_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.host, port: this.systemPort, base: '' });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);

    this.modServerPath = _path2['default'].resolve(this.tmpDir, TEST_APK_PKG + '_' + _packageJson.version + '_' + this.appPackage + '.apk');
  }

  _createClass(EspressoRunner, [{
    key: 'installTestApk',
    value: function installTestApk() {
      return _regeneratorRuntime.async(function installTestApk$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = this.forceEspressoRebuild;

            if (!context$2$0.t0) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 4:
            context$2$0.t0 = context$2$0.sent;

          case 5:
            if (!context$2$0.t0) {
              context$2$0.next = 9;
              break;
            }

            _logger2['default'].debug('Capability \'forceEspressoRebuild\' on. Deleting file \'' + this.modServerPath + '\'');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(this.modServerPath));

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 11:
            if (context$2$0.sent) {
              context$2$0.next = 14;
              break;
            }

            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.buildNewModServer());

          case 14:
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(this.modServerPath));

          case 16:
            if (!this.forceEspressoRebuild) {
              context$2$0.next = 20;
              break;
            }

            _logger2['default'].info("New server was built, uninstalling any instances of it");
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(TEST_APK_PKG));

          case 20:
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.adb.installOrUpgrade(this.modServerPath, TEST_APK_PKG));

          case 22:
            _logger2['default'].info('Installed Espresso Test Server apk \'' + this.modServerPath + '\' (pkg: \'' + TEST_APK_PKG + '\')');

          case 23:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'buildNewModServer',
    value: function buildNewModServer() {
      var packageTmpDir, newManifestPath;
      return _regeneratorRuntime.async(function buildNewModServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Repackaging espresso server for: \'' + this.appPackage + '\'');
            packageTmpDir = _path2['default'].resolve(this.tmpDir, this.appPackage);
            newManifestPath = _path2['default'].resolve(this.tmpDir, 'AndroidManifest.xml');

            _logger2['default'].info('Creating new manifest: \'' + newManifestPath + '\'');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(packageTmpDir));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(TEST_MANIFEST_PATH, newManifestPath));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.adb.compileManifest(newManifestPath, TEST_APK_PKG, this.appPackage));

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.adb.insertManifest(newManifestPath, TEST_APK_PATH, this.modServerPath));

          case 14:
            // copies from second to third and add manifest
            _logger2['default'].info('Repackaged espresso server ready: \'' + this.modServerPath + '\'');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // TODO duplicated from uiautomator2, should be a lib method
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk, apkPackage) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, apkPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var cmd, err;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = ['am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', TEST_APK_PKG + '/android.support.test.runner.AndroidJUnitRunner'];

            _logger2['default'].info('Starting Espresso Server v' + _packageJson.version + ' with cmd: ' + cmd.join(' '));

            // start the instrumentation process, but do not wait for it
            // otherwise it will block for longer than needed for the device to be ready
            err = undefined;

            this.adb.shell(cmd)['catch'](function (e) {
              // eslint-disable-line
              // handle asynchronous errors that no longer get thrown
              err = e;
            });

            _logger2['default'].info('Waiting for Espresso to be online...');

            // wait 20s for espresso to be online
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 1000, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!err) {
                      context$3$0.next = 2;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 2:
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

                  case 4:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 7:
            if (!err) {
              context$2$0.next = 9;
              break;
            }

            throw err;

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 11:
            if (!err) {
              context$2$0.next = 13;
              break;
            }

            throw err;

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    // eslint-disable-line curly
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting Espresso server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation Espresso deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return EspressoRunner;
})();

exports.EspressoRunner = EspressoRunner;
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
exports['default'] = EspressoRunner;
// TODO this should be internal to adb
// creates a file `${newManifestPath}.apk`
// eslint-disable-line curly
// eslint-disable-line curly
//# sourceMappingURL=data:application/json;charset=utf8;base64,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c0NvbnRlbnQiOlsiaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgdmVyc2lvbiB9IGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgaW1wb3J0L25vLXVucmVzb2x2ZWRcblxuXG5jb25zdCBURVNUX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2VzcHJlc3NvLXNlcnZlcicsICdhcHAnLCAnYnVpbGQnLCAnb3V0cHV0cycsICdhcGsnLCAnYW5kcm9pZFRlc3QnLCAnZGVidWcnLCAnYXBwLWRlYnVnLWFuZHJvaWRUZXN0LmFwaycpO1xuY29uc3QgVEVTVF9NQU5JRkVTVF9QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2VzcHJlc3NvLXNlcnZlcicsICdBbmRyb2lkTWFuaWZlc3QtdGVzdC54bWwnKTtcbmNvbnN0IFRFU1RfQVBLX1BLRyA9IFwiaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLnRlc3RcIjtcbmNvbnN0IFJFUVVJUkVEX1BBUkFNUyA9IFsnYWRiJywgJ3RtcERpcicsICdob3N0JywgJ3N5c3RlbVBvcnQnLCAnZGV2aWNlUG9ydCcsICdhcHBQYWNrYWdlJywgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJ107XG5cbmNsYXNzIEVzcHJlc3NvUnVubmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFVSVJFRF9QQVJBTVMpIHtcbiAgICAgIGlmICghb3B0cyB8fCAhdXRpbC5oYXNWYWx1ZShvcHRzW3JlcV0pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xuICAgICAgfVxuICAgICAgdGhpc1tyZXFdID0gb3B0c1tyZXFdO1xuICAgIH1cbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7c2VydmVyOiB0aGlzLmhvc3QsIHBvcnQ6IHRoaXMuc3lzdGVtUG9ydCwgYmFzZTogJyd9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcblxuICAgIHRoaXMubW9kU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgYCR7VEVTVF9BUEtfUEtHfV8ke3ZlcnNpb259XyR7dGhpcy5hcHBQYWNrYWdlfS5hcGtgKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxUZXN0QXBrICgpIHtcbiAgICBpZiAodGhpcy5mb3JjZUVzcHJlc3NvUmVidWlsZCAmJiBhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBDYXBhYmlsaXR5ICdmb3JjZUVzcHJlc3NvUmVidWlsZCcgb24uIERlbGV0aW5nIGZpbGUgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgICAgIGF3YWl0IGZzLnVubGluayh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cblxuICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSkge1xuICAgICAgYXdhaXQgdGhpcy5idWlsZE5ld01vZFNlcnZlcigpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLmNoZWNrQW5kU2lnbkNlcnQodGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICBpZiAodGhpcy5mb3JjZUVzcHJlc3NvUmVidWlsZCkge1xuICAgICAgbG9nZ2VyLmluZm8oXCJOZXcgc2VydmVyIHdhcyBidWlsdCwgdW5pbnN0YWxsaW5nIGFueSBpbnN0YW5jZXMgb2YgaXRcIik7XG4gICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoVEVTVF9BUEtfUEtHKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbE9yVXBncmFkZSh0aGlzLm1vZFNlcnZlclBhdGgsIFRFU1RfQVBLX1BLRyk7XG4gICAgbG9nZ2VyLmluZm8oYEluc3RhbGxlZCBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gIH1cblxuICBhc3luYyBidWlsZE5ld01vZFNlcnZlciAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnaW5nIGVzcHJlc3NvIHNlcnZlciBmb3I6ICcke3RoaXMuYXBwUGFja2FnZX0nYCk7XG4gICAgbGV0IHBhY2thZ2VUbXBEaXIgPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgbGV0IG5ld01hbmlmZXN0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgJ0FuZHJvaWRNYW5pZmVzdC54bWwnKTtcbiAgICBsb2dnZXIuaW5mbyhgQ3JlYXRpbmcgbmV3IG1hbmlmZXN0OiAnJHtuZXdNYW5pZmVzdFBhdGh9J2ApO1xuICAgIGF3YWl0IGZzLm1rZGlyKHBhY2thZ2VUbXBEaXIpO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKFRFU1RfTUFOSUZFU1RfUEFUSCwgbmV3TWFuaWZlc3RQYXRoKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbml0QWFwdCgpOyAvLyBUT0RPIHRoaXMgc2hvdWxkIGJlIGludGVybmFsIHRvIGFkYlxuICAgIGF3YWl0IHRoaXMuYWRiLmNvbXBpbGVNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIFRFU1RfQVBLX1BLRywgdGhpcy5hcHBQYWNrYWdlKTsgLy8gY3JlYXRlcyBhIGZpbGUgYCR7bmV3TWFuaWZlc3RQYXRofS5hcGtgXG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zZXJ0TWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCBURVNUX0FQS19QQVRILCB0aGlzLm1vZFNlcnZlclBhdGgpOyAvLyBjb3BpZXMgZnJvbSBzZWNvbmQgdG8gdGhpcmQgYW5kIGFkZCBtYW5pZmVzdFxuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2VkIGVzcHJlc3NvIHNlcnZlciByZWFkeTogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgfVxuXG4gIC8vIFRPRE8gZHVwbGljYXRlZCBmcm9tIHVpYXV0b21hdG9yMiwgc2hvdWxkIGJlIGEgbGliIG1ldGhvZFxuICBhc3luYyBjaGVja0FuZFNpZ25DZXJ0IChhcGssIGFwa1BhY2thZ2UpIHtcbiAgICBsZXQgc2lnbmVkID0gYXdhaXQgdGhpcy5hZGIuY2hlY2tBcGtDZXJ0KGFwaywgYXBrUGFja2FnZSk7XG4gICAgaWYgKCFzaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24oYXBrKTtcbiAgICB9XG4gICAgcmV0dXJuICFzaWduZWQ7XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICBsZXQgY21kID0gWydhbScsICdpbnN0cnVtZW50JywgJy13JywgJy1lJywgJ2RlYnVnJywgcHJvY2Vzcy5lbnYuRVNQUkVTU09fSkFWQV9ERUJVRyA9PT0gJ3RydWUnID8gJ3RydWUnIDogJ2ZhbHNlJyxcbiAgICAgIGAke1RFU1RfQVBLX1BLR30vYW5kcm9pZC5zdXBwb3J0LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lcmBdO1xuXG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIEVzcHJlc3NvIFNlcnZlciB2JHt2ZXJzaW9ufSB3aXRoIGNtZDogJHtjbWQuam9pbignICcpfWApO1xuXG4gICAgLy8gc3RhcnQgdGhlIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzLCBidXQgZG8gbm90IHdhaXQgZm9yIGl0XG4gICAgLy8gb3RoZXJ3aXNlIGl0IHdpbGwgYmxvY2sgZm9yIGxvbmdlciB0aGFuIG5lZWRlZCBmb3IgdGhlIGRldmljZSB0byBiZSByZWFkeVxuICAgIGxldCBlcnI7XG4gICAgdGhpcy5hZGIuc2hlbGwoY21kKS5jYXRjaCgoZSkgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgICAvLyBoYW5kbGUgYXN5bmNocm9ub3VzIGVycm9ycyB0aGF0IG5vIGxvbmdlciBnZXQgdGhyb3duXG4gICAgICBlcnIgPSBlO1xuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmluZm8oJ1dhaXRpbmcgZm9yIEVzcHJlc3NvIHRvIGJlIG9ubGluZS4uLicpO1xuXG4gICAgLy8gd2FpdCAyMHMgZm9yIGVzcHJlc3NvIHRvIGJlIG9ubGluZVxuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMjAsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIGlmIChlcnIpIHJldHVybjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgfSk7XG4gICAgaWYgKGVycikgdGhyb3cgZXJyOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICAgIGlmIChlcnIpIHRocm93IGVycjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBFc3ByZXNzbyBzZXJ2ZXIgc2Vzc2lvbicpO1xuICAgIC8vIHJlbHkgb24gandwcm94eSdzIGludGVsbGlnZW5jZSB0byBrbm93IHdoYXQgd2UncmUgdGFsa2luZyBhYm91dCBhbmRcbiAgICAvLyBkZWxldGUgdGhlIGN1cnJlbnQgc2Vzc2lvblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnLycsICdERUxFVEUnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBEaWQgbm90IGdldCBjb25maXJtYXRpb24gRXNwcmVzc28gZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBFc3ByZXNzb1J1bm5lciwgUkVRVUlSRURfUEFSQU1TIH07XG5leHBvcnQgZGVmYXVsdCBFc3ByZXNzb1J1bm5lcjtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
