'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _this = this;

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _appiumBaseDriver = require('appium-base-driver');

var commands = {},
    helpers = {},
    extensions = {};

var WEBSOCKET_ENDPOINT = function WEBSOCKET_ENDPOINT(sessionId) {
  return _appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX + '/session/' + sessionId + '/appium/device/logcat';
};

// https://github.com/SeleniumHQ/selenium/blob/0d425676b3c9df261dd641917f867d4d5ce7774d/java/client/src/org/openqa/selenium/logging/LogEntry.java
function toLogRecord(timestamp, level, message) {
  return {
    timestamp: timestamp,
    level: level,
    message: message
  };
}

extensions.supportedLogTypes = {
  logcat: {
    description: 'Logs for Android applications on real device and emulators via ADB',
    getter: function getter(self) {
      return _regeneratorRuntime.async(function getter$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
          case 0:
            context$1$0.next = 2;
            return _regeneratorRuntime.awrap(self.adb.getLogcatLogs());

          case 2:
            return context$1$0.abrupt('return', context$1$0.sent);

          case 3:
          case 'end':
            return context$1$0.stop();
        }
      }, null, _this);
    }
  },
  bugreport: {
    description: '\'adb bugreport\' output for advanced issues diagnostic',
    getter: function getter(self) {
      var output, timestamp;
      return _regeneratorRuntime.async(function getter$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
          case 0:
            context$1$0.next = 2;
            return _regeneratorRuntime.awrap(self.adb.bugreport());

          case 2:
            output = context$1$0.sent;
            timestamp = Date.now();
            return context$1$0.abrupt('return', output.split(_os2['default'].EOL).map(function (x) {
              return toLogRecord(timestamp, 'ALL', x);
            }));

          case 5:
          case 'end':
            return context$1$0.stop();
        }
      }, null, _this);
    }
  },
  server: {
    description: 'Appium server logs',
    getter: function getter(self) {
      if (!self.relaxedSecurityEnabled) {
        throw new Error('Appium server must have relaxed security flag set ' + 'in order to be able to get server logs');
      }
      var timestamp = Date.now();
      return _logger2['default'].unwrap().record.map(function (x) {
        return toLogRecord(timestamp, 'ALL', _lodash2['default'].isEmpty(x.prefix) ? x.message : '[' + x.prefix + '] ' + x.message);
      });
    }
  }
};

/**
 * Starts Android logcat broadcast websocket on the same host and port
 * where Appium server is running at `/ws/session/:sessionId:/appium/logcat` endpoint. The method
 * will return immediately if the web socket is already listening.
 *
 * Each connected webcoket listener will receive logcat log lines
 * as soon as they are visible to Appium.
 */
commands.mobileStartLogsBroadcast = function callee$0$0() {
  var pathname, wss;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        pathname = WEBSOCKET_ENDPOINT(this.sessionId);
        context$1$0.t0 = _lodash2['default'];
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.server.getWebSocketHandlers(pathname));

      case 4:
        context$1$0.t1 = context$1$0.sent;

        if (context$1$0.t0.isEmpty.call(context$1$0.t0, context$1$0.t1)) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].debug('The logcat broadcasting web socket server is already listening at ' + pathname);
        return context$1$0.abrupt('return');

      case 8:

        _logger2['default'].info('Assigning logcat broadcasting web socket server to ' + pathname);
        // https://github.com/websockets/ws/blob/master/doc/ws.md
        wss = new _ws2['default'].Server({
          noServer: true
        });

        wss.on('connection', function (ws, req) {
          if (req) {
            var remoteIp = _lodash2['default'].isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];
            _logger2['default'].debug('Established a new logcat listener web socket connection from ' + remoteIp);
          } else {
            _logger2['default'].debug('Established a new logcat listener web socket connection');
          }
          _this2.adb.setLogcatListener(function (logRecord) {
            if (ws && ws.readyState === _ws2['default'].OPEN) {
              ws.send(logRecord.message);
            }
          });
          ws.on('close', function (code, reason) {
            var closeMsg = 'Logcat listener web socket is closed.';
            if (!_lodash2['default'].isEmpty(code)) {
              closeMsg += ' Code: ' + code + '.';
            }
            if (!_lodash2['default'].isEmpty(reason)) {
              closeMsg += ' Reason: ' + reason + '.';
            }
            _logger2['default'].debug(closeMsg);
          });
        });
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.server.addWebSocketHandler(pathname, wss));

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Stops the previously started logcat broadcasting wesocket server.
 * This method will return immediately if no server is running.
 */
commands.mobileStopLogsBroadcast = function callee$0$0() {
  var pathname;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        pathname = WEBSOCKET_ENDPOINT(this.sessionId);
        context$1$0.t0 = _lodash2['default'];
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.server.getWebSocketHandlers(pathname));

      case 4:
        context$1$0.t1 = context$1$0.sent;

        if (!context$1$0.t0.isEmpty.call(context$1$0.t0, context$1$0.t1)) {
          context$1$0.next = 7;
          break;
        }

        return context$1$0.abrupt('return');

      case 7:

        _logger2['default'].debug('Stopping the logcat broadcasting web socket server');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.server.removeWebSocketHandler(pathname));

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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L0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUM7Ozs7OzRCQUF4RCxPQUFPOzs7Ozs7Ozs7QUFJYiw0QkFBSSxLQUFLLENBQUMsb0RBQW9ELENBQUMsQ0FBQzs7eUNBQzFELElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDOzs7Ozs7O0NBQ25ELENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvbG9nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCB7IERFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXRUJTT0NLRVRfRU5EUE9JTlQgPSAoc2Vzc2lvbklkKSA9PiBgJHtERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWH0vc2Vzc2lvbi8ke3Nlc3Npb25JZH0vYXBwaXVtL2RldmljZS9sb2djYXRgO1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vU2VsZW5pdW1IUS9zZWxlbml1bS9ibG9iLzBkNDI1Njc2YjNjOWRmMjYxZGQ2NDE5MTdmODY3ZDRkNWNlNzc3NGQvamF2YS9jbGllbnQvc3JjL29yZy9vcGVucWEvc2VsZW5pdW0vbG9nZ2luZy9Mb2dFbnRyeS5qYXZhXG5mdW5jdGlvbiB0b0xvZ1JlY29yZCAodGltZXN0YW1wLCBsZXZlbCwgbWVzc2FnZSkge1xuICByZXR1cm4ge1xuICAgIHRpbWVzdGFtcCxcbiAgICBsZXZlbCxcbiAgICBtZXNzYWdlLFxuICB9O1xufVxuXG5leHRlbnNpb25zLnN1cHBvcnRlZExvZ1R5cGVzID0ge1xuICBsb2djYXQ6IHtcbiAgICBkZXNjcmlwdGlvbjogJ0xvZ3MgZm9yIEFuZHJvaWQgYXBwbGljYXRpb25zIG9uIHJlYWwgZGV2aWNlIGFuZCBlbXVsYXRvcnMgdmlhIEFEQicsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5hZGIuZ2V0TG9nY2F0TG9ncygpLFxuICB9LFxuICBidWdyZXBvcnQ6IHtcbiAgICBkZXNjcmlwdGlvbjogYCdhZGIgYnVncmVwb3J0JyBvdXRwdXQgZm9yIGFkdmFuY2VkIGlzc3VlcyBkaWFnbm9zdGljYCxcbiAgICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCBzZWxmLmFkYi5idWdyZXBvcnQoKTtcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgICByZXR1cm4gb3V0cHV0LnNwbGl0KG9zLkVPTClcbiAgICAgICAgLm1hcCgoeCkgPT4gdG9Mb2dSZWNvcmQodGltZXN0YW1wLCAnQUxMJywgeCkpO1xuICAgIH0sXG4gIH0sXG4gIHNlcnZlcjoge1xuICAgIGRlc2NyaXB0aW9uOiAnQXBwaXVtIHNlcnZlciBsb2dzJyxcbiAgICBnZXR0ZXI6IChzZWxmKSA9PiB7XG4gICAgICBpZiAoIXNlbGYucmVsYXhlZFNlY3VyaXR5RW5hYmxlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FwcGl1bSBzZXJ2ZXIgbXVzdCBoYXZlIHJlbGF4ZWQgc2VjdXJpdHkgZmxhZyBzZXQgJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnaW4gb3JkZXIgdG8gYmUgYWJsZSB0byBnZXQgc2VydmVyIGxvZ3MnKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgICByZXR1cm4gbG9nLnVud3JhcCgpLnJlY29yZFxuICAgICAgICAubWFwKCh4KSA9PiB0b0xvZ1JlY29yZCh0aW1lc3RhbXAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdBTEwnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmlzRW1wdHkoeC5wcmVmaXgpID8geC5tZXNzYWdlIDogYFske3gucHJlZml4fV0gJHt4Lm1lc3NhZ2V9YClcbiAgICAgICAgKTtcbiAgICB9LFxuICB9LFxufTtcblxuLyoqXG4gKiBTdGFydHMgQW5kcm9pZCBsb2djYXQgYnJvYWRjYXN0IHdlYnNvY2tldCBvbiB0aGUgc2FtZSBob3N0IGFuZCBwb3J0XG4gKiB3aGVyZSBBcHBpdW0gc2VydmVyIGlzIHJ1bm5pbmcgYXQgYC93cy9zZXNzaW9uLzpzZXNzaW9uSWQ6L2FwcGl1bS9sb2djYXRgIGVuZHBvaW50LiBUaGUgbWV0aG9kXG4gKiB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiB0aGUgd2ViIHNvY2tldCBpcyBhbHJlYWR5IGxpc3RlbmluZy5cbiAqXG4gKiBFYWNoIGNvbm5lY3RlZCB3ZWJjb2tldCBsaXN0ZW5lciB3aWxsIHJlY2VpdmUgbG9nY2F0IGxvZyBsaW5lc1xuICogYXMgc29vbiBhcyB0aGV5IGFyZSB2aXNpYmxlIHRvIEFwcGl1bS5cbiAqL1xuY29tbWFuZHMubW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBjb25zdCBwYXRobmFtZSA9IFdFQlNPQ0tFVF9FTkRQT0lOVCh0aGlzLnNlc3Npb25JZCk7XG4gIGlmICghXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICBsb2cuZGVidWcoYFRoZSBsb2djYXQgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIGlzIGFscmVhZHkgbGlzdGVuaW5nIGF0ICR7cGF0aG5hbWV9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmluZm8oYEFzc2lnbmluZyBsb2djYXQgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIHRvICR7cGF0aG5hbWV9YCk7XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJzb2NrZXRzL3dzL2Jsb2IvbWFzdGVyL2RvYy93cy5tZFxuICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgbm9TZXJ2ZXI6IHRydWUsXG4gIH0pO1xuICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xuICAgIGlmIChyZXEpIHtcbiAgICAgIGNvbnN0IHJlbW90ZUlwID0gXy5pc0VtcHR5KHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSlcbiAgICAgICAgPyByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzXG4gICAgICAgIDogcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddO1xuICAgICAgbG9nLmRlYnVnKGBFc3RhYmxpc2hlZCBhIG5ldyBsb2djYXQgbGlzdGVuZXIgd2ViIHNvY2tldCBjb25uZWN0aW9uIGZyb20gJHtyZW1vdGVJcH1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdFc3RhYmxpc2hlZCBhIG5ldyBsb2djYXQgbGlzdGVuZXIgd2ViIHNvY2tldCBjb25uZWN0aW9uJyk7XG4gICAgfVxuICAgIHRoaXMuYWRiLnNldExvZ2NhdExpc3RlbmVyKChsb2dSZWNvcmQpID0+IHtcbiAgICAgIGlmICh3cyAmJiB3cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICB3cy5zZW5kKGxvZ1JlY29yZC5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB3cy5vbignY2xvc2UnLCAoY29kZSwgcmVhc29uKSA9PiB7XG4gICAgICBsZXQgY2xvc2VNc2cgPSAnTG9nY2F0IGxpc3RlbmVyIHdlYiBzb2NrZXQgaXMgY2xvc2VkLic7XG4gICAgICBpZiAoIV8uaXNFbXB0eShjb2RlKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIENvZGU6ICR7Y29kZX0uYDtcbiAgICAgIH1cbiAgICAgIGlmICghXy5pc0VtcHR5KHJlYXNvbikpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBSZWFzb246ICR7cmVhc29ufS5gO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGNsb3NlTXNnKTtcbiAgICB9KTtcbiAgfSk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUsIHdzcyk7XG59O1xuXG4vKipcbiAqIFN0b3BzIHRoZSBwcmV2aW91c2x5IHN0YXJ0ZWQgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZXNvY2tldCBzZXJ2ZXIuXG4gKiBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBubyBzZXJ2ZXIgaXMgcnVubmluZy5cbiAqL1xuY29tbWFuZHMubW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKF8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdTdG9wcGluZyB0aGUgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlcicpO1xuICBhd2FpdCB0aGlzLnNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lKTtcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7Il0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
